name: Secrets Scan

on:
  push:
    branches: [main, develop, staging]
  pull_request:
    branches: [main, develop, staging]

permissions:
  contents: read

jobs:
  secrets-scan:
    name: Scan for leaked secrets
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_CONFIG: .gitleaks.toml

      - name: Custom pattern scan
        if: always()
        run: |
          set +e
          FINDINGS=0

          # Define patterns
          PATTERNS=(
            'sk-ant-[a-zA-Z0-9_\-]{20,}'
            'sk-[a-zA-Z0-9]{20,}'
            'AKIA[0-9A-Z]{16}'
            'ghp_[a-zA-Z0-9]{36}'
            'ghs_[a-zA-Z0-9]{36}'
            'ghr_[a-zA-Z0-9]{36}'
            '-----BEGIN (RSA |EC |DSA |OPENSSH )?PRIVATE KEY-----'
            'bu_[a-zA-Z0-9]{30,}'
          )

          # Get changed files
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} 2>/dev/null || git diff --name-only HEAD~1)
          else
            FILES=$(git diff --name-only HEAD~1 2>/dev/null || git ls-files)
          fi

          # Skip patterns
          SKIP='node_modules/|\.next/|dist/|build/|venv/|__pycache__|\.env\.example|\.lock$|package-lock\.json|\.test\.|\.spec\.|/tests/|/__tests__/'

          for file in $FILES; do
            # Skip non-existent, binary, excluded files
            [[ ! -f "$file" ]] && continue
            echo "$file" | grep -qE "$SKIP" && continue
            file --mime "$file" 2>/dev/null | grep -q "binary" && continue

            for pattern in "${PATTERNS[@]}"; do
              matches=$(grep -nEi "$pattern" "$file" 2>/dev/null | head -5)
              if [[ -n "$matches" ]]; then
                # Check for inline allowlist
                echo "$matches" | grep -qEi 'gitleaks:allow|# noqa: secrets' && continue
                echo "::error file=$file::Potential secret found matching pattern: ${pattern:0:30}..."
                FINDINGS=$((FINDINGS + 1))
              fi
            done
          done

          if [[ $FINDINGS -gt 0 ]]; then
            echo "::error::Found $FINDINGS potential secret(s) in changed files"
            exit 1
          fi

          echo "âœ… No secrets detected in changed files"
