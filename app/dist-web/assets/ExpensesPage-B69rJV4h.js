import{r as i,j as e}from"./vendor-react-wuMqdllU.js";import{u as I,E as O}from"./ExpenseDialog-dj1c9ijL.js";import{i as R,E as V,a as g,I as U,B as b,A}from"./index-BJ9hpEov.js";import{T as W,a as z,b as S,c as r,d as M,e as n}from"./table-D-p124BO.js";import{C as _}from"./confirm-delete-dialog-D3P6PPsQ.js";import{u as $}from"./usePeriodLocks-CimS-PQ2.js";import{i as q}from"./isRecordLocked-BcN8lokf.js";import{o as H,t as Z,Y,am as J,f as K,W as Q,G as X}from"./vendor-icons-ssgfUAX_.js";import"./vendor-markdown-C3iCDuOK.js";import"./dialog-BPcAFwmD.js";import"./vendor-radix-DqeMb71O.js";import"./vendor-floating-ui-BD6aHMKr.js";import"./vendor-forms-B8CBK7X2.js";import"./index-FI6coOPr.js";import"./vendor-recharts-tRgwS7-V.js";import"./vendor-router-Cm8Qzw9U.js";import"./alert-dialog-CMM_3WOV.js";function m(c){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(c)}function ee(c){return new Intl.DateTimeFormat("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"}).format(c)}function se({onAddExpense:c,onEditExpense:o,className:u,refreshTrigger:d}){const{expenses:h,isLoading:C,error:N,deleteExpense:y,setSelectedExpense:D,refresh:v}=I(),{periods:p}=$(),[j,F]=i.useState(""),[E,k]=i.useState(null);i.useEffect(()=>{d&&d>0&&v()},[d,v]);const w=i.useMemo(()=>{if(!j)return h;const s=j.toLowerCase();return h.filter(t=>t.description.toLowerCase().includes(s)||t.vendor.toLowerCase().includes(s)||t.euerCategory.toLowerCase().includes(s))},[h,j]),T=i.useMemo(()=>w.reduce((s,t)=>({net:s.net+t.netAmount,vat:s.vat+t.vatAmount,gross:s.gross+t.grossAmount}),{net:0,vat:0,gross:0}),[w]),P=s=>{D(s),o==null||o(s)},G=(s,t)=>{s.stopPropagation(),k(t)},B=async()=>{E&&(await y(E),k(null))};return C?e.jsxs("div",{className:R("flex items-center justify-center p-8",u),children:[e.jsx(H,{className:"h-8 w-8 animate-spin text-muted-foreground"}),e.jsx("span",{className:"ml-2 text-muted-foreground",children:"Loading..."})]}):N?e.jsxs("div",{className:R("p-8 text-center",u),children:[e.jsx("p",{className:"text-destructive",children:V(N)}),e.jsx(g,{variant:"outline",className:"mt-4",onClick:()=>window.location.reload(),children:"Retry"})]}):e.jsxs("div",{className:R("space-y-4",u),children:[e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:[e.jsx("h2",{className:"text-2xl sm:text-3xl font-semibold tracking-tight",children:"Expenses"}),e.jsxs(g,{onClick:c,className:"w-full sm:w-auto",children:[e.jsx(Z,{className:"mr-2 h-4 w-4"}),"Add Expense"]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Y,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(U,{placeholder:"Search expenses...",value:j,onChange:s=>F(s.target.value),className:"pl-10"})]}),w.length===0?e.jsx("div",{className:"rounded-lg border border-dashed p-8 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:j?"No expense records match your search":"No expense records yet. Add your first expense to get started."})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"rounded-md border overflow-x-auto",children:e.jsxs(W,{className:"min-w-[800px]",children:[e.jsx(z,{children:e.jsxs(S,{children:[e.jsx(r,{className:"w-[32px]"}),e.jsx(r,{children:"Date"}),e.jsx(r,{children:"Vendor"}),e.jsx(r,{children:"Description"}),e.jsx(r,{children:"VAT"}),e.jsx(r,{className:"text-right",children:"Net"}),e.jsx(r,{className:"text-right",children:"Vorsteuer"}),e.jsx(r,{className:"text-right",children:"Gross"}),e.jsx(r,{className:"text-center",children:"Receipt"}),e.jsx(r,{className:"w-[50px]"})]})}),e.jsx(M,{children:w.map(s=>{const t=q(s.date,p);return e.jsxs(S,{className:"cursor-pointer hover:bg-muted/50",onClick:()=>P(s),children:[e.jsx(n,{className:"w-[32px] px-2",children:t&&e.jsx(J,{className:"h-3.5 w-3.5 text-red-400","aria-label":"Gesperrt",title:"Zeitraum gesperrt"})}),e.jsx(n,{className:"font-medium",children:ee(s.date)}),e.jsx(n,{children:s.vendor}),e.jsx(n,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:s.description}),s.vorsteuerClaimed&&e.jsx(b,{variant:"secondary",className:"text-xs",children:"Claimed"}),s.isRecurring&&e.jsx(b,{variant:"outline",className:"text-xs",children:"Recurring"}),s.isGwg&&e.jsx(b,{variant:"default",className:"text-xs",children:"GWG"})]})}),e.jsx(n,{children:e.jsxs(b,{variant:"outline",children:[s.vatRate,"%"]})}),e.jsx(n,{className:"text-right",children:m(s.netAmount)}),e.jsx(n,{className:"text-right",children:m(s.vatAmount)}),e.jsx(n,{className:"text-right font-medium",children:m(s.grossAmount)}),e.jsx(n,{className:"text-center",children:s.receiptPath?e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx(g,{variant:"ghost",size:"icon",onClick:x=>{x.stopPropagation(),x.preventDefault();const a=window.open("about:blank","_blank");A.requestBlob(`/expenses/${s.id}/receipt`).then(L=>{const f=URL.createObjectURL(L);if(a)a.location.href=f;else{const l=document.createElement("a");l.href=f,l.target="_blank",l.click()}}).catch(()=>{a&&a.close(),alert("Failed to view receipt")})},"aria-label":"View receipt",title:"View PDF",children:e.jsx(K,{className:"h-4 w-4 text-muted-foreground hover:text-primary"})}),e.jsx(g,{variant:"ghost",size:"icon",onClick:x=>{x.stopPropagation(),x.preventDefault();const a=window.open("about:blank","_blank");A.requestBlob(`/expenses/${s.id}/receipt?download=true`).then(L=>{const f=URL.createObjectURL(L);if(a)a.location.href=f;else{const l=document.createElement("a");l.href=f,l.download=`receipt-${s.id}.pdf`,document.body.appendChild(l),l.click(),document.body.removeChild(l)}}).catch(()=>{a&&a.close(),alert("Failed to download receipt")})},"aria-label":"Download receipt",title:"Download PDF",children:e.jsx(Q,{className:"h-4 w-4 text-muted-foreground hover:text-primary"})})]}):e.jsx("span",{className:"text-muted-foreground text-xs",children:"—"})}),e.jsx(n,{children:t?e.jsx("span",{className:"text-xs text-muted-foreground",title:"Zeitraum gesperrt",children:"—"}):e.jsx(g,{variant:"ghost",size:"icon",onClick:x=>G(x,s.id),"aria-label":"Delete",children:e.jsx(X,{className:"h-4 w-4 text-muted-foreground hover:text-destructive"})})})]},s.id)})})]})}),e.jsx("div",{className:"flex justify-start sm:justify-end",children:e.jsxs("div",{className:"rounded-lg bg-muted p-3 sm:p-4 w-full sm:w-auto",children:[e.jsx("div",{className:"text-sm font-medium text-muted-foreground",children:"Total"}),e.jsxs("div",{className:"mt-1 grid grid-cols-3 gap-2 sm:gap-4 text-right",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Net"}),e.jsx("div",{className:"font-medium text-sm sm:text-base",children:m(T.net)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Vorsteuer"}),e.jsx("div",{className:"font-medium text-sm sm:text-base",children:m(T.vat)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Gross"}),e.jsx("div",{className:"font-semibold text-sm sm:text-base",children:m(T.gross)})]})]})]})})]}),e.jsx(_,{open:!!E,onOpenChange:s=>!s&&k(null),title:"Delete expense?",description:"This will permanently delete this expense record. This action cannot be undone.",onConfirm:B})]})}function Ne(){const[c,o]=i.useState(!1),[u,d]=i.useState(null),[h,C]=i.useState(0),N=()=>{d(null),o(!0)},y=p=>{d(p),o(!0)},D=()=>{o(!1),d(null)},v=()=>{C(p=>p+1)};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-6 animate-in fade-in",children:e.jsx(se,{onAddExpense:N,onEditExpense:y,refreshTrigger:h})}),e.jsx(O,{open:c,onOpenChange:o,expense:u,onClose:D,onSuccess:v})]})}export{Ne as ExpensesPage};
