import{r as l,j as e}from"./vendor-react-DeR5d9Tv.js";import{C as Ne}from"./confirm-delete-dialog-BMDwFNTg.js";import{A as be,m as we}from"./vendor-framer-motion-5hIM_3P7.js";import{c as De,a8 as T,a9 as Z,f as ge,j as xe,L as U,I as H,E as Ie,x as Ce,a as R,r as ve,l as G,T as Se,F as ke,B as Pe,m as Ae}from"./index-9iTO35Tf.js";import{C as z,c as Y,a as Fe,b as Ee}from"./card-CJKskPxD.js";import{T as Te,a as Me,b as ee,c as Re}from"./tabs-DYsUY3jx.js";import{T as Oe,a as qe,b as he,c as B,d as Ue,e as V}from"./table-1HdAiBAg.js";import{T as $e}from"./textarea-Cn3IF5S1.js";import{S as te,a as se,b as ae,c as ne,d as k}from"./select-nIcj8TB_.js";import{D as Le,a as _e}from"./dialog-DRTG7Iov.js";import{C as pe}from"./calendar-DlRUgQCZ.js";import{P as ue}from"./plus-B0AmLF8B.js";import{T as me}from"./trash-2-DGGE0QMh.js";import{w as ce}from"./vendor-date-fns-D0ugVOfH.js";import{D as Be}from"./download-CVn5Mw3H.js";import{S as Ve}from"./send-BJMpb7SV.js";import{C as ze}from"./check-Dj5_6VYs.js";import"./vendor-markdown-PIr_2kdo.js";import"./alert-dialog-Ba9m1D5X.js";import"./vendor-radix-zn9KX-y8.js";import"./vendor-floating-ui-CESiY8Ey.js";import"./vendor-recharts-DrMJw15s.js";import"./vendor-router-9bGSKQ4q.js";/**
 * @license lucide-react v0.469.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=De("Percent",[["line",{x1:"19",x2:"5",y1:"5",y2:"19",key:"1x9vlm"}],["circle",{cx:"6.5",cy:"6.5",r:"2.5",key:"4mh3h7"}],["circle",{cx:"17.5",cy:"17.5",r:"2.5",key:"1mdrzq"}]]);function Qe({isActive:s,onComplete:c,iconCount:P=20}){const[C,w]=l.useState(!1),v=l.useMemo(()=>typeof window>"u"?!1:window.matchMedia("(prefers-reduced-motion: reduce)").matches,[]),d=l.useMemo(()=>Array.from({length:P},(n,y)=>({id:y,x:Math.random()*100,delay:Math.random()*.8,duration:2+Math.random()*1,rotation:(Math.random()-.5)*60,scale:1.5+Math.random()})),[P]);return l.useEffect(()=>{if(s){w(!0);const n=setTimeout(()=>{w(!1),c==null||c()},3500);return()=>clearTimeout(n)}},[s,c]),v?null:e.jsx(be,{children:C&&e.jsx("div",{className:"fixed inset-0 pointer-events-none overflow-hidden",style:{zIndex:9999},"aria-hidden":"true",children:d.map(n=>e.jsx(we.div,{className:"absolute text-4xl select-none",style:{left:`${n.x}%`,fontSize:`${n.scale}rem`},initial:{y:-100,x:"-50%",rotate:n.rotation-20,opacity:0},animate:{y:"100vh",rotate:n.rotation+20,opacity:[0,1,1,0]},exit:{opacity:0},transition:{duration:n.duration,delay:n.delay,ease:[.16,1,.3,1],opacity:{duration:n.duration,times:[0,.1,.8,1]}},children:"ðŸ’¸"},n.id))})})}function He(){const[s,c]=l.useState(!1),P=l.useCallback(()=>{c(!0)},[]),C=l.useCallback(()=>{c(!1)},[]);return{isActive:s,trigger:P,onComplete:C}}function J(s){return{id:s.id,invoiceNumber:s.invoiceNumber,invoiceDate:new Date(s.issueDate||s.createdAt),dueDate:new Date(s.dueDate),status:s.status,clientId:s.clientId,projectId:s.projectId,subtotal:s.amount||0,vatRate:s.taxRate||19,vatAmount:s.taxAmount||0,total:s.totalAmount||0,paymentDate:s.paidDate?new Date(s.paidDate):void 0,paymentMethod:void 0,notes:s.notes,items:(s.lineItems||[]).map(c=>({id:c.id??crypto.randomUUID(),invoiceId:s.id,description:c.description,quantity:c.quantity,unit:c.unit||"hours",unitPrice:c.unitPrice,amount:c.amount})),createdAt:new Date(s.createdAt)}}function Je(s={}){const{autoFetch:c=!0,status:P,clientId:C}=s,[w,v]=l.useState([]),[d,n]=l.useState(!1),[y,j]=l.useState(null),[S,D]=l.useState(null),O=l.useCallback(async()=>{n(!0),j(null);try{const a=await T.getAll();v(a.map(J))}catch(a){console.error("Failed to fetch invoices:",a);const i=a instanceof Error?a.message:typeof a=="string"?a:JSON.stringify(a)||"Failed to fetch invoices";j(i)}finally{n(!1)}},[]),u=l.useCallback(async a=>{n(!0),j(null);try{const i=await T.getByStatus(a);v(i.map(J))}catch(i){j(i instanceof Error?i.message:"Failed to fetch invoices")}finally{n(!1)}},[]),h=l.useCallback(async a=>{n(!0),j(null);try{const i=await T.getByClient(a);v(i.map(J))}catch(i){j(i instanceof Error?i.message:"Failed to fetch invoices")}finally{n(!1)}},[]),p=l.useCallback(async a=>{n(!0),j(null);try{const i={invoiceNumber:"",clientId:a.clientId||"",projectId:a.projectId,issueDate:a.invoiceDate.toISOString(),dueDate:a.dueDate.toISOString(),status:"draft",amount:a.items.reduce((f,E)=>f+E.quantity*E.unitPrice,0),currency:"EUR",taxRate:a.vatRate,taxAmount:0,totalAmount:0,notes:a.notes,lineItems:a.items.map(f=>({id:crypto.randomUUID(),description:f.description,quantity:f.quantity,unit:f.unit||"hours",unitPrice:f.unitPrice,amount:f.quantity*f.unitPrice})),updatedAt:new Date().toISOString()},b=await T.create(i),I=J(b);return v(f=>[I,...f]),I}catch(i){return console.error("Failed to create invoice:",i),j(i instanceof Error?i.message:"Failed to create invoice"),null}finally{n(!1)}},[]),$=l.useCallback(async(a,i)=>{n(!0),j(null);try{await T.update(a,i);const b=await T.getById(a);if(b){const I=J(b);return v(f=>f.map(E=>E.id===a?I:E)),(S==null?void 0:S.id)===a&&D(I),I}return null}catch(b){return j(b instanceof Error?b.message:"Failed to update invoice"),null}finally{n(!1)}},[S]),F=l.useCallback(async a=>{n(!0),j(null);try{return await T.delete(a),v(i=>i.filter(b=>b.id!==a)),(S==null?void 0:S.id)===a&&D(null),!0}catch(i){return j(i instanceof Error?i.message:"Failed to delete invoice"),!1}finally{n(!1)}},[S]),M=l.useCallback(async a=>{n(!0),j(null);try{const i=await T.markAsSent(a),b=J(i);return v(I=>I.map(f=>f.id===a?b:f)),b}catch(i){return j(i instanceof Error?i.message:"Failed to mark invoice as sent"),null}finally{n(!1)}},[]),q=l.useCallback(async(a,i,b)=>{n(!0),j(null);try{await T.markAsPaid(a,i,b);const f=(await T.getAll()).find(L=>L.id===a);if(!f)throw new Error("Invoice not found after marking as paid");const E=J(f);return v(L=>L.map(Q=>Q.id===a?E:Q)),E}catch(I){return j(I instanceof Error?I.message:"Failed to mark invoice as paid"),null}finally{n(!1)}},[]),K=l.useCallback(async a=>{n(!0),j(null);try{const i=await T.cancelInvoice(a),b=J(i);return v(I=>I.map(f=>f.id===a?b:f)),b}catch(i){return j(i instanceof Error?i.message:"Failed to cancel invoice"),null}finally{n(!1)}},[]),W=l.useCallback(async()=>{try{return await T.getNextInvoiceNumber()}catch{return`RE-${new Date().getFullYear()}-001`}},[]),X=l.useCallback(async()=>{await O()},[O]);return l.useEffect(()=>{c&&O()},[c,O]),{invoices:w,isLoading:d,error:y,fetchInvoices:O,fetchByStatus:u,fetchByClient:h,createInvoice:p,updateInvoice:$,deleteInvoice:F,markAsSent:M,markAsPaid:q,cancelInvoice:K,getNextInvoiceNumber:W,selectedInvoice:S,setSelectedInvoice:D,refresh:X}}function ye(s={}){const{autoFetch:c=!0}=s,[P,C]=l.useState([]),[w,v]=l.useState(!1),[d,n]=l.useState(null),y=l.useCallback(async()=>{v(!0),n(null);try{const h=(await Z.getAll()).map(p=>({id:p.id,name:p.name,address:p.address||p.company||void 0,vatId:p.vatId||void 0,email:p.email||void 0,createdAt:p.createdAt?new Date(p.createdAt):new Date}));C(h)}catch(u){console.error("Failed to fetch clients:",u);const h=u instanceof Error?u.message:typeof u=="string"?u:JSON.stringify(u)||"Failed to fetch clients";n(h)}finally{v(!1)}},[]),j=l.useCallback(async u=>{v(!0),n(null);try{const h=await Z.create({name:u.name,company:u.address,email:u.email,notes:u.vatId?`VAT ID: ${u.vatId}`:void 0,status:"active"}),p={id:h.id,name:h.name,address:h.company||void 0,vatId:u.vatId,email:h.email||void 0,createdAt:h.createdAt?new Date(h.createdAt):new Date};return C($=>[...$,p].sort((F,M)=>F.name.localeCompare(M.name))),p}catch(h){return n(h instanceof Error?h.message:"Failed to create client"),null}finally{v(!1)}},[]),S=l.useCallback(async(u,h)=>{v(!0),n(null);try{await Z.update(u,{name:h.name,company:h.address,email:h.email,notes:h.vatId?`VAT ID: ${h.vatId}`:void 0});const p=await Z.getById(u);if(p){const $={id:p.id,name:p.name,address:p.company||void 0,vatId:h.vatId,email:p.email||void 0,createdAt:p.createdAt?new Date(p.createdAt):new Date};return C(F=>F.map(M=>M.id===u?$:M).sort((M,q)=>M.name.localeCompare(q.name))),$}return null}catch(p){return n(p instanceof Error?p.message:"Failed to update client"),null}finally{v(!1)}},[]),D=l.useCallback(async u=>{v(!0),n(null);try{return await Z.delete(u),C(h=>h.filter(p=>p.id!==u)),!0}catch(h){return n(h instanceof Error?h.message:"Failed to delete client"),!1}finally{v(!1)}},[]),O=l.useCallback(async()=>{await y()},[y]);return l.useEffect(()=>{c&&y()},[c,y]),{clients:P,isLoading:w,error:d,fetchClients:y,createClient:j,updateClient:S,deleteClient:D,refresh:O}}function re(s){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(s)}function fe(){return`item-${Date.now()}-${Math.random().toString(36).substring(2,9)}`}function Ge(){const s=new Date,c=new Date(s);return c.setDate(c.getDate()+14),{invoiceDate:s.toISOString().split("T")[0],dueDate:c.toISOString().split("T")[0]}}function Ke({invoice:s,onSubmit:c,onCancel:P,className:C}){const w=!!s,v=Ge(),{clients:d}=ye(),{projects:n,initialize:y}=ge();l.useEffect(()=>{y()},[y]);const[j,S]=l.useState(s!=null&&s.invoiceDate?s.invoiceDate.toISOString().split("T")[0]:v.invoiceDate),[D,O]=l.useState(s!=null&&s.dueDate?s.dueDate.toISOString().split("T")[0]:v.dueDate),[u,h]=l.useState((s==null?void 0:s.vatRate)??19),[p,$]=l.useState((s==null?void 0:s.notes)??""),[F,M]=l.useState((s==null?void 0:s.clientId)??""),[q,K]=l.useState((s==null?void 0:s.projectId)??""),[W,X]=l.useState(!1),[a,i]=l.useState({}),b=l.useMemo(()=>F?n.filter(t=>t.clientId===F):[],[n,F]),I=t=>{M(t),q&&(n.some(m=>m.id===q&&m.clientId===t)||K(""))},[f,E]=l.useState(()=>s!=null&&s.items&&s.items.length>0?s.items.map(t=>({id:t.id,description:t.description,quantity:t.quantity,unit:t.unit??"hours",unitPrice:t.unitPrice})):[{id:fe(),description:"",quantity:1,unit:"hours",unitPrice:0}]),L=l.useMemo(()=>f.map(t=>Math.round(t.quantity*t.unitPrice*100)/100),[f]),Q=l.useMemo(()=>{const t=L.reduce((x,o)=>x+o,0),g=Math.round(t*(u/100)*100)/100,m=Math.round((t+g)*100)/100;return{subtotal:t,vatAmount:g,total:m}},[L,u]),_=(t,g,m)=>{E(x=>x.map(o=>o.id===t?{...o,[g]:m}:o))},de=()=>{E(t=>[...t,{id:fe(),description:"",quantity:1,unit:"hours",unitPrice:0}])},le=t=>{E(g=>g.filter(m=>m.id!==t))},r=()=>{const t={};f.length===0&&(t.items="At least one line item is required");const g={},m={},x={};return f.forEach(o=>{o.description.trim()||(g[o.id]="Description is required"),o.quantity<=0&&(m[o.id]="Quantity must be positive"),o.unitPrice<=0&&(x[o.id]="Price must be positive")}),Object.keys(g).length>0&&(t.itemDescriptions=g),Object.keys(m).length>0&&(t.itemQuantities=m),Object.keys(x).length>0&&(t.itemPrices=x),i(t),Object.keys(t).length===0},N=async t=>{if(t.preventDefault(),!!r()){X(!0);try{const g=f.map(x=>({description:x.description,quantity:x.quantity,unit:x.unit,unitPrice:x.unitPrice})),m={invoiceDate:new Date(j),dueDate:new Date(D),vatRate:u,items:g,clientId:F||void 0,projectId:q||void 0,notes:p||void 0};await c(m)}finally{X(!1)}}};return e.jsxs("form",{onSubmit:N,className:xe("space-y-5 w-full max-w-full overflow-hidden",C),children:[e.jsx("h2",{className:"text-xl font-semibold",children:w?"Edit Invoice":"New Invoice"}),e.jsxs("div",{className:"grid gap-4 grid-cols-1 sm:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(U,{htmlFor:"invoiceDate",className:"flex items-center gap-2",children:[e.jsx(pe,{className:"h-3.5 w-3.5 text-muted-foreground"}),"Invoice Date"]}),e.jsx(H,{id:"invoiceDate",type:"date",value:j,onChange:t=>S(t.target.value),className:"h-10"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(U,{htmlFor:"dueDate",className:"flex items-center gap-2",children:[e.jsx(pe,{className:"h-3.5 w-3.5 text-muted-foreground"}),"Due Date"]}),e.jsx(H,{id:"dueDate",type:"date",value:D,onChange:t=>O(t.target.value),className:"h-10"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(U,{htmlFor:"client",className:"flex items-center gap-2",children:[e.jsx(Ie,{className:"h-3.5 w-3.5 text-muted-foreground"}),"Client"]}),e.jsxs(te,{value:F||void 0,onValueChange:I,children:[e.jsx(se,{id:"client",children:e.jsx(ae,{placeholder:"Select a client"})}),e.jsx(ne,{children:d.length===0?e.jsx("div",{className:"px-2 py-4 text-center text-sm text-muted-foreground",children:"No clients available"}):d.filter(t=>t.id).map(t=>e.jsx(k,{value:t.id,children:t.name},t.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(U,{htmlFor:"vatRate",className:"flex items-center gap-2",children:[e.jsx(Ye,{className:"h-3.5 w-3.5 text-muted-foreground"}),"VAT Rate"]}),e.jsxs(te,{value:String(u),onValueChange:t=>h(Number(t)),children:[e.jsx(se,{id:"vatRate",children:e.jsx(ae,{})}),e.jsxs(ne,{children:[e.jsx(k,{value:"19",children:"19%"}),e.jsx(k,{value:"7",children:"7%"}),e.jsx(k,{value:"0",children:"0%"})]})]})]}),F&&b.length>0&&e.jsxs("div",{className:"space-y-2 sm:col-span-2",children:[e.jsxs(U,{htmlFor:"project",className:"flex items-center gap-2",children:[e.jsx(Ce,{className:"h-3.5 w-3.5 text-muted-foreground"}),"Project",e.jsx("span",{className:"text-xs font-normal text-muted-foreground",children:"(optional)"})]}),e.jsxs(te,{value:q||"__none__",onValueChange:t=>K(t==="__none__"?"":t),children:[e.jsx(se,{id:"project",children:e.jsx(ae,{placeholder:"Select a project"})}),e.jsxs(ne,{children:[e.jsx(k,{value:"__none__",children:e.jsx("span",{className:"text-muted-foreground",children:"No project"})}),b.filter(t=>t.id).map(t=>e.jsx(k,{value:t.id,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:xe("h-2 w-2 rounded-full",t.status==="active"&&"bg-green-500",t.status==="pipeline"&&"bg-blue-500",t.status==="on_hold"&&"bg-yellow-500",t.status==="completed"&&"bg-gray-400",t.status==="cancelled"&&"bg-red-400")}),t.name]})},t.id))]})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(U,{children:"Line Items"}),e.jsxs(R,{type:"button",variant:"outline",size:"sm",onClick:de,children:[e.jsx(ue,{className:"mr-2 h-4 w-4"}),"Add Item"]})]}),a.items&&e.jsx("p",{className:"text-sm text-destructive",children:a.items}),e.jsx("div",{className:"space-y-3 w-full",children:f.map((t,g)=>{var m,x,o,ie;return e.jsxs("div",{className:"rounded-lg border p-3 sm:p-4 w-full",children:[e.jsxs("div",{className:"flex flex-col gap-3 sm:hidden w-full",children:[e.jsxs("div",{className:"w-full",children:[e.jsx(U,{className:"text-xs text-muted-foreground mb-1 block",children:"Description"}),e.jsx(H,{placeholder:"Description",className:"h-10 w-full",value:t.description,onChange:A=>_(t.id,"description",A.target.value)}),((m=a.itemDescriptions)==null?void 0:m[t.id])&&e.jsx("p",{className:"mt-1 text-xs text-destructive",children:a.itemDescriptions[t.id]})]}),e.jsxs("div",{className:"w-full",children:[e.jsx(U,{className:"text-xs text-muted-foreground mb-1 block",children:"Quantity"}),e.jsx(H,{id:`quantity-${t.id}`,"aria-label":"Quantity",className:"h-10 w-full",type:"number",inputMode:"decimal",min:"0.01",step:"0.01",value:t.quantity,onChange:A=>_(t.id,"quantity",parseFloat(A.target.value)||0)})]}),e.jsxs("div",{className:"w-full",children:[e.jsx(U,{className:"text-xs text-muted-foreground mb-1 block",children:"Unit"}),e.jsxs(te,{value:t.unit,onValueChange:A=>_(t.id,"unit",A),children:[e.jsx(se,{className:"h-10 w-full",children:e.jsx(ae,{})}),e.jsxs(ne,{children:[e.jsx(k,{value:"hours",children:"Hours"}),e.jsx(k,{value:"days",children:"Days"}),e.jsx(k,{value:"month",children:"Month"}),e.jsx(k,{value:"units",children:"Units"}),e.jsx(k,{value:"pieces",children:"Pieces"})]})]})]}),e.jsxs("div",{className:"w-full",children:[e.jsx(U,{className:"text-xs text-muted-foreground mb-1 block",children:"Unit Price (â‚¬)"}),e.jsx(H,{id:`unitPrice-${t.id}`,"aria-label":"Unit Price",className:"h-10 w-full",type:"number",inputMode:"decimal",min:"0.01",step:"0.01",value:t.unitPrice,onChange:A=>_(t.id,"unitPrice",parseFloat(A.target.value)||0)})]}),e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t w-full",children:[e.jsxs(R,{type:"button",variant:"ghost",size:"sm",className:"text-muted-foreground hover:text-destructive -ml-2",onClick:()=>le(t.id),children:[e.jsx(me,{className:"h-4 w-4 mr-1"}),"Remove"]}),e.jsx("span",{className:"font-semibold text-base",children:re(L[g])})]})]}),e.jsxs("div",{className:"hidden sm:block",children:[e.jsxs("div",{className:"grid items-start gap-3 grid-cols-[1fr_80px_90px_100px_40px]",children:[e.jsxs("div",{children:[e.jsx(H,{placeholder:"Description",className:"h-9",value:t.description,onChange:A=>_(t.id,"description",A.target.value)}),((x=a.itemDescriptions)==null?void 0:x[t.id])&&e.jsx("p",{className:"mt-1 text-xs text-destructive",children:a.itemDescriptions[t.id]})]}),e.jsxs("div",{children:[e.jsx(H,{id:`quantity-desktop-${t.id}`,"aria-label":"Quantity",className:"h-9",type:"number",min:"0.01",step:"0.01",value:t.quantity,onChange:A=>_(t.id,"quantity",parseFloat(A.target.value)||0)}),((o=a.itemQuantities)==null?void 0:o[t.id])&&e.jsx("p",{className:"mt-1 text-xs text-destructive",children:a.itemQuantities[t.id]})]}),e.jsxs(te,{value:t.unit,onValueChange:A=>_(t.id,"unit",A),children:[e.jsx(se,{className:"h-9",children:e.jsx(ae,{})}),e.jsxs(ne,{children:[e.jsx(k,{value:"hours",children:"hrs"}),e.jsx(k,{value:"days",children:"days"}),e.jsx(k,{value:"month",children:"month"}),e.jsx(k,{value:"units",children:"units"}),e.jsx(k,{value:"pieces",children:"pcs"})]})]}),e.jsxs("div",{children:[e.jsx(H,{id:`unitPrice-desktop-${t.id}`,"aria-label":"Unit Price",className:"h-9",type:"number",min:"0.01",step:"0.01",value:t.unitPrice,onChange:A=>_(t.id,"unitPrice",parseFloat(A.target.value)||0)}),((ie=a.itemPrices)==null?void 0:ie[t.id])&&e.jsx("p",{className:"mt-1 text-xs text-destructive",children:a.itemPrices[t.id]})]}),e.jsx(R,{type:"button",variant:"ghost",size:"icon",className:"h-9 w-9",onClick:()=>le(t.id),"aria-label":"Remove",children:e.jsx(me,{className:"h-4 w-4 text-muted-foreground hover:text-destructive"})})]}),e.jsx("div",{className:"mt-3 text-right text-sm font-medium",children:re(L[g])})]})]},t.id)})})]}),e.jsxs("div",{className:"space-y-2 rounded-lg bg-muted p-3 sm:p-4 w-full",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Subtotal"}),e.jsx("span",{children:re(Q.subtotal)})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:["VAT (",u,"%)"]}),e.jsx("span",{children:re(Q.vatAmount)})]}),e.jsxs("div",{className:"flex justify-between border-t pt-2 font-semibold",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{children:re(Q.total)})]})]}),e.jsxs("div",{className:"space-y-2 w-full",children:[e.jsx(U,{htmlFor:"notes",children:"Notes"}),e.jsx($e,{id:"notes",value:p,onChange:t=>$(t.target.value),placeholder:"Additional notes...",rows:3,className:"w-full"})]}),e.jsxs("div",{className:"flex flex-col-reverse sm:flex-row sm:justify-end gap-2 sm:gap-3 pt-2",children:[e.jsx(R,{type:"button",variant:"outline",onClick:P,className:"w-full sm:w-auto",children:"Cancel"}),e.jsxs(R,{type:"submit",disabled:W,className:"w-full sm:w-auto",children:[W&&e.jsx(ve,{className:"mr-2 h-4 w-4 animate-spin"}),"Save Invoice"]})]})]})}function We({open:s,onOpenChange:c,invoice:P,onClose:C,onSuccess:w}){const v=async d=>{try{if(P)await T.update(P.id,{issueDate:d.invoiceDate.toISOString(),dueDate:d.dueDate.toISOString(),clientId:d.clientId||"",projectId:d.projectId,taxRate:d.vatRate,notes:d.notes,lineItems:d.items.map(n=>({id:crypto.randomUUID(),description:n.description,quantity:n.quantity,unit:n.unit||"hours",unitPrice:n.unitPrice,amount:n.quantity*n.unitPrice}))}),G.success("Invoice updated");else{const n=await T.create({invoiceNumber:"",clientId:d.clientId||"",projectId:d.projectId,issueDate:d.invoiceDate.toISOString(),dueDate:d.dueDate.toISOString(),status:"draft",amount:d.items.reduce((y,j)=>y+j.quantity*j.unitPrice,0),currency:"EUR",taxRate:d.vatRate,taxAmount:0,totalAmount:0,notes:d.notes,lineItems:d.items.map(y=>({id:crypto.randomUUID(),description:y.description,quantity:y.quantity,unit:y.unit||"hours",unitPrice:y.unitPrice,amount:y.quantity*y.unitPrice})),updatedAt:new Date().toISOString()});G.success(`Invoice ${n.invoiceNumber} created`)}C(),w==null||w()}catch(n){console.error("Invoice save error:",n),G.error(n instanceof Error?n.message:"Failed to save invoice")}};return e.jsx(Le,{open:s,onOpenChange:c,children:e.jsx(_e,{className:"w-[calc(100vw-1rem)] sm:w-[calc(100vw-2rem)] max-w-[700px] max-h-[85vh] sm:max-h-[90vh] overflow-y-auto overflow-x-hidden p-4 sm:p-6 [&>*]:max-w-full",children:e.jsx(Ke,{invoice:P||void 0,onSubmit:v,onCancel:C})})})}function oe(s){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(s)}function je(s){return new Intl.DateTimeFormat("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"}).format(s)}function Xe(s){switch(s){case"draft":return{variant:"secondary",label:"Draft"};case"sent":return{variant:"default",label:"Sent"};case"paid":return{variant:"outline",label:"Paid"};case"overdue":return{variant:"destructive",label:"Overdue"};case"cancelled":return{variant:"secondary",label:"Cancelled"};default:return{variant:"secondary",label:s}}}function bt(){const[s,c]=l.useState(!1),[P,C]=l.useState(null),[w,v]=l.useState("all"),[d,n]=l.useState(null),[y,j]=l.useState(null),S=He(),{invoices:D,isLoading:O,error:u,markAsSent:h,markAsPaid:p,deleteInvoice:$,refresh:F}=Je(),{clients:M}=ye(),{projects:q,initialize:K}=ge();l.useEffect(()=>{K()},[K]);const W=l.useMemo(()=>new Map(M.map(r=>[r.id,r])),[M]),X=l.useMemo(()=>new Map(q.map(r=>[r.id,r])),[q]),a=l.useMemo(()=>{const r=D.filter(o=>o.status==="draft").length,N=D.filter(o=>o.status==="sent"&&!ce(o.dueDate)).length,t=D.filter(o=>o.status==="paid").length,g=D.filter(o=>o.status==="overdue"||o.status==="sent"&&ce(o.dueDate)).length,m=new Date().getFullYear(),x=D.filter(o=>o.status==="paid"&&o.paymentDate&&o.paymentDate.getFullYear()===m).reduce((o,ie)=>o+ie.total,0);return{draft:r,sent:N,paid:t,overdue:g,ytdRevenue:x}},[D]),i=l.useMemo(()=>{const r=new Date().getFullYear();return["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"].map((t,g)=>{const m=D.filter(x=>x.status==="paid"&&x.paymentDate&&x.paymentDate.getFullYear()===r&&x.paymentDate.getMonth()===g).reduce((x,o)=>x+o.total,0);return{month:t,revenue:m}})},[D]),b=l.useMemo(()=>D.filter(r=>{const N=r.status==="sent"&&ce(r.dueDate);switch(w){case"draft":return r.status==="draft";case"sent":return r.status==="sent"&&!N;case"paid":return r.status==="paid";case"overdue":return N||r.status==="overdue";default:return!0}}),[D,w]),I=r=>{C(r),c(!0)},f=()=>{c(!1),C(null)},E=()=>{F()},L=async(r,N)=>{r.stopPropagation(),await h(N.id)&&G.success(`Invoice ${N.invoiceNumber} marked as sent`)},Q=async(r,N)=>{r.stopPropagation(),await p(N.id,new Date)&&(G.success(`Invoice ${N.invoiceNumber} marked as paid`),S.trigger())},_=(r,N)=>{r.stopPropagation(),n(N)},de=async()=>{d&&(await $(d.id)&&G.success(`Invoice ${d.invoiceNumber} deleted`),n(null))},le=async(r,N)=>{r.stopPropagation(),j(N.id);try{const t=await Ae.downloadInvoicePdf(N.id),g=window.URL.createObjectURL(t),m=document.createElement("a");m.href=g,m.download=`${N.invoiceNumber}.pdf`,document.body.appendChild(m),m.click(),document.body.removeChild(m),window.URL.revokeObjectURL(g),G.success("PDF downloaded")}catch(t){console.error("Failed to download PDF:",t),G.error("Failed to download PDF")}finally{j(null)}};return u?e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{children:e.jsx("h1",{className:"text-2xl sm:text-3xl font-semibold tracking-tight",children:"Invoices"})}),e.jsx(z,{children:e.jsxs(Y,{className:"p-12 text-center",children:[e.jsx("p",{className:"text-destructive",children:u}),e.jsx(R,{variant:"outline",className:"mt-4",onClick:()=>window.location.reload(),children:"Retry"})]})})]}):e.jsxs("div",{className:"space-y-6 animate-in fade-in",children:[e.jsx(Qe,{isActive:S.isActive,onComplete:S.onComplete}),e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:[e.jsx("div",{children:e.jsx("h1",{className:"text-2xl sm:text-3xl font-semibold tracking-tight",children:"Invoices"})}),e.jsxs(R,{onClick:()=>c(!0),className:"w-full sm:w-auto",children:[e.jsx(ue,{className:"h-4 w-4 mr-2"}),"Create Invoice"]})]}),e.jsxs("div",{className:"grid gap-3 sm:gap-4 grid-cols-2 sm:grid-cols-3 lg:grid-cols-5",children:[e.jsx(z,{children:e.jsxs(Y,{className:"pt-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Draft"}),e.jsx("p",{className:"text-2xl font-bold",children:a.draft})]})}),e.jsx(z,{children:e.jsxs(Y,{className:"pt-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Sent"}),e.jsx("p",{className:"text-2xl font-bold",children:a.sent})]})}),e.jsx(z,{children:e.jsxs(Y,{className:"pt-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Paid"}),e.jsx("p",{className:"text-2xl font-bold text-green-600",children:a.paid})]})}),e.jsx(z,{children:e.jsxs(Y,{className:"pt-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Overdue"}),e.jsx("p",{className:"text-2xl font-bold text-destructive",children:a.overdue})]})}),e.jsx(z,{className:"bg-primary/5",children:e.jsxs(Y,{className:"pt-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"YTD Revenue"}),e.jsx("p",{className:"text-2xl font-bold text-primary",children:oe(a.ytdRevenue)})]})})]}),a.ytdRevenue>0&&e.jsxs(z,{children:[e.jsx(Fe,{className:"pb-2",children:e.jsxs(Ee,{className:"text-base flex items-center gap-2",children:[e.jsx(Se,{className:"h-4 w-4"}),new Date().getFullYear()," Revenue"]})}),e.jsx(Y,{children:e.jsx("div",{className:"flex gap-1 h-16",children:i.map((r,N)=>{const t=Math.max(...i.map(m=>m.revenue)),g=t>0?r.revenue/t*100:0;return e.jsxs("div",{className:"flex-1 flex flex-col justify-end items-center gap-1",children:[e.jsx("div",{className:"w-full bg-primary/80 rounded-t transition-all",style:{height:`${g}%`,minHeight:g>0?4:0}}),e.jsx("span",{className:"text-[10px] text-muted-foreground",children:r.month})]},N)})})})]}),e.jsxs(Te,{value:w,onValueChange:v,children:[e.jsxs(Me,{className:"flex w-full overflow-x-auto gap-1 sm:inline-flex sm:w-auto",children:[e.jsxs(ee,{value:"all",className:"flex-shrink-0",children:["All (",D.length,")"]}),e.jsxs(ee,{value:"draft",className:"flex-shrink-0",children:["Draft (",a.draft,")"]}),e.jsxs(ee,{value:"sent",className:"flex-shrink-0",children:["Sent (",a.sent,")"]}),e.jsxs(ee,{value:"overdue",className:"text-destructive flex-shrink-0",children:["Overdue (",a.overdue,")"]}),e.jsxs(ee,{value:"paid",className:"flex-shrink-0",children:["Paid (",a.paid,")"]})]}),e.jsx(Re,{value:w,className:"mt-4",children:O?e.jsx(z,{children:e.jsxs(Y,{className:"p-12 text-center",children:[e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent mx-auto"}),e.jsx("p",{className:"text-muted-foreground mt-4",children:"Loading invoices..."})]})}):b.length===0?e.jsx(z,{children:e.jsxs(Y,{className:"p-12 text-center",children:[e.jsx(ke,{className:"h-12 w-12 mx-auto text-muted-foreground/50 mb-4"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:w==="all"?"No invoices yet":`No ${w} invoices`}),e.jsx("p",{className:"text-muted-foreground text-sm mb-4",children:w==="all"?"Create your first invoice to get started.":`You don't have any ${w} invoices.`}),w==="all"&&e.jsxs(R,{onClick:()=>c(!0),children:[e.jsx(ue,{className:"h-4 w-4 mr-2"}),"Create Invoice"]})]})}):e.jsx("div",{className:"rounded-md border overflow-x-auto",children:e.jsxs(Oe,{className:"min-w-[900px]",children:[e.jsx(qe,{children:e.jsxs(he,{children:[e.jsx(B,{children:"Invoice â„–"}),e.jsx(B,{children:"Client"}),e.jsx(B,{children:"Project"}),e.jsx(B,{children:"Date"}),e.jsx(B,{children:"Due Date"}),e.jsx(B,{children:"Status"}),e.jsx(B,{className:"text-right",children:"Net"}),e.jsx(B,{className:"text-right",children:"VAT"}),e.jsx(B,{className:"text-right",children:"Total"}),e.jsx(B,{className:"w-[100px]",children:"Actions"})]})}),e.jsx(Ue,{children:b.map(r=>{var g,m;const N=Xe(r.status),t=r.status==="sent"&&ce(r.dueDate);return e.jsxs(he,{className:"cursor-pointer hover:bg-muted/50",onClick:()=>I(r),children:[e.jsx(V,{className:"font-medium",children:r.invoiceNumber}),e.jsx(V,{children:r.clientId?((g=W.get(r.clientId))==null?void 0:g.name)??"â€”":"â€”"}),e.jsx(V,{children:r.projectId?((m=X.get(r.projectId))==null?void 0:m.name)??"â€”":"â€”"}),e.jsx(V,{children:je(r.invoiceDate)}),e.jsx(V,{className:t?"text-destructive":"",children:je(r.dueDate)}),e.jsx(V,{children:e.jsx(Pe,{variant:t?"destructive":N.variant,children:t?"Overdue":N.label})}),e.jsx(V,{className:"text-right",children:oe(r.subtotal)}),e.jsx(V,{className:"text-right text-muted-foreground",children:oe(r.vatAmount)}),e.jsx(V,{className:"text-right font-medium",children:oe(r.total)}),e.jsx(V,{children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(R,{variant:"ghost",size:"icon",onClick:x=>le(x,r),title:"Download PDF",disabled:y===r.id,children:y===r.id?e.jsx(ve,{className:"h-4 w-4 animate-spin text-muted-foreground"}):e.jsx(Be,{className:"h-4 w-4 text-muted-foreground hover:text-primary"})}),r.status==="draft"&&e.jsx(R,{variant:"ghost",size:"icon",onClick:x=>L(x,r),title:"Mark as Sent",children:e.jsx(Ve,{className:"h-4 w-4 text-muted-foreground hover:text-primary"})}),(r.status==="sent"||r.status==="overdue"||t)&&e.jsx(R,{variant:"ghost",size:"icon",onClick:x=>Q(x,r),title:"Mark as Paid",children:e.jsx(ze,{className:"h-4 w-4 text-muted-foreground hover:text-green-600"})}),e.jsx(R,{variant:"ghost",size:"icon",onClick:x=>_(x,r),title:"Delete Invoice",children:e.jsx(me,{className:"h-4 w-4 text-destructive"})})]})})]},r.id)})})]})})})]}),e.jsx(We,{open:s,onOpenChange:c,invoice:P,onClose:f,onSuccess:E}),e.jsx(Ne,{open:!!d,onOpenChange:r=>!r&&n(null),title:`Delete invoice ${d==null?void 0:d.invoiceNumber}?`,description:"This will permanently delete this invoice. This action cannot be undone.",onConfirm:de})]})}export{bt as InvoicesPage};
