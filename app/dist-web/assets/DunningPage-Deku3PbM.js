import{j as e,r as d}from"./vendor-react-wuMqdllU.js";import{C as f,c as j}from"./card-BOU-q13f.js";import{B as u,i as N,a as k,L as A,I as V,k as T}from"./index-BJ9hpEov.js";import{T as J,a as q,b as W,c as H}from"./tabs-EeWm2cFj.js";import{b as L}from"./bankingService-C9qt3mZe.js";import{e as S,aC as Z,a5 as $,x as Q,a8 as X,A as Y,o as ee,ae as se,j as te,a$ as P}from"./vendor-icons-ssgfUAX_.js";import{D as ne,a as ae,b as re,c as le,d as ie}from"./dialog-BPcAFwmD.js";import{T as ce}from"./textarea-D5YM9rKe.js";import"./vendor-markdown-C3iCDuOK.js";import"./vendor-recharts-tRgwS7-V.js";import"./vendor-radix-DqeMb71O.js";import"./vendor-floating-ui-BD6aHMKr.js";import"./vendor-router-Cm8Qzw9U.js";const I={0:{label:"Erinnern",shortLabel:"Erinnern",color:"bg-yellow-100 text-yellow-800 border-yellow-200",icon:$},1:{label:"1. Mahnung",shortLabel:"1. Mahn.",color:"bg-orange-100 text-orange-800 border-orange-200",icon:Z},2:{label:"2. Mahnung",shortLabel:"2. Mahn.",color:"bg-red-100 text-red-800 border-red-200",icon:S},3:{label:"Max. Stufe",shortLabel:"Max.",color:"bg-red-200 text-red-900 border-red-300",icon:S}};function de({dunningLevel:t,onClick:p,disabled:n,size:D="sm",className:M}){const l=I[t]||I[0],m=Math.min(t+1,3),x=I[m]||I[3],o=t>=3,h=l.icon;return o?e.jsxs(u,{className:N(l.color,M),variant:"outline",children:[e.jsx(S,{className:"h-3 w-3 mr-1"}),"Max. Mahnstufe"]}):e.jsxs(k,{variant:"outline",size:D,className:N("gap-1.5",M),onClick:w=>{w.stopPropagation(),p()},disabled:n,children:[e.jsx(h,{className:"h-3.5 w-3.5"}),t===0?"Erinnern":`${x.shortLabel} senden`,t>0&&e.jsxs(u,{className:N(l.color,"text-[9px] h-4 px-1"),variant:"outline",children:["Stufe ",t]})]})}const y={1:{subject:"Zahlungserinnerung",body:`Sehr geehrte Damen und Herren,

wir m√∂chten Sie freundlich daran erinnern, dass die Rechnung {invoice_number} √ºber {amount} am {due_date} f√§llig war.

Bitte √ºberweisen Sie den ausstehenden Betrag innerhalb der n√§chsten 7 Tage auf unser Konto.

Sollten Sie die Zahlung bereits veranlasst haben, betrachten Sie dieses Schreiben als gegenstandslos.

Mit freundlichen Gr√º√üen`,suggestedFee:0,suggestedInterest:0},2:{subject:"1. Mahnung",body:`Sehr geehrte Damen und Herren,

trotz unserer Zahlungserinnerung ist die Rechnung {invoice_number} √ºber {amount} (f√§llig am {due_date}) weiterhin offen.

Wir bitten Sie dringend, den Betrag zuz√ºglich eventueller Mahngeb√ºhren innerhalb von 7 Tagen zu begleichen.

Bei Fragen wenden Sie sich bitte an uns.

Mit freundlichen Gr√º√üen`,suggestedFee:5,suggestedInterest:0},3:{subject:"2. Mahnung (letzte Aufforderung)",body:`Sehr geehrte Damen und Herren,

die Rechnung {invoice_number} √ºber {amount} (f√§llig am {due_date}) ist trotz wiederholter Aufforderung weiterhin nicht bezahlt.

Wir fordern Sie hiermit letztmalig auf, den Gesamtbetrag einschlie√ülich aller Mahngeb√ºhren und Verzugszinsen innerhalb von 5 Werktagen zu √ºberweisen.

Sollte die Zahlung nicht fristgem√§√ü eingehen, sehen wir uns gezwungen, weitere rechtliche Schritte einzuleiten.

Mit freundlichen Gr√º√üen`,suggestedFee:10,suggestedInterest:5}};function b(t){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(t)}function oe(t){return Math.ceil((Date.now()-new Date(t).getTime())/(1e3*60*60*24))}const B=[{title:"Mahnstufe",description:"W√§hlen Sie die Erinnerungsstufe"},{title:"Vorschau",description:"Text pr√ºfen und anpassen"},{title:"Geb√ºhren",description:"Mahngeb√ºhren und Zinsen"},{title:"Absenden",description:"Versand best√§tigen"}];function ue({open:t,onOpenChange:p,invoice:n,onCreateDunning:D,onSendDunning:M}){var K;const[l,m]=d.useState(0),[x,o]=d.useState(!1),[h,w]=d.useState(1),[_,C]=d.useState(""),[v,s]=d.useState(0),[r,c]=d.useState(0);if(d.useEffect(()=>{if(t&&n){const a=Math.min((n.dunning_level||0)+1,3);w(a),m(0);const i=y[a]||y[1],g=i.body.replace("{invoice_number}",n.invoice_number).replace("{amount}",b(n.total)).replace("{due_date}",new Date(n.due_date).toLocaleDateString("de-DE"));C(g),s(i.suggestedFee),c(i.suggestedInterest)}},[t,n]),!n)return null;const E=oe(n.due_date),R=r>0?Math.round(n.total*r/100/365*E*100)/100:0,G=n.total+v+R,O=async()=>{o(!0);try{await D({invoice_id:n.id,level:h,fee:v,interest_rate:r,notes:_}),p(!1)}catch{}finally{o(!1)}},U=a=>{w(a);const i=y[a]||y[1],g=i.body.replace("{invoice_number}",n.invoice_number).replace("{amount}",b(n.total)).replace("{due_date}",new Date(n.due_date).toLocaleDateString("de-DE"));C(g),s(i.suggestedFee),c(i.suggestedInterest)};return e.jsx(ne,{open:t,onOpenChange:p,children:e.jsxs(ae,{className:"w-[calc(100vw-1rem)] max-w-[560px] max-h-[90vh] overflow-y-auto",children:[e.jsxs(re,{children:[e.jsxs(le,{className:"flex items-center gap-2",children:[e.jsx(S,{className:"h-5 w-5 text-orange-500"}),"Mahnung erstellen"]}),e.jsxs(ie,{children:[n.invoice_number," ‚Äî ",n.client_name||"Kein Kunde"," ‚Äî"," ",E," Tage √ºberf√§llig"]})]}),e.jsx("div",{className:"flex items-center gap-2 mb-2",children:B.map((a,i)=>e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsx("div",{className:N("flex items-center justify-center w-6 h-6 rounded-full text-[10px] font-medium",i<l?"bg-green-100 text-green-700":i===l?"bg-primary text-primary-foreground":"bg-muted text-muted-foreground"),children:i<l?e.jsx(Q,{className:"h-3.5 w-3.5"}):i+1}),i<B.length-1&&e.jsx("div",{className:N("flex-1 h-0.5 rounded",i<l?"bg-green-300":"bg-muted")})]},i))}),l===0&&e.jsx("div",{className:"space-y-3",children:[1,2,3].map(a=>{const i=y[a],g=a<=(n.dunning_level||0);return e.jsxs("button",{type:"button",className:N("w-full p-4 rounded-lg border text-left transition-colors",h===a?"border-primary bg-primary/5 ring-1 ring-primary":g?"opacity-40 cursor-not-allowed":"hover:bg-muted/50"),onClick:()=>!g&&U(a),disabled:g,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(u,{variant:"outline",className:N(a===1&&"border-yellow-300 text-yellow-700",a===2&&"border-orange-300 text-orange-700",a===3&&"border-red-300 text-red-700"),children:["Stufe ",a]}),e.jsx("span",{className:"font-medium",children:i.subject})]}),g&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"Bereits gesendet"})]}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Geb√ºhr: ",b(i.suggestedFee)," | Zinsen:"," ",i.suggestedInterest,"%"]})]},a)})}),l===1&&e.jsx("div",{className:"space-y-3",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{children:"Mahntext (bearbeitbar)"}),e.jsx(ce,{value:_,onChange:a=>C(a.target.value),rows:10,className:"text-sm font-mono"})]})}),l===2&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded-lg border bg-muted/30 p-4 space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Rechnungsbetrag"}),e.jsx("span",{className:"font-medium",children:b(n.total)})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Mahngeb√ºhr"}),e.jsx("span",{className:"font-medium",children:b(v)})]}),R>0&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{children:["Verzugszinsen (",r,"% p.a., ",E," Tage)"]}),e.jsx("span",{className:"font-medium",children:b(R)})]}),e.jsxs("div",{className:"flex justify-between text-sm border-t pt-2 font-bold",children:[e.jsx("span",{children:"Gesamtforderung"}),e.jsx("span",{children:b(G)})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{children:"Mahngeb√ºhr (‚Ç¨)"}),e.jsx(V,{type:"number",step:"0.01",value:v,onChange:a=>s(Number(a.target.value))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{children:"Verzugszinsen (%/Jahr)"}),e.jsx(V,{type:"number",step:"0.1",value:r,onChange:a=>c(Number(a.target.value))})]})]})]}),l===3&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded-lg border bg-muted/30 p-4 space-y-3",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Rechnung"}),e.jsx("span",{className:"font-medium",children:n.invoice_number})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Kunde"}),e.jsx("span",{children:n.client_name||"‚Äî"})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Stufe"}),e.jsx(u,{variant:"outline",children:((K=y[h])==null?void 0:K.subject)||`Stufe ${h}`})]}),e.jsxs("div",{className:"flex justify-between text-sm border-t pt-2 font-bold",children:[e.jsx("span",{children:"Gesamtforderung"}),e.jsx("span",{children:b(G)})]})]}),e.jsx("div",{className:"text-sm text-muted-foreground text-center",children:"Die Mahnung wird als Entwurf gespeichert. Sie k√∂nnen sie anschlie√üend per E-Mail versenden oder als PDF herunterladen."})]}),e.jsxs("div",{className:"flex justify-between pt-2",children:[e.jsx(k,{variant:"outline",onClick:l===0?()=>p(!1):()=>m(l-1),disabled:x,children:l===0?"Abbrechen":e.jsxs(e.Fragment,{children:[e.jsx(X,{className:"h-4 w-4 mr-2"}),"Zur√ºck"]})}),l<B.length-1?e.jsxs(k,{onClick:()=>m(l+1),children:["Weiter",e.jsx(Y,{className:"h-4 w-4 ml-2"})]}):e.jsxs(k,{onClick:O,disabled:x,children:[x?e.jsx(ee,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(Z,{className:"h-4 w-4 mr-2"}),"Mahnung erstellen"]})]})]})})}const F=t=>new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(t),me=t=>new Date(t).toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"}),z={0:{label:"Keine Mahnung",color:"bg-gray-100 text-gray-800"},1:{label:"Zahlungserinnerung",color:"bg-yellow-100 text-yellow-800"},2:{label:"1. Mahnung",color:"bg-orange-100 text-orange-800"},3:{label:"2. Mahnung",color:"bg-red-100 text-red-800"}};function Me(){const[t,p]=d.useState([]),[n,D]=d.useState([]),[M,l]=d.useState(!0),[m,x]=d.useState(null),o=d.useCallback(async()=>{try{const[s,r]=await Promise.all([L.getOverdueInvoices(),L.getDunningEntries()]);p(s),D(r)}catch{T.error("Fehler beim Laden")}finally{l(!1)}},[]);d.useEffect(()=>{o()},[o]);const h=async s=>{var r;try{await L.createDunning(s),T.success(`${((r=z[s.level])==null?void 0:r.label)||"Mahnung"} erstellt`),o()}catch(c){const E=c instanceof Error?c.message:"Fehler beim Erstellen";throw T.error(E),c}},w=async s=>{try{await L.sendDunning(s),T.success("Als versendet markiert"),o()}catch{T.error("Fehler")}},_=s=>Math.ceil((Date.now()-new Date(s).getTime())/(1e3*60*60*24)),C=t.reduce((s,r)=>s+r.total,0),v=t.length>0?Math.round(t.reduce((s,r)=>s+_(r.due_date),0)/t.length):0;return M?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(se,{className:"h-6 w-6 animate-spin"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Mahnwesen"}),e.jsx("p",{className:"text-muted-foreground",children:"√úberf√§llige Rechnungen & Zahlungserinnerungen"})]}),e.jsxs("div",{className:"grid gap-4 grid-cols-2 lg:grid-cols-4",children:[e.jsx(f,{children:e.jsxs(j,{className:"pt-4 pb-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-xs text-muted-foreground font-medium uppercase tracking-wider",children:"√úberf√§llig"}),e.jsx(S,{className:"h-4 w-4 text-orange-500"})]}),e.jsx("p",{className:"text-2xl font-bold text-red-600",children:t.length}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"offene Rechnungen"})]})}),e.jsx(f,{children:e.jsxs(j,{className:"pt-4 pb-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-xs text-muted-foreground font-medium uppercase tracking-wider",children:"Betrag"}),e.jsx(te,{className:"h-4 w-4 text-red-500"})]}),e.jsx("p",{className:"text-2xl font-bold text-red-600",children:F(C)}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"ausstehend"})]})}),e.jsx(f,{children:e.jsxs(j,{className:"pt-4 pb-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-xs text-muted-foreground font-medium uppercase tracking-wider",children:"√ò √úberf√§llig"}),e.jsx($,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs("p",{className:"text-2xl font-bold",children:[v," Tage"]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Durchschnitt"})]})}),e.jsx(f,{children:e.jsxs(j,{className:"pt-4 pb-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-xs text-muted-foreground font-medium uppercase tracking-wider",children:"Mahnungen"}),e.jsx(P,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx("p",{className:"text-2xl font-bold",children:n.length}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"gesamt erstellt"})]})})]}),e.jsxs(J,{defaultValue:"overdue",className:"w-full",children:[e.jsxs(q,{children:[e.jsxs(W,{value:"overdue",className:"flex items-center gap-1.5",children:[e.jsx(S,{className:"h-4 w-4"}),"√úberf√§llig",t.length>0&&e.jsx(u,{variant:"destructive",className:"h-5 text-[10px] ml-1",children:t.length})]}),e.jsxs(W,{value:"history",className:"flex items-center gap-1.5",children:[e.jsx(P,{className:"h-4 w-4"}),"Verlauf"]})]}),e.jsx(H,{value:"overdue",className:"mt-4",children:t.length===0?e.jsx(f,{children:e.jsx(j,{className:"py-12 text-center text-muted-foreground",children:"Keine √ºberf√§lligen Rechnungen üéâ"})}):e.jsx("div",{className:"space-y-2",children:t.map(s=>{var r,c;return e.jsx(f,{children:e.jsx(j,{className:"py-3",children:e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-2",children:[e.jsxs("div",{className:"flex items-center gap-4 flex-1 min-w-0",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.invoice_number}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.client_name||"Kein Kunde"})]}),e.jsxs(u,{variant:"destructive",children:[_(s.due_date)," Tage"]}),s.dunning_level>0&&e.jsx(u,{className:(r=z[s.dunning_level])==null?void 0:r.color,variant:"outline",children:(c=z[s.dunning_level])==null?void 0:c.label})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"font-mono font-medium",children:F(s.total)}),e.jsx(de,{dunningLevel:s.dunning_level,onClick:()=>x(s)})]})]})})},s.id)})})}),e.jsx(H,{value:"history",className:"mt-4",children:n.length===0?e.jsx(f,{children:e.jsx(j,{className:"py-12 text-center text-muted-foreground",children:"Noch keine Mahnungen erstellt."})}):e.jsx("div",{className:"space-y-2",children:n.map(s=>{var r,c;return e.jsx(f,{children:e.jsx(j,{className:"py-3",children:e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(u,{className:(r=z[s.level])==null?void 0:r.color,variant:"outline",children:(c=z[s.level])==null?void 0:c.label}),e.jsx("span",{className:"text-sm font-medium",children:s.invoice_number}),s.fee>0&&e.jsxs("span",{className:"text-sm text-muted-foreground",children:["Geb√ºhr: ",F(s.fee)]}),s.interest_amount>0&&e.jsxs("span",{className:"text-sm text-muted-foreground",children:["Zinsen: ",F(s.interest_amount)]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(u,{variant:s.status==="sent"?"default":"secondary",children:s.status==="sent"?"Versendet":"Entwurf"}),s.sent_date&&e.jsx("span",{className:"text-xs text-muted-foreground",children:me(s.sent_date)}),s.status==="draft"&&e.jsxs(k,{size:"sm",variant:"outline",onClick:()=>w(s.id),children:[e.jsx(Z,{className:"h-4 w-4 mr-1"}),"Senden"]})]})]})})},s.id)})})})]}),e.jsx(ue,{open:!!m,onOpenChange:s=>!s&&x(null),invoice:m,onCreateDunning:h})]})}export{Me as DunningPage};
