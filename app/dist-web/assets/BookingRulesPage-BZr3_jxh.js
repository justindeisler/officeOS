import{j as e,r as n}from"./vendor-react-wuMqdllU.js";import{i as te,a as _,B as h,L as r,I as p,k as x}from"./index-BJ9hpEov.js";import{C as se,c as ne}from"./card-BOU-q13f.js";import{S as ie}from"./switch-BGK1s4qN.js";import{o as H,t as ae,Z as ce,aZ as de,G as me,a_ as xe}from"./vendor-icons-ssgfUAX_.js";import{D as he,a as ue,b as ge,c as pe,d as je}from"./dialog-BPcAFwmD.js";import{S as R,a as B,b as E,c as D,d as o}from"./select-DW4QIkWb.js";import{E as fe}from"./index-FI6coOPr.js";import{b as N}from"./bankingService-C9qt3mZe.js";import"./vendor-markdown-C3iCDuOK.js";import"./vendor-recharts-tRgwS7-V.js";import"./vendor-radix-DqeMb71O.js";import"./vendor-floating-ui-BD6aHMKr.js";import"./vendor-router-Cm8Qzw9U.js";function ve(i){return i==="credit"?"Eingang":i==="debit"?"Ausgang":"Alle"}function Ne(i){return i?{expense:"Ausgabe",income:"Einnahme",ignore:"Ignorieren"}[i]||i:"—"}function _e({rules:i,isLoading:u,onCreateRule:a,onEditRule:y,onDeleteRule:g,onToggleActive:m,className:d}){return u?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(H,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):e.jsxs("div",{className:te("space-y-4",d),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Buchungsregeln"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[i.length," ",i.length===1?"Regel":"Regeln"," konfiguriert"]})]}),e.jsxs(_,{onClick:a,children:[e.jsx(ae,{className:"h-4 w-4 mr-2"}),"Neue Regel"]})]}),i.length===0?e.jsx(se,{children:e.jsxs(ne,{className:"py-12 text-center text-muted-foreground",children:[e.jsx(ce,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"Keine Buchungsregeln konfiguriert."}),e.jsx("p",{className:"text-sm mt-1",children:"Erstellen Sie Regeln, um Bankumsätze automatisch zu kategorisieren."}),e.jsxs(_,{onClick:a,className:"mt-4",children:[e.jsx(ae,{className:"h-4 w-4 mr-2"}),"Erste Regel erstellen"]})]})}):e.jsx("div",{className:"space-y-2",children:i.sort((t,l)=>t.priority-l.priority).map(t=>e.jsx(se,{className:te("transition-opacity",!t.is_active&&"opacity-50"),children:e.jsx(ne,{className:"py-3",children:e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4 flex-1 min-w-0",children:[e.jsxs("div",{className:"text-center w-12 flex-shrink-0",children:[e.jsx("div",{className:"text-[10px] text-muted-foreground uppercase tracking-wider",children:"Prio"}),e.jsx("div",{className:"font-mono font-bold text-lg",children:t.priority})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"font-medium truncate",children:t.name}),e.jsxs("div",{className:"flex flex-wrap items-center gap-1.5 mt-1",children:[t.condition_direction&&e.jsx(h,{variant:"outline",className:"text-[10px]",children:ve(t.condition_direction)}),t.condition_counterpart_pattern&&e.jsxs(h,{variant:"outline",className:"text-[10px]",children:["Auftraggeber: ",t.condition_counterpart_pattern]}),t.condition_purpose_pattern&&e.jsxs(h,{variant:"outline",className:"text-[10px]",children:["Zweck: ",t.condition_purpose_pattern]}),(t.condition_amount_min!==null||t.condition_amount_max!==null)&&e.jsxs(h,{variant:"outline",className:"text-[10px]",children:[t.condition_amount_min!==null?`€${t.condition_amount_min}`:"€0"," ","–"," ",t.condition_amount_max!==null?`€${t.condition_amount_max}`:"∞"]}),t.action_category&&e.jsxs(h,{className:"text-[10px]",children:["→ ",t.action_category]}),e.jsx(h,{variant:"secondary",className:"text-[10px]",children:Ne(t.action_match_type)}),e.jsxs("span",{className:"text-[10px] text-muted-foreground",children:[t.match_count," Treffer"]}),t.action_auto_confirm===1&&e.jsx(h,{variant:"outline",className:"text-[10px] border-green-300 text-green-700",children:"Auto-Buchen"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[e.jsx(ie,{checked:!!t.is_active,onCheckedChange:()=>m(t),"aria-label":t.is_active?"Deaktivieren":"Aktivieren"}),e.jsx(_,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>y(t),title:"Bearbeiten",children:e.jsx(de,{className:"h-4 w-4 text-muted-foreground"})}),e.jsx(_,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>g(t.id),title:"Löschen",children:e.jsx(me,{className:"h-4 w-4 text-red-500"})})]})]})})},t.id))})]})}function ye({open:i,onOpenChange:u,rule:a,onSave:y,onTest:g}){const m=!!a,[d,t]=n.useState(""),[l,b]=n.useState(100),[j,S]=n.useState(""),[f,C]=n.useState(""),[v,c]=n.useState(""),[w,T]=n.useState(""),[k,z]=n.useState(""),[F,L]=n.useState(""),[$,M]=n.useState(19),[P,I]=n.useState(""),[V,Z]=n.useState("expense"),[q,K]=n.useState(!1),[X,J]=n.useState(!1),[Q,U]=n.useState(!1),[O,G]=n.useState(null),[A,W]=n.useState({});n.useEffect(()=>{i&&a?(t(a.name),b(a.priority),S(a.condition_direction||""),C(a.condition_counterpart_pattern||""),c(a.condition_purpose_pattern||""),T(a.condition_amount_min!==null?String(a.condition_amount_min):""),z(a.condition_amount_max!==null?String(a.condition_amount_max):""),L(a.action_category||""),M(a.action_vat_rate??19),I(a.action_description_template||""),Z(a.action_match_type||"expense"),K(a.action_auto_confirm===1)):i&&(t(""),b(100),S(""),C(""),c(""),T(""),z(""),L(""),M(19),I(""),Z("expense"),K(!1)),G(null),W({})},[i,a]);const Y=()=>{const s={name:d,priority:l,action_vat_rate:$,action_match_type:V,action_auto_confirm:q?1:0};return j&&(s.condition_direction=j),f&&(s.condition_counterpart_pattern=f),v&&(s.condition_purpose_pattern=v),w&&(s.condition_amount_min=parseFloat(w)),k&&(s.condition_amount_max=parseFloat(k)),F&&(s.action_category=F),P&&(s.action_description_template=P),s},re=()=>{const s={};return d.trim()||(s.name="Name ist erforderlich"),j||f||v||w||k||(s.conditions="Mindestens eine Bedingung erforderlich"),W(s),Object.keys(s).length===0},le=async()=>{if(re()){J(!0);try{await y(Y()),u(!1)}catch{}finally{J(!1)}}},oe=async()=>{if(g){U(!0),G(null);try{const s=await g(Y());G(s)}catch{}finally{U(!1)}}};return e.jsx(he,{open:i,onOpenChange:u,children:e.jsxs(ue,{className:"w-[calc(100vw-1rem)] max-w-[560px] max-h-[90vh] overflow-y-auto",children:[e.jsxs(ge,{children:[e.jsx(pe,{children:m?"Regel bearbeiten":"Neue Buchungsregel"}),e.jsx(je,{children:"Definieren Sie Bedingungen und Aktionen für die automatische Zuordnung."})]}),e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"ruleName",children:"Name *"}),e.jsx(p,{id:"ruleName",value:d,onChange:s=>t(s.target.value),placeholder:"z.B. Netflix Abo",autoFocus:!0}),A.name&&e.jsx("p",{className:"text-xs text-destructive",children:A.name})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"priority",children:"Priorität (kleiner = höher)"}),e.jsx(p,{id:"priority",type:"number",value:l,onChange:s=>b(Number(s.target.value)),min:1})]})]}),e.jsxs("div",{className:"rounded-lg border p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h4",{className:"font-medium text-sm",children:"Bedingungen"}),A.conditions&&e.jsx(h,{variant:"destructive",className:"text-[10px]",children:A.conditions})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{className:"text-xs",children:"Richtung"}),e.jsxs(R,{value:j,onValueChange:S,children:[e.jsx(B,{children:e.jsx(E,{placeholder:"Alle Richtungen"})}),e.jsxs(D,{children:[e.jsx(o,{value:"all_directions",children:"Alle"}),e.jsx(o,{value:"credit",children:"Eingang (Haben)"}),e.jsx(o,{value:"debit",children:"Ausgang (Soll)"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{className:"text-xs",children:"Auftraggeber enthält"}),e.jsx(p,{value:f,onChange:s=>C(s.target.value),placeholder:"z.B. Netflix, Amazon"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{className:"text-xs",children:"Verwendungszweck enthält"}),e.jsx(p,{value:v,onChange:s=>c(s.target.value),placeholder:"z.B. Mitgliedschaft, Rechnung"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{className:"text-xs",children:"Betrag min (€)"}),e.jsx(p,{type:"number",step:"0.01",value:w,onChange:s=>T(s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{className:"text-xs",children:"Betrag max (€)"}),e.jsx(p,{type:"number",step:"0.01",value:k,onChange:s=>z(s.target.value)})]})]})]}),e.jsxs("div",{className:"rounded-lg border p-4 space-y-3",children:[e.jsx("h4",{className:"font-medium text-sm",children:"Aktionen"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{className:"text-xs",children:"Typ"}),e.jsxs(R,{value:V,onValueChange:Z,children:[e.jsx(B,{children:e.jsx(E,{})}),e.jsxs(D,{children:[e.jsx(o,{value:"expense",children:"Ausgabe erstellen"}),e.jsx(o,{value:"income",children:"Einnahme erstellen"}),e.jsx(o,{value:"ignore",children:"Ignorieren"})]})]})]}),V!=="ignore"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{className:"text-xs",children:"Kategorie"}),e.jsxs(R,{value:F,onValueChange:L,children:[e.jsx(B,{children:e.jsx(E,{placeholder:"Kategorie wählen"})}),e.jsx(D,{children:Object.entries(fe).map(([s,ee])=>e.jsx(o,{value:s,children:ee.label},s))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{className:"text-xs",children:"MwSt-Satz"}),e.jsxs(R,{value:String($),onValueChange:s=>M(Number(s)),children:[e.jsx(B,{children:e.jsx(E,{})}),e.jsxs(D,{children:[e.jsx(o,{value:"19",children:"19%"}),e.jsx(o,{value:"7",children:"7%"}),e.jsx(o,{value:"0",children:"0%"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(r,{className:"text-xs",children:["Beschreibungsvorlage"," ",e.jsx("span",{className:"text-muted-foreground",children:"(optional)"})]}),e.jsx(p,{value:P,onChange:s=>I(s.target.value),placeholder:"z.B. {counterpart} - {purpose}"})]})]}),e.jsxs("div",{className:"flex items-center gap-3 pt-1",children:[e.jsx(ie,{checked:q,onCheckedChange:K,id:"autoConfirm"}),e.jsx(r,{htmlFor:"autoConfirm",className:"text-sm cursor-pointer",children:"Automatisch buchen (ohne Bestätigung)"})]})]}),O&&e.jsxs("div",{className:"rounded-lg bg-blue-50 dark:bg-blue-950/30 text-blue-800 dark:text-blue-200 p-3 text-sm",children:[e.jsx("strong",{children:O.would_match})," von"," ",O.total_unmatched," offenen Transaktionen würden matchen."]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[g&&e.jsxs(_,{variant:"outline",onClick:oe,disabled:Q,className:"flex-1",children:[Q?e.jsx(H,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(xe,{className:"h-4 w-4 mr-2"}),"Testen"]}),e.jsxs(_,{onClick:le,disabled:X,className:"flex-1",children:[X?e.jsx(H,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(ce,{className:"h-4 w-4 mr-2"}),m?"Speichern":"Erstellen"]})]})]})]})})}function Me(){const[i,u]=n.useState([]),[a,y]=n.useState(!0),[g,m]=n.useState(!1),[d,t]=n.useState(null),l=n.useCallback(async()=>{try{u(await N.getRules())}catch{x.error("Fehler beim Laden der Buchungsregeln")}finally{y(!1)}},[]);n.useEffect(()=>{l()},[l]);const b=()=>{t(null),m(!0)},j=c=>{t(c),m(!0)},S=async c=>{try{d?(await N.updateRule(d.id,c),x.success("Regel aktualisiert")):(await N.createRule(c),x.success("Regel erstellt")),l()}catch{throw x.error("Fehler beim Speichern"),new Error("save failed")}},f=async c=>{try{await N.deleteRule(c),x.success("Regel gelöscht"),l()}catch{x.error("Fehler beim Löschen")}},C=async c=>{try{await N.updateRule(c.id,{is_active:c.is_active?0:1}),x.success(c.is_active?"Deaktiviert":"Aktiviert"),l()}catch{x.error("Fehler")}},v=async c=>N.testRule(c);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Buchungsregeln"}),e.jsx("p",{className:"text-muted-foreground",children:"Automatische Kategorisierung von Bankumsätzen"})]}),e.jsx(_e,{rules:i,isLoading:a,onCreateRule:b,onEditRule:j,onDeleteRule:f,onToggleActive:C}),e.jsx(ye,{open:g,onOpenChange:m,rule:d,onSave:S,onTest:v})]})}export{Me as BookingRulesPage};
