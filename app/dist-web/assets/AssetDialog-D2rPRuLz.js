import{r as i,j as e}from"./vendor-react-DeR5d9Tv.js";import{D as le,a as ne}from"./dialog-FtNsGa4T.js";import{u as ce,a as oe,o as de,s as O,e as X,n as ue}from"./vendor-forms-slL2B-gN.js";import{A as me,G as _}from"./index-uXN-dP3D.js";import{j as B,F as ae,s as z,V as se,a as H,L as C,I as M,B as he,n as re}from"./index-B9wpeZVf.js";import{S as J,a as K,b as Q,c as Z,d as q}from"./select-BY8eQiQN.js";import{a as R,g as fe,b as pe,c as ge,d as xe,e as ve,f as ye,u as je,h as be,i as Ne,j as Ae,k as we,l as Pe}from"./assets-DTNv2ysQ.js";import{m as G,A as ee}from"./vendor-framer-motion-5hIM_3P7.js";import{U as De}from"./upload-Ddt_p2-Y.js";import{C as Fe}from"./circle-alert-DR10Pc3C.js";import{A as Ce,a as Se,b as Ie,c as Ee,d as ke,e as Re,f as Be,g as Te,h as Oe}from"./alert-dialog-83Lj5Hrs.js";import{E as Me}from"./external-link-DW0qQmWJ.js";import{T as Ge}from"./trash-2-BAQCKdVR.js";import{I as Le}from"./info-D7pY16WJ.js";function $e({accept:t="PDF",maxSize:D=10*1024*1024,onFileSelect:N,onError:p,disabled:o=!1,className:g}){const[x,n]=i.useState(!1),[y,l]=i.useState(!1),[d,u]=i.useState(null),h=i.useCallback(async()=>{if(!(o||y)){l(!0),u(null);try{const m=await R.pickBillFile();if(m){const F=R.validateFile(m.name);if(!F.valid){const A=F.error||"Invalid file";u(A),p==null||p(A);return}N(m)}}catch(m){const F=m instanceof Error?m.message:"Failed to select file";u(F),p==null||p(F)}finally{l(!1)}}},[o,y,N,p]),I=i.useCallback(m=>{m.preventDefault(),m.stopPropagation(),o||n(!0)},[o]),E=i.useCallback(m=>{m.preventDefault(),m.stopPropagation(),n(!1)},[]),b=i.useCallback(m=>{m.preventDefault(),m.stopPropagation()},[]),k=i.useCallback(m=>{m.preventDefault(),m.stopPropagation(),n(!1),o||h()},[o,h]);return e.jsxs("div",{className:B("relative",g),children:[e.jsx(G.button,{type:"button",onClick:h,onDragEnter:I,onDragLeave:E,onDragOver:b,onDrop:k,disabled:o||y,className:B("w-full rounded-lg border-2 border-dashed p-6","flex flex-col items-center justify-center gap-2","transition-all duration-200 ease-out","focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",x?"border-primary bg-primary/5":"border-muted-foreground/25 hover:border-muted-foreground/50 hover:bg-muted/50",o&&"cursor-not-allowed opacity-50",d&&"border-destructive/50"),animate:{scale:x?1.02:1},transition:{duration:.2,ease:[.16,1,.3,1]},children:e.jsx(ee,{mode:"wait",children:y?e.jsxs(G.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},className:"flex flex-col items-center gap-2",children:[e.jsx("div",{className:"h-10 w-10 animate-pulse rounded-full bg-muted"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"Opening file picker..."})]},"loading"):e.jsxs(G.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"flex flex-col items-center gap-2",children:[e.jsx(G.div,{animate:{y:x?-4:0},transition:{duration:.2,ease:[.16,1,.3,1]},children:x?e.jsx(ae,{className:"h-10 w-10 text-primary"}):e.jsx(De,{className:"h-10 w-10 text-muted-foreground"})}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm font-medium",children:x?"Drop to upload":"Click to attach bill"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[t," files only (max ",Math.round(D/1024/1024),"MB)"]})]})]},"idle")})}),e.jsx(ee,{children:d&&e.jsxs(G.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"mt-2 flex items-center gap-1.5 text-sm text-destructive",children:[e.jsx(Fe,{className:"h-4 w-4"}),e.jsx("span",{children:d})]})})]})}function te({filePath:t,fileName:D,onRemove:N,disabled:p=!1,className:o}){const[g,x]=i.useState(null),[n,y]=i.useState(!0),[l,d]=i.useState(!1),[u,h]=i.useState(null);i.useEffect(()=>{async function b(){y(!0),h(null);try{const k=await R.getAttachmentInfo(t);x(k),k&&!k.exists&&h("File not found")}catch{h("Failed to load file info")}finally{y(!1)}}b()},[t]);const I=async()=>{if(!(p||l)){d(!0),h(null);try{await R.openAttachment(t)}catch(b){h(b instanceof Error?b.message:"Failed to open file")}finally{d(!1)}}},E=D||(g==null?void 0:g.name)||"Attached file";return n?e.jsxs("div",{className:B("flex items-center gap-3 rounded-lg border p-3",o),children:[e.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded bg-muted",children:e.jsx(z,{className:"h-5 w-5 animate-spin text-muted-foreground"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"h-4 w-32 animate-pulse rounded bg-muted"}),e.jsx("div",{className:"mt-1 h-3 w-20 animate-pulse rounded bg-muted"})]})]}):e.jsxs(G.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.2,ease:[.16,1,.3,1]},className:B("flex items-center gap-3 rounded-lg border p-3",u&&"border-destructive/50 bg-destructive/5",o),children:[e.jsx("div",{className:B("flex h-10 w-10 items-center justify-center rounded",u?"bg-destructive/10":"bg-primary/10"),children:e.jsx(ae,{className:B("h-5 w-5",u?"text-destructive":"text-primary")})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"truncate text-sm font-medium",children:E}),u?e.jsx("p",{className:"text-xs text-destructive",children:se(u)}):e.jsx("p",{className:"text-xs text-muted-foreground",children:"PDF Document"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(H,{type:"button",variant:"ghost",size:"icon",onClick:I,disabled:p||l||!!u,title:"Open in PDF viewer",children:l?e.jsx(z,{className:"h-4 w-4 animate-spin"}):e.jsx(Me,{className:"h-4 w-4"})}),e.jsxs(Ce,{children:[e.jsx(Se,{asChild:!0,children:e.jsx(H,{type:"button",variant:"ghost",size:"icon",disabled:p,title:"Remove attachment",className:"text-destructive hover:text-destructive hover:bg-destructive/10",children:e.jsx(Ge,{className:"h-4 w-4"})})}),e.jsxs(Ie,{children:[e.jsxs(Ee,{children:[e.jsx(ke,{children:"Remove attachment?"}),e.jsx(Re,{children:"This will remove the attached bill from this asset. The file will be deleted when you save."})]}),e.jsxs(Be,{children:[e.jsx(Te,{children:"Cancel"}),e.jsx(Oe,{onClick:N,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Remove"})]})]})]})]})]})}const Ve=de({name:O().min(1,"Name is required"),description:O().optional(),purchaseDate:O().min(1,"Purchase date is required"),vendor:O().optional(),purchasePrice:ue().positive("Amount must be positive"),vatRate:X(["0","7","19"]),category:X(["computer","phone","furniture","equipment","software"]),location:O().optional(),inventoryNumber:O().optional()});function Y(t){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(t)}const Ye=[{value:"computer",label:"Computer (3 years)"},{value:"phone",label:"Phone (5 years)"},{value:"furniture",label:"Furniture (13 years)"},{value:"equipment",label:"Equipment (5 years)"},{value:"software",label:"Software (3 years)"}];function We(t){return t<=0?null:t<=_.SOFORTABSCHREIBUNG?"immediate":t<=_.GWG_MAX?"gwg":t<=_.POOL_MAX?"pool":"afa"}function Ue(t){return t>0&&t<=_.GWG_MAX}function qe(t){switch(t){case"immediate":return{label:"Immediate Write-off",description:"≤€250: Full expense in year of purchase",variant:"default"};case"gwg":return{label:"Immediate Write-off",description:"≤€800 (GWG): Full expense in year of purchase",variant:"default"};case"pool":return{label:"Pool Method",description:"€800-€1000: Pool depreciation (5 years) or regular AfA",variant:"outline"};case"afa":return{label:"Regular AfA",description:">€1000: Standard linear depreciation",variant:"outline"};default:return null}}function _e({asset:t,onSubmit:D,onCancel:N,className:p}){const[o,g]=i.useState(!1),[x,n]=i.useState(null),[y,l]=i.useState(t==null?void 0:t.billPath),[d,u]=i.useState(!1),h=!!t,I=s=>{if(!s||s.purchasePrice<=0)return"19";if(s.vatPaid===0)return"0";const f=Math.round(s.vatPaid/s.purchasePrice*100);return f===7?"7":f===19?"19":"0"},E={name:(t==null?void 0:t.name)??"",description:(t==null?void 0:t.description)??"",purchaseDate:t!=null&&t.purchaseDate?t.purchaseDate.toISOString().split("T")[0]:new Date().toISOString().split("T")[0],vendor:(t==null?void 0:t.vendor)??"",purchasePrice:(t==null?void 0:t.purchasePrice)??0,vatRate:I(t),category:(t==null?void 0:t.category)??"computer",location:(t==null?void 0:t.location)??""},{register:b,handleSubmit:k,watch:m,setValue:F,formState:{errors:A}}=ce({resolver:oe(Ve),defaultValues:E}),W=m("purchasePrice"),L=m("vatRate"),$=m("category"),j=i.useMemo(()=>{const s=Number(W)||0,f=Number(L)||19,v=Math.round(s*(f/100)*100)/100,w=Math.round((s+v)*100)/100,P=Ue(s),U=P?1:me[$]||3,ie=s>0?P?s:Math.round(s/U*100)/100:0;return{net:s,vat:v,gross:w,rate:f,afaYears:U,annualAfa:ie,isImmediate:P}},[W,L,$]),V=i.useMemo(()=>We(j.net),[j.net]),T=qe(V),a=s=>{n(s),u(!1)},r=()=>{x?n(null):y&&(l(void 0),u(!0))},c=async s=>{g(!0);try{let f;x?f=x.path:!d&&y&&(f=y);const v={name:s.name,description:s.description||void 0,purchaseDate:new Date(s.purchaseDate),vendor:s.vendor||void 0,purchasePrice:s.purchasePrice,vatRate:Number(s.vatRate),afaYears:j.afaYears,afaMethod:j.isImmediate?"immediate":void 0,category:s.category,location:s.location||void 0,billPath:f};await D(v)}finally{g(!1)}};return e.jsxs("form",{onSubmit:k(c),className:B("space-y-6",p),children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:h?"Edit Asset":"Add Asset"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:h?"Update the asset record details below.":"Enter the details for the new asset."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"name",children:"Name"}),e.jsx(M,{id:"name",placeholder:'e.g., MacBook Pro 16"',...b("name"),"aria-invalid":!!A.name}),A.name&&e.jsx("p",{className:"text-sm text-destructive",children:A.name.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"description",children:"Description (optional)"}),e.jsx(M,{id:"description",placeholder:"e.g., Development laptop for work",...b("description")})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"purchaseDate",children:"Purchase Date"}),e.jsx(M,{id:"purchaseDate",type:"date",...b("purchaseDate"),"aria-invalid":!!A.purchaseDate}),A.purchaseDate&&e.jsx("p",{className:"text-sm text-destructive",children:A.purchaseDate.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"vendor",children:"Vendor (optional)"}),e.jsx(M,{id:"vendor",placeholder:"e.g., Apple, Amazon",...b("vendor")})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"purchasePrice",children:"Purchase Price (Net, €)"}),e.jsx(M,{id:"purchasePrice",type:"number",step:"0.01",min:"0",placeholder:"0.00",...b("purchasePrice",{valueAsNumber:!0}),"aria-invalid":!!A.purchasePrice}),A.purchasePrice&&e.jsx("p",{className:"text-sm text-destructive",children:A.purchasePrice.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"vatRate",children:"VAT Rate"}),e.jsxs(J,{value:L,onValueChange:s=>F("vatRate",s),children:[e.jsx(K,{id:"vatRate",children:e.jsx(Q,{placeholder:"Select VAT rate"})}),e.jsxs(Z,{children:[e.jsx(q,{value:"19",children:"19%"}),e.jsx(q,{value:"7",children:"7%"}),e.jsx(q,{value:"0",children:"0%"})]})]})]})]}),e.jsxs("div",{className:"rounded-lg bg-muted p-4",children:[e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Net"}),e.jsx("div",{className:"font-medium",children:Y(j.net)})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-muted-foreground",children:["Vorsteuer (",j.rate,"%)"]}),e.jsx("div",{className:"font-medium",children:Y(j.vat)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Gross"}),e.jsx("div",{className:"font-semibold",children:Y(j.gross)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:j.isImmediate?"Write-off":"AfA/Year"}),e.jsx("div",{className:"font-medium",children:j.isImmediate?`${Y(j.annualAfa)} (full)`:`${Y(j.annualAfa)}/year`})]})]}),T&&e.jsxs("div",{className:"mt-3 flex items-start gap-2 text-sm",children:[e.jsx(Le,{className:"h-4 w-4 mt-0.5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx(he,{variant:T.variant,className:"mb-1",children:T.label}),e.jsx("p",{className:"text-muted-foreground",children:T.description})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"category",children:"Category"}),e.jsxs(J,{value:$,onValueChange:s=>F("category",s),children:[e.jsx(K,{id:"category",children:e.jsx(Q,{placeholder:"Select category"})}),e.jsx(Z,{children:Ye.map(s=>e.jsx(q,{value:s.value,children:s.label},s.value))})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:j.isImmediate?"Depreciation: Immediate write-off (GWG)":`Depreciation period: ${j.afaYears} years (linear AfA)`})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"location",children:"Location (optional)"}),e.jsx(M,{id:"location",placeholder:"e.g., Home Office, Büro",...b("location")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{children:"Inventory Number"}),e.jsx("div",{className:"flex h-10 items-center rounded-md border border-input bg-muted px-3 text-sm text-muted-foreground",children:h&&(t!=null&&t.inventoryNumber)?t.inventoryNumber:"Auto-generated on save"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{children:"Bill/Invoice (optional)"}),x?e.jsx(te,{filePath:x.path,fileName:x.name,onRemove:r,disabled:o}):y?e.jsx(te,{filePath:y,onRemove:r,disabled:o}):e.jsx($e,{onFileSelect:a,disabled:o}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Attach a PDF of the purchase invoice or receipt"})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx(H,{type:"button",variant:"outline",onClick:N,children:"Cancel"}),e.jsxs(H,{type:"submit",disabled:o,children:[o&&e.jsx(z,{className:"mr-2 h-4 w-4 animate-spin"}),"Save"]})]})]})}const S=re("useAssets");function He(t={}){const{autoFetch:D=!0,category:N,status:p}=t,[o,g]=i.useState([]),[x,n]=i.useState(!1),[y,l]=i.useState(null),[d,u]=i.useState(null),h=i.useCallback(async()=>{n(!0),l(null);try{const a=await fe();g(a)}catch(a){l(a instanceof Error?a.message:"Failed to fetch assets")}finally{n(!1)}},[]),I=i.useCallback(async a=>{n(!0),l(null);try{const r=await pe(a);g(r)}catch(r){l(r instanceof Error?r.message:"Failed to fetch assets")}finally{n(!1)}},[]),E=i.useCallback(async a=>{n(!0),l(null);try{const r=await ge(a);g(r)}catch(r){l(r instanceof Error?r.message:"Failed to fetch assets")}finally{n(!1)}},[]),b=i.useCallback(async()=>{n(!0),l(null);try{const a=await xe();g(a)}catch(a){l(a instanceof Error?a.message:"Failed to fetch active assets")}finally{n(!1)}},[]),k=i.useCallback(async()=>{n(!0),l(null);try{const a=await ve();g(a)}catch(a){l(a instanceof Error?a.message:"Failed to fetch disposed assets")}finally{n(!1)}},[]),m=i.useCallback(async a=>{n(!0),l(null);try{const r=crypto.randomUUID();S.info(`[useAssets] Creating asset with ID: ${r}`),S.info(`[useAssets] Input billPath: ${a.billPath}`);let c=a.billPath;if(a.billPath)try{const v=a.billPath.split(/[/\\]/),w=v[v.length-1];S.info(`[useAssets] Extracted filename: ${w}`),c=await R.saveAttachment(r,a.billPath,w),S.info(`[useAssets] Final billPath after save: ${c}`)}catch(v){throw S.error("[useAssets] Failed to save attachment:",v),new Error("Failed to save attachment file. Please try again.")}const s={...a,billPath:c};S.info("[useAssets] Creating asset with data:",{...s,description:"..."});const f=await ye(s,r);return S.info(`[useAssets] Asset created with billPath: ${f.billPath}`),g(v=>[f,...v]),f}catch(r){return S.error("[useAssets] Failed to create asset:",r),l(r instanceof Error?r.message:"Failed to create asset"),null}finally{n(!1)}},[]),F=i.useCallback(async(a,r)=>{n(!0),l(null);try{const c=o.find(w=>w.id===a);let s=r.billPath;if(r.billPath!==void 0){const w=r.billPath!==(c==null?void 0:c.billPath);if(w&&r.billPath)try{const P=r.billPath.split(/[/\\]/),U=P[P.length-1];s=await R.saveAttachment(a,r.billPath,U),c!=null&&c.billPath&&await R.deleteAttachment(c.billPath)}catch(P){S.error("Failed to save attachment:",P),s=c==null?void 0:c.billPath}else if(w&&!r.billPath&&(c!=null&&c.billPath))try{await R.deleteAttachment(c.billPath),s=void 0}catch(P){S.error("Failed to delete attachment:",P),s=c==null?void 0:c.billPath}}const f={...r,billPath:s},v=await je(a,f);return v&&(g(w=>w.map(P=>P.id===a?v:P)),(d==null?void 0:d.id)===a&&u(v)),v}catch(c){return l(c instanceof Error?c.message:"Failed to update asset"),null}finally{n(!1)}},[d,o]),A=i.useCallback(async a=>{n(!0),l(null);try{const r=await be(a);return r&&(g(c=>c.filter(s=>s.id!==a)),(d==null?void 0:d.id)===a&&u(null)),r}catch(r){return l(r instanceof Error?r.message:"Failed to delete asset"),!1}finally{n(!1)}},[d]),W=i.useCallback(async(a,r,c,s)=>{n(!0),l(null);try{const f=await Ne(a,r,c,s);return f&&(g(v=>v.map(w=>w.id===a?f:w)),(d==null?void 0:d.id)===a&&u(f)),f}catch(f){return l(f instanceof Error?f.message:"Failed to dispose asset"),null}finally{n(!1)}},[d]),L=i.useCallback(async a=>{try{return await Ae(a)}catch(r){return l(r instanceof Error?r.message:"Failed to get depreciation"),0}},[]),$=i.useCallback(async a=>{try{return await we(a)}catch(r){return l(r instanceof Error?r.message:"Failed to get depreciation by category"),{computer:0,phone:0,furniture:0,equipment:0,software:0}}},[]),j=i.useCallback(async()=>{try{return await Pe()}catch(a){return l(a instanceof Error?a.message:"Failed to get total asset value"),0}},[]),V=i.useCallback(async()=>{N?await I(N):p?await E(p):await h()},[N,p,I,E,h]);i.useEffect(()=>{D&&V()},[D,V]);const T=i.useCallback(()=>{l(null)},[]);return{assets:o,isLoading:x,error:y,fetchAssets:h,fetchByCategory:I,fetchByStatus:E,fetchActiveAssets:b,fetchDisposedAssets:k,createAsset:m,updateAsset:F,deleteAsset:A,disposeAsset:W,getYearlyDepreciation:L,getDepreciationByCategory:$,getTotalAssetValue:j,selectedAsset:d,setSelectedAsset:u,refresh:V,clearError:T}}const ze=re("AssetDialog");function ot({open:t,onOpenChange:D,asset:N,onClose:p,onSuccess:o}){const{createAsset:g,updateAsset:x,error:n,clearError:y}=He(),l=u=>{u||y(),D(u)},d=async u=>{try{let h;if(N?h=await x(N.id,u):h=await g(u),!h)return;o==null||o(),p()}catch(h){ze.error("Failed to save asset:",h)}};return e.jsx(le,{open:t,onOpenChange:l,children:e.jsxs(ne,{className:"w-[calc(100vw-2rem)] max-w-[600px] max-h-[90vh] overflow-y-auto",children:[n&&e.jsx("div",{className:"mb-4 p-3 bg-destructive/10 border border-destructive/20 rounded-md text-destructive text-sm",children:se(n)}),e.jsx(_e,{asset:N||void 0,onSubmit:d,onCancel:p})]})})}export{ot as A,He as u};
