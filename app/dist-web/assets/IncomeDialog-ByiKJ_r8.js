import{r as o,j as e}from"./vendor-react-nkeu7MKf.js";import{D as M,a as T}from"./dialog-Bl_bvdQq.js";import{u as P,a as B,o as L,s as w,e as O,n as V}from"./vendor-forms-BDwCPqGD.js";import{l as U,L as g,I as R,a as D,q}from"./index-CPS4omDK.js";import{g as _,a as $,b as z,c as G,u as W,d as X,m as H,e as J}from"./income-C3s9lyfz.js";function K(t={}){const{autoFetch:x=!0,dateRange:h,ustPeriod:p}=t,[f,d]=o.useState([]),[y,n]=o.useState(!1),[u,l]=o.useState(null),[m,k]=o.useState(null),c=o.useCallback(async()=>{n(!0),l(null);try{const s=await _();d(s)}catch(s){l(s instanceof Error?s.message:"Failed to fetch income")}finally{n(!1)}},[]),v=o.useCallback(async(s,a)=>{n(!0),l(null);try{const r=await $(s,a);d(r)}catch(r){l(r instanceof Error?r.message:"Failed to fetch income")}finally{n(!1)}},[]),b=o.useCallback(async s=>{n(!0),l(null);try{const a=await z(s);d(a)}catch(a){l(a instanceof Error?a.message:"Failed to fetch income")}finally{n(!1)}},[]),j=o.useCallback(async s=>{n(!0),l(null);try{const a=await G(s);return d(r=>[a,...r]),a}catch(a){return l(a instanceof Error?a.message:"Failed to create income"),null}finally{n(!1)}},[]),A=o.useCallback(async(s,a)=>{n(!0),l(null);try{const r=await W(s,a);return r&&(d(S=>S.map(E=>E.id===s?r:E)),(m==null?void 0:m.id)===s&&k(r)),r}catch(r){return l(r instanceof Error?r.message:"Failed to update income"),null}finally{n(!1)}},[m]),i=o.useCallback(async s=>{n(!0),l(null);try{const a=await X(s);return a&&(d(r=>r.filter(S=>S.id!==s)),(m==null?void 0:m.id)===s&&k(null)),a}catch(a){return l(a instanceof Error?a.message:"Failed to delete income"),!1}finally{n(!1)}},[m]),N=o.useCallback(async s=>{n(!0),l(null);try{await H(s),d(a=>a.map(r=>s.includes(r.id)?{...r,ustReported:!0}:r))}catch(a){l(a instanceof Error?a.message:"Failed to mark as reported")}finally{n(!1)}},[]),C=o.useCallback(async(s,a)=>{try{return await J(s,a)}catch(r){return l(r instanceof Error?r.message:"Failed to get summary"),null}},[]),I=o.useCallback(async()=>{h?await v(h.start,h.end):p?await b(p):await c()},[h,p,v,b,c]);return o.useEffect(()=>{x&&I()},[x,I]),{income:f,isLoading:y,error:u,fetchIncome:c,fetchByDateRange:v,fetchByUstPeriod:b,createIncome:j,updateIncome:A,deleteIncome:i,markAsReported:N,getSummary:C,selectedIncome:m,setSelectedIncome:k,refresh:I}}const Q=L({date:w().min(1,"Date is required"),description:w().min(1,"Description is required"),netAmount:V().positive("Amount must be positive"),vatRate:O(["0","7","19"]),euerCategory:w().min(1),paymentMethod:w().optional(),bankReference:w().optional()});function F(t){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(t)}const Y=[{value:"services",label:"Dienstleistungen (Services)"},{value:"products",label:"Warenverkauf (Products)"},{value:"license",label:"Lizenzgebühren (License Fees)"},{value:"other",label:"Sonstige (Other)"}];function Z({income:t,onSubmit:x,onCancel:h,className:p}){const[f,d]=o.useState(!1),y=!!t,n={date:t!=null&&t.date?t.date.toISOString().split("T")[0]:new Date().toISOString().split("T")[0],description:(t==null?void 0:t.description)??"",netAmount:(t==null?void 0:t.netAmount)??0,vatRate:String((t==null?void 0:t.vatRate)??19),euerCategory:(t==null?void 0:t.euerCategory)??"services",paymentMethod:(t==null?void 0:t.paymentMethod)??"",bankReference:(t==null?void 0:t.bankReference)??""},{register:u,handleSubmit:l,watch:m,setValue:k,formState:{errors:c}}=P({resolver:B(Q),defaultValues:n}),v=m("netAmount"),b=m("vatRate"),j=o.useMemo(()=>{const i=Number(v)||0,N=Number(b)||19,C=Math.round(i*(N/100)*100)/100,I=Math.round((i+C)*100)/100;return{net:i,vat:C,gross:I,rate:N}},[v,b]),A=async i=>{d(!0);try{const N={date:new Date(i.date),description:i.description,netAmount:i.netAmount,vatRate:Number(i.vatRate),euerCategory:i.euerCategory,paymentMethod:i.paymentMethod,bankReference:i.bankReference};await x(N)}finally{d(!1)}};return e.jsxs("form",{onSubmit:l(A),className:U("space-y-6",p),children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:y?"Edit Income":"Add Income"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:y?"Update the income record details below.":"Enter the details for the new income record."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"date",children:"Date"}),e.jsx(R,{id:"date",type:"date",...u("date"),"aria-invalid":!!c.date}),c.date&&e.jsx("p",{className:"text-sm text-destructive",children:c.date.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"description",children:"Description"}),e.jsx(R,{id:"description",placeholder:"e.g., Consulting services for Project X",...u("description"),"aria-invalid":!!c.description}),c.description&&e.jsx("p",{className:"text-sm text-destructive",children:c.description.message})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"netAmount",children:"Net Amount (€)"}),e.jsx(R,{id:"netAmount",type:"number",step:"0.01",min:"0",placeholder:"0.00",...u("netAmount",{valueAsNumber:!0}),"aria-invalid":!!c.netAmount}),c.netAmount&&e.jsx("p",{className:"text-sm text-destructive",children:c.netAmount.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"vatRate",children:"VAT Rate"}),e.jsxs("select",{id:"vatRate",className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",...u("vatRate"),children:[e.jsx("option",{value:"19",children:"19%"}),e.jsx("option",{value:"7",children:"7%"}),e.jsx("option",{value:"0",children:"0%"})]})]})]}),e.jsx("div",{className:"rounded-lg bg-muted p-4",children:e.jsxs("div",{className:"grid grid-cols-3 gap-2 sm:gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Net"}),e.jsx("div",{className:"font-medium",children:F(j.net)})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-muted-foreground",children:["VAT (",j.rate,"%)"]}),e.jsx("div",{className:"font-medium",children:F(j.vat)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Gross"}),e.jsx("div",{className:"font-semibold",children:F(j.gross)})]})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"euerCategory",children:"Category"}),e.jsx("select",{id:"euerCategory",className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",...u("euerCategory"),children:Y.map(i=>e.jsx("option",{value:i.value,children:i.label},i.value))})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"paymentMethod",children:"Payment Method (optional)"}),e.jsxs("select",{id:"paymentMethod",className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",...u("paymentMethod"),children:[e.jsx("option",{value:"",children:"Select..."}),e.jsx("option",{value:"bank_transfer",children:"Bank Transfer"}),e.jsx("option",{value:"paypal",children:"PayPal"}),e.jsx("option",{value:"credit_card",children:"Credit Card"}),e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"other",children:"Other"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"bankReference",children:"Bank Reference (optional)"}),e.jsx(R,{id:"bankReference",placeholder:"e.g., Transaction ID",...u("bankReference")})]})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx(D,{type:"button",variant:"outline",onClick:h,children:"Cancel"}),e.jsxs(D,{type:"submit",disabled:f,children:[f&&e.jsx(q,{className:"mr-2 h-4 w-4 animate-spin"}),"Save"]})]})]})}function ne({open:t,onOpenChange:x,income:h,onClose:p,onSuccess:f}){const{createIncome:d,updateIncome:y}=K(),n=async u=>{h?await y(h.id,u):await d(u),f==null||f(),p()};return e.jsx(M,{open:t,onOpenChange:x,children:e.jsx(T,{className:"w-[calc(100vw-2rem)] max-w-[600px] max-h-[90vh] overflow-y-auto",children:e.jsx(Z,{income:h||void 0,onSubmit:n,onCancel:p})})})}export{ne as I,K as u};
