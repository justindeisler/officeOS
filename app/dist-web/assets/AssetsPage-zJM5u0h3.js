import{r as d,j as e}from"./vendor-react-wuMqdllU.js";import{u as I,A as B}from"./AssetDialog-_6ghs_GE.js";import{i as T,E as G,a as C,I as E,B as V,L as F}from"./index-BJ9hpEov.js";import{T as M,a as Y,b as O,c as p,d as $,e as g}from"./table-D-p124BO.js";import{C as q}from"./confirm-delete-dialog-D3P6PPsQ.js";import{a as z}from"./assets-CVBAgqHn.js";import{o as H,t as U,Y as J,f as _,aJ as K,G as Q}from"./vendor-icons-ssgfUAX_.js";import"./card-BOU-q13f.js";import{D as W,a as X,b as Z,c as ee,d as se,e as te}from"./dialog-BPcAFwmD.js";import{S as ae,a as re,b as ne,c as le,d as ie}from"./select-DW4QIkWb.js";import"./vendor-markdown-C3iCDuOK.js";import"./vendor-forms-B8CBK7X2.js";import"./index-FI6coOPr.js";import"./vendor-framer-motion-C26rlN9R.js";import"./alert-dialog-CMM_3WOV.js";import"./vendor-radix-DqeMb71O.js";import"./vendor-floating-ui-BD6aHMKr.js";import"./vendor-recharts-tRgwS7-V.js";import"./vendor-router-Cm8Qzw9U.js";import"./db-BUkeUm8J.js";function P(t){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(t)}function oe(t){return new Intl.DateTimeFormat("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"}).format(t)}function ce(t){return{computer:"Computer",phone:"Phone",furniture:"Furniture",equipment:"Equipment",software:"Software"}[t]}function de(t){return{active:"Active",disposed:"Disposed",sold:"Sold"}[t]}function ue(t){return{active:"default",disposed:"secondary",sold:"outline"}[t]}function R(t){const r=new Date().getFullYear(),n=t.depreciationSchedule.filter(i=>i.year<=r).sort((i,u)=>u.year-i.year)[0];return(n==null?void 0:n.bookValue)??t.purchasePrice}function me({onAddAsset:t,onEditAsset:r,onDisposeAsset:n,className:i,refreshTrigger:u}){const{assets:m,isLoading:b,error:x,deleteAsset:A,setSelectedAsset:D,refresh:w}=I(),[h,j]=d.useState(""),[o,y]=d.useState(null);d.useEffect(()=>{u&&u>0&&w()},[u,w]);const f=d.useMemo(()=>{if(!h)return m;const s=h.toLowerCase();return m.filter(l=>{var N,k;return l.name.toLowerCase().includes(s)||(((N=l.vendor)==null?void 0:N.toLowerCase().includes(s))??!1)||(((k=l.description)==null?void 0:k.toLowerCase().includes(s))??!1)||l.category.toLowerCase().includes(s)})},[m,h]),a=d.useMemo(()=>{const s=f.filter(l=>l.status==="active");return{purchaseValue:f.reduce((l,N)=>l+N.purchasePrice,0),bookValue:f.reduce((l,N)=>l+R(N),0),activeCount:s.length}},[f]),S=s=>{D(s),r==null||r(s)},v=(s,l)=>{s.stopPropagation(),y(l)},c=async()=>{o&&(await A(o),y(null))};return b?e.jsxs("div",{className:T("flex items-center justify-center p-8",i),children:[e.jsx(H,{className:"h-8 w-8 animate-spin text-muted-foreground"}),e.jsx("span",{className:"ml-2 text-muted-foreground",children:"Loading..."})]}):x?e.jsxs("div",{className:T("p-8 text-center",i),children:[e.jsx("p",{className:"text-destructive",children:G(x)}),e.jsx(C,{variant:"outline",className:"mt-4",onClick:()=>window.location.reload(),children:"Retry"})]}):e.jsxs("div",{className:T("space-y-4",i),children:[e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:[e.jsx("h2",{className:"text-2xl sm:text-3xl font-semibold tracking-tight",children:"Assets"}),e.jsxs(C,{onClick:t,className:"w-full sm:w-auto",children:[e.jsx(U,{className:"mr-2 h-4 w-4"}),"Add Asset"]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(J,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(E,{placeholder:"Search assets...",value:h,onChange:s=>j(s.target.value),className:"pl-10"})]}),f.length===0?e.jsx("div",{className:"rounded-lg border border-dashed p-8 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:h?"No assets match your search":"No assets yet. Add your first asset to get started."})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"rounded-md border overflow-x-auto",children:e.jsxs(M,{className:"min-w-[900px]",children:[e.jsx(Y,{children:e.jsxs(O,{children:[e.jsx(p,{children:"Name"}),e.jsx(p,{children:"Vendor"}),e.jsx(p,{children:"Category"}),e.jsx(p,{children:"Purchase Date"}),e.jsx(p,{className:"text-right",children:"Purchase Price"}),e.jsx(p,{className:"text-right",children:"Book Value"}),e.jsx(p,{children:"AfA"}),e.jsx(p,{children:"Status"}),e.jsx(p,{className:"w-[40px]"}),e.jsx(p,{className:"w-[40px]"}),e.jsx(p,{className:"w-[50px]"})]})}),e.jsx($,{children:f.map(s=>e.jsxs(O,{className:"cursor-pointer hover:bg-muted/50",onClick:()=>S(s),children:[e.jsx(g,{className:"font-medium",children:s.name}),e.jsx(g,{className:"text-muted-foreground",children:s.vendor||"—"}),e.jsx(g,{children:e.jsx(V,{variant:"outline",children:ce(s.category)})}),e.jsx(g,{children:oe(s.purchaseDate)}),e.jsx(g,{className:"text-right",children:P(s.purchasePrice)}),e.jsx(g,{className:"text-right font-medium",children:P(R(s))}),e.jsx(g,{children:e.jsx("span",{className:"text-sm text-muted-foreground",children:s.afaMethod==="immediate"?"Immediate":`${s.afaYears} years`})}),e.jsx(g,{children:e.jsx(V,{variant:ue(s.status),children:de(s.status)})}),e.jsx(g,{className:"text-center",children:s.billPath&&e.jsx(C,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:async l=>{l.stopPropagation(),console.log(`[AssetList] Opening attachment for asset ${s.id}:`,s.billPath);try{await z.openAttachment(s.billPath)}catch(N){const k=N instanceof Error?N.message:"Unknown error";console.error("[AssetList] Failed to open attachment:",k),alert(`Failed to open attachment: ${k}`)}},title:"View attached bill",children:e.jsx(_,{className:"h-4 w-4 text-muted-foreground hover:text-primary"})})}),e.jsx(g,{className:"text-center",children:s.status==="active"&&n&&e.jsx(C,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:l=>{l.stopPropagation(),n(s)},title:"Dispose asset","aria-label":"Dispose",children:e.jsx(K,{className:"h-4 w-4 text-muted-foreground hover:text-destructive"})})}),e.jsx(g,{children:e.jsx(C,{variant:"ghost",size:"icon",onClick:l=>v(l,s.id),"aria-label":"Delete",children:e.jsx(Q,{className:"h-4 w-4 text-muted-foreground hover:text-destructive"})})})]},s.id))})]})}),e.jsx("div",{className:"flex justify-start sm:justify-end",children:e.jsxs("div",{className:"rounded-lg bg-muted p-3 sm:p-4 w-full sm:w-auto",children:[e.jsx("div",{className:"text-sm font-medium text-muted-foreground",children:"Summary"}),e.jsxs("div",{className:"mt-1 grid grid-cols-3 gap-2 sm:gap-6 text-right",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Total Purchase"}),e.jsx("div",{className:"font-medium text-sm sm:text-base",children:P(a.purchaseValue)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Total Book Value"}),e.jsx("div",{className:"font-semibold text-sm sm:text-base",children:P(a.bookValue)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Active Assets"}),e.jsxs("div",{className:"font-medium text-sm sm:text-base",children:[a.activeCount," active"]})]})]})]})})]}),e.jsx(q,{open:!!o,onOpenChange:s=>!s&&y(null),title:"Delete asset?",description:"This will permanently delete this asset. This action cannot be undone.",onConfirm:c})]})}function L(t){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(t)}function xe(t,r){const n=r.getFullYear(),i=t.depreciationSchedule.filter(u=>u.year<=n).sort((u,m)=>m.year-u.year)[0];return(i==null?void 0:i.bookValue)??t.purchasePrice}const he=[{value:"sold",label:"Sold"},{value:"scrapped",label:"Scrapped"},{value:"donated",label:"Donated"},{value:"stolen",label:"Stolen / Lost"},{value:"other",label:"Other"}];function pe({open:t,onOpenChange:r,asset:n,onConfirm:i,isLoading:u=!1}){const[m,b]=d.useState(new Date().toISOString().split("T")[0]),[x,A]=d.useState("0"),[D,w]=d.useState("sold"),[h,j]=d.useState(null),o=d.useMemo(()=>{if(!n)return null;const a=new Date(m),S=parseFloat(x)||0,v=xe(n,a),c=S-v;return{bookValue:v,gainLoss:c,isGain:c>0,isLoss:c<0,isBreakEven:c===0}},[n,m,x]),y=a=>{a&&(b(new Date().toISOString().split("T")[0]),A("0"),w("sold"),j(null)),r(a)},f=async()=>{if(!n)return;const a=parseFloat(x)||0;if(a<0){j("Disposal price cannot be negative");return}if(!m){j("Disposal date is required");return}j(null);const S=a>0?"sold":"disposed";try{await i({disposalDate:new Date(m),disposalPrice:a,disposalReason:D,status:S})}catch(v){j(v instanceof Error?v.message:"Failed to dispose asset")}};return n?e.jsx(W,{open:t,onOpenChange:y,children:e.jsxs(X,{className:"w-[calc(100vw-2rem)] max-w-[500px]",children:[e.jsxs(Z,{children:[e.jsx(ee,{children:"Dispose Asset"}),e.jsxs(se,{children:['Mark "',n.name,'" as disposed or sold. This action records the disposal for EÜR reporting.']})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[h&&e.jsx("div",{className:"p-3 bg-destructive/10 border border-destructive/20 rounded-md text-destructive text-sm",children:h}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"disposal-date",children:"Disposal Date"}),e.jsx(E,{id:"disposal-date",type:"date",value:m,onChange:a=>b(a.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(F,{htmlFor:"disposal-price",children:["Sale Price (€)",e.jsx("span",{className:"text-muted-foreground font-normal ml-1",children:"— enter 0 if scrapped or donated"})]}),e.jsx(E,{id:"disposal-price",type:"number",step:"0.01",min:"0",value:x,onChange:a=>A(a.target.value),placeholder:"0.00"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"disposal-reason",children:"Reason"}),e.jsxs(ae,{value:D,onValueChange:w,children:[e.jsx(re,{id:"disposal-reason",children:e.jsx(ne,{placeholder:"Select reason"})}),e.jsx(le,{children:he.map(a=>e.jsx(ie,{value:a.value,children:a.label},a.value))})]})]}),o&&e.jsxs("div",{className:"rounded-lg border bg-muted/50 p-4 space-y-2",children:[e.jsx("div",{className:"text-sm font-medium text-muted-foreground",children:"Disposal Preview"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Original Price"}),e.jsx("div",{className:"font-medium",children:L(n.purchasePrice)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Book Value"}),e.jsx("div",{className:"font-medium",children:L(o.bookValue)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Sale Price"}),e.jsx("div",{className:"font-medium",children:L(parseFloat(x)||0)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:o.isGain?"Gain":o.isLoss?"Loss":"Break Even"}),e.jsxs("div",{className:T("font-semibold",o.isGain&&"text-green-600 dark:text-green-400",o.isLoss&&"text-red-600 dark:text-red-400"),children:[o.isGain?"+":"",L(o.gainLoss)]})]})]}),e.jsx("div",{className:"text-xs text-muted-foreground pt-1 border-t",children:o.isGain?"Gain will be reported as income (EÜR line 16 – Veräußerungsgewinne)":o.isLoss?"Loss will be reported as expense (EÜR line 35 – Anlagenabgang)":"No gain or loss to report"})]})]}),e.jsxs(te,{children:[e.jsx(C,{variant:"outline",onClick:()=>r(!1),disabled:u,children:"Cancel"}),e.jsx(C,{variant:"destructive",onClick:f,disabled:u,children:u?"Disposing...":"Confirm Disposal"})]})]})}):null}function Re(){const[t,r]=d.useState(!1),[n,i]=d.useState(!1),[u,m]=d.useState(null),[b,x]=d.useState(null),[A,D]=d.useState(0),[w,h]=d.useState(!1),{disposeAsset:j}=I({autoFetch:!1}),o=()=>{m(null),r(!0)},y=c=>{m(c),r(!0)},f=c=>{x(c),i(!0)},a=()=>{r(!1),m(null)},S=()=>{D(c=>c+1)},v=async c=>{if(b){h(!0);try{await j(b.id,c.disposalDate,c.status,c.disposalPrice),i(!1),x(null),D(s=>s+1)}finally{h(!1)}}};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-6 animate-in fade-in",children:e.jsx(me,{onAddAsset:o,onEditAsset:y,onDisposeAsset:f,refreshTrigger:A})}),e.jsx(B,{open:t,onOpenChange:r,asset:u,onClose:a,onSuccess:S}),e.jsx(pe,{open:n,onOpenChange:i,asset:b,onConfirm:v,isLoading:w})]})}export{Re as AssetsPage};
