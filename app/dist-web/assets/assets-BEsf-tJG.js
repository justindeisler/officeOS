const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DV0Z4ueH.js","assets/core-BDPGcIsz.js","assets/index-CDjnCujr.js","assets/path-E9zjYLSN.js","assets/index-CLbthooq.js"])))=>i.map(i=>d[i]);
var G=Object.defineProperty;var J=(e,t,a)=>t in e?G(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a;var M=(e,t,a)=>J(e,typeof t!="symbol"?t+"":t,a);import{g as v}from"./db-DbzJDTiu.js";import{_ as P,a9 as E,aa as j}from"./index-CSu7ioLu.js";import{A as q,G as Y}from"./index-uXN-dP3D.js";let O=null,$=null,I=null,F=null;async function A(){if(!O||!$||!I||!F){const[e,t,a,s]=await Promise.all([P(()=>import("./index-DV0Z4ueH.js"),__vite__mapDeps([0,1])),P(()=>import("./index-CDjnCujr.js"),__vite__mapDeps([2,3,1])),P(()=>import("./index-CLbthooq.js"),__vite__mapDeps([4,1])),P(()=>import("./path-E9zjYLSN.js"),__vite__mapDeps([3,1]))]);O=e,$=t,I=a,F=s}return{open:O.open,copyFile:$.copyFile,remove:$.remove,exists:$.exists,mkdir:$.mkdir,readFile:$.readFile,writeFile:$.writeFile,openPath:I.openPath,appDataDir:F.appDataDir,join:F.join}}const m=(e,t,a)=>{const s=new Promise((o,n)=>setTimeout(()=>n(new Error(`${a} timed out after ${t}ms`)),t));return Promise.race([e,s])};class z{constructor(){M(this,"ATTACHMENTS_DIR","attachments");M(this,"ASSETS_SUBDIR","assets")}async pickBillFile(){try{const{open:t}=await A(),a=await t({multiple:!1,filters:[{name:"PDF Documents",extensions:["pdf"]}],title:"Select Bill/Invoice PDF"});if(!a||Array.isArray(a))return null;const s=a.split(/[/\\]/),o=s[s.length-1];return{path:a,name:o}}catch(t){throw console.error("Failed to pick file:",t),new Error("Failed to open file picker")}}async saveAttachment(t,a,s){try{const{appDataDir:o,join:n,copyFile:h,readFile:i,writeFile:u,exists:f}=await A();console.log(`[Attachment] Starting save for asset ${t}`),console.log(`[Attachment] Source path: ${a}`);const d=await m(o(),5e3,"Get app data dir");console.log(`[Attachment] App data dir: ${d}`);const y=await m(n(d,this.ATTACHMENTS_DIR),1e3,"Join path"),_=await m(n(y,this.ASSETS_SUBDIR),1e3,"Join path"),r=await m(n(_,t),1e3,"Join path");await m(this.ensureDirectory(y),5e3,"Create attachments dir"),await m(this.ensureDirectory(_),5e3,"Create assets dir"),await m(this.ensureDirectory(r),5e3,"Create asset dir"),console.log(`[Attachment] Directories created: ${r}`);const c=Date.now(),l=this.sanitizeFilename(s),p=`${c}_${l}`,w=await m(n(r,p),1e3,"Join target path");console.log(`[Attachment] Target path: ${w}`),console.log("[Attachment] Starting file copy..."),console.log(`[Attachment] From: ${a}`),console.log(`[Attachment] To: ${w}`);try{await m(h(a,w),3e4,"File copy"),console.log("[Attachment] File copy completed via copyFile")}catch(x){console.warn("[Attachment] copyFile failed, trying readFile + writeFile:",x);try{const S=await m(i(a),3e4,"Read source file");console.log(`[Attachment] Read ${S.byteLength} bytes from source`),await m(u(w,S),3e4,"Write destination file"),console.log("[Attachment] File written to destination")}catch(S){throw console.error("[Attachment] Read/Write also failed:",S),new Error(`Failed to copy file: ${S instanceof Error?S.message:"Unknown error"}`)}}let T=!1;try{T=await m(f(w),5e3,"Verify copy"),console.log(`[Attachment] Post-copy exists() check: ${T}`)}catch(x){console.warn("[Attachment] Post-copy exists() check failed, assuming success:",x),T=!0}return T||console.warn("[Attachment] exists() returned false for target, but copy may have succeeded"),console.log("[Attachment] File save completed (exists check may be unreliable)"),console.log(`[Attachment] Successfully saved: ${w}`),w}catch(o){console.error("[Attachment] Failed to save attachment:",o);const n=o instanceof Error?o.message:"Failed to save attachment";throw new Error(n)}}async deleteAttachment(t){try{const{exists:a,remove:s}=await A();return await a(t)?(await s(t),console.log(`Attachment deleted: ${t}`),!0):(console.warn(`Attachment not found: ${t}`),!1)}catch(a){throw console.error("Failed to delete attachment:",a),new Error("Failed to delete attachment")}}async openAttachment(t){try{const{openPath:a}=await A();console.log(`[Attachment] Opening attachment: ${t}`),console.log("[Attachment] Calling openPath directly..."),await m(a(t),1e4,"Open file"),console.log("[Attachment] File opened successfully")}catch(a){console.error("[Attachment] Failed to open attachment:",a);const s=a instanceof Error?a.message:String(a);throw new Error(`Could not open file at ${t}: ${s}`)}}async getAttachmentInfo(t){try{const{exists:a}=await A();console.log(`[Attachment] Getting info for: ${t}`);let s=!0;try{s=await m(a(t),5e3,"Check exists for info"),console.log(`[Attachment] File exists check: ${s}`)}catch(u){console.warn("[Attachment] exists() check failed, assuming file exists:",u),s=!0}const o=t.split(/[/\\]/),h=o[o.length-1].replace(/^\d+_/,""),i={path:t,name:h,exists:s};return console.log("[Attachment] Info result:",i),i}catch(a){return console.error("[Attachment] Failed to get attachment info:",a),null}}validateFile(t){var s;return((s=t.split(".").pop())==null?void 0:s.toLowerCase())!=="pdf"?{valid:!1,error:"Only PDF files are supported"}:{valid:!0}}async cleanupAssetAttachments(t){try{const{appDataDir:a,join:s,exists:o,remove:n}=await A(),h=await a(),i=await s(h,this.ATTACHMENTS_DIR,this.ASSETS_SUBDIR,t);await o(i)&&(await n(i,{recursive:!0}),console.log(`Cleaned up attachments for asset: ${t}`))}catch(a){console.error("Failed to cleanup attachments:",a)}}async ensureDirectory(t){const{exists:a,mkdir:s}=await A();let o=!1;try{o=await a(t)}catch{o=!1}if(!o)try{await s(t,{recursive:!0})}catch(n){console.warn("[Attachment] mkdir warning (may be OK if dir exists):",n)}}sanitizeFilename(t){return t.replace(/[<>:"/\\|?*]/g,"_").replace(/\s+/g,"_").substring(0,100)}}const X=new z,D=(e,t)=>j.request(e,t);function k(e,t){return Math.round(e*(t/100)*100)/100}function L(e,t,a,s){const o=[],n=t/s,i=12-a.getMonth(),u=n*i/12;let f=0,d=t;const y=a.getFullYear();f+=u,d-=u,o.push({id:crypto.randomUUID(),assetId:e,year:y,months:i,amount:Math.round(u*100)/100,cumulative:Math.round(f*100)/100,bookValue:Math.round(d*100)/100});const _=s-1;for(let r=1;r<=_;r++)f+=n,d-=n,d<0&&(d=0),o.push({id:crypto.randomUUID(),assetId:e,year:y+r,months:12,amount:Math.round(n*100)/100,cumulative:Math.round(f*100)/100,bookValue:Math.round(d*100)/100});if(i<12){const r=12-i,c=n*r/12;f+=c,d=0,o.push({id:crypto.randomUUID(),assetId:e,year:y+s,months:r,amount:Math.round(c*100)/100,cumulative:Math.round(t*100)/100,bookValue:0})}return o}function V(e,t,a){const s=a.getFullYear();return[{id:crypto.randomUUID(),assetId:e,year:s,months:12,amount:Math.round(t*100)/100,cumulative:Math.round(t*100)/100,bookValue:0}]}function K(e){return{id:e.id,assetId:e.asset_id,year:e.year,months:e.months,amount:e.amount,cumulative:e.cumulative,bookValue:e.book_value}}function g(e,t=[]){return{id:e.id,name:e.name,description:e.description??void 0,purchaseDate:new Date(e.purchase_date),vendor:e.vendor??void 0,purchasePrice:e.purchase_price,vatPaid:e.vat_paid??0,grossPrice:e.gross_price??e.purchase_price,afaMethod:e.afa_method??e.depreciation_method??"linear",afaYears:e.afa_years??e.useful_life_years??3,afaStartDate:new Date(e.afa_start_date??e.purchase_date),afaAnnualAmount:e.afa_annual_amount??0,status:e.status??"active",disposalDate:e.disposal_date?new Date(e.disposal_date):void 0,disposalPrice:e.disposal_price??void 0,euerLine:e.euer_line??30,euerCategory:e.euer_category??"afa_beweglich",category:e.category,inventoryNumber:e.inventory_number??void 0,location:e.location??void 0,billPath:e.bill_path??void 0,depreciationSchedule:t,createdAt:new Date(e.created_at??Date.now())}}async function R(e){return(await(await v()).select("SELECT * FROM depreciation_schedule WHERE asset_id = $1 ORDER BY year ASC",[e])).map(K)}async function H(e){const t=await v();for(const a of e)await t.execute(`INSERT INTO depreciation_schedule (
        id, asset_id, year, months, amount, cumulative, book_value
      ) VALUES ($1, $2, $3, $4, $5, $6, $7)`,[a.id,a.assetId,a.year,a.months,a.amount,a.cumulative,a.bookValue])}async function Q(){const t=await(await v()).select(`SELECT inventory_number as max_num FROM assets
     WHERE inventory_number IS NOT NULL
     ORDER BY inventory_number DESC LIMIT 1`);if(t.length===0||!t[0].max_num)return"INV-001";const a=t[0].max_num.match(/INV-(\d+)/);if(!a)return"INV-001";const s=parseInt(a[1],10)+1;return`INV-${String(s).padStart(3,"0")}`}async function ne(){if(!E())return(await D("/assets")).map(o=>g(o));const t=await(await v()).select("SELECT * FROM assets ORDER BY purchase_date DESC"),a=[];for(const s of t){const o=await R(s.id);a.push(g(s,o))}return a}async function b(e){if(!E())try{const o=await D(`/assets/${e}`);return g(o)}catch{return null}const a=await(await v()).select("SELECT * FROM assets WHERE id = $1",[e]);if(a.length===0)return null;const s=await R(e);return g(a[0],s)}async function re(e){if(!E())return(await D(`/assets?category=${e}`)).map(n=>g(n));const a=await(await v()).select("SELECT * FROM assets WHERE category = $1 ORDER BY purchase_date DESC",[e]),s=[];for(const o of a){const n=await R(o.id);s.push(g(o,n))}return s}async function Z(e){if(!E())return(await D(`/assets?status=${e}`)).map(n=>g(n));const a=await(await v()).select("SELECT * FROM assets WHERE status = $1 ORDER BY purchase_date DESC",[e]),s=[];for(const o of a){const n=await R(o.id);s.push(g(o,n))}return s}async function N(){return await Z("active")}async function ee(){if(!E())return(await D("/assets?status=disposed,sold")).map(o=>g(o));const t=await(await v()).select("SELECT * FROM assets WHERE status IN ('disposed', 'sold') ORDER BY purchase_date DESC"),a=[];for(const s of t){const o=await R(s.id);a.push(g(s,o))}return a}async function ie(e,t){if(!E()){const _=await D("/assets",{method:"POST",body:JSON.stringify({id:t,name:e.name,description:e.description,purchase_date:e.purchaseDate.toISOString().split("T")[0],vendor:e.vendor,purchase_price:e.purchasePrice,vat_rate:e.vatRate,afa_method:e.afaMethod,afa_years:e.afaYears,category:e.category,inventory_number:e.inventoryNumber,location:e.location,bill_path:e.billPath})});return g(_)}const a=await v(),s=t??crypto.randomUUID(),o=new Date().toISOString(),n=k(e.purchasePrice,e.vatRate),h=e.purchasePrice+n;let i=e.afaMethod??"linear",u=e.afaYears??q[e.category];!e.afaMethod&&e.purchasePrice<=Y.GWG_MAX&&(i="immediate",u=1);const f=i==="immediate"?V(s,e.purchasePrice,e.purchaseDate):L(s,e.purchasePrice,e.purchaseDate,u),d=i==="immediate"?e.purchasePrice:e.purchasePrice/u,y=e.inventoryNumber||await Q();return await a.execute(`INSERT INTO assets (
      id, name, description, purchase_date, vendor, purchase_price,
      vat_paid, gross_price, afa_method, afa_years, afa_start_date,
      afa_annual_amount, status, euer_line, euer_category, category,
      inventory_number, location, bill_path, created_at
    ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20)`,[s,e.name,e.description??null,e.purchaseDate.toISOString().split("T")[0],e.vendor??null,e.purchasePrice,n,h,i,u,e.purchaseDate.toISOString().split("T")[0],d,"active",30,"afa_beweglich",e.category,y,e.location??"Home Office",e.billPath??null,o]),await H(f),{id:s,name:e.name,description:e.description,purchaseDate:e.purchaseDate,vendor:e.vendor,purchasePrice:e.purchasePrice,vatPaid:n,grossPrice:h,afaMethod:i,afaYears:u,afaStartDate:e.purchaseDate,afaAnnualAmount:d,status:"active",euerLine:30,euerCategory:"afa_beweglich",category:e.category,inventoryNumber:y,location:e.location??"Home Office",billPath:e.billPath,depreciationSchedule:f,createdAt:new Date(o)}}async function ce(e,t){if(!E())try{const p={};t.name!==void 0&&(p.name=t.name),t.description!==void 0&&(p.description=t.description),t.purchaseDate&&(p.purchase_date=t.purchaseDate.toISOString().split("T")[0]),t.vendor!==void 0&&(p.vendor=t.vendor),t.purchasePrice!==void 0&&(p.purchase_price=t.purchasePrice),t.vatRate!==void 0&&(p.vat_rate=t.vatRate),t.afaMethod!==void 0&&(p.afa_method=t.afaMethod),t.afaYears!==void 0&&(p.afa_years=t.afaYears),t.category!==void 0&&(p.category=t.category),t.inventoryNumber!==void 0&&(p.inventory_number=t.inventoryNumber),t.location!==void 0&&(p.location=t.location),t.billPath!==void 0&&(p.bill_path=t.billPath);const w=await D(`/assets/${e}`,{method:"PATCH",body:JSON.stringify(p)});return g(w)}catch{return null}const a=await b(e);if(!a)return null;const s=await v(),o=t.purchasePrice??a.purchasePrice,n=t.category??a.category,h=t.purchaseDate??a.purchaseDate;let i=t.afaYears??a.afaYears,u=t.afaMethod??a.afaMethod;t.afaMethod===void 0&&o<=Y.GWG_MAX&&(u="immediate",i=1);let f=a.depreciationSchedule,d=a.afaAnnualAmount;(t.purchasePrice!==void 0||t.category!==void 0||t.purchaseDate!==void 0||t.afaYears!==void 0||t.afaMethod!==void 0)&&(await s.execute("DELETE FROM depreciation_schedule WHERE asset_id = $1",[e]),f=u==="immediate"?V(e,o,h):L(e,o,h,i),d=u==="immediate"?o:o/i,await H(f));let y=a.vatPaid,_=a.grossPrice;if(t.purchasePrice!==void 0||t.vatRate!==void 0){const p=t.vatRate??19;y=k(o,p),_=o+y}const r=[],c=[];let l=1;return t.name!==void 0&&(r.push(`name = $${l++}`),c.push(t.name)),t.description!==void 0&&(r.push(`description = $${l++}`),c.push(t.description??null)),t.purchaseDate!==void 0&&(r.push(`purchase_date = $${l++}`),c.push(h.toISOString().split("T")[0]),r.push(`afa_start_date = $${l++}`),c.push(h.toISOString().split("T")[0])),t.vendor!==void 0&&(r.push(`vendor = $${l++}`),c.push(t.vendor??null)),t.purchasePrice!==void 0&&(r.push(`purchase_price = $${l++}`),c.push(o)),(t.purchasePrice!==void 0||t.vatRate!==void 0)&&(r.push(`vat_paid = $${l++}`),c.push(y),r.push(`gross_price = $${l++}`),c.push(_)),(t.afaYears!==void 0||t.purchasePrice!==void 0||t.afaMethod!==void 0)&&(r.push(`afa_years = $${l++}`),c.push(i),r.push(`afa_method = $${l++}`),c.push(u),r.push(`afa_annual_amount = $${l++}`),c.push(d)),t.category!==void 0&&(r.push(`category = $${l++}`),c.push(n)),t.inventoryNumber!==void 0&&(r.push(`inventory_number = $${l++}`),c.push(t.inventoryNumber??null)),t.location!==void 0&&(r.push(`location = $${l++}`),c.push(t.location??null)),t.billPath!==void 0&&(r.push(`bill_path = $${l++}`),c.push(t.billPath??null)),r.length>0&&(c.push(e),await s.execute(`UPDATE assets SET ${r.join(", ")} WHERE id = $${l}`,c)),await b(e)}async function ue(e){if(!E())return await D(`/assets/${e}`,{method:"DELETE"}),!0;if(!await b(e))return!1;const a=await v();return await X.cleanupAssetAttachments(e),await a.execute("DELETE FROM depreciation_schedule WHERE asset_id = $1",[e]),await a.execute("DELETE FROM assets WHERE id = $1",[e]),!0}async function le(e,t,a,s){if(!E()){const h=await D(`/assets/${e}/dispose`,{method:"POST",body:JSON.stringify({disposal_date:t.toISOString().split("T")[0],status:a,disposal_price:s})});return g(h)}return await b(e)?(await(await v()).execute("UPDATE assets SET status = $1, disposal_date = $2, disposal_price = $3 WHERE id = $4",[a,t.toISOString().split("T")[0],a==="sold"?s??null:null,e]),await b(e)):null}function U(e){const t=new Date().getFullYear(),a=e.depreciationSchedule.filter(s=>s.year<=t).sort((s,o)=>o.year-s.year)[0];return(a==null?void 0:a.bookValue)??e.purchasePrice}async function pe(e){return(await N()).reduce((a,s)=>{const o=s.depreciationSchedule.find(n=>n.year===e);return a+((o==null?void 0:o.amount)??0)},0)}async function he(e){const t=await N(),a={computer:0,phone:0,furniture:0,equipment:0,software:0};for(const s of t){const o=s.depreciationSchedule.find(n=>n.year===e);o&&(a[s.category]+=o.amount)}return a}async function de(){return(await N()).reduce((t,a)=>t+U(a),0)}async function B(e){return(await ee()).filter(a=>a.disposalDate?new Date(a.disposalDate).getFullYear()===e:!1)}function C(e){if(!e.disposalDate)return U(e);const t=new Date(e.disposalDate).getFullYear(),a=e.depreciationSchedule.find(o=>o.year===t);if(a)return a.bookValue;const s=e.depreciationSchedule.filter(o=>o.year<t).sort((o,n)=>n.year-o.year)[0];return(s==null?void 0:s.bookValue)??e.purchasePrice}function W(e){if(e.status!=="sold"||!e.disposalPrice)return-C(e);const t=C(e);return e.disposalPrice-t}async function me(e){return(await B(e)).reduce((a,s)=>{const o=W(s);return a+(o>0?o:0)},0)}async function fe(e){return(await B(e)).reduce((a,s)=>{const o=W(s);return a+(o<0?Math.abs(o):0)},0)}export{X as a,re as b,Z as c,N as d,ee as e,ie as f,ne as g,ue as h,le as i,pe as j,he as k,de as l,me as m,fe as n,ce as u};
