import{r as t,j as e}from"./vendor-react-wuMqdllU.js";import{T as Ee,a as Me,b as ce,c as ie}from"./tabs-EeWm2cFj.js";import{i as f,S as Z,a as F,B as G,L as _,I as M,F as ge,G as Le,H as Ke,k as B}from"./index-BJ9hpEov.js";import{C as X,c as Y,a as we,b as ke}from"./card-BOU-q13f.js";import{C as Ue}from"./confirm-delete-dialog-D3P6PPsQ.js";import{aa as $e,t as je,B as oe,ae as Se,G as Oe,v as Ce,aT as Ve,aU as Re,x as de,aK as Ge,a8 as Pe,A as Ze,o as ne,Y as He,aV as We,aW as te,aX as re,aE as qe,J as Xe,aG as _e,R as Ye,T as fe,c as pe,aq as Te,aY as Je,q as Qe,Z as es,ao as ss,j as as}from"./vendor-icons-ssgfUAX_.js";import{D as Ae,a as De,b as Be,c as Fe,d as ze}from"./dialog-BPcAFwmD.js";import{T as ns,a as ts,b as be,c as H,d as rs,e as W}from"./table-D-p124BO.js";import{S as J,a as Q,b as ee,c as se,d as E}from"./select-DW4QIkWb.js";import{E as ls}from"./index-FI6coOPr.js";import{y as Ie,z as cs}from"./vendor-radix-DqeMb71O.js";import{B as is}from"./BankReconciliation-CfH4SssS.js";import{b as K}from"./bankingService-C9qt3mZe.js";import"./vendor-markdown-C3iCDuOK.js";import"./vendor-recharts-tRgwS7-V.js";import"./vendor-router-Cm8Qzw9U.js";import"./vendor-floating-ui-BD6aHMKr.js";import"./alert-dialog-CMM_3WOV.js";function Ne(a){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(a)}function os(a){if(!a)return"â€”";const o=a.replace(/\s/g,"");return o.length<8?a:`${o.slice(0,4)} â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ ${o.slice(-4)}`}function ds(a){if(!a)return"Nie synchronisiert";const o=new Date(a),i=new Date().getTime()-o.getTime(),h=Math.floor(i/6e4),S=Math.floor(i/36e5),x=Math.floor(i/864e5);return h<1?"Gerade eben":h<60?`vor ${h} Min.`:S<24?`vor ${S} Std.`:x<7?`vor ${x} Tagen`:o.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"})}function ms(a,o){if(o)return{icon:Ce,label:"Fehler",variant:"destructive",className:"bg-red-100 text-red-800 border-red-200"};switch(a){case"synced":return{icon:Re,label:"Synchronisiert",variant:"default",className:"bg-green-100 text-green-800 border-green-200"};case"syncing":return{icon:Se,label:"Synchronisiert...",variant:"default",className:"bg-blue-100 text-blue-800 border-blue-200"};default:return{icon:Ve,label:"Ausstehend",variant:"secondary",className:"bg-gray-100 text-gray-800 border-gray-200"}}}function us({accounts:a,isLoading:o,onConnectAccount:j,onSyncAccount:i,onDeleteAccount:h,syncingAccountId:S,className:x}){const[y,T]=t.useState(null),N=a.reduce((n,u)=>n+(u.balance||0),0);return o?e.jsxs("div",{className:f("space-y-4",x),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(Z,{className:"h-8 w-48"}),e.jsx(Z,{className:"h-9 w-36"})]}),e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:[1,2,3].map(n=>e.jsx(X,{children:e.jsxs(Y,{className:"p-6",children:[e.jsx(Z,{className:"h-6 w-32 mb-4"}),e.jsx(Z,{className:"h-8 w-24 mb-2"}),e.jsx(Z,{className:"h-4 w-48"})]})},n))})]}):e.jsxs("div",{className:f("space-y-4",x),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($e,{className:"h-5 w-5 text-muted-foreground"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[a.length," ",a.length===1?"Konto":"Konten"]})]}),a.length>0&&e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Gesamtsaldo: "}),e.jsx("span",{className:f("font-semibold",N>=0?"text-green-600":"text-red-600"),children:Ne(N)})]})]}),e.jsxs(F,{onClick:j,size:"sm",children:[e.jsx(je,{className:"h-4 w-4 mr-2"}),"Konto verbinden"]})]}),a.length===0?e.jsx(X,{children:e.jsxs(Y,{className:"py-12 text-center",children:[e.jsx(oe,{className:"h-12 w-12 mx-auto mb-4 text-muted-foreground/50"}),e.jsx("p",{className:"text-muted-foreground",children:"Keine Bankkonten verbunden."}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Verbinden Sie Ihr GeschÃ¤ftskonto, um Transaktionen zu importieren."}),e.jsxs(F,{onClick:j,className:"mt-4",children:[e.jsx(je,{className:"h-4 w-4 mr-2"}),"Erstes Konto verbinden"]})]})}):e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:a.map(n=>{const u=ms(n.sync_status,n.last_sync_error),w=u.icon,v=S===n.id;return e.jsxs(X,{className:f("transition-shadow hover:shadow-md",!n.is_active&&"opacity-60"),children:[e.jsxs(we,{className:"pb-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx(oe,{className:"h-5 w-5 text-muted-foreground flex-shrink-0"}),e.jsx(ke,{className:"text-base truncate",children:n.account_name||n.bank_name||"Bankkonto"})]}),e.jsxs(G,{className:u.className,variant:"outline",children:[e.jsx(w,{className:"h-3 w-3 mr-1"}),u.label]})]}),e.jsx("p",{className:"font-mono text-xs text-muted-foreground mt-1",children:os(n.iban)})]}),e.jsxs(Y,{children:[e.jsx("div",{className:f("text-2xl font-bold mb-2",n.balance>=0?"text-foreground":"text-red-600"),children:Ne(n.balance)}),n.last_sync_error&&e.jsx("p",{className:"text-xs text-destructive mb-2 line-clamp-2",children:n.last_sync_error}),e.jsx("p",{className:"text-xs text-muted-foreground mb-3",children:ds(n.last_sync_at)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(F,{variant:"outline",size:"sm",className:"flex-1",onClick:()=>i(n.id),disabled:v,children:[e.jsx(Se,{className:f("h-3.5 w-3.5 mr-1.5",v&&"animate-spin")}),v?"Sync...":"Synchronisieren"]}),e.jsx(F,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>T(n.id),title:"Konto entfernen",children:e.jsx(Oe,{className:"h-4 w-4 text-muted-foreground hover:text-destructive"})})]})]})]},n.id)})}),e.jsx(Ue,{open:!!y,onOpenChange:n=>!n&&T(null),title:"Bankkonto entfernen?",description:"Das Konto wird entfernt. Transaktionen bleiben erhalten.",onConfirm:()=>{y&&(h(y),T(null))}})]})}function hs(a){return a.replace(/[^A-Za-z0-9]/g,"").toUpperCase().replace(/(.{4})/g,"$1 ").trim()}function xs(a){const o=a.replace(/\s/g,"");return o.length>=15&&o.length<=34&&/^[A-Z]{2}[0-9]{2}/.test(o)}const q=[{title:"Bankdaten",description:"Bankname und IBAN eingeben"},{title:"Anfangssaldo",description:"Aktuellen Kontostand eintragen"},{title:"BestÃ¤tigung",description:"Daten Ã¼berprÃ¼fen und bestÃ¤tigen"}];function gs({open:a,onOpenChange:o,onConnect:j}){const[i,h]=t.useState(0),[S,x]=t.useState(!1),[y,T]=t.useState(""),[N,n]=t.useState(""),[u,w]=t.useState(""),[v,z]=t.useState(""),[I,p]=t.useState(""),[A,l]=t.useState({}),C=()=>{h(0),T(""),n(""),w(""),z(""),p(""),l({}),x(!1)},k=r=>{r||C(),o(r)},D=()=>{const r={};return y.trim()||(r.bankName="Bankname ist erforderlich"),N.trim()?xs(N)||(r.iban="UngÃ¼ltige IBAN"):r.iban="IBAN ist erforderlich",l(r),Object.keys(r).length===0},$=()=>{i===0&&!D()||h(r=>Math.min(r+1,q.length-1))},U=()=>{h(r=>Math.max(r-1,0))},d=async()=>{x(!0);try{await j({bank_name:y.trim(),iban:N.replace(/\s/g,""),bic:u.trim()||void 0,account_name:v.trim()||void 0,balance:I?parseFloat(I):void 0}),k(!1)}catch{}finally{x(!1)}};return e.jsx(Ae,{open:a,onOpenChange:k,children:e.jsxs(De,{className:"w-[calc(100vw-2rem)] max-w-[500px]",children:[e.jsxs(Be,{children:[e.jsxs(Fe,{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"h-5 w-5"}),"Bankkonto verbinden"]}),e.jsx(ze,{children:q[i].description})]}),e.jsx("div",{className:"flex items-center gap-2 mb-4",children:q.map((r,L)=>e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsx("div",{className:f("flex items-center justify-center w-7 h-7 rounded-full text-xs font-medium transition-colors",L<i?"bg-green-100 text-green-700":L===i?"bg-primary text-primary-foreground":"bg-muted text-muted-foreground"),children:L<i?e.jsx(de,{className:"h-4 w-4"}):L+1}),L<q.length-1&&e.jsx("div",{className:f("flex-1 h-0.5 rounded",L<i?"bg-green-300":"bg-muted")})]},L))}),i===0&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{htmlFor:"bankName",children:"Bankname *"}),e.jsx(M,{id:"bankName",value:y,onChange:r=>T(r.target.value),placeholder:"z.B. Deutsche Bank, Sparkasse, N26",autoFocus:!0}),A.bankName&&e.jsx("p",{className:"text-xs text-destructive",children:A.bankName})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{htmlFor:"iban",children:"IBAN *"}),e.jsx(M,{id:"iban",value:N,onChange:r=>n(hs(r.target.value)),placeholder:"DE89 3704 0044 0532 0130 00",className:"font-mono",maxLength:40}),A.iban&&e.jsx("p",{className:"text-xs text-destructive",children:A.iban})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(_,{htmlFor:"bic",children:["BIC ",e.jsx("span",{className:"text-xs text-muted-foreground",children:"(optional)"})]}),e.jsx(M,{id:"bic",value:u,onChange:r=>w(r.target.value.toUpperCase()),placeholder:"z.B. DEUTDEDB",className:"font-mono",maxLength:11})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(_,{htmlFor:"accountName",children:["Kontoname ",e.jsx("span",{className:"text-xs text-muted-foreground",children:"(optional)"})]}),e.jsx(M,{id:"accountName",value:v,onChange:r=>z(r.target.value),placeholder:"z.B. GeschÃ¤ftskonto, Sparkonto"})]}),e.jsxs("div",{className:"flex items-start gap-2 text-xs text-muted-foreground bg-blue-50 dark:bg-blue-950/30 p-3 rounded-lg",children:[e.jsx(Ge,{className:"h-4 w-4 flex-shrink-0 mt-0.5 text-blue-500"}),e.jsx("p",{children:"Aktuell werden Konten manuell verbunden. FinAPI-Integration fÃ¼r automatischen Import wird in einer zukÃ¼nftigen Version verfÃ¼gbar."})]})]}),i===1&&e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{htmlFor:"balance",children:"Aktueller Kontostand (â‚¬)"}),e.jsx(M,{id:"balance",type:"number",step:"0.01",value:I,onChange:r=>p(r.target.value),placeholder:"0,00",className:"text-lg font-mono",autoFocus:!0}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Geben Sie den aktuellen Kontostand ein. Dieser kann jederzeit durch Synchronisierung aktualisiert werden."})]})}),i===2&&e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"rounded-lg border bg-muted/50 p-4 space-y-3",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Bank"}),e.jsx("span",{className:"font-medium",children:y})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"IBAN"}),e.jsx("span",{className:"font-mono text-xs",children:N})]}),u&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"BIC"}),e.jsx("span",{className:"font-mono text-xs",children:u})]}),v&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Kontoname"}),e.jsx("span",{children:v})]}),e.jsxs("div",{className:"flex justify-between text-sm border-t pt-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Anfangssaldo"}),e.jsx("span",{className:"font-semibold",children:I?new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(parseFloat(I)):"â‚¬0,00"})]})]})}),e.jsxs("div",{className:"flex justify-between pt-2",children:[e.jsx(F,{variant:"outline",onClick:i===0?()=>k(!1):U,disabled:S,children:i===0?"Abbrechen":e.jsxs(e.Fragment,{children:[e.jsx(Pe,{className:"h-4 w-4 mr-2"}),"ZurÃ¼ck"]})}),i<q.length-1?e.jsxs(F,{onClick:$,children:["Weiter",e.jsx(Ze,{className:"h-4 w-4 ml-2"})]}):e.jsxs(F,{onClick:d,disabled:S,children:[S?e.jsx(ne,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(de,{className:"h-4 w-4 mr-2"}),"Konto verbinden"]})]})]})})}const ae={unmatched:{label:"Offen",dotColor:"bg-yellow-500",bgColor:"hover:bg-yellow-50 dark:hover:bg-yellow-950/20"},auto_matched:{label:"Auto-Match",dotColor:"bg-blue-500",bgColor:"hover:bg-blue-50 dark:hover:bg-blue-950/20"},manual_matched:{label:"Zugeordnet",dotColor:"bg-green-500",bgColor:"hover:bg-green-50 dark:hover:bg-green-950/20"},booked:{label:"Gebucht",dotColor:"bg-green-500",bgColor:"hover:bg-green-50 dark:hover:bg-green-950/20"},ignored:{label:"Ignoriert",dotColor:"bg-gray-400",bgColor:"hover:bg-gray-50 dark:hover:bg-gray-950/20 opacity-60"}};function ve(a){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(a)}function ye(a){return new Date(a).toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"})}function js({transactions:a,accounts:o,isLoading:j,onRowClick:i,page:h,setPage:S,pageSize:x,totalPages:y,className:T}){const[N,n]=t.useState(""),[u,w]=t.useState("all"),[v,z]=t.useState("all"),[I,p]=t.useState(!1),[A,l]=t.useState(""),[C,k]=t.useState(""),[D,$]=t.useState(""),[U,d]=t.useState(""),[r,L]=t.useState("date"),[O,m]=t.useState("desc"),c=t.useMemo(()=>{let s=a;if(N){const g=N.toLowerCase();s=s.filter(R=>{var V,xe;return((V=R.counterpart_name)==null?void 0:V.toLowerCase().includes(g))||((xe=R.purpose)==null?void 0:xe.toLowerCase().includes(g))||String(R.amount).includes(g)})}return u!=="all"&&(s=s.filter(g=>g.match_status===u)),v!=="all"&&(s=s.filter(g=>g.account_id===v)),A&&(s=s.filter(g=>g.booking_date>=A)),C&&(s=s.filter(g=>g.booking_date<=C)),D&&(s=s.filter(g=>Math.abs(g.amount)>=parseFloat(D))),U&&(s=s.filter(g=>Math.abs(g.amount)<=parseFloat(U))),s},[a,N,u,v,A,C,D,U]),b=t.useMemo(()=>{const s=[...c];return s.sort((g,R)=>{let V=0;return r==="date"?V=g.booking_date.localeCompare(R.booking_date):V=g.amount-R.amount,O==="asc"?V:-V}),s},[c,r,O]),P=t.useMemo(()=>{const s=(h-1)*x;return b.slice(s,s+x)},[b,h,x]),le=Math.max(1,Math.ceil(b.length/x)),ue=s=>{r===s?m(g=>g==="asc"?"desc":"asc"):(L(s),m("desc"))},he=(u!=="all"?1:0)+(v!=="all"?1:0)+(A?1:0)+(C?1:0)+(D?1:0)+(U?1:0);return e.jsxs("div",{className:f("space-y-4",T),children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(He,{className:"absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground"}),e.jsx(M,{placeholder:"Suchen (Auftraggeber, Zweck, Betrag)...",value:N,onChange:s=>n(s.target.value),className:"pl-8"})]}),e.jsxs(J,{value:u,onValueChange:w,children:[e.jsx(Q,{className:"w-full sm:w-44",children:e.jsx(ee,{placeholder:"Status"})}),e.jsxs(se,{children:[e.jsx(E,{value:"all",children:"Alle Status"}),e.jsx(E,{value:"unmatched",children:"Offen"}),e.jsx(E,{value:"auto_matched",children:"Auto-Match"}),e.jsx(E,{value:"manual_matched",children:"Zugeordnet"}),e.jsx(E,{value:"booked",children:"Gebucht"}),e.jsx(E,{value:"ignored",children:"Ignoriert"})]})]}),e.jsx(ge,{open:I,onOpenChange:p,children:e.jsx(Le,{asChild:!0,children:e.jsxs(F,{variant:"outline",size:"default",className:"gap-2",children:[e.jsx(We,{className:"h-4 w-4"}),"Filter",he>0&&e.jsx(G,{variant:"secondary",className:"ml-1 h-5 w-5 p-0 flex items-center justify-center text-[10px]",children:he})]})})})]}),e.jsx(ge,{open:I,onOpenChange:p,children:e.jsx(Ke,{children:e.jsxs("div",{className:"rounded-lg border bg-muted/30 p-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3",children:[o&&o.length>1&&e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(_,{className:"text-xs",children:"Konto"}),e.jsxs(J,{value:v,onValueChange:z,children:[e.jsx(Q,{children:e.jsx(ee,{placeholder:"Alle Konten"})}),e.jsxs(se,{children:[e.jsx(E,{value:"all",children:"Alle Konten"}),o.map(s=>e.jsx(E,{value:s.id,children:s.account_name||s.bank_name},s.id))]})]})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(_,{className:"text-xs",children:"Datum von"}),e.jsx(M,{type:"date",value:A,onChange:s=>l(s.target.value)})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(_,{className:"text-xs",children:"Datum bis"}),e.jsx(M,{type:"date",value:C,onChange:s=>k(s.target.value)})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(_,{className:"text-xs",children:"Betrag min (â‚¬)"}),e.jsx(M,{type:"number",step:"0.01",value:D,onChange:s=>$(s.target.value),placeholder:"0,00"})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(_,{className:"text-xs",children:"Betrag max (â‚¬)"}),e.jsx(M,{type:"number",step:"0.01",value:U,onChange:s=>d(s.target.value),placeholder:"âˆž"})]}),e.jsx("div",{className:"flex items-end",children:e.jsx(F,{variant:"ghost",size:"sm",onClick:()=>{z("all"),l(""),k(""),$(""),d("")},children:"Filter zurÃ¼cksetzen"})})]})})}),e.jsx("div",{className:"flex items-center justify-between text-sm text-muted-foreground",children:e.jsxs("span",{children:[b.length," Transaktionen"]})}),P.length===0?e.jsx("div",{className:"rounded-lg border border-dashed p-8 text-center text-muted-foreground",children:a.length===0?"Keine Transaktionen vorhanden.":"Keine Transaktionen gefunden."}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"hidden md:block rounded-md border",children:e.jsxs(ns,{children:[e.jsx(ts,{children:e.jsxs(be,{children:[e.jsxs(H,{className:"cursor-pointer select-none w-[100px]",onClick:()=>ue("date"),children:["Datum ",r==="date"&&(O==="asc"?"â†‘":"â†“")]}),e.jsx(H,{children:"Auftraggeber"}),e.jsx(H,{className:"hidden lg:table-cell",children:"Verwendungszweck"}),e.jsxs(H,{className:"text-right cursor-pointer select-none w-[120px]",onClick:()=>ue("amount"),children:["Betrag ",r==="amount"&&(O==="asc"?"â†‘":"â†“")]}),e.jsx(H,{className:"w-[120px]",children:"Status"})]})}),e.jsx(rs,{children:P.map(s=>{const g=ae[s.match_status]||ae.unmatched;return e.jsxs(be,{className:f("cursor-pointer transition-colors",g.bgColor),onClick:()=>i==null?void 0:i(s),children:[e.jsx(W,{className:"text-sm tabular-nums",children:ye(s.booking_date)}),e.jsx(W,{children:e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("div",{className:f("flex-shrink-0 p-1 rounded-full",s.amount>=0?"bg-green-100":"bg-red-100"),children:s.amount>=0?e.jsx(te,{className:"h-3 w-3 text-green-600"}):e.jsx(re,{className:"h-3 w-3 text-red-600"})}),e.jsx("span",{className:"font-medium truncate",children:s.counterpart_name||"Unbekannt"})]})}),e.jsx(W,{className:"hidden lg:table-cell text-sm text-muted-foreground truncate max-w-[300px]",children:s.purpose||"â€”"}),e.jsx(W,{className:"text-right",children:e.jsxs("span",{className:f("font-mono font-medium",s.amount>=0?"text-green-600":"text-red-600"),children:[s.amount>=0?"+":"",ve(s.amount)]})}),e.jsx(W,{children:e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:f("w-2 h-2 rounded-full",g.dotColor)}),e.jsx("span",{className:"text-xs",children:g.label})]})})]},s.id)})})]})}),e.jsx("div",{className:"md:hidden space-y-1",children:P.map(s=>{const g=ae[s.match_status]||ae.unmatched;return e.jsxs("div",{className:f("flex items-center justify-between p-3 rounded-lg border cursor-pointer",g.bgColor),onClick:()=>i==null?void 0:i(s),children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0 flex-1",children:[e.jsx("div",{className:f("flex-shrink-0 p-1.5 rounded-full",s.amount>=0?"bg-green-100":"bg-red-100"),children:s.amount>=0?e.jsx(te,{className:"h-4 w-4 text-green-600"}):e.jsx(re,{className:"h-4 w-4 text-red-600"})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"font-medium truncate text-sm",children:s.counterpart_name||"Unbekannt"}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:s.purpose||"â€”"})]})]}),e.jsxs("div",{className:"text-right flex-shrink-0 ml-2",children:[e.jsxs("p",{className:f("font-mono font-medium text-sm",s.amount>=0?"text-green-600":"text-red-600"),children:[s.amount>=0?"+":"",ve(s.amount)]}),e.jsxs("div",{className:"flex items-center justify-end gap-1 mt-0.5",children:[e.jsx("div",{className:f("w-1.5 h-1.5 rounded-full",g.dotColor)}),e.jsx("span",{className:"text-[10px] text-muted-foreground",children:ye(s.booking_date)})]})]})]},s.id)})}),le>1&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-sm text-muted-foreground",children:["Seite ",h," von ",le]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(F,{variant:"outline",size:"icon",className:"h-8 w-8",disabled:h<=1,onClick:()=>S(h-1),children:e.jsx(qe,{className:"h-4 w-4"})}),e.jsx(F,{variant:"outline",size:"icon",className:"h-8 w-8",disabled:h>=le,onClick:()=>S(h+1),children:e.jsx(Xe,{className:"h-4 w-4"})})]})]})]})]})}function fs(a){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(a)}function ps(a){return new Date(a).toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"})}function bs({open:a,onOpenChange:o,transaction:j,onMatchInvoice:i,onMatchExpense:h,onMatchIncome:S,onCreateExpense:x,onCreateIncome:y,onIgnore:T,onCreateRule:N}){const[n,u]=t.useState(null),[w,v]=t.useState(!1),[z,I]=t.useState(""),[p,A]=t.useState("other"),[l,C]=t.useState(""),[k,D]=t.useState(19),[$,U]=t.useState("");if(t.useEffect(()=>{a&&j&&(u(null),I(""),A("other"),C(j.purpose||""),D(19),U(""),j.amount>0?u("create_income"):u("create_expense"))},[a,j]),!j)return null;const d=j,r=d.amount>=0,L=async()=>{if(n){v(!0);try{switch(n){case"match_invoice":await(i==null?void 0:i(d.id,z));break;case"match_expense":await(h==null?void 0:h(d.id,z));break;case"match_income":await(S==null?void 0:S(d.id,z));break;case"create_expense":await(x==null?void 0:x(d.id,{category:p,description:l||void 0,vat_rate:k}));break;case"create_income":await(y==null?void 0:y(d.id,{description:l||void 0,vat_rate:k}));break;case"ignore":await(T==null?void 0:T(d.id,$||void 0));break}o(!1)}catch{}finally{v(!1)}}},O=[{value:"match_invoice",label:"Rechnung zuordnen",icon:Ye,description:"Mit einer vorhandenen Rechnung verknÃ¼pfen",available:r},{value:"create_income",label:"Einnahme erstellen",icon:fe,description:"Neue Einnahme aus dieser Transaktion",available:r},{value:"create_expense",label:"Ausgabe erstellen",icon:pe,description:"Neue Ausgabe aus dieser Transaktion",available:!r},{value:"match_expense",label:"Ausgabe zuordnen",icon:pe,description:"Mit einer vorhandenen Ausgabe verknÃ¼pfen",available:!r},{value:"match_income",label:"Einnahme zuordnen",icon:fe,description:"Mit einer vorhandenen Einnahme verknÃ¼pfen",available:r},{value:"ignore",label:"Ignorieren",icon:Te,description:"Transaktion als irrelevant markieren",available:!0}];return e.jsx(Ae,{open:a,onOpenChange:o,children:e.jsxs(De,{className:"w-[calc(100vw-1rem)] max-w-[600px] max-h-[90vh] overflow-y-auto",children:[e.jsxs(Be,{children:[e.jsx(Fe,{children:"Transaktion zuordnen"}),e.jsx(ze,{children:"Ordnen Sie diese Transaktion einer Rechnung, Einnahme oder Ausgabe zu."})]}),e.jsxs("div",{className:"rounded-lg border bg-muted/30 p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:f("p-1.5 rounded-full",r?"bg-green-100":"bg-red-100"),children:r?e.jsx(te,{className:"h-4 w-4 text-green-600"}):e.jsx(re,{className:"h-4 w-4 text-red-600"})}),e.jsx("span",{className:"font-medium",children:d.counterpart_name||"Unbekannt"})]}),e.jsxs("span",{className:f("font-mono text-lg font-bold",r?"text-green-600":"text-red-600"),children:[r?"+":"",fs(d.amount)]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Datum: "}),e.jsx("span",{children:ps(d.booking_date)})]}),d.counterpart_iban&&e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"IBAN: "}),e.jsx("span",{className:"font-mono text-xs",children:d.counterpart_iban})]})]}),d.purpose&&e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Zweck: "}),e.jsx("span",{children:d.purpose})]}),d.match_confidence!==null&&d.match_confidence>0&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_e,{className:"h-4 w-4 text-blue-500"}),e.jsxs("span",{className:"text-sm text-blue-600",children:["Auto-Match Vorschlag (",Math.round(d.match_confidence*100),"% Konfidenz)"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{className:"text-sm font-medium",children:"Aktion wÃ¤hlen"}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2",children:O.filter(m=>m.available).map(m=>{const c=m.icon;return e.jsxs("button",{type:"button",className:f("flex items-start gap-3 p-3 rounded-lg border text-left transition-colors",n===m.value?"border-primary bg-primary/5 ring-1 ring-primary":"hover:bg-muted/50"),onClick:()=>u(m.value),children:[e.jsx(c,{className:"h-4 w-4 mt-0.5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:m.label}),e.jsx("p",{className:"text-xs text-muted-foreground",children:m.description})]})]},m.value)})})]}),n&&e.jsxs("div",{className:"space-y-4 border-t pt-4",children:[(n==="match_invoice"||n==="match_expense"||n==="match_income")&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:n==="match_invoice"?"Rechnungsnummer":n==="match_expense"?"Ausgaben-ID":"Einnahmen-ID"}),e.jsx(M,{value:z,onChange:m=>I(m.target.value),placeholder:"ID eingeben..."})]}),n==="create_expense"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"Kategorie"}),e.jsxs(J,{value:p,onValueChange:A,children:[e.jsx(Q,{children:e.jsx(ee,{})}),e.jsx(se,{children:Object.entries(ls).map(([m,c])=>e.jsx(E,{value:m,children:c.label},m))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"Beschreibung"}),e.jsx(M,{value:l,onChange:m=>C(m.target.value),placeholder:d.purpose||d.counterpart_name||""})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"MwSt-Satz"}),e.jsxs(J,{value:String(k),onValueChange:m=>D(Number(m)),children:[e.jsx(Q,{children:e.jsx(ee,{})}),e.jsxs(se,{children:[e.jsx(E,{value:"19",children:"19%"}),e.jsx(E,{value:"7",children:"7%"}),e.jsx(E,{value:"0",children:"0%"})]})]})]})]}),n==="create_income"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"Beschreibung"}),e.jsx(M,{value:l,onChange:m=>C(m.target.value),placeholder:d.purpose||d.counterpart_name||""})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"MwSt-Satz"}),e.jsxs(J,{value:String(k),onValueChange:m=>D(Number(m)),children:[e.jsx(Q,{children:e.jsx(ee,{})}),e.jsxs(se,{children:[e.jsx(E,{value:"19",children:"19%"}),e.jsx(E,{value:"7",children:"7%"}),e.jsx(E,{value:"0",children:"0%"})]})]})]})]}),n==="ignore"&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs(_,{children:["Grund ",e.jsx("span",{className:"text-xs text-muted-foreground",children:"(optional)"})]}),e.jsx(M,{value:$,onChange:m=>U(m.target.value),placeholder:"z.B. Private Transaktion, Umbuchung..."})]})]}),e.jsxs("div",{className:"flex flex-col-reverse sm:flex-row justify-between gap-2 pt-2",children:[e.jsx("div",{className:"flex gap-2",children:N&&e.jsxs(F,{variant:"outline",size:"sm",onClick:()=>{N(d),o(!1)},children:[e.jsx(Je,{className:"h-4 w-4 mr-1.5"}),"Regel erstellen"]})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(F,{variant:"outline",onClick:()=>o(!1),children:"Abbrechen"}),e.jsxs(F,{onClick:L,disabled:!n||w,children:[w?e.jsx(ne,{className:"h-4 w-4 mr-2 animate-spin"}):null,"Zuordnen"]})]})]})]})})}const me=t.forwardRef(({className:a,...o},j)=>e.jsx(Ie,{ref:j,className:f("peer h-4 w-4 shrink-0 rounded-sm border border-primary shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",a),...o,children:e.jsx(cs,{className:f("flex items-center justify-center text-current"),children:e.jsx(de,{className:"h-3.5 w-3.5"})})}));me.displayName=Ie.displayName;function Ns(a){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(a)}function vs(a){return new Date(a).toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit"})}function ys({transactions:a,isLoading:o,onAutoMatchAll:j,onIgnoreSelected:i,onRowClick:h,className:S}){const[x,y]=t.useState(new Set),[T,N]=t.useState(!1),[n,u]=t.useState(!1),w=a.filter(l=>l.match_status==="unmatched"),v=w.filter(l=>l.match_confidence!==null&&l.match_confidence>.5).length,z=l=>{y(C=>{const k=new Set(C);return k.has(l)?k.delete(l):k.add(l),k})},I=()=>{x.size===w.length?y(new Set):y(new Set(w.map(l=>l.id)))},p=async()=>{N(!0);try{await(j==null?void 0:j())}finally{N(!1)}},A=async()=>{u(!0);try{await(i==null?void 0:i(Array.from(x))),y(new Set)}finally{u(!1)}};return w.length===0?e.jsx(X,{className:S,children:e.jsxs(Y,{className:"py-12 text-center",children:[e.jsx(Qe,{className:"h-12 w-12 mx-auto mb-4 text-green-500/50"}),e.jsx("p",{className:"text-muted-foreground font-medium",children:"Alle Transaktionen zugeordnet! ðŸŽ‰"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Keine offenen Transaktionen vorhanden."})]})}):e.jsxs(X,{className:S,children:[e.jsx(we,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ke,{className:"text-base",children:"Offene Transaktionen"}),e.jsx(G,{variant:"destructive",className:"h-6",children:w.length})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[x.size>0&&e.jsxs(F,{variant:"outline",size:"sm",onClick:A,disabled:n,children:[n?e.jsx(ne,{className:"h-3.5 w-3.5 mr-1.5 animate-spin"}):e.jsx(Te,{className:"h-3.5 w-3.5 mr-1.5"}),x.size," ignorieren"]}),e.jsxs(F,{size:"sm",onClick:p,disabled:T||w.length===0,children:[T?e.jsx(ne,{className:"h-3.5 w-3.5 mr-1.5 animate-spin"}):e.jsx(es,{className:"h-3.5 w-3.5 mr-1.5"}),"Auto-Match",v>0&&e.jsx(G,{variant:"secondary",className:"ml-1.5 h-5 text-[10px]",children:v})]})]})]})}),e.jsxs(Y,{className:"pt-0",children:[e.jsxs("div",{className:"flex items-center gap-2 pb-2 border-b mb-2",children:[e.jsx(me,{checked:x.size===w.length&&w.length>0,onCheckedChange:I,"aria-label":"Alle auswÃ¤hlen"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"Alle auswÃ¤hlen"})]}),e.jsx("div",{className:"space-y-1 max-h-[400px] overflow-y-auto",children:w.map(l=>{const C=l.amount>=0,k=l.match_confidence!==null&&l.match_confidence>.5,D=x.has(l.id);return e.jsxs("div",{className:f("flex items-center gap-3 p-2.5 rounded-lg border transition-colors",D?"bg-primary/5 border-primary/30":k?"bg-blue-50/50 dark:bg-blue-950/20 hover:bg-blue-50 dark:hover:bg-blue-950/30":"hover:bg-muted/50"),children:[e.jsx(me,{checked:D,onCheckedChange:()=>z(l.id),onClick:$=>$.stopPropagation(),"aria-label":`Transaktion ${l.counterpart_name||"auswÃ¤hlen"}`}),e.jsxs("div",{className:"flex items-center gap-3 flex-1 min-w-0 cursor-pointer",onClick:()=>h==null?void 0:h(l),children:[e.jsx("div",{className:f("flex-shrink-0 p-1 rounded-full",C?"bg-green-100":"bg-red-100"),children:C?e.jsx(te,{className:"h-3 w-3 text-green-600"}):e.jsx(re,{className:"h-3 w-3 text-red-600"})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("p",{className:"font-medium text-sm truncate",children:l.counterpart_name||"Unbekannt"}),k&&e.jsx(_e,{className:"h-3.5 w-3.5 text-blue-500 flex-shrink-0"})]}),e.jsxs("p",{className:"text-xs text-muted-foreground truncate",children:[l.purpose||"â€”"," Â· ",vs(l.booking_date)]})]}),e.jsxs("span",{className:f("font-mono font-medium text-sm flex-shrink-0",C?"text-green-600":"text-red-600"),children:[C?"+":"",Ns(l.amount)]})]})]},l.id)})})]})]})}function Os(){const[a,o]=t.useState([]),[j,i]=t.useState([]),[h,S]=t.useState(!0),[x,y]=t.useState(null),[T,N]=t.useState(!1),[n,u]=t.useState(null),[w,v]=t.useState(1),z=50,I=Math.max(1,Math.ceil(j.length/z)),p=t.useCallback(async()=>{try{const[c,b]=await Promise.all([K.getAccounts(),K.getTransactions()]);o(c),i(b)}catch{B.error("Fehler beim Laden der Bankdaten")}finally{S(!1)}},[]);t.useEffect(()=>{p()},[p]);const A=async c=>{try{await K.connectAccount(c),B.success("Bankkonto verbunden"),p()}catch{throw B.error("Fehler beim Verbinden"),new Error("connect failed")}},l=async c=>{y(c);try{const b=await K.syncAccount(c);B.success(`${b.transactions_imported} Transaktionen importiert`),p()}catch{B.error("Synchronisierung fehlgeschlagen")}finally{y(null)}},C=async c=>{try{await K.deleteAccount(c),B.success("Bankkonto entfernt"),p()}catch{B.error("Fehler beim Entfernen")}},k=async(c,b)=>{await K.matchTransaction(c,"invoice",b),B.success("Transaktion zugeordnet"),p()},D=async(c,b)=>{await K.matchTransaction(c,"expense",b),B.success("Transaktion zugeordnet"),p()},$=async(c,b)=>{await K.matchTransaction(c,"income",b),B.success("Transaktion zugeordnet"),p()},U=async(c,b)=>{await K.createExpenseFromTransaction(c,b),B.success("Ausgabe erstellt und zugeordnet"),p()},d=async(c,b)=>{await K.createIncomeFromTransaction(c,b),B.success("Einnahme erstellt und zugeordnet"),p()},r=async(c,b)=>{await K.ignoreTransaction(c,b),B.success("Transaktion ignoriert"),p()},L=async()=>{try{const c=await K.autoMatch();B.success(`${c.matched} von ${c.total_processed} Transaktionen zugeordnet`),p()}catch{B.error("Auto-Match fehlgeschlagen")}},O=async c=>{let b=0;for(const P of c)try{await K.ignoreTransaction(P),b++}catch{}B.success(`${b} Transaktionen ignoriert`),p()},m=j.filter(c=>c.match_status==="unmatched").length;return h?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"h-6 w-6 animate-spin rounded-full border-2 border-primary border-t-transparent"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Banking"}),e.jsx("p",{className:"text-muted-foreground",children:"Bankkonten & Transaktionen verwalten"})]}),e.jsx(us,{accounts:a,isLoading:!1,onConnectAccount:()=>N(!0),onSyncAccount:l,onDeleteAccount:C,syncingAccountId:x}),e.jsxs(Ee,{defaultValue:"transactions",className:"w-full",children:[e.jsxs(Me,{className:"flex w-full overflow-x-auto gap-1",children:[e.jsxs(ce,{value:"transactions",className:"flex items-center gap-1.5",children:[e.jsx(ss,{className:"h-4 w-4"}),"Transaktionen",e.jsx(G,{variant:"secondary",className:"h-5 text-[10px] ml-1",children:j.length})]}),e.jsxs(ce,{value:"unmatched",className:"flex items-center gap-1.5",children:[e.jsx(Ce,{className:"h-4 w-4"}),"Offen",m>0&&e.jsx(G,{variant:"destructive",className:"h-5 text-[10px] ml-1",children:m})]}),e.jsxs(ce,{value:"reconciliation",className:"flex items-center gap-1.5",children:[e.jsx(as,{className:"h-4 w-4"}),"Abstimmung"]})]}),e.jsx(ie,{value:"transactions",className:"mt-4",children:e.jsx(js,{transactions:j,accounts:a,onRowClick:u,page:w,setPage:v,pageSize:z,totalPages:I})}),e.jsx(ie,{value:"unmatched",className:"mt-4",children:e.jsx(ys,{transactions:j,onAutoMatchAll:L,onIgnoreSelected:O,onRowClick:u})}),e.jsx(ie,{value:"reconciliation",className:"mt-4",children:e.jsx(is,{transactions:j})})]}),e.jsx(gs,{open:T,onOpenChange:N,onConnect:A}),e.jsx(bs,{open:!!n,onOpenChange:c=>!c&&u(null),transaction:n,onMatchInvoice:k,onMatchExpense:D,onMatchIncome:$,onCreateExpense:U,onCreateIncome:d,onIgnore:r})]})}export{Os as BankingPage};
