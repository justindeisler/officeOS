import{r as u,j as e}from"./vendor-react-DeR5d9Tv.js";import{D as Z,a as $}from"./dialog-BL6SFop0.js";import{u as Q,a as J,o as ee,s as T,e as U,b as te,n as z}from"./vendor-forms-slL2B-gN.js";import{G as B}from"./index-uXN-dP3D.js";import{m as k,j as M,L as N,I as P,B as re,a as H,r as ae}from"./index-RJ0cNIvj.js";import{T as se}from"./triangle-alert-DD7JH2M1.js";function Y(r){const t={};for(const[n,c]of Object.entries(r)){const l=n.replace(/_([a-z])/g,(w,f)=>f.toUpperCase());t[l]=c}return t}function K(r){const t={};for(const[n,c]of Object.entries(r))if(c instanceof Date){const l=n.replace(/[A-Z]/g,w=>`_${w.toLowerCase()}`);t[l]=c.toISOString().split("T")[0]}else{const l=n.replace(/[A-Z]/g,w=>`_${w.toLowerCase()}`);t[l]=c}return t}function V(r){const t=Y(r);return{id:String(t.id??""),date:new Date(t.date),vendor:String(t.vendor??""),description:String(t.description??""),netAmount:Number(t.netAmount)||0,vatRate:Number(t.vatRate)||0,vatAmount:Number(t.vatAmount)||0,grossAmount:Number(t.grossAmount)||0,euerLine:Number(t.euerLine)||34,euerCategory:String(t.euerCategory??"Sonstige Aufwendungen"),deductiblePercent:Number(t.deductiblePercent)||100,paymentMethod:t.paymentMethod,receiptPath:t.receiptPath,isRecurring:!!t.isRecurring,recurringFrequency:t.recurringFrequency,ustPeriod:t.ustPeriod,vorsteuerClaimed:!!(t.vorsteuerClaimed||t.ustReported),isGwg:!!t.isGwg,assetId:t.assetId,createdAt:new Date(t.createdAt)}}class ne{async getAll(t){const n=t?{start_date:t.startDate,end_date:t.endDate,category:t.category,vendor:t.vendor}:void 0;return(await k.getExpenses(n)).map(l=>V(l))}async getById(t){try{const n=await k.getExpenseById(t);return V(n)}catch{return null}}async create(t){const n=K(t),c=await k.createExpense(n);return V(c)}async update(t,n){const c=K(n);await k.updateExpense(t,c)}async delete(t){await k.deleteExpense(t)}async getCategories(){return(await k.getExpenseCategories()).map(n=>Y(n))}async markReported(t,n){await k.markExpensesReported(t,n)}}const j=new ne;function ie(r={}){const{autoFetch:t=!0,dateRange:n,ustPeriod:c,category:l,recurring:w}=r,[f,y]=u.useState([]),[E,g]=u.useState(!1),[b,d]=u.useState(null),[h,S]=u.useState(null),m=u.useCallback(async()=>{g(!0),d(null);try{const a=await j.getAll();y(a)}catch(a){d(a instanceof Error?a.message:"Failed to fetch expenses")}finally{g(!1)}},[]),C=u.useCallback(async(a,s)=>{g(!0),d(null);try{const o=await j.getAll({startDate:a.toISOString().split("T")[0],endDate:s.toISOString().split("T")[0]});y(o)}catch(o){d(o instanceof Error?o.message:"Failed to fetch expenses")}finally{g(!1)}},[]),A=u.useCallback(async a=>{g(!0),d(null);try{const o=(await j.getAll()).filter(v=>v.ustPeriod===a);y(o)}catch(s){d(s instanceof Error?s.message:"Failed to fetch expenses")}finally{g(!1)}},[]),D=u.useCallback(async a=>{g(!0),d(null);try{const s=await j.getAll({category:a});y(s)}catch(s){d(s instanceof Error?s.message:"Failed to fetch expenses")}finally{g(!1)}},[]),O=u.useCallback(async a=>{g(!0),d(null);try{const s=await j.create(a);return y(o=>[s,...o]),s}catch(s){return d(s instanceof Error?s.message:"Failed to create expense"),null}finally{g(!1)}},[]),R=u.useCallback(async(a,s)=>{g(!0),d(null);try{await j.update(a,s);const o=await j.getById(a);return o&&(y(v=>v.map(x=>x.id===a?o:x)),(h==null?void 0:h.id)===a&&S(o)),o}catch(o){return d(o instanceof Error?o.message:"Failed to update expense"),null}finally{g(!1)}},[h]),G=u.useCallback(async a=>{g(!0),d(null);try{return await j.delete(a),y(s=>s.filter(o=>o.id!==a)),(h==null?void 0:h.id)===a&&S(null),!0}catch(s){return d(s instanceof Error?s.message:"Failed to delete expense"),!1}finally{g(!1)}},[h]),F=u.useCallback(async a=>{g(!0),d(null);try{await j.markReported(a),y(s=>s.map(o=>a.includes(o.id)?{...o,vorsteuerClaimed:!0}:o))}catch(s){d(s instanceof Error?s.message:"Failed to mark as claimed")}finally{g(!1)}},[]),I=u.useCallback(async()=>{try{return(await j.getAll()).filter(s=>s.isRecurring)}catch(a){return d(a instanceof Error?a.message:"Failed to get recurring expenses"),[]}},[]),q=u.useCallback(async()=>{try{return(await j.getAll()).filter(s=>s.isGwg)}catch(a){return d(a instanceof Error?a.message:"Failed to get GWG expenses"),[]}},[]),i=u.useCallback(async(a,s)=>{try{const o=await j.getAll({startDate:a.toISOString().split("T")[0],endDate:s.toISOString().split("T")[0]}),v={total:0,byCategory:{},byVatRate:{}};for(const x of o)v.total+=x.vatAmount,v.byCategory[x.euerCategory]||(v.byCategory[x.euerCategory]=0),v.byCategory[x.euerCategory]+=x.vatAmount,v.byVatRate[x.vatRate]||(v.byVatRate[x.vatRate]=0),v.byVatRate[x.vatRate]+=x.vatAmount;return v}catch(o){return d(o instanceof Error?o.message:"Failed to get Vorsteuer summary"),null}},[]),p=u.useCallback(async()=>{n?await C(n.start,n.end):c?await A(c):l?await D(l):await m()},[n,c,l,C,A,D,m]);return u.useEffect(()=>{t&&p()},[t,p]),{expenses:f,isLoading:E,error:b,fetchExpenses:m,fetchByDateRange:C,fetchByUstPeriod:A,fetchByCategory:D,createExpense:O,updateExpense:R,deleteExpense:G,markVorsteuerClaimed:F,getRecurringExpenses:I,getGwgExpenses:q,getVorsteuerSummary:i,selectedExpense:h,setSelectedExpense:S,refresh:p}}function W(r,t){const n=Math.round(r*100)/100,c=Math.round(n*(t/100)*100)/100,l=Math.round((n+c)*100)/100;return{net:n,vat:c,gross:l}}function L(r,t){const n=Math.round(r*100)/100;if(t===0)return{net:n,vat:0,gross:n};const c=Math.round(n/(1+t/100)*100)/100,l=Math.round((n-c)*100)/100;return{net:c,vat:l,gross:n}}const oe=ee({date:T().min(1,"Date is required"),vendor:T().min(1,"Vendor is required"),description:T().min(1,"Description is required"),netAmount:z().positive("Amount must be positive"),vatRate:U(["0","7","19"]),euerCategory:T().min(1),deductiblePercent:z().min(0).max(100,"Must be between 0 and 100"),isRecurring:te(),recurringFrequency:U(["monthly","quarterly","yearly"]).optional(),receiptPath:T().optional()});function _(r){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(r)}const X=[{value:"software",label:"Software & Lizenzen",line:34},{value:"telecom",label:"Telekommunikation",line:34},{value:"hosting",label:"Hosting & Domains",line:34},{value:"travel",label:"Reisekosten",line:34},{value:"insurance",label:"Versicherungen",line:34},{value:"bank_fees",label:"Kontoführung",line:34},{value:"training",label:"Fortbildung",line:34},{value:"books",label:"Fachliteratur",line:34},{value:"office_supplies",label:"Büromaterial",line:34},{value:"subcontractor",label:"Fremdleistungen",line:25},{value:"homeoffice",label:"Arbeitszimmer",line:33}];function ce(r){return r<=0?null:r<=B.SOFORTABSCHREIBUNG?"immediate":r<=B.GWG_MAX?"gwg":r<=B.POOL_MAX?"pool":"afa"}function le({expense:r,onSubmit:t,onCancel:n,className:c}){const[l,w]=u.useState(!1),[f,y]=u.useState("net"),E=!!r,g={date:r!=null&&r.date?r.date.toISOString().split("T")[0]:new Date().toISOString().split("T")[0],vendor:(r==null?void 0:r.vendor)??"",description:(r==null?void 0:r.description)??"",netAmount:(r==null?void 0:r.netAmount)??0,vatRate:String((r==null?void 0:r.vatRate)??19),euerCategory:(r==null?void 0:r.euerCategory)??"software",deductiblePercent:(r==null?void 0:r.deductiblePercent)??100,isRecurring:(r==null?void 0:r.isRecurring)??!1,recurringFrequency:r==null?void 0:r.recurringFrequency,receiptPath:(r==null?void 0:r.receiptPath)??""},{register:b,handleSubmit:d,watch:h,setValue:S,formState:{errors:m}}=Q({resolver:J(oe),defaultValues:g}),C=h("netAmount"),A=h("vatRate"),D=h("isRecurring"),O=h("euerCategory"),R=u.useMemo(()=>{const i=Number(C)||0,p=A!=null?Number(A):19;return f==="gross"?{...L(i,p),rate:p}:{...W(i,p),rate:p}},[C,A,f]),G=u.useCallback(i=>{if(i===f)return;const p=Number(C)||0,a=Number(A)||19;if(i==="gross"){const s=W(p,a);S("netAmount",s.gross)}else{const s=L(p,a);S("netAmount",s.net)}y(i)},[f,C,A,S]),F=u.useMemo(()=>ce(R.net),[R.net]),I=X.find(i=>i.value===O),q=async i=>{w(!0);try{let p=i.netAmount;f==="gross"&&(p=L(i.netAmount,Number(i.vatRate)).net);const a={date:new Date(i.date),vendor:i.vendor,description:i.description,netAmount:p,vatRate:Number(i.vatRate),euerLine:(I==null?void 0:I.line)??34,euerCategory:i.euerCategory,deductiblePercent:i.deductiblePercent,isRecurring:i.isRecurring,recurringFrequency:i.isRecurring?i.recurringFrequency:void 0,receiptPath:i.receiptPath||void 0};await t(a)}finally{w(!1)}};return e.jsxs("form",{onSubmit:d(q),className:M("space-y-6",c),children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:E?"Edit Expense":"Add Expense"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:E?"Update the expense record details below.":"Enter the details for the new expense record."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"date",children:"Date"}),e.jsx(P,{id:"date",type:"date",...b("date"),"aria-invalid":!!m.date}),m.date&&e.jsx("p",{className:"text-sm text-destructive",children:m.date.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"vendor",children:"Vendor"}),e.jsx(P,{id:"vendor",placeholder:"e.g., Amazon, Adobe, etc.",...b("vendor"),"aria-invalid":!!m.vendor}),m.vendor&&e.jsx("p",{className:"text-sm text-destructive",children:m.vendor.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"description",children:"Description"}),e.jsx(P,{id:"description",placeholder:"e.g., Software subscription, Office supplies",...b("description"),"aria-invalid":!!m.description}),m.description&&e.jsx("p",{className:"text-sm text-destructive",children:m.description.message})]}),e.jsxs("div",{className:"flex items-center gap-1 rounded-lg bg-muted p-1 w-fit",role:"radiogroup","aria-label":"Amount input mode",children:[e.jsx("button",{type:"button",role:"radio","aria-checked":f==="net","aria-label":"Net Amount",className:M("px-3 py-1.5 rounded-md text-sm font-medium transition-colors",f==="net"?"bg-background text-foreground shadow-sm":"text-muted-foreground hover:text-foreground"),onClick:()=>G("net"),children:"Net"}),e.jsx("button",{type:"button",role:"radio","aria-checked":f==="gross","aria-label":"Gross Amount",className:M("px-3 py-1.5 rounded-md text-sm font-medium transition-colors",f==="gross"?"bg-background text-foreground shadow-sm":"text-muted-foreground hover:text-foreground"),onClick:()=>G("gross"),children:"Gross"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"netAmount",children:f==="gross"?"Gross Amount (€)":"Net Amount (€)"}),e.jsx(P,{id:"netAmount",type:"number",step:"0.01",min:"0",placeholder:"0.00",...b("netAmount",{valueAsNumber:!0}),"aria-invalid":!!m.netAmount}),m.netAmount&&e.jsx("p",{className:"text-sm text-destructive",children:m.netAmount.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"vatRate",children:"VAT Rate"}),e.jsxs("select",{id:"vatRate",className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",...b("vatRate"),children:[e.jsx("option",{value:"19",children:"19%"}),e.jsx("option",{value:"7",children:"7%"}),e.jsx("option",{value:"0",children:"0%"})]})]})]}),e.jsxs("div",{className:"rounded-lg bg-muted p-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-2 sm:gap-4 text-sm flex-1",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Net"}),e.jsx("div",{className:"font-medium",children:_(R.net)})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-muted-foreground",children:["Vorsteuer (",R.rate,"%)"]}),e.jsx("div",{className:"font-medium",children:_(R.vat)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Gross"}),e.jsx("div",{className:"font-semibold",children:_(R.gross)})]})]}),F==="gwg"&&e.jsx(re,{variant:"default",className:"ml-4",children:"GWG"})]}),(F==="pool"||F==="afa")&&e.jsxs("div",{className:"mt-3 flex items-center gap-2 text-sm text-amber-600",children:[e.jsx(se,{className:"h-4 w-4"}),e.jsx("span",{children:F==="afa"?"This expense should be recorded as an asset with depreciation (AfA).":"This expense can be depreciated via pool method or regular AfA."})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"euerCategory",children:"Category"}),e.jsx("select",{id:"euerCategory",className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",...b("euerCategory"),children:X.map(i=>e.jsx("option",{value:i.value,children:i.label},i.value))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"deductiblePercent",children:"Deductible (%)"}),e.jsx(P,{id:"deductiblePercent",type:"number",step:"1",min:"0",max:"100",...b("deductiblePercent",{valueAsNumber:!0}),"aria-invalid":!!m.deductiblePercent}),m.deductiblePercent&&e.jsx("p",{className:"text-sm text-destructive",children:m.deductiblePercent.message})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{id:"isRecurring",type:"checkbox",className:"h-4 w-4 rounded border-input",...b("isRecurring")}),e.jsx(N,{htmlFor:"isRecurring",className:"cursor-pointer",children:"Recurring expense"})]}),D&&e.jsxs("div",{className:"space-y-2 ml-7",children:[e.jsx(N,{htmlFor:"recurringFrequency",children:"Frequency"}),e.jsxs("select",{id:"recurringFrequency",className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",...b("recurringFrequency"),children:[e.jsx("option",{value:"monthly",children:"Monthly"}),e.jsx("option",{value:"quarterly",children:"Quarterly"}),e.jsx("option",{value:"yearly",children:"Yearly"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"receiptPath",children:"Receipt Path (optional)"}),e.jsx(P,{id:"receiptPath",placeholder:"e.g., /receipts/2024/invoice.pdf",...b("receiptPath")})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx(H,{type:"button",variant:"outline",onClick:n,children:"Cancel"}),e.jsxs(H,{type:"submit",disabled:l,children:[l&&e.jsx(ae,{className:"mr-2 h-4 w-4 animate-spin"}),"Save"]})]})]})}function pe({open:r,onOpenChange:t,expense:n,onClose:c,onSuccess:l}){const{createExpense:w,updateExpense:f}=ie(),y=async E=>{n?await f(n.id,E):await w(E),l==null||l(),c()};return e.jsx(Z,{open:r,onOpenChange:t,children:e.jsx($,{className:"w-[calc(100vw-2rem)] max-w-[600px] max-h-[90vh] overflow-y-auto",children:e.jsx(le,{expense:n||void 0,onSubmit:y,onCancel:c})})})}export{pe as E,ie as u};
