import{g as m}from"./db-T8VULxQj.js";import{a7 as c,a8 as y}from"./index-D99RQVTX.js";const a=(e,t)=>y.request(e,t);function $(){return crypto.randomUUID()}function _(e,t){return Math.round(e*(t/100)*100)/100}function d(e){return{id:e.id,date:new Date(e.date),clientId:e.client_id,invoiceId:e.invoice_id,description:e.description,netAmount:e.net_amount,vatRate:e.vat_rate,vatAmount:e.vat_amount,grossAmount:e.gross_amount,euerLine:e.euer_line??14,euerCategory:e.euer_category??"services",paymentMethod:e.payment_method,bankReference:e.bank_reference,ustPeriod:e.ust_period,ustReported:e.ust_reported===1,createdAt:new Date(e.created_at??Date.now())}}async function I(){return c()?(await(await m()).select("SELECT * FROM income ORDER BY date DESC")).map(l):(await a("/api/income")).map(d)}async function f(e){if(!c())try{const i=await a(`/api/income/${e}`);return d(i)}catch{return null}const s=await(await m()).select("SELECT * FROM income WHERE id = $1",[e]);return s.length===0?null:l(s[0])}async function h(e,t){if(!c()){const n=e.toISOString().split("T")[0],o=t.toISOString().split("T")[0];return(await a(`/api/income?startDate=${n}&endDate=${o}`)).map(d)}return(await(await m()).select("SELECT * FROM income WHERE date >= $1 AND date <= $2 ORDER BY date DESC",[e.toISOString().split("T")[0],t.toISOString().split("T")[0]])).map(l)}async function b(e){return c()?(await(await m()).select("SELECT * FROM income WHERE ust_period = $1 ORDER BY date DESC",[e])).map(l):(await a(`/api/income?ustPeriod=${e}`)).map(d)}async function S(e){if(!c()){const p=await a("/api/income",{method:"POST",body:JSON.stringify({date:e.date.toISOString().split("T")[0],client_id:e.clientId,invoice_id:e.invoiceId,description:e.description,net_amount:e.netAmount,vat_rate:e.vatRate,euer_line:e.euerLine,euer_category:e.euerCategory,payment_method:e.paymentMethod,bank_reference:e.bankReference,ust_period:e.ustPeriod})});return d(p)}const t=await m(),s=$(),i=_(e.netAmount,e.vatRate),n=e.netAmount+i,o=new Date,u=Math.ceil((e.date.getMonth()+1)/3),r=e.ustPeriod??`${e.date.getFullYear()}-Q${u}`;return await t.execute(`INSERT INTO income (
      id, date, client_id, invoice_id, description, net_amount, vat_rate,
      vat_amount, gross_amount, euer_line, euer_category, payment_method,
      bank_reference, ust_period, ust_reported, created_at
    ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16)`,[s,e.date.toISOString().split("T")[0],e.clientId??null,e.invoiceId??null,e.description,e.netAmount,e.vatRate,i,n,e.euerLine??14,e.euerCategory??"services",e.paymentMethod??null,e.bankReference??null,r,0,o.toISOString()]),{id:s,date:e.date,clientId:e.clientId,invoiceId:e.invoiceId,description:e.description,netAmount:e.netAmount,vatRate:e.vatRate,vatAmount:i,grossAmount:n,euerLine:e.euerLine??14,euerCategory:e.euerCategory??"services",paymentMethod:e.paymentMethod,bankReference:e.bankReference,ustPeriod:r,ustReported:!1,createdAt:o}}async function E(e,t){if(!c())try{const r={};t.date&&(r.date=t.date.toISOString().split("T")[0]),t.clientId!==void 0&&(r.client_id=t.clientId),t.invoiceId!==void 0&&(r.invoice_id=t.invoiceId),t.description!==void 0&&(r.description=t.description),t.netAmount!==void 0&&(r.net_amount=t.netAmount),t.vatRate!==void 0&&(r.vat_rate=t.vatRate),t.euerLine!==void 0&&(r.euer_line=t.euerLine),t.euerCategory!==void 0&&(r.euer_category=t.euerCategory),t.paymentMethod!==void 0&&(r.payment_method=t.paymentMethod),t.bankReference!==void 0&&(r.bank_reference=t.bankReference),t.ustPeriod!==void 0&&(r.ust_period=t.ustPeriod);const p=await a(`/api/income/${e}`,{method:"PATCH",body:JSON.stringify(r)});return d(p)}catch{return null}const s=await f(e);if(!s)return null;const i=await m(),n=[],o=[];let u=1;if(t.date!==void 0&&(n.push(`date = $${u++}`),o.push(t.date.toISOString().split("T")[0])),t.description!==void 0&&(n.push(`description = $${u++}`),o.push(t.description)),t.clientId!==void 0&&(n.push(`client_id = $${u++}`),o.push(t.clientId)),t.invoiceId!==void 0&&(n.push(`invoice_id = $${u++}`),o.push(t.invoiceId)),t.paymentMethod!==void 0&&(n.push(`payment_method = $${u++}`),o.push(t.paymentMethod)),t.bankReference!==void 0&&(n.push(`bank_reference = $${u++}`),o.push(t.bankReference)),t.euerLine!==void 0&&(n.push(`euer_line = $${u++}`),o.push(t.euerLine)),t.euerCategory!==void 0&&(n.push(`euer_category = $${u++}`),o.push(t.euerCategory)),t.ustPeriod!==void 0&&(n.push(`ust_period = $${u++}`),o.push(t.ustPeriod)),t.netAmount!==void 0||t.vatRate!==void 0){const r=t.netAmount??s.netAmount,p=t.vatRate??s.vatRate,v=_(r,p);n.push(`net_amount = $${u++}`),o.push(r),n.push(`vat_rate = $${u++}`),o.push(p),n.push(`vat_amount = $${u++}`),o.push(v),n.push(`gross_amount = $${u++}`),o.push(r+v)}return n.length>0&&(o.push(e),await i.execute(`UPDATE income SET ${n.join(", ")} WHERE id = $${u}`,o)),f(e)}async function A(e){return c()?(await(await m()).execute("DELETE FROM income WHERE id = $1",[e]),!0):(await a(`/api/income/${e}`,{method:"DELETE"}),!0)}async function T(e){if(!c()){await a("/api/income/mark-reported",{method:"POST",body:JSON.stringify({ids:e})});return}const t=await m();for(const s of e)await t.execute("UPDATE income SET ust_reported = 1 WHERE id = $1",[s])}async function O(e,t){if(!c()){const n=e.toISOString().split("T")[0],o=t.toISOString().split("T")[0];return await a(`/api/income/summary?startDate=${n}&endDate=${o}`)}const s=await h(e,t),i={totalNet:0,totalVat:0,totalGross:0,count:s.length,byVatRate:{}};for(const n of s)i.totalNet+=n.netAmount,i.totalVat+=n.vatAmount,i.totalGross+=n.grossAmount,i.byVatRate[n.vatRate]||(i.byVatRate[n.vatRate]={net:0,vat:0}),i.byVatRate[n.vatRate].net+=n.netAmount,i.byVatRate[n.vatRate].vat+=n.vatAmount;return i.totalNet=Math.round(i.totalNet*100)/100,i.totalVat=Math.round(i.totalVat*100)/100,i.totalGross=Math.round(i.totalGross*100)/100,i}function l(e){return{id:e.id,date:new Date(e.date),clientId:e.client_id??void 0,invoiceId:e.invoice_id??void 0,description:e.description,netAmount:e.net_amount,vatRate:e.vat_rate,vatAmount:e.vat_amount,grossAmount:e.gross_amount,euerLine:e.euer_line??14,euerCategory:e.euer_category??"services",paymentMethod:e.payment_method,bankReference:e.bank_reference??void 0,ustPeriod:e.ust_period??void 0,ustReported:e.ust_reported===1,createdAt:new Date(e.created_at??Date.now())}}export{h as a,b,S as c,A as d,O as e,I as g,T as m,E as u};
