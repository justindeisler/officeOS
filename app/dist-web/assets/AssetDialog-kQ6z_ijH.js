import{r as i,j as e}from"./vendor-react-wuMqdllU.js";import{D as re,a as ie}from"./dialog-B7DVSW16.js";import{u as le,a as ne,o as ce,s as T,e as H,n as oe}from"./vendor-forms-B8CBK7X2.js";import{A as de,G as q}from"./index-uXN-dP3D.js";import{i as R,E as te,a as U,L as C,I as O,B as ue}from"./index-BVfXMJeG.js";import{S as X,a as J,b as K,c as Q,d as _}from"./select-BeRsbXBo.js";import{a as k,g as me,b as he,c as fe,d as pe,e as ge,f as xe,u as ve,h as ye,i as je,j as be,k as Ne,l as we}from"./assets-B0pxIYIb.js";import{m as M,A as Z}from"./vendor-framer-motion-C26rlN9R.js";import{d as ae,ac as Ae,t as Pe,m as z,_ as De,z as Fe,aJ as Ce}from"./vendor-icons-lkZWRnZW.js";import{A as Se,a as Ee,b as Ie,c as ke,d as Re,e as Be,f as Te,g as Oe,h as Me}from"./alert-dialog-BkE8aMwJ.js";function Ge({accept:t="PDF",maxSize:D=10*1024*1024,onFileSelect:N,onError:p,disabled:o=!1,className:g}){const[x,n]=i.useState(!1),[y,l]=i.useState(!1),[d,u]=i.useState(null),h=i.useCallback(async()=>{if(!(o||y)){l(!0),u(null);try{const m=await k.pickBillFile();if(m){const F=k.validateFile(m.name);if(!F.valid){const w=F.error||"Invalid file";u(w),p==null||p(w);return}N(m)}}catch(m){const F=m instanceof Error?m.message:"Failed to select file";u(F),p==null||p(F)}finally{l(!1)}}},[o,y,N,p]),S=i.useCallback(m=>{m.preventDefault(),m.stopPropagation(),o||n(!0)},[o]),E=i.useCallback(m=>{m.preventDefault(),m.stopPropagation(),n(!1)},[]),b=i.useCallback(m=>{m.preventDefault(),m.stopPropagation()},[]),I=i.useCallback(m=>{m.preventDefault(),m.stopPropagation(),n(!1),o||h()},[o,h]);return e.jsxs("div",{className:R("relative",g),children:[e.jsx(M.button,{type:"button",onClick:h,onDragEnter:S,onDragLeave:E,onDragOver:b,onDrop:I,disabled:o||y,className:R("w-full rounded-lg border-2 border-dashed p-6","flex flex-col items-center justify-center gap-2","transition-all duration-200 ease-out","focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",x?"border-primary bg-primary/5":"border-muted-foreground/25 hover:border-muted-foreground/50 hover:bg-muted/50",o&&"cursor-not-allowed opacity-50",d&&"border-destructive/50"),animate:{scale:x?1.02:1},transition:{duration:.2,ease:[.16,1,.3,1]},children:e.jsx(Z,{mode:"wait",children:y?e.jsxs(M.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},className:"flex flex-col items-center gap-2",children:[e.jsx("div",{className:"h-10 w-10 animate-pulse rounded-full bg-muted"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"Opening file picker..."})]},"loading"):e.jsxs(M.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"flex flex-col items-center gap-2",children:[e.jsx(M.div,{animate:{y:x?-4:0},transition:{duration:.2,ease:[.16,1,.3,1]},children:x?e.jsx(ae,{className:"h-10 w-10 text-primary"}):e.jsx(Ae,{className:"h-10 w-10 text-muted-foreground"})}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm font-medium",children:x?"Drop to upload":"Click to attach bill"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[t," files only (max ",Math.round(D/1024/1024),"MB)"]})]})]},"idle")})}),e.jsx(Z,{children:d&&e.jsxs(M.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"mt-2 flex items-center gap-1.5 text-sm text-destructive",children:[e.jsx(Pe,{className:"h-4 w-4"}),e.jsx("span",{children:d})]})})]})}function ee({filePath:t,fileName:D,onRemove:N,disabled:p=!1,className:o}){const[g,x]=i.useState(null),[n,y]=i.useState(!0),[l,d]=i.useState(!1),[u,h]=i.useState(null);i.useEffect(()=>{async function b(){y(!0),h(null);try{const I=await k.getAttachmentInfo(t);x(I),I&&!I.exists&&h("File not found")}catch{h("Failed to load file info")}finally{y(!1)}}b()},[t]);const S=async()=>{if(!(p||l)){d(!0),h(null);try{await k.openAttachment(t)}catch(b){h(b instanceof Error?b.message:"Failed to open file")}finally{d(!1)}}},E=D||(g==null?void 0:g.name)||"Attached file";return n?e.jsxs("div",{className:R("flex items-center gap-3 rounded-lg border p-3",o),children:[e.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded bg-muted",children:e.jsx(z,{className:"h-5 w-5 animate-spin text-muted-foreground"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"h-4 w-32 animate-pulse rounded bg-muted"}),e.jsx("div",{className:"mt-1 h-3 w-20 animate-pulse rounded bg-muted"})]})]}):e.jsxs(M.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.2,ease:[.16,1,.3,1]},className:R("flex items-center gap-3 rounded-lg border p-3",u&&"border-destructive/50 bg-destructive/5",o),children:[e.jsx("div",{className:R("flex h-10 w-10 items-center justify-center rounded",u?"bg-destructive/10":"bg-primary/10"),children:e.jsx(ae,{className:R("h-5 w-5",u?"text-destructive":"text-primary")})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"truncate text-sm font-medium",children:E}),u?e.jsx("p",{className:"text-xs text-destructive",children:te(u)}):e.jsx("p",{className:"text-xs text-muted-foreground",children:"PDF Document"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(U,{type:"button",variant:"ghost",size:"icon",onClick:S,disabled:p||l||!!u,title:"Open in PDF viewer",children:l?e.jsx(z,{className:"h-4 w-4 animate-spin"}):e.jsx(De,{className:"h-4 w-4"})}),e.jsxs(Se,{children:[e.jsx(Ee,{asChild:!0,children:e.jsx(U,{type:"button",variant:"ghost",size:"icon",disabled:p,title:"Remove attachment",className:"text-destructive hover:text-destructive hover:bg-destructive/10",children:e.jsx(Fe,{className:"h-4 w-4"})})}),e.jsxs(Ie,{children:[e.jsxs(ke,{children:[e.jsx(Re,{children:"Remove attachment?"}),e.jsx(Be,{children:"This will remove the attached bill from this asset. The file will be deleted when you save."})]}),e.jsxs(Te,{children:[e.jsx(Oe,{children:"Cancel"}),e.jsx(Me,{onClick:N,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Remove"})]})]})]})]})]})}const Le=ce({name:T().min(1,"Name is required"),description:T().optional(),purchaseDate:T().min(1,"Purchase date is required"),vendor:T().optional(),purchasePrice:oe().positive("Amount must be positive"),vatRate:H(["0","7","19"]),category:H(["computer","phone","furniture","equipment","software"]),location:T().optional(),inventoryNumber:T().optional()});function V(t){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(t)}const $e=[{value:"computer",label:"Computer (3 years)"},{value:"phone",label:"Phone (5 years)"},{value:"furniture",label:"Furniture (13 years)"},{value:"equipment",label:"Equipment (5 years)"},{value:"software",label:"Software (3 years)"}];function Ve(t){return t<=0?null:t<=q.SOFORTABSCHREIBUNG?"immediate":t<=q.GWG_MAX?"gwg":t<=q.POOL_MAX?"pool":"afa"}function Ye(t){return t>0&&t<=q.GWG_MAX}function We(t){switch(t){case"immediate":return{label:"Immediate Write-off",description:"≤€250: Full expense in year of purchase",variant:"default"};case"gwg":return{label:"Immediate Write-off",description:"≤€800 (GWG): Full expense in year of purchase",variant:"default"};case"pool":return{label:"Pool Method",description:"€800-€1000: Pool depreciation (5 years) or regular AfA",variant:"outline"};case"afa":return{label:"Regular AfA",description:">€1000: Standard linear depreciation",variant:"outline"};default:return null}}function _e({asset:t,onSubmit:D,onCancel:N,className:p}){const[o,g]=i.useState(!1),[x,n]=i.useState(null),[y,l]=i.useState(t==null?void 0:t.billPath),[d,u]=i.useState(!1),h=!!t,S=s=>{if(!s||s.purchasePrice<=0)return"19";if(s.vatPaid===0)return"0";const f=Math.round(s.vatPaid/s.purchasePrice*100);return f===7?"7":f===19?"19":"0"},E={name:(t==null?void 0:t.name)??"",description:(t==null?void 0:t.description)??"",purchaseDate:t!=null&&t.purchaseDate?t.purchaseDate.toISOString().split("T")[0]:new Date().toISOString().split("T")[0],vendor:(t==null?void 0:t.vendor)??"",purchasePrice:(t==null?void 0:t.purchasePrice)??0,vatRate:S(t),category:(t==null?void 0:t.category)??"computer",location:(t==null?void 0:t.location)??""},{register:b,handleSubmit:I,watch:m,setValue:F,formState:{errors:w}}=le({resolver:ne(Le),defaultValues:E}),Y=m("purchasePrice"),G=m("vatRate"),L=m("category"),j=i.useMemo(()=>{const s=Number(Y)||0,f=Number(G)||19,v=Math.round(s*(f/100)*100)/100,A=Math.round((s+v)*100)/100,P=Ye(s),W=P?1:de[L]||3,se=s>0?P?s:Math.round(s/W*100)/100:0;return{net:s,vat:v,gross:A,rate:f,afaYears:W,annualAfa:se,isImmediate:P}},[Y,G,L]),$=i.useMemo(()=>Ve(j.net),[j.net]),B=We($),a=s=>{n(s),u(!1)},r=()=>{x?n(null):y&&(l(void 0),u(!0))},c=async s=>{g(!0);try{let f;x?f=x.path:!d&&y&&(f=y);const v={name:s.name,description:s.description||void 0,purchaseDate:new Date(s.purchaseDate),vendor:s.vendor||void 0,purchasePrice:s.purchasePrice,vatRate:Number(s.vatRate),afaYears:j.afaYears,afaMethod:j.isImmediate?"immediate":void 0,category:s.category,location:s.location||void 0,billPath:f};await D(v)}finally{g(!1)}};return e.jsxs("form",{onSubmit:I(c),className:R("space-y-6",p),children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:h?"Edit Asset":"Add Asset"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:h?"Update the asset record details below.":"Enter the details for the new asset."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"name",children:"Name"}),e.jsx(O,{id:"name",placeholder:'e.g., MacBook Pro 16"',...b("name"),"aria-invalid":!!w.name}),w.name&&e.jsx("p",{className:"text-sm text-destructive",children:w.name.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"description",children:"Description (optional)"}),e.jsx(O,{id:"description",placeholder:"e.g., Development laptop for work",...b("description")})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"purchaseDate",children:"Purchase Date"}),e.jsx(O,{id:"purchaseDate",type:"date",...b("purchaseDate"),"aria-invalid":!!w.purchaseDate}),w.purchaseDate&&e.jsx("p",{className:"text-sm text-destructive",children:w.purchaseDate.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"vendor",children:"Vendor (optional)"}),e.jsx(O,{id:"vendor",placeholder:"e.g., Apple, Amazon",...b("vendor")})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"purchasePrice",children:"Purchase Price (Net, €)"}),e.jsx(O,{id:"purchasePrice",type:"number",step:"0.01",min:"0",placeholder:"0.00",...b("purchasePrice",{valueAsNumber:!0}),"aria-invalid":!!w.purchasePrice}),w.purchasePrice&&e.jsx("p",{className:"text-sm text-destructive",children:w.purchasePrice.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"vatRate",children:"VAT Rate"}),e.jsxs(X,{value:G,onValueChange:s=>F("vatRate",s),children:[e.jsx(J,{id:"vatRate",children:e.jsx(K,{placeholder:"Select VAT rate"})}),e.jsxs(Q,{children:[e.jsx(_,{value:"19",children:"19%"}),e.jsx(_,{value:"7",children:"7%"}),e.jsx(_,{value:"0",children:"0%"})]})]})]})]}),e.jsxs("div",{className:"rounded-lg bg-muted p-4",children:[e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Net"}),e.jsx("div",{className:"font-medium",children:V(j.net)})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-muted-foreground",children:["Vorsteuer (",j.rate,"%)"]}),e.jsx("div",{className:"font-medium",children:V(j.vat)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Gross"}),e.jsx("div",{className:"font-semibold",children:V(j.gross)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:j.isImmediate?"Write-off":"AfA/Year"}),e.jsx("div",{className:"font-medium",children:j.isImmediate?`${V(j.annualAfa)} (full)`:`${V(j.annualAfa)}/year`})]})]}),B&&e.jsxs("div",{className:"mt-3 flex items-start gap-2 text-sm",children:[e.jsx(Ce,{className:"h-4 w-4 mt-0.5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx(ue,{variant:B.variant,className:"mb-1",children:B.label}),e.jsx("p",{className:"text-muted-foreground",children:B.description})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"category",children:"Category"}),e.jsxs(X,{value:L,onValueChange:s=>F("category",s),children:[e.jsx(J,{id:"category",children:e.jsx(K,{placeholder:"Select category"})}),e.jsx(Q,{children:$e.map(s=>e.jsx(_,{value:s.value,children:s.label},s.value))})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:j.isImmediate?"Depreciation: Immediate write-off (GWG)":`Depreciation period: ${j.afaYears} years (linear AfA)`})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"location",children:"Location (optional)"}),e.jsx(O,{id:"location",placeholder:"e.g., Home Office, Büro",...b("location")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{children:"Inventory Number"}),e.jsx("div",{className:"flex h-10 items-center rounded-md border border-input bg-muted px-3 text-sm text-muted-foreground",children:h&&(t!=null&&t.inventoryNumber)?t.inventoryNumber:"Auto-generated on save"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{children:"Bill/Invoice (optional)"}),x?e.jsx(ee,{filePath:x.path,fileName:x.name,onRemove:r,disabled:o}):y?e.jsx(ee,{filePath:y,onRemove:r,disabled:o}):e.jsx(Ge,{onFileSelect:a,disabled:o}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Attach a PDF of the purchase invoice or receipt"})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx(U,{type:"button",variant:"outline",onClick:N,children:"Cancel"}),e.jsxs(U,{type:"submit",disabled:o,children:[o&&e.jsx(z,{className:"mr-2 h-4 w-4 animate-spin"}),"Save"]})]})]})}function qe(t={}){const{autoFetch:D=!0,category:N,status:p}=t,[o,g]=i.useState([]),[x,n]=i.useState(!1),[y,l]=i.useState(null),[d,u]=i.useState(null),h=i.useCallback(async()=>{n(!0),l(null);try{const a=await me();g(a)}catch(a){l(a instanceof Error?a.message:"Failed to fetch assets")}finally{n(!1)}},[]),S=i.useCallback(async a=>{n(!0),l(null);try{const r=await he(a);g(r)}catch(r){l(r instanceof Error?r.message:"Failed to fetch assets")}finally{n(!1)}},[]),E=i.useCallback(async a=>{n(!0),l(null);try{const r=await fe(a);g(r)}catch(r){l(r instanceof Error?r.message:"Failed to fetch assets")}finally{n(!1)}},[]),b=i.useCallback(async()=>{n(!0),l(null);try{const a=await pe();g(a)}catch(a){l(a instanceof Error?a.message:"Failed to fetch active assets")}finally{n(!1)}},[]),I=i.useCallback(async()=>{n(!0),l(null);try{const a=await ge();g(a)}catch(a){l(a instanceof Error?a.message:"Failed to fetch disposed assets")}finally{n(!1)}},[]),m=i.useCallback(async a=>{n(!0),l(null);try{const r=crypto.randomUUID();console.log(`[useAssets] Creating asset with ID: ${r}`),console.log(`[useAssets] Input billPath: ${a.billPath}`);let c=a.billPath;if(a.billPath)try{const v=a.billPath.split(/[/\\]/),A=v[v.length-1];console.log(`[useAssets] Extracted filename: ${A}`),c=await k.saveAttachment(r,a.billPath,A),console.log(`[useAssets] Final billPath after save: ${c}`)}catch(v){throw console.error("[useAssets] Failed to save attachment:",v),new Error("Failed to save attachment file. Please try again.")}const s={...a,billPath:c};console.log("[useAssets] Creating asset with data:",{...s,description:"..."});const f=await xe(s,r);return console.log(`[useAssets] Asset created with billPath: ${f.billPath}`),g(v=>[f,...v]),f}catch(r){return console.error("[useAssets] Failed to create asset:",r),l(r instanceof Error?r.message:"Failed to create asset"),null}finally{n(!1)}},[]),F=i.useCallback(async(a,r)=>{n(!0),l(null);try{const c=o.find(A=>A.id===a);let s=r.billPath;if(r.billPath!==void 0){const A=r.billPath!==(c==null?void 0:c.billPath);if(A&&r.billPath)try{const P=r.billPath.split(/[/\\]/),W=P[P.length-1];s=await k.saveAttachment(a,r.billPath,W),c!=null&&c.billPath&&await k.deleteAttachment(c.billPath)}catch(P){console.error("Failed to save attachment:",P),s=c==null?void 0:c.billPath}else if(A&&!r.billPath&&(c!=null&&c.billPath))try{await k.deleteAttachment(c.billPath),s=void 0}catch(P){console.error("Failed to delete attachment:",P),s=c==null?void 0:c.billPath}}const f={...r,billPath:s},v=await ve(a,f);return v&&(g(A=>A.map(P=>P.id===a?v:P)),(d==null?void 0:d.id)===a&&u(v)),v}catch(c){return l(c instanceof Error?c.message:"Failed to update asset"),null}finally{n(!1)}},[d,o]),w=i.useCallback(async a=>{n(!0),l(null);try{const r=await ye(a);return r&&(g(c=>c.filter(s=>s.id!==a)),(d==null?void 0:d.id)===a&&u(null)),r}catch(r){return l(r instanceof Error?r.message:"Failed to delete asset"),!1}finally{n(!1)}},[d]),Y=i.useCallback(async(a,r,c,s)=>{n(!0),l(null);try{const f=await je(a,r,c,s);return f&&(g(v=>v.map(A=>A.id===a?f:A)),(d==null?void 0:d.id)===a&&u(f)),f}catch(f){return l(f instanceof Error?f.message:"Failed to dispose asset"),null}finally{n(!1)}},[d]),G=i.useCallback(async a=>{try{return await be(a)}catch(r){return l(r instanceof Error?r.message:"Failed to get depreciation"),0}},[]),L=i.useCallback(async a=>{try{return await Ne(a)}catch(r){return l(r instanceof Error?r.message:"Failed to get depreciation by category"),{computer:0,phone:0,furniture:0,equipment:0,software:0}}},[]),j=i.useCallback(async()=>{try{return await we()}catch(a){return l(a instanceof Error?a.message:"Failed to get total asset value"),0}},[]),$=i.useCallback(async()=>{N?await S(N):p?await E(p):await h()},[N,p,S,E,h]);i.useEffect(()=>{D&&$()},[D,$]);const B=i.useCallback(()=>{l(null)},[]);return{assets:o,isLoading:x,error:y,fetchAssets:h,fetchByCategory:S,fetchByStatus:E,fetchActiveAssets:b,fetchDisposedAssets:I,createAsset:m,updateAsset:F,deleteAsset:w,disposeAsset:Y,getYearlyDepreciation:G,getDepreciationByCategory:L,getTotalAssetValue:j,selectedAsset:d,setSelectedAsset:u,refresh:$,clearError:B}}function at({open:t,onOpenChange:D,asset:N,onClose:p,onSuccess:o}){const{createAsset:g,updateAsset:x,error:n,clearError:y}=qe(),l=u=>{u||y(),D(u)},d=async u=>{try{let h;if(N?h=await x(N.id,u):h=await g(u),!h)return;o==null||o(),p()}catch(h){console.error("Failed to save asset:",h)}};return e.jsx(re,{open:t,onOpenChange:l,children:e.jsxs(ie,{className:"w-[calc(100vw-2rem)] max-w-[600px] max-h-[90vh] overflow-y-auto",children:[n&&e.jsx("div",{className:"mb-4 p-3 bg-destructive/10 border border-destructive/20 rounded-md text-destructive text-sm",children:te(n)}),e.jsx(_e,{asset:N||void 0,onSubmit:d,onCancel:p})]})})}export{at as A,qe as u};
