import{r as l,j as e}from"./vendor-react-wuMqdllU.js";import{C as Ce}from"./confirm-delete-dialog-D3P6PPsQ.js";import{A as ke,m as Pe}from"./vendor-framer-motion-C26rlN9R.js";import{M as A,e as De,i as ve,L as P,I as _,a as q,k as Z,B as Re,l as Fe}from"./index-BJ9hpEov.js";import{C as Y,c as Q,a as Ae,b as Ee}from"./card-BOU-q13f.js";import{T as Me,a as Te,b as ue,c as Oe}from"./tabs-EeWm2cFj.js";import{T as qe,a as Ue,b as ye,c as L,d as Be,e as $}from"./table-D-p124BO.js";import{T as _e}from"./textarea-D5YM9rKe.js";import{S as G,a as J,b as K,c as W,d as x}from"./select-DW4QIkWb.js";import{u as Ie}from"./useClients-Ny5hLbBc.js";import"./dropdown-menu-Dz1PdlGq.js";import{D as Le,a as $e}from"./dialog-BPcAFwmD.js";import{Q as Ne,B as ze,aI as Ve,F as Ye,t as je,G as ge,o as Se,T as Qe,f as He,W as Ge,aC as Je,x as Ke}from"./vendor-icons-ssgfUAX_.js";import"./switch-BGK1s4qN.js";import{w as xe}from"./vendor-date-fns-D0ugVOfH.js";import"./vendor-markdown-C3iCDuOK.js";import"./alert-dialog-CMM_3WOV.js";import"./vendor-radix-DqeMb71O.js";import"./vendor-floating-ui-BD6aHMKr.js";import"./vendor-recharts-tRgwS7-V.js";import"./vendor-router-Cm8Qzw9U.js";function We({isActive:s,onComplete:c,iconCount:E=20}){const[T,v]=l.useState(!1),D=l.useMemo(()=>typeof window>"u"?!1:window.matchMedia("(prefers-reduced-motion: reduce)").matches,[]),d=l.useMemo(()=>Array.from({length:E},(r,I)=>({id:I,x:Math.random()*100,delay:Math.random()*.8,duration:2+Math.random()*1,rotation:(Math.random()-.5)*60,scale:1.5+Math.random()})),[E]);return l.useEffect(()=>{if(s){v(!0);const r=setTimeout(()=>{v(!1),c==null||c()},3500);return()=>clearTimeout(r)}},[s,c]),D?null:e.jsx(ke,{children:T&&e.jsx("div",{className:"fixed inset-0 pointer-events-none overflow-hidden",style:{zIndex:9999},"aria-hidden":"true",children:d.map(r=>e.jsx(Pe.div,{className:"absolute text-4xl select-none",style:{left:`${r.x}%`,fontSize:`${r.scale}rem`},initial:{y:-100,x:"-50%",rotate:r.rotation-20,opacity:0},animate:{y:"100vh",rotate:r.rotation+20,opacity:[0,1,1,0]},exit:{opacity:0},transition:{duration:r.duration,delay:r.delay,ease:[.16,1,.3,1],opacity:{duration:r.duration,times:[0,.1,.8,1]}},children:"ðŸ’¸"},r.id))})})}function Xe(){const[s,c]=l.useState(!1),E=l.useCallback(()=>{c(!0)},[]),T=l.useCallback(()=>{c(!1)},[]);return{isActive:s,trigger:E,onComplete:T}}function X(s){return{id:s.id,invoiceNumber:s.invoiceNumber,invoiceDate:new Date(s.issueDate||s.createdAt),dueDate:new Date(s.dueDate),status:s.status,clientId:s.clientId,projectId:s.projectId,subtotal:s.amount||0,vatRate:s.taxRate||19,vatAmount:s.taxAmount||0,total:s.totalAmount||0,paymentDate:s.paidDate?new Date(s.paidDate):void 0,paymentMethod:void 0,notes:s.notes,items:(s.lineItems||[]).map(c=>({id:c.id??crypto.randomUUID(),invoiceId:s.id,description:c.description,quantity:c.quantity,unit:c.unit||"hours",unitPrice:c.unitPrice,amount:c.amount})),createdAt:new Date(s.createdAt)}}function Ze(s={}){const{autoFetch:c=!0,status:E,clientId:T}=s,[v,D]=l.useState([]),[d,r]=l.useState(!1),[I,u]=l.useState(null),[R,S]=l.useState(null),z=l.useCallback(async()=>{r(!0),u(null);try{const a=await A.getAll();D(a.map(X))}catch(a){console.error("Failed to fetch invoices:",a);const i=a instanceof Error?a.message:typeof a=="string"?a:JSON.stringify(a)||"Failed to fetch invoices";u(i)}finally{r(!1)}},[]),M=l.useCallback(async a=>{r(!0),u(null);try{const i=await A.getByStatus(a);D(i.map(X))}catch(i){u(i instanceof Error?i.message:"Failed to fetch invoices")}finally{r(!1)}},[]),ce=l.useCallback(async a=>{r(!0),u(null);try{const i=await A.getByClient(a);D(i.map(X))}catch(i){u(i instanceof Error?i.message:"Failed to fetch invoices")}finally{r(!1)}},[]),se=l.useCallback(async a=>{r(!0),u(null);try{const i={invoiceNumber:"",clientId:a.clientId||"",projectId:a.projectId,issueDate:a.invoiceDate.toISOString(),dueDate:a.dueDate.toISOString(),status:"draft",amount:a.items.reduce((m,O)=>m+O.quantity*O.unitPrice,0),currency:"EUR",taxRate:a.vatRate,taxAmount:0,totalAmount:0,notes:a.notes,lineItems:a.items.map(m=>({id:crypto.randomUUID(),description:m.description,quantity:m.quantity,unit:m.unit||"hours",unitPrice:m.unitPrice,amount:m.quantity*m.unitPrice})),updatedAt:new Date().toISOString()},h=await A.create(i),C=X(h);return D(m=>[C,...m]),C}catch(i){return console.error("Failed to create invoice:",i),u(i instanceof Error?i.message:"Failed to create invoice"),null}finally{r(!1)}},[]),de=l.useCallback(async(a,i)=>{r(!0),u(null);try{await A.update(a,i);const h=await A.getById(a);if(h){const C=X(h);return D(m=>m.map(O=>O.id===a?C:O)),(R==null?void 0:R.id)===a&&S(C),C}return null}catch(h){return u(h instanceof Error?h.message:"Failed to update invoice"),null}finally{r(!1)}},[R]),U=l.useCallback(async a=>{r(!0),u(null);try{return await A.delete(a),D(i=>i.filter(h=>h.id!==a)),(R==null?void 0:R.id)===a&&S(null),!0}catch(i){return u(i instanceof Error?i.message:"Failed to delete invoice"),!1}finally{r(!1)}},[R]),ae=l.useCallback(async a=>{r(!0),u(null);try{const i=await A.markAsSent(a),h=X(i);return D(C=>C.map(m=>m.id===a?h:m)),h}catch(i){return u(i instanceof Error?i.message:"Failed to mark invoice as sent"),null}finally{r(!1)}},[]),V=l.useCallback(async(a,i,h)=>{r(!0),u(null);try{await A.markAsPaid(a,i,h);const m=(await A.getAll()).find(te=>te.id===a);if(!m)throw new Error("Invoice not found after marking as paid");const O=X(m);return D(te=>te.map(le=>le.id===a?O:le)),O}catch(C){return u(C instanceof Error?C.message:"Failed to mark invoice as paid"),null}finally{r(!1)}},[]),ee=l.useCallback(async a=>{r(!0),u(null);try{const i=await A.cancelInvoice(a),h=X(i);return D(C=>C.map(m=>m.id===a?h:m)),h}catch(i){return u(i instanceof Error?i.message:"Failed to cancel invoice"),null}finally{r(!1)}},[]),ne=l.useCallback(async()=>{try{return await A.getNextInvoiceNumber()}catch{return`RE-${new Date().getFullYear()}-001`}},[]),re=l.useCallback(async()=>{await z()},[z]);return l.useEffect(()=>{c&&z()},[c,z]),{invoices:v,isLoading:d,error:I,fetchInvoices:z,fetchByStatus:M,fetchByClient:ce,createInvoice:se,updateInvoice:de,deleteInvoice:U,markAsSent:ae,markAsPaid:V,cancelInvoice:ee,getNextInvoiceNumber:ne,selectedInvoice:R,setSelectedInvoice:S,refresh:re}}function ie(s){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(s)}function be(){return`item-${Date.now()}-${Math.random().toString(36).substring(2,9)}`}function et(){const s=new Date,c=new Date(s);return c.setDate(c.getDate()+14),{invoiceDate:s.toISOString().split("T")[0],dueDate:c.toISOString().split("T")[0]}}function tt({invoice:s,onSubmit:c,onCancel:E,className:T}){const v=!!s,D=et(),{clients:d}=Ie(),{projects:r,initialize:I}=De();l.useEffect(()=>{I()},[I]);const[u,R]=l.useState(s!=null&&s.invoiceDate?s.invoiceDate.toISOString().split("T")[0]:D.invoiceDate),[S,z]=l.useState(s!=null&&s.dueDate?s.dueDate.toISOString().split("T")[0]:D.dueDate),[M,ce]=l.useState((s==null?void 0:s.vatRate)??19),[se,de]=l.useState((s==null?void 0:s.notes)??""),[U,ae]=l.useState((s==null?void 0:s.clientId)??""),[V,ee]=l.useState((s==null?void 0:s.projectId)??""),[ne,re]=l.useState(!1),[a,i]=l.useState({}),[h,C]=l.useState((s==null?void 0:s.eInvoiceFormat)??"none"),[m,O]=l.useState((s==null?void 0:s.leitwegId)??""),[te,le]=l.useState((s==null?void 0:s.buyerReference)??""),me=l.useMemo(()=>U?r.filter(t=>t.clientId===U):[],[r,U]),pe=t=>{ae(t),V&&(r.some(N=>N.id===V&&N.clientId===t)||ee(""))},[B,n]=l.useState(()=>s!=null&&s.items&&s.items.length>0?s.items.map(t=>({id:t.id,description:t.description,quantity:t.quantity,unit:t.unit??"hours",unitPrice:t.unitPrice,vatRate:t.vatRate??M})):[{id:be(),description:"",quantity:1,unit:"hours",unitPrice:0,vatRate:19}]),o=l.useMemo(()=>B.map(t=>Math.round(t.quantity*t.unitPrice*100)/100),[B]),g=l.useMemo(()=>{const t=o.reduce((w,H)=>w+H,0),p={};B.forEach((w,H)=>{const j=o[H],oe=w.vatRate??M;p[oe]||(p[oe]={net:0,vat:0}),p[oe].net+=j,p[oe].vat+=Math.round(j*(oe/100)*100)/100});const N=Object.values(p).reduce((w,{vat:H})=>w+H,0),F=Math.round((t+N)*100)/100;return{subtotal:t,vatAmount:N,total:F,vatBreakdown:p}},[o,B,M]),f=(t,p,N)=>{n(F=>F.map(w=>w.id===t?{...w,[p]:N}:w))},k=()=>{n(t=>[...t,{id:be(),description:"",quantity:1,unit:"hours",unitPrice:0,vatRate:M}])},b=t=>{n(p=>p.filter(N=>N.id!==t))},y=()=>{const t={};B.length===0&&(t.items="At least one line item is required");const p={},N={},F={};return B.forEach(w=>{w.description.trim()||(p[w.id]="Description is required"),w.quantity<=0&&(N[w.id]="Quantity must be positive"),w.unitPrice<=0&&(F[w.id]="Price must be positive")}),Object.keys(p).length>0&&(t.itemDescriptions=p),Object.keys(N).length>0&&(t.itemQuantities=N),Object.keys(F).length>0&&(t.itemPrices=F),i(t),Object.keys(t).length===0},fe=async t=>{if(t.preventDefault(),!!y()){re(!0);try{const p=B.map(F=>({description:F.description,quantity:F.quantity,unit:F.unit,unitPrice:F.unitPrice})),N={invoiceDate:new Date(u),dueDate:new Date(S),vatRate:M,items:p,clientId:U||void 0,projectId:V||void 0,notes:se||void 0};await c(N)}finally{re(!1)}}};return e.jsxs("form",{onSubmit:fe,className:ve("space-y-5 w-full max-w-full overflow-hidden",T),children:[e.jsx("h2",{className:"text-xl font-semibold",children:v?"Edit Invoice":"New Invoice"}),e.jsxs("div",{className:"grid gap-4 grid-cols-1 sm:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(P,{htmlFor:"invoiceDate",className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"h-3.5 w-3.5 text-muted-foreground"}),"Invoice Date"]}),e.jsx(_,{id:"invoiceDate",type:"date",value:u,onChange:t=>R(t.target.value),className:"h-10"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(P,{htmlFor:"dueDate",className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"h-3.5 w-3.5 text-muted-foreground"}),"Due Date"]}),e.jsx(_,{id:"dueDate",type:"date",value:S,onChange:t=>z(t.target.value),className:"h-10"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(P,{htmlFor:"client",className:"flex items-center gap-2",children:[e.jsx(ze,{className:"h-3.5 w-3.5 text-muted-foreground"}),"Client"]}),e.jsxs(G,{value:U||void 0,onValueChange:pe,children:[e.jsx(J,{id:"client",children:e.jsx(K,{placeholder:"Select a client"})}),e.jsx(W,{children:d.length===0?e.jsx("div",{className:"px-2 py-4 text-center text-sm text-muted-foreground",children:"No clients available"}):d.filter(t=>t.id).map(t=>e.jsx(x,{value:t.id,children:t.name},t.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(P,{htmlFor:"vatRate",className:"flex items-center gap-2",children:[e.jsx(Ve,{className:"h-3.5 w-3.5 text-muted-foreground"}),"VAT Rate"]}),e.jsxs(G,{value:String(M),onValueChange:t=>ce(Number(t)),children:[e.jsx(J,{id:"vatRate",children:e.jsx(K,{})}),e.jsxs(W,{children:[e.jsx(x,{value:"19",children:"19%"}),e.jsx(x,{value:"7",children:"7%"}),e.jsx(x,{value:"0",children:"0%"})]})]})]}),U&&me.length>0&&e.jsxs("div",{className:"space-y-2 sm:col-span-2",children:[e.jsxs(P,{htmlFor:"project",className:"flex items-center gap-2",children:[e.jsx(Ye,{className:"h-3.5 w-3.5 text-muted-foreground"}),"Project",e.jsx("span",{className:"text-xs font-normal text-muted-foreground",children:"(optional)"})]}),e.jsxs(G,{value:V||"__none__",onValueChange:t=>ee(t==="__none__"?"":t),children:[e.jsx(J,{id:"project",children:e.jsx(K,{placeholder:"Select a project"})}),e.jsxs(W,{children:[e.jsx(x,{value:"__none__",children:e.jsx("span",{className:"text-muted-foreground",children:"No project"})}),me.filter(t=>t.id).map(t=>e.jsx(x,{value:t.id,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:ve("h-2 w-2 rounded-full",t.status==="active"&&"bg-green-500",t.status==="pipeline"&&"bg-blue-500",t.status==="on_hold"&&"bg-yellow-500",t.status==="completed"&&"bg-gray-400",t.status==="cancelled"&&"bg-red-400")}),t.name]})},t.id))]})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(P,{children:"Line Items"}),e.jsxs(q,{type:"button",variant:"outline",size:"sm",onClick:k,children:[e.jsx(je,{className:"mr-2 h-4 w-4"}),"Add Item"]})]}),a.items&&e.jsx("p",{className:"text-sm text-destructive",children:a.items}),e.jsx("div",{className:"space-y-3 w-full",children:B.map((t,p)=>{var N,F,w,H;return e.jsxs("div",{className:"rounded-lg border p-3 sm:p-4 w-full",children:[e.jsxs("div",{className:"flex flex-col gap-3 sm:hidden w-full",children:[e.jsxs("div",{className:"w-full",children:[e.jsx(P,{className:"text-xs text-muted-foreground mb-1 block",children:"Description"}),e.jsx(_,{placeholder:"Description",className:"h-10 w-full",value:t.description,onChange:j=>f(t.id,"description",j.target.value)}),((N=a.itemDescriptions)==null?void 0:N[t.id])&&e.jsx("p",{className:"mt-1 text-xs text-destructive",children:a.itemDescriptions[t.id]})]}),e.jsxs("div",{className:"w-full",children:[e.jsx(P,{className:"text-xs text-muted-foreground mb-1 block",children:"Quantity"}),e.jsx(_,{id:`quantity-${t.id}`,"aria-label":"Quantity",className:"h-10 w-full",type:"number",inputMode:"decimal",min:"0.01",step:"0.01",value:t.quantity,onChange:j=>f(t.id,"quantity",parseFloat(j.target.value)||0)})]}),e.jsxs("div",{className:"w-full",children:[e.jsx(P,{className:"text-xs text-muted-foreground mb-1 block",children:"Unit"}),e.jsxs(G,{value:t.unit,onValueChange:j=>f(t.id,"unit",j),children:[e.jsx(J,{className:"h-10 w-full",children:e.jsx(K,{})}),e.jsxs(W,{children:[e.jsx(x,{value:"hours",children:"Hours"}),e.jsx(x,{value:"days",children:"Days"}),e.jsx(x,{value:"month",children:"Month"}),e.jsx(x,{value:"units",children:"Units"}),e.jsx(x,{value:"pieces",children:"Pieces"})]})]})]}),e.jsxs("div",{className:"w-full",children:[e.jsx(P,{className:"text-xs text-muted-foreground mb-1 block",children:"Einzelpreis (â‚¬)"}),e.jsx(_,{id:`unitPrice-${t.id}`,"aria-label":"Unit Price",className:"h-10 w-full",type:"number",inputMode:"decimal",min:"0.01",step:"0.01",value:t.unitPrice,onChange:j=>f(t.id,"unitPrice",parseFloat(j.target.value)||0)})]}),e.jsxs("div",{className:"w-full",children:[e.jsx(P,{className:"text-xs text-muted-foreground mb-1 block",children:"MwSt"}),e.jsxs(G,{value:String(t.vatRate??M),onValueChange:j=>f(t.id,"vatRate",Number(j)),children:[e.jsx(J,{className:"h-10 w-full",children:e.jsx(K,{})}),e.jsxs(W,{children:[e.jsx(x,{value:"19",children:"19%"}),e.jsx(x,{value:"7",children:"7%"}),e.jsx(x,{value:"0",children:"0%"})]})]})]}),e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t w-full",children:[e.jsxs(q,{type:"button",variant:"ghost",size:"sm",className:"text-muted-foreground hover:text-destructive -ml-2",onClick:()=>b(t.id),children:[e.jsx(ge,{className:"h-4 w-4 mr-1"}),"Remove"]}),e.jsx("span",{className:"font-semibold text-base",children:ie(o[p])})]})]}),e.jsxs("div",{className:"hidden sm:block",children:[e.jsxs("div",{className:"grid items-start gap-3 grid-cols-[1fr_70px_80px_90px_70px_40px]",children:[e.jsxs("div",{children:[e.jsx(_,{placeholder:"Beschreibung",className:"h-9",value:t.description,onChange:j=>f(t.id,"description",j.target.value)}),((F=a.itemDescriptions)==null?void 0:F[t.id])&&e.jsx("p",{className:"mt-1 text-xs text-destructive",children:a.itemDescriptions[t.id]})]}),e.jsxs("div",{children:[e.jsx(_,{id:`quantity-desktop-${t.id}`,"aria-label":"Quantity",className:"h-9",type:"number",min:"0.01",step:"0.01",value:t.quantity,onChange:j=>f(t.id,"quantity",parseFloat(j.target.value)||0)}),((w=a.itemQuantities)==null?void 0:w[t.id])&&e.jsx("p",{className:"mt-1 text-xs text-destructive",children:a.itemQuantities[t.id]})]}),e.jsxs(G,{value:t.unit,onValueChange:j=>f(t.id,"unit",j),children:[e.jsx(J,{className:"h-9",children:e.jsx(K,{})}),e.jsxs(W,{children:[e.jsx(x,{value:"hours",children:"Std"}),e.jsx(x,{value:"days",children:"Tage"}),e.jsx(x,{value:"month",children:"Mon"}),e.jsx(x,{value:"units",children:"Stk"}),e.jsx(x,{value:"pieces",children:"Stk"})]})]}),e.jsxs("div",{children:[e.jsx(_,{id:`unitPrice-desktop-${t.id}`,"aria-label":"Unit Price",className:"h-9",type:"number",min:"0.01",step:"0.01",value:t.unitPrice,onChange:j=>f(t.id,"unitPrice",parseFloat(j.target.value)||0)}),((H=a.itemPrices)==null?void 0:H[t.id])&&e.jsx("p",{className:"mt-1 text-xs text-destructive",children:a.itemPrices[t.id]})]}),e.jsxs(G,{value:String(t.vatRate??M),onValueChange:j=>f(t.id,"vatRate",Number(j)),children:[e.jsx(J,{className:"h-9",children:e.jsx(K,{})}),e.jsxs(W,{children:[e.jsx(x,{value:"19",children:"19%"}),e.jsx(x,{value:"7",children:"7%"}),e.jsx(x,{value:"0",children:"0%"})]})]}),e.jsx(q,{type:"button",variant:"ghost",size:"icon",className:"h-9 w-9",onClick:()=>b(t.id),"aria-label":"Remove",children:e.jsx(ge,{className:"h-4 w-4 text-muted-foreground hover:text-destructive"})})]}),e.jsx("div",{className:"mt-3 text-right text-sm font-medium",children:ie(o[p])})]})]},t.id)})})]}),e.jsxs("div",{className:"space-y-2 rounded-lg bg-muted p-3 sm:p-4 w-full",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Netto"}),e.jsx("span",{children:ie(g.subtotal)})]}),Object.entries(g.vatBreakdown).filter(([,{net:t}])=>t>0).sort(([t],[p])=>Number(p)-Number(t)).map(([t,{net:p,vat:N}])=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:["MwSt ",t,"% auf ",ie(p)]}),e.jsx("span",{children:ie(N)})]},t)),e.jsxs("div",{className:"flex justify-between border-t pt-2 font-semibold",children:[e.jsx("span",{children:"Gesamt"}),e.jsx("span",{children:ie(g.total)})]})]}),e.jsxs("div",{className:"space-y-3 rounded-lg border p-4",children:[e.jsx(P,{className:"text-sm font-semibold",children:"E-Rechnung (optional)"}),e.jsxs("div",{className:"grid gap-3 grid-cols-1 sm:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"eInvoiceFormat",className:"text-xs text-muted-foreground",children:"Format"}),e.jsxs(G,{value:h,onValueChange:C,children:[e.jsx(J,{id:"eInvoiceFormat",children:e.jsx(K,{})}),e.jsxs(W,{children:[e.jsx(x,{value:"none",children:"Keine E-Rechnung"}),e.jsx(x,{value:"zugferd",children:"ZUGFeRD"}),e.jsx(x,{value:"xrechnung",children:"X-Rechnung"})]})]})]}),h==="xrechnung"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"leitwegId",className:"text-xs text-muted-foreground",children:"Leitweg-ID"}),e.jsx(_,{id:"leitwegId",value:m,onChange:t=>O(t.target.value),placeholder:"z.B. 04011000-1234512345-06"})]}),h!=="none"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"buyerReference",className:"text-xs text-muted-foreground",children:"Buyer Reference"}),e.jsx(_,{id:"buyerReference",value:te,onChange:t=>le(t.target.value),placeholder:"KÃ¤ufer-Referenz"})]})]})]}),e.jsxs("div",{className:"space-y-2 w-full",children:[e.jsx(P,{htmlFor:"notes",children:"Notes"}),e.jsx(_e,{id:"notes",value:se,onChange:t=>de(t.target.value),placeholder:"Additional notes...",rows:3,className:"w-full"})]}),e.jsxs("div",{className:"flex flex-col-reverse sm:flex-row sm:justify-end gap-2 sm:gap-3 pt-2",children:[e.jsx(q,{type:"button",variant:"outline",onClick:E,className:"w-full sm:w-auto",children:"Cancel"}),e.jsxs(q,{type:"submit",disabled:ne,className:"w-full sm:w-auto",children:[ne&&e.jsx(Se,{className:"mr-2 h-4 w-4 animate-spin"}),"Save Invoice"]})]})]})}function st({open:s,onOpenChange:c,invoice:E,onClose:T,onSuccess:v}){const D=async d=>{try{if(E)await A.update(E.id,{issueDate:d.invoiceDate.toISOString(),dueDate:d.dueDate.toISOString(),clientId:d.clientId||"",projectId:d.projectId,taxRate:d.vatRate,notes:d.notes,lineItems:d.items.map(r=>({id:crypto.randomUUID(),description:r.description,quantity:r.quantity,unit:r.unit||"hours",unitPrice:r.unitPrice,amount:r.quantity*r.unitPrice}))}),Z.success("Invoice updated");else{const r=await A.create({invoiceNumber:"",clientId:d.clientId||"",projectId:d.projectId,issueDate:d.invoiceDate.toISOString(),dueDate:d.dueDate.toISOString(),status:"draft",amount:d.items.reduce((I,u)=>I+u.quantity*u.unitPrice,0),currency:"EUR",taxRate:d.vatRate,taxAmount:0,totalAmount:0,notes:d.notes,lineItems:d.items.map(I=>({id:crypto.randomUUID(),description:I.description,quantity:I.quantity,unit:I.unit||"hours",unitPrice:I.unitPrice,amount:I.quantity*I.unitPrice})),updatedAt:new Date().toISOString()});Z.success(`Invoice ${r.invoiceNumber} created`)}T(),v==null||v()}catch(r){console.error("Invoice save error:",r),Z.error(r instanceof Error?r.message:"Failed to save invoice")}};return e.jsx(Le,{open:s,onOpenChange:c,children:e.jsx($e,{className:"w-[calc(100vw-1rem)] sm:w-[calc(100vw-2rem)] max-w-[700px] max-h-[85vh] sm:max-h-[90vh] overflow-y-auto overflow-x-hidden p-4 sm:p-6 [&>*]:max-w-full",children:e.jsx(tt,{invoice:E||void 0,onSubmit:D,onCancel:T})})})}function he(s){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(s)}function we(s){return new Intl.DateTimeFormat("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"}).format(s)}function at(s){switch(s){case"draft":return{variant:"secondary",label:"Draft"};case"sent":return{variant:"default",label:"Sent"};case"paid":return{variant:"outline",label:"Paid"};case"overdue":return{variant:"destructive",label:"Overdue"};case"cancelled":return{variant:"secondary",label:"Cancelled"};default:return{variant:"secondary",label:s}}}function It(){const[s,c]=l.useState(!1),[E,T]=l.useState(null),[v,D]=l.useState("all"),[d,r]=l.useState(null),[I,u]=l.useState(null),R=Xe(),{invoices:S,isLoading:z,error:M,markAsSent:ce,markAsPaid:se,deleteInvoice:de,refresh:U}=Ze(),{clients:ae}=Ie(),{projects:V,initialize:ee}=De();l.useEffect(()=>{ee()},[ee]);const ne=l.useMemo(()=>new Map(ae.map(n=>[n.id,n])),[ae]),re=l.useMemo(()=>new Map(V.map(n=>[n.id,n])),[V]),a=l.useMemo(()=>{const n=S.filter(y=>y.status==="draft").length,o=S.filter(y=>y.status==="sent"&&!xe(y.dueDate)).length,g=S.filter(y=>y.status==="paid").length,f=S.filter(y=>y.status==="overdue"||y.status==="sent"&&xe(y.dueDate)).length,k=new Date().getFullYear(),b=S.filter(y=>y.status==="paid"&&y.paymentDate&&y.paymentDate.getFullYear()===k).reduce((y,fe)=>y+fe.total,0);return{draft:n,sent:o,paid:g,overdue:f,ytdRevenue:b}},[S]),i=l.useMemo(()=>{const n=new Date().getFullYear();return["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"].map((g,f)=>{const k=S.filter(b=>b.status==="paid"&&b.paymentDate&&b.paymentDate.getFullYear()===n&&b.paymentDate.getMonth()===f).reduce((b,y)=>b+y.total,0);return{month:g,revenue:k}})},[S]),h=l.useMemo(()=>S.filter(n=>{const o=n.status==="sent"&&xe(n.dueDate);switch(v){case"draft":return n.status==="draft";case"sent":return n.status==="sent"&&!o;case"paid":return n.status==="paid";case"overdue":return o||n.status==="overdue";default:return!0}}),[S,v]),C=n=>{T(n),c(!0)},m=()=>{c(!1),T(null)},O=()=>{U()},te=async(n,o)=>{n.stopPropagation(),await ce(o.id)&&Z.success(`Invoice ${o.invoiceNumber} marked as sent`)},le=async(n,o)=>{n.stopPropagation(),await se(o.id,new Date)&&(Z.success(`Invoice ${o.invoiceNumber} marked as paid`),R.trigger())},me=(n,o)=>{n.stopPropagation(),r(o)},pe=async()=>{d&&(await de(d.id)&&Z.success(`Invoice ${d.invoiceNumber} deleted`),r(null))},B=async(n,o)=>{n.stopPropagation(),u(o.id);try{const g=await Fe.downloadInvoicePdf(o.id),f=window.URL.createObjectURL(g),k=document.createElement("a");k.href=f,k.download=`${o.invoiceNumber}.pdf`,document.body.appendChild(k),k.click(),document.body.removeChild(k),window.URL.revokeObjectURL(f),Z.success("PDF downloaded")}catch(g){console.error("Failed to download PDF:",g),Z.error("Failed to download PDF")}finally{u(null)}};return M?e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{children:e.jsx("h1",{className:"text-2xl sm:text-3xl font-semibold tracking-tight",children:"Invoices"})}),e.jsx(Y,{children:e.jsxs(Q,{className:"p-12 text-center",children:[e.jsx("p",{className:"text-destructive",children:M}),e.jsx(q,{variant:"outline",className:"mt-4",onClick:()=>window.location.reload(),children:"Retry"})]})})]}):e.jsxs("div",{className:"space-y-6 animate-in fade-in",children:[e.jsx(We,{isActive:R.isActive,onComplete:R.onComplete}),e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:[e.jsx("div",{children:e.jsx("h1",{className:"text-2xl sm:text-3xl font-semibold tracking-tight",children:"Invoices"})}),e.jsxs(q,{onClick:()=>c(!0),className:"w-full sm:w-auto",children:[e.jsx(je,{className:"h-4 w-4 mr-2"}),"Create Invoice"]})]}),e.jsxs("div",{className:"grid gap-3 sm:gap-4 grid-cols-2 sm:grid-cols-3 lg:grid-cols-5",children:[e.jsx(Y,{children:e.jsxs(Q,{className:"pt-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Draft"}),e.jsx("p",{className:"text-2xl font-bold",children:a.draft})]})}),e.jsx(Y,{children:e.jsxs(Q,{className:"pt-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Sent"}),e.jsx("p",{className:"text-2xl font-bold",children:a.sent})]})}),e.jsx(Y,{children:e.jsxs(Q,{className:"pt-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Paid"}),e.jsx("p",{className:"text-2xl font-bold text-green-600",children:a.paid})]})}),e.jsx(Y,{children:e.jsxs(Q,{className:"pt-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Overdue"}),e.jsx("p",{className:"text-2xl font-bold text-destructive",children:a.overdue})]})}),e.jsx(Y,{className:"bg-primary/5",children:e.jsxs(Q,{className:"pt-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"YTD Revenue"}),e.jsx("p",{className:"text-2xl font-bold text-primary",children:he(a.ytdRevenue)})]})})]}),a.ytdRevenue>0&&e.jsxs(Y,{children:[e.jsx(Ae,{className:"pb-2",children:e.jsxs(Ee,{className:"text-base flex items-center gap-2",children:[e.jsx(Qe,{className:"h-4 w-4"}),new Date().getFullYear()," Revenue"]})}),e.jsx(Q,{children:e.jsx("div",{className:"flex gap-1 h-16",children:i.map((n,o)=>{const g=Math.max(...i.map(k=>k.revenue)),f=g>0?n.revenue/g*100:0;return e.jsxs("div",{className:"flex-1 flex flex-col justify-end items-center gap-1",children:[e.jsx("div",{className:"w-full bg-primary/80 rounded-t transition-all",style:{height:`${f}%`,minHeight:f>0?4:0}}),e.jsx("span",{className:"text-[10px] text-muted-foreground",children:n.month})]},o)})})})]}),e.jsxs(Me,{value:v,onValueChange:D,children:[e.jsxs(Te,{className:"flex w-full overflow-x-auto gap-1 sm:inline-flex sm:w-auto",children:[e.jsxs(ue,{value:"all",className:"flex-shrink-0",children:["All (",S.length,")"]}),e.jsxs(ue,{value:"draft",className:"flex-shrink-0",children:["Draft (",a.draft,")"]}),e.jsxs(ue,{value:"sent",className:"flex-shrink-0",children:["Sent (",a.sent,")"]}),e.jsxs(ue,{value:"overdue",className:"text-destructive flex-shrink-0",children:["Overdue (",a.overdue,")"]}),e.jsxs(ue,{value:"paid",className:"flex-shrink-0",children:["Paid (",a.paid,")"]})]}),e.jsx(Oe,{value:v,className:"mt-4",children:z?e.jsx(Y,{children:e.jsxs(Q,{className:"p-12 text-center",children:[e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent mx-auto"}),e.jsx("p",{className:"text-muted-foreground mt-4",children:"Loading invoices..."})]})}):h.length===0?e.jsx(Y,{children:e.jsxs(Q,{className:"p-12 text-center",children:[e.jsx(He,{className:"h-12 w-12 mx-auto text-muted-foreground/50 mb-4"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:v==="all"?"No invoices yet":`No ${v} invoices`}),e.jsx("p",{className:"text-muted-foreground text-sm mb-4",children:v==="all"?"Create your first invoice to get started.":`You don't have any ${v} invoices.`}),v==="all"&&e.jsxs(q,{onClick:()=>c(!0),children:[e.jsx(je,{className:"h-4 w-4 mr-2"}),"Create Invoice"]})]})}):e.jsx("div",{className:"rounded-md border overflow-x-auto",children:e.jsxs(qe,{className:"min-w-[900px]",children:[e.jsx(Ue,{children:e.jsxs(ye,{children:[e.jsx(L,{children:"Invoice â„–"}),e.jsx(L,{children:"Client"}),e.jsx(L,{children:"Project"}),e.jsx(L,{children:"Date"}),e.jsx(L,{children:"Due Date"}),e.jsx(L,{children:"Status"}),e.jsx(L,{className:"text-right",children:"Net"}),e.jsx(L,{className:"text-right",children:"VAT"}),e.jsx(L,{className:"text-right",children:"Total"}),e.jsx(L,{className:"w-[100px]",children:"Actions"})]})}),e.jsx(Be,{children:h.map(n=>{var f,k;const o=at(n.status),g=n.status==="sent"&&xe(n.dueDate);return e.jsxs(ye,{className:"cursor-pointer hover:bg-muted/50",onClick:()=>C(n),children:[e.jsx($,{className:"font-medium",children:n.invoiceNumber}),e.jsx($,{children:n.clientId?((f=ne.get(n.clientId))==null?void 0:f.name)??"â€”":"â€”"}),e.jsx($,{children:n.projectId?((k=re.get(n.projectId))==null?void 0:k.name)??"â€”":"â€”"}),e.jsx($,{children:we(n.invoiceDate)}),e.jsx($,{className:g?"text-destructive":"",children:we(n.dueDate)}),e.jsx($,{children:e.jsx(Re,{variant:g?"destructive":o.variant,children:g?"Overdue":o.label})}),e.jsx($,{className:"text-right",children:he(n.subtotal)}),e.jsx($,{className:"text-right text-muted-foreground",children:he(n.vatAmount)}),e.jsx($,{className:"text-right font-medium",children:he(n.total)}),e.jsx($,{children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(q,{variant:"ghost",size:"icon",onClick:b=>B(b,n),title:"Download PDF",disabled:I===n.id,children:I===n.id?e.jsx(Se,{className:"h-4 w-4 animate-spin text-muted-foreground"}):e.jsx(Ge,{className:"h-4 w-4 text-muted-foreground hover:text-primary"})}),n.status==="draft"&&e.jsx(q,{variant:"ghost",size:"icon",onClick:b=>te(b,n),title:"Mark as Sent",children:e.jsx(Je,{className:"h-4 w-4 text-muted-foreground hover:text-primary"})}),(n.status==="sent"||n.status==="overdue"||g)&&e.jsx(q,{variant:"ghost",size:"icon",onClick:b=>le(b,n),title:"Mark as Paid",children:e.jsx(Ke,{className:"h-4 w-4 text-muted-foreground hover:text-green-600"})}),e.jsx(q,{variant:"ghost",size:"icon",onClick:b=>me(b,n),title:"Delete Invoice",children:e.jsx(ge,{className:"h-4 w-4 text-destructive"})})]})})]},n.id)})})]})})})]}),e.jsx(st,{open:s,onOpenChange:c,invoice:E,onClose:m,onSuccess:O}),e.jsx(Ce,{open:!!d,onOpenChange:n=>!n&&r(null),title:`Delete invoice ${d==null?void 0:d.invoiceNumber}?`,description:"This will permanently delete this invoice. This action cannot be undone.",onConfirm:pe})]})}export{It as InvoicesPage};
