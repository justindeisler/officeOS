import{j as e,r as i}from"./vendor-react-wuMqdllU.js";import{i as X,a as v,B as K,L as j,I as w,k as h}from"./index-BJ9hpEov.js";import{b}from"./bankingService-C9qt3mZe.js";import{C as ee,c as se}from"./card-BOU-q13f.js";import{o as Y,t as $,d as z,f as oe,$ as de,_ as ue,G as te}from"./vendor-icons-ssgfUAX_.js";import{D as he,a as xe,b as me,c as ge}from"./dialog-BPcAFwmD.js";import{S as je}from"./switch-BGK1s4qN.js";import{S as M,a as T,b as E,c as L,d as m}from"./select-DW4QIkWb.js";import{u as ve}from"./useClients-Ny5hLbBc.js";import"./vendor-markdown-C3iCDuOK.js";import"./vendor-recharts-tRgwS7-V.js";import"./vendor-radix-DqeMb71O.js";import"./vendor-floating-ui-BD6aHMKr.js";import"./vendor-router-Cm8Qzw9U.js";function fe(r){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(r)}const ye={monthly:"Monatlich",quarterly:"Quartalsweise",yearly:"Jährlich"};function pe(r){try{return JSON.parse(r).reduce((a,l)=>a+l.quantity*l.unit_price,0)}catch{return 0}}function Ne(r,x,a=3){const l=[];let n=new Date(r);for(let d=0;d<a;d++)switch(l.push(n.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"})),x){case"monthly":n=new Date(n.setMonth(n.getMonth()+1));break;case"quarterly":n=new Date(n.setMonth(n.getMonth()+3));break;case"yearly":n=new Date(n.setFullYear(n.getFullYear()+1));break}return l}function we({templates:r,isLoading:x,onCreateTemplate:a,onEditTemplate:l,onGenerate:n,onToggleActive:d,onDelete:f,generatingId:y,className:S}){return x?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(Y,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):e.jsxs("div",{className:X("space-y-4",S),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Wiederkehrende Rechnungen"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[r.length," ",r.length===1?"Vorlage":"Vorlagen"]})]}),e.jsxs(v,{onClick:a,children:[e.jsx($,{className:"h-4 w-4 mr-2"}),"Neue Vorlage"]})]}),r.length===0?e.jsx(ee,{children:e.jsxs(se,{className:"py-12 text-center text-muted-foreground",children:[e.jsx(z,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"Keine wiederkehrenden Rechnungen konfiguriert."}),e.jsx("p",{className:"text-sm mt-1",children:"Erstellen Sie Vorlagen für automatische Rechnungserstellung."}),e.jsxs(v,{onClick:a,className:"mt-4",children:[e.jsx($,{className:"h-4 w-4 mr-2"}),"Erste Vorlage erstellen"]})]})}):e.jsx("div",{className:"space-y-2",children:r.map(t=>{const o=pe(t.items_json),p=y===t.id,N=Ne(t.next_date,t.frequency);return e.jsx(ee,{className:X(!t.is_active&&"opacity-60"),children:e.jsx(se,{className:"py-4",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0 cursor-pointer",onClick:()=>l==null?void 0:l(t),children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("h3",{className:"font-medium",children:t.name}),e.jsx(K,{variant:t.is_active?"default":"secondary",children:t.is_active?"Aktiv":"Pausiert"}),e.jsx(K,{variant:"outline",className:"text-[10px]",children:ye[t.frequency]||t.frequency})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-x-4 gap-y-1 mt-2 text-sm text-muted-foreground",children:[e.jsxs("span",{children:["Nächste:"," ",e.jsx("span",{className:"text-foreground",children:new Date(t.next_date).toLocaleDateString("de-DE")})]}),e.jsxs("span",{children:["Betrag:"," ",e.jsx("span",{className:"text-foreground font-medium",children:fe(o)})]}),e.jsxs("span",{children:[t.generated_count," erstellt"]}),t.auto_send===1&&e.jsx(K,{variant:"outline",className:"text-[10px] border-green-300 text-green-700",children:"Auto-Versand"})]}),e.jsxs("div",{className:"flex items-center gap-1 mt-1.5 text-xs text-muted-foreground",children:[e.jsx(z,{className:"h-3 w-3"}),"Nächste Termine: ",N.join(" → ")]})]}),e.jsxs("div",{className:"flex items-center gap-1.5 flex-shrink-0",children:[e.jsx(v,{variant:"outline",size:"icon",className:"h-8 w-8",onClick:()=>n(t.id),disabled:p||!t.is_active,title:"Jetzt generieren",children:p?e.jsx(Y,{className:"h-4 w-4 animate-spin"}):e.jsx(oe,{className:"h-4 w-4"})}),e.jsx(v,{variant:"outline",size:"icon",className:"h-8 w-8",onClick:()=>d(t.id,!!t.is_active),title:t.is_active?"Pausieren":"Aktivieren",children:t.is_active?e.jsx(de,{className:"h-4 w-4"}):e.jsx(ue,{className:"h-4 w-4"})}),e.jsx(v,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>f(t.id),title:"Löschen",children:e.jsx(te,{className:"h-4 w-4 text-red-500"})})]})]})})},t.id)})})]})}function J(r){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(r)}function _e(r,x,a=3){const l=[];let n=new Date(r);for(let d=0;d<a;d++)switch(l.push(n.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"})),x){case"monthly":n=new Date(n.setMonth(n.getMonth()+1));break;case"quarterly":n=new Date(n.setMonth(n.getMonth()+3));break;case"yearly":n=new Date(n.setFullYear(n.getFullYear()+1));break}return l}function be({open:r,onOpenChange:x,template:a,onSave:l}){const n=!!a,{clients:d}=ve(),[f,y]=i.useState(""),[S,t]=i.useState(""),[o,p]=i.useState("monthly"),[N,I]=i.useState(new Date().toISOString().split("T")[0]),[V,R]=i.useState(""),[D,q]=i.useState(19),[c,C]=i.useState(14),[O,A]=i.useState(!1),[_,k]=i.useState([{description:"",quantity:1,unit:"hours",unit_price:0}]),[H,P]=i.useState(""),[Q,U]=i.useState(!1);i.useEffect(()=>{if(r&&a){y(a.name),t(a.client_id||""),p(a.frequency),I(a.next_date.split("T")[0]),R(a.end_date?a.end_date.split("T")[0]:""),q(a.vat_rate),C(a.payment_terms_days),A(a.auto_send===1),P(a.notes||"");try{const s=JSON.parse(a.items_json);k(s.length>0?s:[{description:"",quantity:1,unit:"hours",unit_price:0}])}catch{k([{description:"",quantity:1,unit:"hours",unit_price:0}])}}else r&&(y(""),t(""),p("monthly"),I(new Date().toISOString().split("T")[0]),R(""),q(19),C(14),A(!1),P(""),k([{description:"",quantity:1,unit:"hours",unit_price:0}]))},[r,a]);const G=i.useMemo(()=>_.reduce((s,u)=>s+u.quantity*u.unit_price,0),[_]),W=Math.round(G*(D/100)*100)/100,ne=G+W,ae=i.useMemo(()=>_e(N,o),[N,o]),F=(s,u,g)=>{k(B=>B.map((Z,le)=>le===s?{...Z,[u]:g}:Z))},re=()=>{k(s=>[...s,{description:"",quantity:1,unit:"hours",unit_price:0}])},ie=s=>{k(u=>u.filter((g,B)=>B!==s))},ce=async()=>{if(f.trim()&&!(_.length===0||!_[0].description)){U(!0);try{await l({name:f,client_id:S||null,frequency:o,next_date:N,end_date:V||null,vat_rate:D,payment_terms_days:c,auto_send:O?1:0,auto_generate:1,is_active:1,notes:H||null,items:_}),x(!1)}catch{}finally{U(!1)}}};return e.jsx(he,{open:r,onOpenChange:x,children:e.jsxs(xe,{className:"w-[calc(100vw-1rem)] max-w-[650px] max-h-[90vh] overflow-y-auto",children:[e.jsx(me,{children:e.jsx(ge,{children:n?"Vorlage bearbeiten":"Neue wiederkehrende Rechnung"})}),e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{children:"Name *"}),e.jsx(w,{value:f,onChange:s=>y(s.target.value),placeholder:"z.B. Monthly Hosting",autoFocus:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{children:"Kunde"}),e.jsxs(M,{value:S||"__none__",onValueChange:s=>t(s==="__none__"?"":s),children:[e.jsx(T,{children:e.jsx(E,{placeholder:"Kunde wählen"})}),e.jsxs(L,{children:[e.jsx(m,{value:"__none__",children:"Kein Kunde"}),d.map(s=>e.jsx(m,{value:s.id,children:s.name},s.id))]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{children:"Frequenz"}),e.jsxs(M,{value:o,onValueChange:p,children:[e.jsx(T,{children:e.jsx(E,{})}),e.jsxs(L,{children:[e.jsx(m,{value:"monthly",children:"Monatlich"}),e.jsx(m,{value:"quarterly",children:"Quartalsweise"}),e.jsx(m,{value:"yearly",children:"Jährlich"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{children:"Nächstes Datum"}),e.jsx(w,{type:"date",value:N,onChange:s=>I(s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(j,{children:["Enddatum"," ",e.jsx("span",{className:"text-xs text-muted-foreground",children:"(optional)"})]}),e.jsx(w,{type:"date",value:V,onChange:s=>R(s.target.value)})]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground bg-muted/50 rounded-lg p-3",children:[e.jsx(z,{className:"h-4 w-4 flex-shrink-0"}),e.jsxs("span",{children:["Nächste Termine: ",ae.join(" → ")]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{children:"MwSt-Satz"}),e.jsxs(M,{value:String(D),onValueChange:s=>q(Number(s)),children:[e.jsx(T,{children:e.jsx(E,{})}),e.jsxs(L,{children:[e.jsx(m,{value:"19",children:"19%"}),e.jsx(m,{value:"7",children:"7%"}),e.jsx(m,{value:"0",children:"0%"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{children:"Zahlungsziel (Tage)"}),e.jsx(w,{type:"number",value:c,onChange:s=>C(Number(s.target.value))})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs("div",{className:"flex items-center gap-2 pb-2",children:[e.jsx(je,{checked:O,onCheckedChange:A,id:"autoSend"}),e.jsx(j,{htmlFor:"autoSend",className:"text-sm cursor-pointer",children:"Auto-Versand"})]})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(j,{children:"Positionen"}),e.jsxs(v,{variant:"outline",size:"sm",onClick:re,children:[e.jsx($,{className:"h-3.5 w-3.5 mr-1"}),"Position"]})]}),_.map((s,u)=>e.jsxs("div",{className:"grid grid-cols-[1fr_70px_70px_80px_32px] gap-2 items-center",children:[e.jsx(w,{placeholder:"Beschreibung",value:s.description,onChange:g=>F(u,"description",g.target.value)}),e.jsx(w,{type:"number",placeholder:"Menge",value:s.quantity,onChange:g=>F(u,"quantity",Number(g.target.value))}),e.jsxs(M,{value:s.unit,onValueChange:g=>F(u,"unit",g),children:[e.jsx(T,{className:"h-9",children:e.jsx(E,{})}),e.jsxs(L,{children:[e.jsx(m,{value:"hours",children:"Std"}),e.jsx(m,{value:"days",children:"Tage"}),e.jsx(m,{value:"month",children:"Mon"}),e.jsx(m,{value:"units",children:"Stk"})]})]}),e.jsx(w,{type:"number",placeholder:"Preis",step:"0.01",value:s.unit_price,onChange:g=>F(u,"unit_price",Number(g.target.value))}),e.jsx(v,{variant:"ghost",size:"icon",className:"h-9 w-9",onClick:()=>ie(u),disabled:_.length<=1,children:e.jsx(te,{className:"h-3.5 w-3.5 text-muted-foreground"})})]},u)),e.jsxs("div",{className:"rounded-lg bg-muted p-3 space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Netto"}),e.jsx("span",{children:J(G)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"text-muted-foreground",children:["MwSt (",D,"%)"]}),e.jsx("span",{children:J(W)})]}),e.jsxs("div",{className:"flex justify-between font-semibold border-t pt-1",children:[e.jsx("span",{children:"Gesamt"}),e.jsx("span",{children:J(ne)})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(j,{children:["Notizen"," ",e.jsx("span",{className:"text-xs text-muted-foreground",children:"(optional)"})]}),e.jsx(w,{value:H,onChange:s=>P(s.target.value),placeholder:"Anmerkungen zur Vorlage..."})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(v,{variant:"outline",onClick:()=>x(!1),className:"flex-1",children:"Abbrechen"}),e.jsxs(v,{onClick:ce,disabled:Q,className:"flex-1",children:[Q&&e.jsx(Y,{className:"h-4 w-4 mr-2 animate-spin"}),n?"Speichern":"Vorlage erstellen"]})]})]})]})})}function Ae(){const[r,x]=i.useState([]),[a,l]=i.useState(!0),[n,d]=i.useState(!1),[f,y]=i.useState(null),[S,t]=i.useState(null),o=i.useCallback(async()=>{try{const c=await b.getRecurringInvoices();x(c)}catch{h.error("Fehler beim Laden")}finally{l(!1)}},[]);i.useEffect(()=>{o()},[o]);const p=()=>{y(null),d(!0)},N=c=>{y(c),d(!0)},I=async c=>{try{f?(await b.updateRecurringInvoice(f.id,c),h.success("Vorlage aktualisiert")):(await b.createRecurringInvoice(c),h.success("Vorlage erstellt")),o()}catch{throw h.error("Fehler beim Speichern"),new Error("save failed")}},V=async c=>{t(c);try{await b.generateFromRecurring(c),h.success("Rechnung generiert"),o()}catch{h.error("Fehler beim Generieren")}finally{t(null)}},R=async(c,C)=>{try{await b.updateRecurringInvoice(c,{is_active:C?0:1}),h.success(C?"Pausiert":"Aktiviert"),o()}catch{h.error("Fehler")}},D=async c=>{try{await b.deleteRecurringInvoice(c),h.success("Vorlage gelöscht"),o()}catch{h.error("Fehler beim Löschen")}},q=async()=>{try{const c=await b.processRecurring();c.generated>0?h.success(`${c.generated} Rechnungen generiert`):h.info("Keine fälligen Vorlagen"),o()}catch{h.error("Fehler beim Verarbeiten")}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Wiederkehrende Rechnungen"}),e.jsx("p",{className:"text-muted-foreground",children:"Automatische Rechnungserstellung"})]}),e.jsxs(v,{variant:"outline",onClick:q,children:[e.jsx(z,{className:"h-4 w-4 mr-2"}),"Fällige verarbeiten"]})]}),e.jsx(we,{templates:r,isLoading:a,onCreateTemplate:p,onEditTemplate:N,onGenerate:V,onToggleActive:R,onDelete:D,generatingId:S}),e.jsx(be,{open:n,onOpenChange:d,template:f,onSave:I})]})}export{Ae as RecurringInvoicesPage};
