const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-B9wpeZVf.js","assets/vendor-react-DeR5d9Tv.js","assets/vendor-router-9bGSKQ4q.js","assets/index-DEy-KA7P.css"])))=>i.map(i=>d[i]);
import{r,j as e}from"./vendor-react-DeR5d9Tv.js";import{u as Ne,E as ye}from"./ExpenseDialog-Bj4X75FY.js";import{c as Y,j as D,s as Z,V as we,a as A,I as V,B as T,F as H,O as ce,_ as he,X as ke,a0 as Ce,L as G,l as X}from"./index-B9wpeZVf.js";import{T as _e,a as Ie,b as oe,c as P,d as De,e as R}from"./table-pJl76dEH.js";import{C as Se}from"./confirm-delete-dialog-LuDEhVpD.js";import{P as Ee}from"./plus-BG4HFTMm.js";import{S as Ae}from"./search-CsGBUCyq.js";import{D as Pe}from"./download-DMg57E9E.js";import{T as Re}from"./trash-2-BAQCKdVR.js";import{u as Le,a as Te,o as Fe,n as de,s as z,e as Ue}from"./vendor-forms-slL2B-gN.js";import{s as pe,t as Me}from"./vendor-radix-sPo3_CXI.js";import{C as Oe}from"./check-BOz78U_D.js";import{C as Ve}from"./chevron-up-Csf9Xqjr.js";import{C as K}from"./circle-check-big-BcRTjbGf.js";import{C as J}from"./circle-alert-DR10Pc3C.js";import{T as B}from"./triangle-alert-DBjitRmJ.js";import{D as $e,a as qe}from"./dialog-FtNsGa4T.js";import{U as ze}from"./upload-Ddt_p2-Y.js";import"./vendor-markdown-PIr_2kdo.js";import"./index-uXN-dP3D.js";import"./vendor-recharts-DrMJw15s.js";import"./vendor-router-9bGSKQ4q.js";import"./vendor-floating-ui-CESiY8Ey.js";import"./alert-dialog-83Lj5Hrs.js";/**
 * @license lucide-react v0.469.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ge=Y("Camera",[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]]);/**
 * @license lucide-react v0.469.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ge=Y("Paperclip",[["path",{d:"M13.234 20.252 21 12.3",key:"1cbrk9"}],["path",{d:"m16 6-8.414 8.586a2 2 0 0 0 0 2.828 2 2 0 0 0 2.828 0l8.414-8.586a4 4 0 0 0 0-5.656 4 4 0 0 0-5.656 0l-8.415 8.585a6 6 0 1 0 8.486 8.486",key:"1pkts6"}]]);/**
 * @license lucide-react v0.469.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Be=Y("ShoppingCart",[["circle",{cx:"8",cy:"21",r:"1",key:"jimo8o"}],["circle",{cx:"19",cy:"21",r:"1",key:"13723u"}],["path",{d:"M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12",key:"9zh506"}]]);function O(l){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(l)}function He(l){return new Intl.DateTimeFormat("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"}).format(l)}function We({onAddExpense:l,onEditExpense:c,onScanInvoice:p,className:o,refreshTrigger:m}){const{expenses:v,isLoading:b,error:C,deleteExpense:y,setSelectedExpense:t,refresh:N}=Ne(),[g,w]=r.useState(""),[j,E]=r.useState(null);r.useEffect(()=>{m&&m>0&&N()},[m,N]);const i=r.useMemo(()=>{if(!g)return v;const s=g.toLowerCase();return v.filter(n=>n.description.toLowerCase().includes(s)||n.vendor.toLowerCase().includes(s)||n.euerCategory.toLowerCase().includes(s))},[v,g]),I=r.useMemo(()=>i.reduce((s,n)=>({net:s.net+n.netAmount,vat:s.vat+n.vatAmount,gross:s.gross+n.grossAmount}),{net:0,vat:0,gross:0}),[i]),F=s=>{t(s),c==null||c(s)},k=(s,n)=>{s.stopPropagation(),E(n)},U=async()=>{j&&(await y(j),E(null))};return b?e.jsxs("div",{className:D("flex items-center justify-center p-8",o),children:[e.jsx(Z,{className:"h-8 w-8 animate-spin text-muted-foreground"}),e.jsx("span",{className:"ml-2 text-muted-foreground",children:"Loading..."})]}):C?e.jsxs("div",{className:D("p-8 text-center",o),children:[e.jsx("p",{className:"text-destructive",children:we(C)}),e.jsx(A,{variant:"outline",className:"mt-4",onClick:()=>window.location.reload(),children:"Retry"})]}):e.jsxs("div",{className:D("space-y-4",o),children:[e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:[e.jsx("h2",{className:"text-2xl sm:text-3xl font-semibold tracking-tight",children:"Expenses"}),e.jsxs("div",{className:"flex gap-2 w-full sm:w-auto",children:[p&&e.jsxs(A,{variant:"outline",onClick:p,className:"flex-1 sm:flex-none",children:[e.jsx(ge,{className:"mr-2 h-4 w-4"}),"Scan Invoice"]}),e.jsxs(A,{onClick:l,className:"flex-1 sm:flex-none",children:[e.jsx(Ee,{className:"mr-2 h-4 w-4"}),"Add Expense"]})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Ae,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(V,{placeholder:"Search expenses...",value:g,onChange:s=>w(s.target.value),className:"pl-10"})]}),i.length===0?e.jsx("div",{className:"rounded-lg border border-dashed p-8 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:g?"No expense records match your search":"No expense records yet. Add your first expense to get started."})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"rounded-md border overflow-x-auto",children:e.jsxs(_e,{className:"min-w-[800px]",children:[e.jsx(Ie,{children:e.jsxs(oe,{children:[e.jsx(P,{children:"Date"}),e.jsx(P,{children:"Vendor"}),e.jsx(P,{children:"Description"}),e.jsx(P,{children:"VAT"}),e.jsx(P,{className:"text-right",children:"Net"}),e.jsx(P,{className:"text-right",children:"Vorsteuer"}),e.jsx(P,{className:"text-right",children:"Gross"}),e.jsx(P,{className:"text-center",children:"Receipt"}),e.jsx(P,{className:"w-[50px]"})]})}),e.jsx(De,{children:i.map(s=>e.jsxs(oe,{className:"cursor-pointer hover:bg-muted/50",onClick:()=>F(s),children:[e.jsx(R,{className:"font-medium",children:He(s.date)}),e.jsx(R,{children:s.vendor}),e.jsx(R,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:s.description}),s.vorsteuerClaimed&&e.jsx(T,{variant:"secondary",className:"text-xs",children:"Claimed"}),s.isRecurring&&e.jsx(T,{variant:"outline",className:"text-xs",children:"Recurring"}),s.isGwg&&e.jsx(T,{variant:"default",className:"text-xs",children:"GWG"})]})}),e.jsx(R,{children:e.jsxs(T,{variant:"outline",children:[s.vatRate,"%"]})}),e.jsx(R,{className:"text-right",children:O(s.netAmount)}),e.jsx(R,{className:"text-right",children:O(s.vatAmount)}),e.jsx(R,{className:"text-right font-medium",children:O(s.grossAmount)}),e.jsx(R,{className:"text-center",children:s.receiptPath||s.attachmentId?e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[s.attachmentId&&e.jsx(Ge,{className:"h-3 w-3 text-primary shrink-0","aria-label":"Has attachment"}),e.jsx(A,{variant:"ghost",size:"icon",onClick:n=>{n.stopPropagation(),n.preventDefault();const u=s.attachmentId?`/attachments/${s.attachmentId}/file`:`/expenses/${s.id}/receipt`,f=window.open("about:blank","_blank");ce.requestBlob(u).then(d=>{const S=URL.createObjectURL(d);if(f)f.location.href=S;else{const _=document.createElement("a");_.href=S,_.target="_blank",_.click()}}).catch(()=>{f&&f.close(),alert("Failed to view receipt")})},"aria-label":"View receipt",title:"View PDF",children:e.jsx(H,{className:"h-4 w-4 text-muted-foreground hover:text-primary"})}),e.jsx(A,{variant:"ghost",size:"icon",onClick:n=>{n.stopPropagation(),n.preventDefault();const u=s.attachmentId?`/attachments/${s.attachmentId}/file?download=true`:`/expenses/${s.id}/receipt?download=true`,f=window.open("about:blank","_blank");ce.requestBlob(u).then(d=>{const S=URL.createObjectURL(d);if(f)f.location.href=S;else{const _=document.createElement("a");_.href=S,_.download=`receipt-${s.id}.pdf`,document.body.appendChild(_),_.click(),document.body.removeChild(_)}}).catch(()=>{f&&f.close(),alert("Failed to download receipt")})},"aria-label":"Download receipt",title:"Download",children:e.jsx(Pe,{className:"h-4 w-4 text-muted-foreground hover:text-primary"})})]}):e.jsx("span",{className:"text-muted-foreground text-xs",children:"—"})}),e.jsx(R,{children:e.jsx(A,{variant:"ghost",size:"icon",onClick:n=>k(n,s.id),"aria-label":"Delete",children:e.jsx(Re,{className:"h-4 w-4 text-muted-foreground hover:text-destructive"})})})]},s.id))})]})}),e.jsx("div",{className:"flex justify-start sm:justify-end",children:e.jsxs("div",{className:"rounded-lg bg-muted p-3 sm:p-4 w-full sm:w-auto",children:[e.jsx("div",{className:"text-sm font-medium text-muted-foreground",children:"Total"}),e.jsxs("div",{className:"mt-1 grid grid-cols-3 gap-2 sm:gap-4 text-right",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Net"}),e.jsx("div",{className:"font-medium text-sm sm:text-base",children:O(I.net)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Vorsteuer"}),e.jsx("div",{className:"font-medium text-sm sm:text-base",children:O(I.vat)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Gross"}),e.jsx("div",{className:"font-semibold text-sm sm:text-base",children:O(I.gross)})]})]})]})})]}),e.jsx(Se,{open:!!j,onOpenChange:s=>!s&&E(null),title:"Delete expense?",description:"This will permanently delete this expense record. This action cannot be undone.",onConfirm:U})]})}const me=10*1024*1024,ue=".pdf,.jpg,.jpeg,.png,.webp,.heic,.heif";function Xe({onUploadComplete:l,onError:c,className:p}){const[o,m]=r.useState("idle"),[v,b]=r.useState(0),[C,y]=r.useState(null),[t,N]=r.useState(!1),g=r.useRef(null),w=r.useRef(null),j=r.useCallback(n=>{y(n),m("error"),c==null||c(n)},[c]),E=r.useCallback(n=>{var f;if(n.size>me)return j(`File too large. Maximum size is ${me/1024/1024} MB`),!1;const u="."+((f=n.name.split(".").pop())==null?void 0:f.toLowerCase());return ue.includes(u)?!0:(j("File type not supported. Accepted: PDF, JPEG, PNG, WebP, HEIC"),!1)},[j]),i=r.useCallback(async n=>{if(E(n)){m("uploading"),b(0),y(null);try{const u=setInterval(()=>{b(S=>Math.min(S+15,80))},200);m("processing"),b(85);const{api:f}=await he(async()=>{const{api:S}=await import("./index-B9wpeZVf.js").then(_=>_.ak);return{api:S}},__vite__mapDeps([0,1,2,3])),d=await f.uploadInvoice(n);clearInterval(u),b(100),l({attachmentId:d.attachment_id,extractionId:d.extraction_id,fileUrl:d.file_url,thumbnailUrl:d.thumbnail_url,file:n,extraction:d.extraction,duplicate:d.duplicate}),setTimeout(()=>{m("idle"),b(0)},500)}catch(u){j(u instanceof Error?u.message:"Upload failed. Please try again.")}}},[E,l,j]),I=r.useCallback(n=>{var f;const u=(f=n.target.files)==null?void 0:f[0];u&&i(u),n.target.value=""},[i]),F=r.useCallback(n=>{n.preventDefault(),N(!0)},[]),k=r.useCallback(n=>{n.preventDefault(),N(!1)},[]),U=r.useCallback(n=>{n.preventDefault(),N(!1);const u=n.dataTransfer.files[0];u&&i(u)},[i]),s=o==="uploading"||o==="processing";return e.jsxs("div",{className:D("space-y-3",p),children:[e.jsx("input",{ref:g,type:"file",accept:ue,onChange:I,className:"hidden","aria-hidden":"true"}),e.jsx("input",{ref:w,type:"file",accept:"image/*",capture:"environment",onChange:I,className:"hidden","aria-hidden":"true"}),e.jsx("div",{onDragOver:F,onDragLeave:k,onDrop:U,onClick:()=>{var n;return!s&&((n=g.current)==null?void 0:n.click())},className:D("relative rounded-lg border-2 border-dashed p-6 transition-all duration-200 cursor-pointer","flex flex-col items-center justify-center gap-3 text-center",t&&"border-primary bg-primary/5 scale-[1.02]",!t&&!s&&"border-muted-foreground/25 hover:border-muted-foreground/50 hover:bg-muted/30",s&&"border-muted-foreground/25 cursor-wait",o==="error"&&"border-destructive/50 bg-destructive/5"),children:s?e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx(Z,{className:"h-10 w-10 animate-spin text-primary"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-medium",children:o==="uploading"?"Uploading...":"Extracting invoice data..."}),e.jsx("p",{className:"text-xs text-muted-foreground",children:o==="uploading"?"Sending file to server":"AI is reading your invoice"})]}),e.jsx("div",{className:"w-full max-w-[200px] h-1.5 rounded-full bg-muted overflow-hidden",children:e.jsx("div",{className:"h-full bg-primary rounded-full transition-all duration-300",style:{width:`${v}%`}})})]}):o==="error"?e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx(J,{className:"h-10 w-10 text-destructive"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-medium text-destructive",children:C}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Click to try again"})]}),e.jsxs(A,{variant:"ghost",size:"sm",onClick:n=>{n.stopPropagation(),m("idle"),y(null)},children:[e.jsx(ke,{className:"h-3 w-3 mr-1"})," Dismiss"]})]}):e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[t?e.jsx(H,{className:"h-10 w-10 text-primary"}):e.jsx(ze,{className:"h-10 w-10 text-muted-foreground"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-medium",children:t?"Drop invoice here":"Upload invoice"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Drop a file here, click to browse, or take a photo"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"PDF, JPEG, PNG · Max 10 MB"})]})]})}),o==="idle"&&e.jsxs(A,{variant:"outline",size:"sm",className:"w-full sm:hidden",onClick:n=>{var u;n.stopPropagation(),(u=w.current)==null||u.click()},children:[e.jsx(ge,{className:"h-4 w-4 mr-2"}),"Take Photo"]})]})}const fe=r.forwardRef(({className:l,...c},p)=>e.jsx(pe,{ref:p,className:D("peer h-4 w-4 shrink-0 rounded-sm border border-primary shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",l),...c,children:e.jsx(Me,{className:D("flex items-center justify-center text-current"),children:e.jsx(Oe,{className:"h-3.5 w-3.5"})})}));fe.displayName=pe.displayName;function Ke(l,c,p){const m=l.filter((y,t)=>c.includes(t)).reduce((y,t)=>{const N=t.amount??(t.quantity??0)*(t.unitPrice??0);return y+N},0),v=Math.round(m*100)/100,b=Math.round(v*(p/100)*100)/100,C=Math.round((v+b)*100)/100;return{net_amount:v,vat_amount:b,gross_amount:C,vat_rate:p}}function xe(l){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(l)}const Je=Fe({date:z().min(1,"Date is required"),vendor:z().min(1,"Vendor is required"),description:z().min(1,"Description is required"),netAmount:de().positive("Amount must be positive"),vatRate:Ue(["0","7","19"]),euerCategory:z().min(1),deductiblePercent:de().min(0).max(100)}),Ye=[{value:"software",label:"Software & Lizenzen"},{value:"telecom",label:"Telekommunikation"},{value:"hosting",label:"Hosting & Domains"},{value:"travel",label:"Reisekosten"},{value:"insurance",label:"Versicherungen"},{value:"bank_fees",label:"Kontoführung"},{value:"training",label:"Fortbildung"},{value:"books",label:"Fachliteratur"},{value:"office_supplies",label:"Büromaterial"},{value:"subcontractor",label:"Fremdleistungen"},{value:"homeoffice",label:"Arbeitszimmer"},{value:"other",label:"Sonstige Kosten"}];function Ze({confidence:l}){return l>=.9?e.jsx(K,{className:"h-3.5 w-3.5 text-green-500 shrink-0","aria-label":"High confidence"}):l>=.7?e.jsx(K,{className:"h-3.5 w-3.5 text-yellow-500 shrink-0","aria-label":"Medium confidence"}):e.jsx(B,{className:"h-3.5 w-3.5 text-amber-500 shrink-0","aria-label":"Low confidence - please verify"})}function $({label:l,confidence:c,children:p,className:o}){const m=c!==void 0&&c<.7;return e.jsxs("div",{className:D("space-y-2",m&&"ring-1 ring-amber-300 rounded-md p-2 -m-2 bg-amber-50/50 dark:bg-amber-950/20",o),children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(G,{children:l}),c!==void 0&&e.jsx(Ze,{confidence:c}),m&&e.jsx("span",{className:"text-[10px] text-amber-600 dark:text-amber-400",children:"Verify"})]}),p]})}function q(l){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(l)}function Qe({upload:l,selectedLineItems:c,onSave:p,onCancel:o,className:m}){var ee,te,se,ae,ne,re,le,ie;const[v,b]=r.useState(!1),[C,y]=r.useState(!0),{extraction:t}=l,N=(((ee=t.line_items)==null?void 0:ee.length)??0)>0,[g,w]=r.useState(()=>{var a;return c??((a=t.line_items)==null?void 0:a.map((x,h)=>h))??[]}),j=N?g:void 0,E=j!==void 0&&((te=t.line_items)==null?void 0:te.length)>0&&j.length<t.line_items.length,i=r.useCallback(a=>{w(x=>x.includes(a)?x.filter(h=>h!==a):[...x,a].sort((h,L)=>h-L))},[]),I=r.useCallback(()=>{var a;w(((a=t.line_items)==null?void 0:a.map((x,h)=>h))??[])},[t.line_items]),F=r.useCallback(()=>{w([])},[]),k=r.useMemo(()=>{var a,x;return!j||!((a=t.line_items)!=null&&a.length)?null:Ke(t.line_items,j,((x=t.vat_rate)==null?void 0:x.value)??19)},[j,t.line_items,t.vat_rate]),U=r.useMemo(()=>{var a,x,h,L;return{date:((a=t.invoice_date)==null?void 0:a.value)||new Date().toISOString().split("T")[0],vendor:((x=t.vendor)==null?void 0:x.value)||"",description:t.suggested_description||"",netAmount:(k==null?void 0:k.net_amount)??((h=t.net_amount)==null?void 0:h.value)??0,vatRate:String((k==null?void 0:k.vat_rate)??((L=t.vat_rate)==null?void 0:L.value)??19),euerCategory:t.suggested_category||"software",deductiblePercent:100}},[t,k]),{register:s,handleSubmit:n,watch:u,setValue:f,formState:{errors:d}}=Le({resolver:Te(Je),defaultValues:U}),S=u("netAmount"),_=u("vatRate");r.useEffect(()=>{k&&f("netAmount",k.net_amount)},[k,f]);const M=r.useMemo(()=>{const a=Number(S)||0,x=Number(_)||19,h=Math.round(a*(x/100)*100)/100,L=Math.round((a+h)*100)/100;return{net:a,vat:h,gross:L,rate:x}},[S,_]),W=r.useMemo(()=>{var h;if(!((h=t.gross_amount)!=null&&h.value))return null;const a=t.gross_amount.value,x=Math.abs(M.gross-a);return x>.05?{extracted:a,calculated:M.gross,difference:x}:null},[M.gross,t.gross_amount]),ve=r.useCallback(async a=>{b(!0);try{await p({date:new Date(a.date),vendor:a.vendor,description:a.description,netAmount:a.netAmount,vatRate:Number(a.vatRate),euerLine:34,euerCategory:a.euerCategory,deductiblePercent:a.deductiblePercent,attachment_id:l.attachmentId,ocr_extraction_id:l.extractionId})}finally{b(!1)}},[p,l.attachmentId,l.extractionId]),be=l.file.type==="application/pdf",[Q]=r.useState(()=>URL.createObjectURL(l.file));return e.jsxs("div",{className:D("flex flex-col lg:flex-row gap-4 lg:gap-6",m),children:[e.jsxs("div",{className:"lg:w-1/2 lg:max-w-[500px]",children:[e.jsxs("button",{type:"button",className:"flex lg:hidden items-center gap-2 w-full p-3 rounded-lg bg-muted mb-2",onClick:()=>y(!C),children:[e.jsx(H,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm font-medium flex-1 text-left",children:l.file.name}),C?e.jsx(Ve,{className:"h-4 w-4"}):e.jsx(Ce,{className:"h-4 w-4"})]}),e.jsxs("div",{className:D("rounded-lg border overflow-hidden bg-muted/30",!C&&"hidden lg:block"),children:[e.jsxs("div",{className:"p-2 bg-muted border-b hidden lg:flex items-center gap-2",children:[e.jsx(H,{className:"h-4 w-4"}),e.jsx("span",{className:"text-xs font-medium truncate flex-1",children:l.file.name}),e.jsxs(T,{variant:"outline",className:"text-[10px]",children:[(l.file.size/1024).toFixed(0)," KB"]})]}),e.jsx("div",{className:"relative",style:{minHeight:"300px",maxHeight:"600px"},children:be?e.jsx("iframe",{src:Q,className:"w-full h-[400px] lg:h-[560px]",title:"Invoice preview"}):e.jsx("img",{src:Q,alt:"Invoice preview",className:"w-full h-auto max-h-[560px] object-contain"})})]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx(K,{className:"h-3 w-3 text-green-500"}),e.jsxs("span",{children:["Processed in ",((t.processing_time_ms||0)/1e3).toFixed(1),"s"]}),t.status==="completed"&&e.jsx(T,{variant:"secondary",className:"text-[10px]",children:E&&j?`${j.length}/${t.line_items.length} items`:`${((se=t.line_items)==null?void 0:se.length)||0} line items`})]})]}),e.jsx("div",{className:"lg:flex-1 lg:min-w-0",children:e.jsxs("form",{onSubmit:n(ve),className:"space-y-4",children:[t.is_credit_note&&e.jsxs("div",{className:"flex items-center gap-2 p-3 rounded-lg bg-amber-50 dark:bg-amber-950/30 border border-amber-200 dark:border-amber-800",children:[e.jsx(J,{className:"h-4 w-4 text-amber-600 shrink-0"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium text-amber-700 dark:text-amber-400",children:"Credit Note Detected"}),e.jsx("p",{className:"text-amber-600 dark:text-amber-500 text-xs",children:"This appears to be a Gutschrift. Consider creating a negative expense."})]})]}),l.duplicate&&e.jsxs("div",{className:"flex items-center gap-2 p-3 rounded-lg bg-blue-50 dark:bg-blue-950/30 border border-blue-200 dark:border-blue-800",children:[e.jsx(J,{className:"h-4 w-4 text-blue-600 shrink-0"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium text-blue-700 dark:text-blue-400",children:"Possible Duplicate"}),e.jsxs("p",{className:"text-blue-600 dark:text-blue-500 text-xs",children:["This file was already uploaded for an expense on ",l.duplicate.existing_date,"."]})]})]}),t.status!=="completed"&&e.jsxs("div",{className:"flex items-center gap-2 p-3 rounded-lg bg-yellow-50 dark:bg-yellow-950/30 border border-yellow-200 dark:border-yellow-800",children:[e.jsx(B,{className:"h-4 w-4 text-yellow-600 shrink-0"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium text-yellow-700 dark:text-yellow-400",children:"Extraction Incomplete"}),e.jsx("p",{className:"text-yellow-600 dark:text-yellow-500 text-xs",children:"Some fields could not be extracted. Please fill in the missing information manually."})]})]}),e.jsxs($,{label:"Invoice Date",confidence:(ae=t.invoice_date)==null?void 0:ae.confidence,children:[e.jsx(V,{type:"date",...s("date"),"aria-invalid":!!d.date}),d.date&&e.jsx("p",{className:"text-sm text-destructive",children:d.date.message})]}),e.jsxs($,{label:"Vendor",confidence:(ne=t.vendor)==null?void 0:ne.confidence,children:[e.jsx(V,{placeholder:"e.g., Hetzner Online GmbH",...s("vendor"),"aria-invalid":!!d.vendor}),d.vendor&&e.jsx("p",{className:"text-sm text-destructive",children:d.vendor.message})]}),e.jsxs($,{label:"Description",children:[e.jsx(V,{placeholder:"e.g., Cloud Server CX21",...s("description"),"aria-invalid":!!d.description}),d.description&&e.jsx("p",{className:"text-sm text-destructive",children:d.description.message})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs($,{label:"Net Amount (€)",confidence:(re=t.net_amount)==null?void 0:re.confidence,children:[e.jsx(V,{type:"number",step:"0.01",min:"0",placeholder:"0.00",...s("netAmount",{valueAsNumber:!0}),"aria-invalid":!!d.netAmount}),d.netAmount&&e.jsx("p",{className:"text-sm text-destructive",children:d.netAmount.message})]}),e.jsx($,{label:"VAT Rate",confidence:(le=t.vat_rate)==null?void 0:le.confidence,children:e.jsxs("select",{className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",...s("vatRate"),children:[e.jsx("option",{value:"19",children:"19%"}),e.jsx("option",{value:"7",children:"7%"}),e.jsx("option",{value:"0",children:"0%"})]})})]}),e.jsxs("div",{className:"rounded-lg bg-muted p-3",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground text-xs",children:"Net"}),e.jsx("div",{className:"font-medium",children:q(M.net)})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-muted-foreground text-xs",children:["Vorsteuer (",M.rate,"%)"]}),e.jsx("div",{className:"font-medium",children:q(M.vat)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground text-xs",children:"Gross"}),e.jsx("div",{className:"font-semibold",children:q(M.gross)})]})]}),W&&e.jsx("div",{className:"mt-2 pt-2 border-t border-muted-foreground/20",children:e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-amber-600",children:[e.jsx(B,{className:"h-3 w-3"}),e.jsxs("span",{children:["Extracted gross: ",q(W.extracted)," (diff:"," ",q(W.difference),")"]})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{children:"Category"}),e.jsx("select",{className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",...s("euerCategory"),children:Ye.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{children:"Deductible (%)"}),e.jsx(V,{type:"number",step:"1",min:"0",max:"100",...s("deductiblePercent",{valueAsNumber:!0})})]})]}),N&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Be,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(G,{className:"text-sm font-medium",children:"Line Items"}),e.jsxs(T,{variant:"secondary",className:"text-[10px]",children:[g.length,"/",t.line_items.length]})]}),e.jsxs("div",{className:"flex gap-1.5",children:[e.jsx("button",{type:"button",className:"text-xs text-muted-foreground hover:text-foreground transition-colors px-1.5 py-0.5",onClick:I,disabled:g.length===t.line_items.length,children:"All"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"·"}),e.jsx("button",{type:"button",className:"text-xs text-muted-foreground hover:text-foreground transition-colors px-1.5 py-0.5",onClick:F,disabled:g.length===0,children:"None"})]})]}),E&&e.jsx("p",{className:"text-xs text-muted-foreground -mt-1",children:"Deselect personal items. Amounts update automatically."}),e.jsx("div",{className:"rounded-lg border divide-y text-sm max-h-[40vh] overflow-y-auto",children:t.line_items.map((a,x)=>{const h=g.includes(x),L=a.amount??(a.quantity??0)*(a.unitPrice??0);return e.jsxs("button",{type:"button",onClick:()=>i(x),className:D("w-full flex items-start gap-3 px-3 py-2.5 text-left transition-colors","hover:bg-muted/50 active:bg-muted/70",h?"bg-transparent":"bg-muted/20 opacity-60"),children:[e.jsx(fe,{checked:h,onCheckedChange:()=>i(x),onClick:je=>je.stopPropagation(),className:"mt-0.5 shrink-0","aria-label":`Select ${a.description||"item"}`}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("span",{className:D("text-sm leading-tight",!h&&"line-through text-muted-foreground"),children:[a.description||"Unnamed item",a.quantity!=null&&a.quantity>1&&e.jsxs("span",{className:"text-xs text-muted-foreground ml-1",children:["×",a.quantity]})]}),e.jsx("span",{className:D("text-sm font-medium tabular-nums shrink-0",!h&&"text-muted-foreground"),children:xe(L)})]}),a.quantity!=null&&a.unitPrice!=null&&a.quantity>1&&e.jsxs("div",{className:"text-xs text-muted-foreground mt-0.5",children:[a.quantity," × ",xe(a.unitPrice)]}),!h&&e.jsx(T,{variant:"outline",className:"text-[10px] mt-1 border-muted-foreground/30 text-muted-foreground",children:"personal"})]})]},x)})}),g.length===0&&e.jsxs("div",{className:"flex items-center gap-2 p-2.5 rounded-md bg-amber-50 dark:bg-amber-950/30 border border-amber-200 dark:border-amber-800",children:[e.jsx(B,{className:"h-4 w-4 text-amber-600 shrink-0"}),e.jsx("span",{className:"text-sm text-amber-700 dark:text-amber-400",children:"Select at least one item to save"})]})]}),((ie=t.invoice_number)==null?void 0:ie.value)&&e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Invoice #: ",t.invoice_number.value]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-2 sticky bottom-0 bg-background pb-2 sm:pb-0 sm:static sm:bg-transparent border-t sm:border-0 -mx-4 px-4 sm:mx-0 sm:px-0",children:[e.jsx(A,{type:"button",variant:"outline",onClick:o,children:"Cancel"}),e.jsxs(A,{type:"submit",disabled:v||N&&g.length===0,children:[v&&e.jsx(Z,{className:"mr-2 h-4 w-4 animate-spin"}),"Save Expense"]})]})]})})]})}function et({open:l,onOpenChange:c,onSuccess:p}){const[o,m]=r.useState("upload"),[v,b]=r.useState(null),[C,y]=r.useState(null),t=r.useCallback(i=>{b(i),y(null),m("review")},[]),N=r.useCallback(()=>{m("upload"),b(null),y(null)},[]),g=r.useCallback(async i=>{try{const{api:I}=await he(async()=>{const{api:k}=await import("./index-B9wpeZVf.js").then(U=>U.ak);return{api:k}},__vite__mapDeps([0,1,2,3]));await I.createExpense({date:i.date instanceof Date?i.date.toISOString().split("T")[0]:String(i.date),vendor:i.vendor,description:i.description,category:i.euerCategory,net_amount:i.netAmount,vat_rate:Number(i.vatRate),euer_category:i.euerCategory,euer_line:i.euerLine,deductible_percent:i.deductiblePercent??100,attachment_id:i.attachment_id,ocr_extraction_id:i.ocr_extraction_id});const F=i.netAmount*(1+Number(i.vatRate)/100);X.success("Expense saved",{description:`${i.vendor} · ${new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(F)} · Invoice attached`}),p==null||p(),w()}catch(I){X.error("Failed to save expense",{description:I instanceof Error?I.message:"Unknown error"})}},[p]),w=r.useCallback(()=>{m("upload"),b(null),y(null),c(!1)},[c]),j=r.useCallback(()=>{o==="review"?N():w()},[o,N,w]),E=o==="review"?"max-w-[1100px]":"max-w-[500px]";return e.jsx($e,{open:l,onOpenChange:c,children:e.jsxs(qe,{className:tt("w-[calc(100vw-1rem)] max-h-[95vh] overflow-y-auto p-4 sm:p-6",E),children:[o==="upload"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Scan Invoice"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Upload an invoice PDF or photo. AI will extract the data automatically."})]}),e.jsx(Xe,{onUploadComplete:t,onError:i=>X.error("Upload failed",{description:i})})]}),o==="review"&&v&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Review Extracted Data"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Verify the extracted information and make corrections if needed."})]}),e.jsx(Qe,{upload:v,selectedLineItems:C??void 0,onSave:g,onCancel:j})]})]})})}function tt(...l){return l.filter(Boolean).join(" ")}function _t(){const[l,c]=r.useState(!1),[p,o]=r.useState(!1),[m,v]=r.useState(null),[b,C]=r.useState(0),y=()=>{v(null),c(!0)},t=w=>{v(w),c(!0)},N=()=>{c(!1),v(null)},g=()=>{C(w=>w+1)};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-6 animate-in fade-in",children:e.jsx(We,{onAddExpense:y,onEditExpense:t,onScanInvoice:()=>o(!0),refreshTrigger:b})}),e.jsx(ye,{open:l,onOpenChange:c,expense:m,onClose:N,onSuccess:g}),e.jsx(et,{open:p,onOpenChange:o,onSuccess:g})]})}export{_t as ExpensesPage};
