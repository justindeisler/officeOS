const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DV0Z4ueH.js","assets/core-BDPGcIsz.js","assets/index-CDjnCujr.js","assets/path-E9zjYLSN.js"])))=>i.map(i=>d[i]);
import{r as i,j as e}from"./vendor-react-wuMqdllU.js";import{T as _e,a as Ve,b as F,c as B}from"./tabs-EeWm2cFj.js";import{S as q,a as W,b as ee,c as te,d as T}from"./select-DW4QIkWb.js";import{N as xe,O as yt,l as se,E as Z,i as D,a as V,L as re,I as me,B as Y,F as wt,G as Dt,H as kt,D as St,_ as Ue}from"./index-BJ9hpEov.js";import{T as le,a as ce,b as I,c as R,d as ie,e as A}from"./table-D-p124BO.js";import{g as he}from"./db-BUkeUm8J.js";import{j as Et,m as Ct,n as Rt,g as Lt}from"./assets-CVBAgqHn.js";import{a as M,H as Tt}from"./index-FI6coOPr.js";import{D as Se,a as Ee,b as Ce,c as Re,d as Le,e as $e}from"./dialog-BPcAFwmD.js";import{o as J,A as Te,q as je,aL as Be,e as it,W as fe,aM as ot,aN as dt,aO as Fe,P as It,aP as ut,f as _t,c as Ye,g as Vt,am as ue,aQ as be,aR as Ft,aS as Mt,Y as Ot,G as zt,E as Ut,t as $t,C as Bt}from"./vendor-icons-ssgfUAX_.js";import{C as Q,a as H,b as X,c as K}from"./card-BOU-q13f.js";import{u as Yt}from"./usePeriodLocks-CimS-PQ2.js";import{s as Pt,t as Gt,O as Qt,v as Kt,w as Zt,D as Ht,x as Pe}from"./vendor-radix-DqeMb71O.js";import{B as Xt}from"./BankReconciliation-CfH4SssS.js";import{g as Jt}from"./income-BENnsCsJ.js";import{g as qt}from"./expenses-DVN_3R06.js";import{b as Wt}from"./bankingService-C9qt3mZe.js";import"./vendor-markdown-C3iCDuOK.js";import"./vendor-recharts-tRgwS7-V.js";import"./vendor-router-Cm8Qzw9U.js";import"./vendor-floating-ui-BD6aHMKr.js";const ge=(t,s)=>yt.request(t,s);function pe(t,s){const r=(s-1)*3,n=new Date(t,r,1),c=new Date(t,r+3,0);return{startDate:n,endDate:c}}function mt(t){return{id:t.id,date:new Date(t.date),clientId:t.client_id??void 0,invoiceId:t.invoice_id??void 0,description:t.description,netAmount:t.net_amount,vatRate:t.vat_rate,vatAmount:t.vat_amount,grossAmount:t.gross_amount,euerLine:t.euer_line??14,euerCategory:t.euer_category??"services",paymentMethod:t.payment_method,bankReference:t.bank_reference??void 0,ustPeriod:t.ust_period??void 0,ustReported:t.ust_reported===1,createdAt:new Date(t.created_at)}}function xt(t){return{id:t.id,date:new Date(t.date),vendor:t.vendor,description:t.description,netAmount:t.net_amount,vatRate:t.vat_rate,vatAmount:t.vat_amount,grossAmount:t.gross_amount,euerLine:t.euer_line,euerCategory:t.euer_category,deductiblePercent:t.deductible_percent,paymentMethod:t.payment_method,receiptPath:t.receipt_path??void 0,isRecurring:t.is_recurring===1,recurringFrequency:t.recurring_frequency,ustPeriod:t.ust_period??void 0,vorsteuerClaimed:t.vorsteuer_claimed===1,isGwg:t.is_gwg===1,assetId:t.asset_id??void 0,createdAt:new Date(t.created_at)}}async function es(t,s){const{startDate:r,endDate:n}=pe(t,s);return(await(await he()).select(`SELECT * FROM income
     WHERE date >= $1 AND date <= $2
     ORDER BY date DESC`,[r.toISOString().split("T")[0],n.toISOString().split("T")[0]])).map(mt)}async function ts(t,s){const{startDate:r,endDate:n}=pe(t,s);return(await(await he()).select(`SELECT * FROM expenses
     WHERE date >= $1 AND date <= $2
     ORDER BY date DESC`,[r.toISOString().split("T")[0],n.toISOString().split("T")[0]])).map(xt)}async function ss(t){const s=new Date(t,0,1),r=new Date(t,11,31);return(await(await he()).select(`SELECT * FROM income
     WHERE date >= $1 AND date <= $2
     ORDER BY date DESC`,[s.toISOString().split("T")[0],r.toISOString().split("T")[0]])).map(mt)}async function rs(t){const s=new Date(t,0,1),r=new Date(t,11,31);return(await(await he()).select(`SELECT * FROM expenses
     WHERE date >= $1 AND date <= $2
     ORDER BY date DESC`,[s.toISOString().split("T")[0],r.toISOString().split("T")[0]])).map(xt)}async function Me(t,s){if(!xe()){const l=await ge(`/reports/ust/${t}/${s}`);return{...l,startDate:new Date(l.startDate),endDate:new Date(l.endDate),filedDate:l.filedDate?new Date(l.filedDate):void 0}}const{startDate:r,endDate:n}=pe(t,s),c=await es(t,s),o=await ts(t,s),u=c.filter(l=>l.vatRate===19).reduce((l,h)=>l+h.vatAmount,0),b=c.filter(l=>l.vatRate===7).reduce((l,h)=>l+h.vatAmount,0),f=u+b,m=o.reduce((l,h)=>l+(h.vatAmount||0),0),x=f-m,p=l=>Math.round(l*100)/100;return{period:`${t}-Q${s}`,year:t,quarter:s,startDate:r,endDate:n,umsatzsteuer19:p(u),umsatzsteuer7:p(b),totalUmsatzsteuer:p(f),vorsteuer:p(m),zahllast:p(x),status:"draft"}}async function ns(t){if(!xe())return(await ge(`/reports/ust/${t}`)).map(c=>({...c,startDate:new Date(c.startDate),endDate:new Date(c.endDate),filedDate:c.filedDate?new Date(c.filedDate):void 0}));const s=[1,2,3,4];return await Promise.all(s.map(n=>Me(t,n)))}async function as(t,s){if(!xe()){const f=await ge(`/reports/ust/${t}/${s}/file`,{method:"POST"});return{...f,startDate:new Date(f.startDate),endDate:new Date(f.endDate),filedDate:f.filedDate?new Date(f.filedDate):void 0}}const{startDate:r,endDate:n}=pe(t,s),c=await he(),o=r.toISOString().split("T")[0],u=n.toISOString().split("T")[0];return await c.execute("UPDATE income SET ust_reported = 1 WHERE date >= $1 AND date <= $2",[o,u]),await c.execute("UPDATE expenses SET ust_reported = 1 WHERE date >= $1 AND date <= $2",[o,u]),{...await Me(t,s),status:"filed",filedDate:new Date}}async function ls(t){if(!xe())return ge(`/reports/euer/${t}`);const s=await ss(t),r=await rs(t),n=await Et(t),c={};for(const l of s){const h=l.euerLine;c[h]=(c[h]||0)+l.netAmount}const o={};for(const l of r){const h=l.euerLine,a=l.netAmount*((l.deductiblePercent??100)/100);o[h]=(o[h]||0)+a}o[M.AFA]=(o[M.AFA]||0)+n;const u=await Ct(t);u>0&&(c[M.ENTNAHME_VERKAUF]=(c[M.ENTNAHME_VERKAUF]||0)+u);const b=await Rt(t);b>0&&(o[M.ANLAGENABGANG_VERLUST]=(o[M.ANLAGENABGANG_VERLUST]||0)+b),o[M.ARBEITSZIMMER]||(o[M.ARBEITSZIMMER]=Tt);const f=Object.values(c).reduce((l,h)=>l+h,0),m=Object.values(o).reduce((l,h)=>l+h,0),x=f-m,p=l=>Math.round(l*100)/100;for(const l of Object.keys(c))c[Number(l)]=p(c[Number(l)]);for(const l of Object.keys(o))o[Number(l)]=p(o[Number(l)]);return{year:t,income:c,expenses:o,totalIncome:p(f),totalExpenses:p(m),gewinn:p(x)}}function cs(){return{income:[{line:M.BETRIEBSEINNAHMEN,name:"Betriebseinnahmen",description:"Standard taxable business income (19% or 7%)"},{line:M.ENTNAHME_VERKAUF,name:"Veräußerungsgewinne",description:"Gains from asset sales (selling price - book value)"},{line:M.UST_ERSTATTUNG,name:"USt-Erstattung",description:"VAT refunds from tax office"}],expenses:[{line:M.FREMDLEISTUNGEN,name:"Fremdleistungen",description:"Subcontractors, freelancers"},{line:M.VORSTEUER,name:"Vorsteuer",description:"Input VAT on purchases"},{line:M.GEZAHLTE_UST,name:"Gezahlte USt",description:"Output VAT paid to tax office"},{line:M.AFA,name:"AfA",description:"Depreciation of movable assets"},{line:M.ARBEITSZIMMER,name:"Arbeitszimmer",description:"Home office costs (Pauschale: €1,260/year)"},{line:M.SONSTIGE,name:"Sonstige",description:"Other fully deductible business expenses"},{line:M.ANLAGENABGANG_VERLUST,name:"Anlagenabgang (Verlust)",description:"Losses from asset disposals (remaining book value)"}]}}function is(){const t=new Date().getMonth();return Math.floor(t/3)+1}function os(t={}){const{autoFetch:s=!0,year:r=new Date().getFullYear(),quarter:n=is()}=t,[c,o]=i.useState(null),[u,b]=i.useState([]),[f,m]=i.useState(!1),[x,p]=i.useState(null),[l,h]=i.useState(r),[a,N]=i.useState(n),j=i.useCallback(async(g,d)=>{m(!0),p(null);try{const k=await Me(g,d);o(k)}catch(k){p(k instanceof Error?k.message:"Failed to fetch USt-Voranmeldung")}finally{m(!1)}},[]),v=i.useCallback(async g=>{m(!0),p(null);try{const d=await ns(g);b(d)}catch(d){p(d instanceof Error?d.message:"Failed to fetch quarterly data")}finally{m(!1)}},[]),L=i.useCallback(async(g,d)=>{m(!0),p(null);try{const k=await as(g,d);o(k),b(E=>E.map(z=>z.year===g&&z.quarter===d?k:z))}catch(k){p(k instanceof Error?k.message:"Failed to mark as filed")}finally{m(!1)}},[]),S=i.useCallback(async()=>{await j(l,a)},[l,a,j]);return i.useEffect(()=>{s&&j(l,a)},[s,l,a,j]),{ustVoranmeldung:c,allQuarters:u,isLoading:f,error:x,selectedYear:l,selectedQuarter:a,setSelectedYear:h,setSelectedQuarter:N,fetchUstVoranmeldung:j,fetchAllQuarters:v,markAsFiled:L,refresh:S}}const ds={kz81:"Kz 81 – Steuerpflichtige Umsätze 19%",kz86:"Kz 86 – Steuerpflichtige Umsätze 7%",kz66:"Kz 66 – Vorsteuerbeträge",kz83:"Kz 83 – Verbleibende USt-Vorauszahlung"};function us(t){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(t)}function ms({open:t,onOpenChange:s,year:r,quarter:n,onSubmitted:c,className:o}){const[u,b]=i.useState("review"),[f,m]=i.useState(!1),[x,p]=i.useState(null),[l,h]=i.useState(null),[a,N]=i.useState(null),[j,v]=i.useState(""),[L,S]=i.useState(!1),g=`Q${n} ${r}`,d=i.useCallback(async()=>{m(!0),p(null);try{const w=await se.validateUstVaElster(r,n,"quarterly");h(w),b("validate")}catch(w){p(Z(w))}finally{m(!1)}},[r,n]),k=i.useCallback(async()=>{m(!0),p(null);try{const w=await se.generateUstVaElster(r,n,"quarterly",!0);N(w),b("generate")}catch(w){p(Z(w))}finally{m(!1)}},[r,n]),E=i.useCallback(()=>{if(!(a!=null&&a.xml))return;const w=new Blob([a.xml],{type:"application/xml"}),C=URL.createObjectURL(w),U=document.createElement("a");U.href=C,U.download=`UStVA-${r}-Q${n}.xml`,document.body.appendChild(U),U.click(),document.body.removeChild(U),URL.revokeObjectURL(C)},[a,r,n]),z=i.useCallback(async()=>{var w;if((w=a==null?void 0:a.submission)!=null&&w.id){S(!0),p(null);try{await se.updateElsterSubmissionStatus(a.submission.id,{status:"submitted",transfer_ticket:j||void 0}),b("confirm"),c==null||c()}catch(C){p(Z(C))}finally{S(!1)}}},[a,j,c]),P=w=>{w||(b("review"),h(null),N(null),v(""),p(null)),s(w)},G=(l==null?void 0:l.taxData)||(a==null?void 0:a.taxData);return e.jsx(Se,{open:t,onOpenChange:P,children:e.jsxs(Ee,{className:D("max-w-lg",o),children:[e.jsxs(Ce,{children:[e.jsx(Re,{children:"ELSTER USt-VA Export"}),e.jsxs(Le,{children:["USt-Voranmeldung ",g," für das Finanzamt vorbereiten"]})]}),e.jsxs(_e,{value:u,className:"w-full",children:[e.jsxs(Ve,{className:"grid w-full grid-cols-4",children:[e.jsx(F,{value:"review",disabled:u!=="review",children:"Prüfen"}),e.jsx(F,{value:"validate",disabled:!l,children:"Validieren"}),e.jsx(F,{value:"generate",disabled:!a,children:"Generieren"}),e.jsx(F,{value:"confirm",disabled:u!=="confirm",children:"Bestätigen"})]}),e.jsxs(B,{value:"review",className:"space-y-4 mt-4",children:[e.jsxs("div",{className:"rounded-lg border p-4 space-y-3",children:[e.jsx("h3",{className:"font-semibold text-sm",children:"Zeitraum"}),e.jsx("p",{className:"text-lg font-medium",children:g}),e.jsx("p",{className:"text-sm text-muted-foreground",children:'Klicken Sie auf "Daten prüfen", um die USt-VA Kennzahlen zu berechnen und zu validieren.'})]}),x&&e.jsx("div",{className:"rounded-lg border border-red-200 bg-red-50 p-3 text-sm text-red-700",children:x}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(V,{onClick:d,disabled:f,children:[f&&e.jsx(J,{className:"mr-2 h-4 w-4 animate-spin"}),"Daten prüfen",e.jsx(Te,{className:"ml-2 h-4 w-4"})]})})]}),e.jsx(B,{value:"validate",className:"space-y-4 mt-4",children:l&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"rounded-lg border p-4 space-y-3",children:[e.jsx("h3",{className:"font-semibold text-sm",children:"Kennzahlen"}),e.jsx("div",{className:"space-y-2",children:Object.entries(ds).map(([w,C])=>{const U=(G==null?void 0:G[w])??0;return e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:C}),e.jsx("span",{className:D("font-mono font-medium",w==="kz83"&&U<0?"text-green-600":"",w==="kz83"&&U>0?"text-red-600":""),children:us(U)})]},w)})})]}),e.jsxs("div",{className:D("flex items-center gap-3 rounded-lg p-3",l.valid?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"),children:[l.valid?e.jsx(je,{className:"h-5 w-5 text-green-600"}):e.jsx(Be,{className:"h-5 w-5 text-red-600"}),e.jsx("span",{className:"text-sm font-medium",children:l.valid?"Validierung bestanden":"Validierungsfehler"})]}),l.errors.length>0&&e.jsx("div",{className:"space-y-1",children:l.errors.map((w,C)=>e.jsxs("div",{className:"flex items-start gap-2 text-sm text-red-600",children:[e.jsx(Be,{className:"h-4 w-4 mt-0.5 flex-shrink-0"}),e.jsx("span",{children:w})]},C))}),l.warnings.length>0&&e.jsx("div",{className:"space-y-1",children:l.warnings.map((w,C)=>e.jsxs("div",{className:"flex items-start gap-2 text-sm text-yellow-600",children:[e.jsx(it,{className:"h-4 w-4 mt-0.5 flex-shrink-0"}),e.jsx("span",{children:w})]},C))}),x&&e.jsx("div",{className:"rounded-lg border border-red-200 bg-red-50 p-3 text-sm text-red-700",children:x}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(V,{variant:"outline",onClick:()=>b("review"),children:"Zurück"}),e.jsxs(V,{onClick:k,disabled:f||!l.valid,children:[f&&e.jsx(J,{className:"mr-2 h-4 w-4 animate-spin"}),"ELSTER XML generieren",e.jsx(Te,{className:"ml-2 h-4 w-4"})]})]})]})}),e.jsx(B,{value:"generate",className:"space-y-4 mt-4",children:a&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-3 rounded-lg bg-green-50 border border-green-200 p-4",children:[e.jsx(je,{className:"h-6 w-6 text-green-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-green-800",children:"ELSTER XML generiert"}),e.jsxs("p",{className:"text-sm text-green-600",children:["Submission-ID: ",a.submission.id.slice(0,8),"..."]})]})]}),e.jsxs(V,{variant:"outline",className:"w-full",onClick:E,children:[e.jsx(fe,{className:"mr-2 h-4 w-4"}),"ELSTER XML herunterladen"]}),e.jsxs("div",{className:"rounded-lg border bg-muted/30 p-4 text-sm text-muted-foreground space-y-2",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Nächster Schritt:"})," Laden Sie die XML-Datei herunter und übermitteln Sie diese über ",e.jsx("a",{href:"https://www.elster.de",target:"_blank",rel:"noopener noreferrer",className:"underline",children:"elster.de"})," oder Ihre Steuersoftware."]}),e.jsx("p",{children:"Nach erfolgreicher Übermittlung können Sie den Transferticket-Code hier eingeben."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(re,{htmlFor:"transferTicket",children:"Transferticket (optional)"}),e.jsx(me,{id:"transferTicket",value:j,onChange:w=>v(w.target.value),placeholder:"z.B. et12345678901234"})]}),x&&e.jsx("div",{className:"rounded-lg border border-red-200 bg-red-50 p-3 text-sm text-red-700",children:x}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(V,{variant:"outline",onClick:()=>b("validate"),children:"Zurück"}),e.jsxs(V,{onClick:z,disabled:L,children:[L&&e.jsx(J,{className:"mr-2 h-4 w-4 animate-spin"}),e.jsx(ot,{className:"mr-2 h-4 w-4"}),"Als übermittelt markieren"]})]})]})}),e.jsxs(B,{value:"confirm",className:"space-y-4 mt-4",children:[e.jsxs("div",{className:"flex flex-col items-center gap-4 py-6",children:[e.jsx(je,{className:"h-12 w-12 text-green-600"}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-lg font-semibold",children:"Übermittlung bestätigt"}),e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:["Die USt-VA für ",g," wurde als übermittelt markiert."]}),j&&e.jsx("div",{className:"mt-3",children:e.jsxs(Y,{variant:"outline",className:"font-mono",children:["Transferticket: ",j]})})]})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(V,{onClick:()=>P(!1),children:"Schließen"})})]})]})]})})}function oe(t){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(t)}function Ne(t){return new Intl.DateTimeFormat("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"}).format(t)}function xs(){const t=new Date().getFullYear();return Array.from({length:6},(s,r)=>t-r)}function hs({onPrint:t,className:s}){const{ustVoranmeldung:r,isLoading:n,error:c,selectedYear:o,selectedQuarter:u,setSelectedYear:b,setSelectedQuarter:f,markAsFiled:m}=os(),[x,p]=i.useState(!1),l=xs(),h=()=>{t?t():window.print()},a=async()=>{r&&await m(r.year,r.quarter)};if(n)return e.jsxs("div",{className:D("space-y-6",s),children:[e.jsx("h2",{className:"text-xl font-semibold",children:"USt-Voranmeldung"}),e.jsx("div",{className:"rounded-lg border p-8 text-center text-muted-foreground",children:"Laden..."})]});if(c)return e.jsxs("div",{className:D("space-y-6",s),children:[e.jsx("h2",{className:"text-xl font-semibold",children:"USt-Voranmeldung"}),e.jsxs("div",{className:"rounded-lg border border-destructive p-8 text-center text-destructive",children:["Fehler: ",Z(c)]})]});if(!r)return e.jsxs("div",{className:D("space-y-6",s),children:[e.jsx("h2",{className:"text-xl font-semibold",children:"USt-Voranmeldung"}),e.jsx("div",{className:"rounded-lg border p-8 text-center text-muted-foreground",children:"Keine Daten verfügbar"})]});const N=r.zahllast<0;return e.jsxs("div",{className:D("space-y-6",s),children:[e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"USt-Voranmeldung"}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs(V,{variant:"outline",size:"sm",onClick:h,children:[e.jsx(dt,{className:"mr-2 h-4 w-4"}),"Drucken"]}),e.jsxs(V,{variant:"outline",size:"sm",onClick:()=>p(!0),children:[e.jsx(Fe,{className:"mr-2 h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"ELSTER Export"}),e.jsx("span",{className:"sm:hidden",children:"ELSTER"})]}),r.status==="draft"&&e.jsxs(V,{size:"sm",onClick:a,children:[e.jsx(ot,{className:"mr-2 h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Als gemeldet markieren"}),e.jsx("span",{className:"sm:hidden",children:"Melden"})]})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3 sm:gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{htmlFor:"year-select",className:"text-sm font-medium",children:"Jahr:"}),e.jsxs(q,{value:String(o),onValueChange:j=>b(Number(j)),children:[e.jsx(W,{id:"year-select",className:"w-[100px]",children:e.jsx(ee,{})}),e.jsx(te,{children:l.map(j=>e.jsx(T,{value:String(j),children:j},j))})]})]}),e.jsx(_e,{value:`Q${u}`,onValueChange:j=>f(Number(j.replace("Q",""))),children:e.jsxs(Ve,{children:[e.jsx(F,{value:"Q1",children:"Q1"}),e.jsx(F,{value:"Q2",children:"Q2"}),e.jsx(F,{value:"Q3",children:"Q3"}),e.jsx(F,{value:"Q4",children:"Q4"})]})})]}),e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between rounded-lg border p-3 sm:p-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Zeitraum"}),e.jsx("p",{className:"font-medium",children:r.period}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[Ne(r.startDate)," –"," ",Ne(r.endDate)]})]}),e.jsxs("div",{className:"sm:text-right",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Status"}),r.status==="draft"?e.jsx(Y,{variant:"secondary",children:"Entwurf"}):e.jsx(Y,{variant:"default",children:"Gemeldet"}),r.filedDate&&e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:Ne(r.filedDate)})]})]}),e.jsx("div",{className:"rounded-lg border overflow-x-auto",children:e.jsxs(le,{className:"min-w-[400px]",children:[e.jsx(ce,{children:e.jsxs(I,{children:[e.jsx(R,{className:"w-[300px]",children:"Position"}),e.jsx(R,{className:"text-right",children:"Betrag"})]})}),e.jsxs(ie,{children:[e.jsx(I,{className:"bg-muted/30",children:e.jsx(A,{colSpan:2,className:"font-semibold",children:"Umsatzsteuer (Output VAT)"})}),e.jsxs(I,{children:[e.jsx(A,{className:"pl-8",children:"Umsatzsteuer 19%"}),e.jsx(A,{className:"text-right",children:oe(r.umsatzsteuer19)})]}),e.jsxs(I,{children:[e.jsx(A,{className:"pl-8",children:"Umsatzsteuer 7%"}),e.jsx(A,{className:"text-right",children:oe(r.umsatzsteuer7)})]}),e.jsxs(I,{className:"font-medium",children:[e.jsx(A,{className:"pl-8",children:"Summe Umsatzsteuer"}),e.jsx(A,{className:"text-right",children:oe(r.totalUmsatzsteuer)})]}),e.jsx(I,{className:"bg-muted/30",children:e.jsx(A,{colSpan:2,className:"font-semibold",children:"Vorsteuer (Input VAT)"})}),e.jsxs(I,{children:[e.jsx(A,{className:"pl-8",children:"Abziehbare Vorsteuer"}),e.jsx(A,{className:"text-right",children:oe(r.vorsteuer)})]}),e.jsxs(I,{className:"border-t-2 bg-muted font-bold",children:[e.jsxs(A,{children:["Zahllast"," ",N&&e.jsx("span",{className:"text-green-600 font-normal",children:"(Erstattung)"})]}),e.jsxs(A,{className:D("text-right",N?"text-green-600":"text-red-600"),children:[oe(Math.abs(r.zahllast)),N&&" (Erstattung)"]})]})]})]})}),e.jsxs("div",{className:"rounded-lg border bg-muted/30 p-4 text-sm text-muted-foreground",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Zahllast"}),": Umsatzsteuer − Vorsteuer"]}),e.jsxs("p",{children:["Positiver Betrag = Zahlung an das Finanzamt fällig",e.jsx("br",{}),"Negativer Betrag = Erstattung vom Finanzamt erwartet"]})]}),e.jsx(ms,{open:x,onOpenChange:p,year:o,quarter:u,onSubmitted:refresh})]})}function fs(t={}){const{autoFetch:s=!0,year:r=new Date().getFullYear()}=t,[n,c]=i.useState(null),[o,u]=i.useState(!1),[b,f]=i.useState(null),[m,x]=i.useState(r),p=i.useCallback(async a=>{u(!0),f(null);try{const N=await ls(a);c(N)}catch(N){f(N instanceof Error?N.message:"Failed to fetch EÜR report")}finally{u(!1)}},[]),l=i.useCallback(()=>cs(),[]),h=i.useCallback(async()=>{await p(m)},[m,p]);return i.useEffect(()=>{s&&p(m)},[s,m,p]),{euerReport:n,isLoading:o,error:b,selectedYear:m,setSelectedYear:x,fetchEuerReport:p,getLineDetails:l,refresh:h}}function de(t){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(t)}function gs(){const t=new Date().getFullYear();return Array.from({length:6},(s,r)=>t-r)}function ps({onPrint:t,onExport:s,className:r}){const{euerReport:n,isLoading:c,error:o,selectedYear:u,setSelectedYear:b,getLineDetails:f}=fs(),m=gs(),x=f(),p=()=>{t?t():window.print()},l=()=>{s&&s()};if(c)return e.jsxs("div",{className:D("space-y-6",r),children:[e.jsxs("h2",{className:"text-xl font-semibold",children:["EÜR ",u]}),e.jsx("div",{className:"rounded-lg border p-8 text-center text-muted-foreground",children:"Laden..."})]});if(o)return e.jsxs("div",{className:D("space-y-6",r),children:[e.jsxs("h2",{className:"text-xl font-semibold",children:["EÜR ",u]}),e.jsxs("div",{className:"rounded-lg border border-destructive p-8 text-center text-destructive",children:["Fehler: ",Z(o)]})]});if(!n)return e.jsxs("div",{className:D("space-y-6",r),children:[e.jsxs("h2",{className:"text-xl font-semibold",children:["EÜR ",u]}),e.jsx("div",{className:"rounded-lg border p-8 text-center text-muted-foreground",children:"Keine Daten verfügbar"})]});const h=n.gewinn>=0;return e.jsxs("div",{className:D("space-y-6",r),children:[e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("h2",{className:"text-xl font-semibold",children:["EÜR ",u]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs(V,{variant:"outline",size:"sm",onClick:p,children:[e.jsx(dt,{className:"mr-2 h-4 w-4"}),"Drucken"]}),e.jsxs(V,{variant:"outline",size:"sm",onClick:l,children:[e.jsx(fe,{className:"mr-2 h-4 w-4"}),"Export"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{htmlFor:"year-select",className:"text-sm font-medium",children:"Jahr:"}),e.jsxs(q,{value:String(u),onValueChange:a=>b(Number(a)),children:[e.jsx(W,{id:"year-select",className:"w-[100px]",children:e.jsx(ee,{})}),e.jsx(te,{children:m.map(a=>e.jsx(T,{value:String(a),children:a},a))})]})]}),e.jsx("div",{className:"rounded-lg border overflow-x-auto",children:e.jsxs(le,{className:"min-w-[500px]",children:[e.jsx(ce,{children:e.jsxs(I,{children:[e.jsx(R,{className:"w-[100px]",children:"Zeile"}),e.jsx(R,{children:"Position"}),e.jsx(R,{className:"text-right",children:"Betrag"})]})}),e.jsxs(ie,{children:[e.jsx(I,{className:"bg-muted/30",children:e.jsx(A,{colSpan:3,className:"font-semibold",children:"Einnahmen"})}),x.income.map(a=>e.jsxs(I,{children:[e.jsxs(A,{className:"font-mono text-sm",children:["Zeile ",a.line]}),e.jsx(A,{children:e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:a.name}),e.jsxs("span",{className:"text-muted-foreground text-sm ml-2",children:["(",a.description,")"]})]})}),e.jsx(A,{className:"text-right",children:de(n.income[a.line]||0)})]},a.line)),e.jsxs(I,{className:"font-medium bg-muted/20",children:[e.jsx(A,{}),e.jsx(A,{children:"Summe Einnahmen"}),e.jsx(A,{className:"text-right",children:de(n.totalIncome)})]}),e.jsx(I,{className:"bg-muted/30",children:e.jsx(A,{colSpan:3,className:"font-semibold",children:"Ausgaben"})}),x.expenses.map(a=>e.jsxs(I,{children:[e.jsxs(A,{className:"font-mono text-sm",children:["Zeile ",a.line]}),e.jsx(A,{children:e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:a.name}),e.jsxs("span",{className:"text-muted-foreground text-sm ml-2",children:["(",a.description,")"]})]})}),e.jsx(A,{className:"text-right",children:de(n.expenses[a.line]||0)})]},a.line)),e.jsxs(I,{className:"font-medium bg-muted/20",children:[e.jsx(A,{}),e.jsx(A,{children:"Summe Ausgaben"}),e.jsx(A,{className:"text-right",children:de(n.totalExpenses)})]}),e.jsxs(I,{className:"border-t-2 bg-muted font-bold",children:[e.jsx(A,{}),e.jsx(A,{children:h?"Gewinn":"Verlust"}),e.jsx(A,{className:D("text-right",h?"text-green-600":"text-red-600"),children:de(Math.abs(n.gewinn))})]})]})]})}),e.jsxs("div",{className:"rounded-lg border bg-muted/30 p-4 text-sm text-muted-foreground",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Gewinn/Verlust"}),": Einnahmen − Ausgaben"]}),e.jsxs("p",{children:["Positiver Betrag = Gewinn (steuerpflichtiges Einkommen)",e.jsx("br",{}),"Negativer Betrag = Verlust (kann vorgetragen werden)"]})]})]})}function ne(t){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(t)}function Ge(t){return new Intl.DateTimeFormat("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"}).format(t)}function js(t){return{computer:"EDV/Computer",furniture:"Büromöbel",equipment:"Geräte",software:"Software",phone:"Telefon"}[t]||t}function bs(t){return{active:"Aktiv",disposed:"Abgang",sold:"Verkauft"}[t]||t}function Qe(t,s){if(!t.depreciationSchedule||t.depreciationSchedule.length===0)return t.purchasePrice;const r=t.depreciationSchedule.find(o=>o.year===s);if(r)return r.bookValue;const c=[...t.depreciationSchedule].sort((o,u)=>u.year-o.year).find(o=>o.year<=s);return c?c.bookValue:t.purchasePrice}function Ns({year:t,assets:s,isLoading:r=!1,error:n=null,showOnlyYearAcquisitions:c=!1,onExportCSV:o,onExportPDF:u,className:b}){const f=i.useMemo(()=>c?s.filter(x=>new Date(x.purchaseDate).getFullYear()===t):s,[s,t,c]),m=i.useMemo(()=>{const x=f.reduce((h,a)=>h+a.purchasePrice,0),p=f.reduce((h,a)=>h+a.afaAnnualAmount,0),l=f.reduce((h,a)=>h+Qe(a,t),0);return{count:f.length,totalPurchaseValue:x,totalAnnualAfa:p,totalBookValue:l}},[f,t]);return r?e.jsxs("div",{className:D("space-y-6",b),children:[e.jsxs("h2",{className:"text-xl font-semibold",children:["Anlageverzeichnis ",t]}),e.jsx("div",{className:"rounded-lg border p-8 text-center text-muted-foreground",children:"Laden..."})]}):n?e.jsxs("div",{className:D("space-y-6",b),children:[e.jsxs("h2",{className:"text-xl font-semibold",children:["Anlageverzeichnis ",t]}),e.jsx("div",{className:"rounded-lg border border-destructive p-8 text-center text-destructive",children:Z(n)})]}):f.length===0?e.jsxs("div",{className:D("space-y-6",b),children:[e.jsxs("h2",{className:"text-xl font-semibold",children:["Anlageverzeichnis ",t]}),e.jsxs("div",{className:"rounded-lg border p-8 text-center text-muted-foreground",children:[e.jsx(It,{className:"mx-auto h-12 w-12 mb-4 opacity-50"}),e.jsx("p",{children:"Keine Anlagen vorhanden"}),e.jsx("p",{className:"text-sm mt-1",children:"No assets registered"})]})]}):e.jsxs("div",{className:D("space-y-6",b),children:[e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("h2",{className:"text-xl font-semibold",children:["Anlageverzeichnis ",t]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs(V,{variant:"outline",size:"sm",onClick:()=>o==null?void 0:o(f,t),className:"flex-1 sm:flex-none",children:[e.jsx(ut,{className:"mr-2 h-4 w-4"}),"CSV Export"]}),e.jsxs(V,{variant:"outline",size:"sm",onClick:()=>u==null?void 0:u(f,t),className:"flex-1 sm:flex-none",children:[e.jsx(_t,{className:"mr-2 h-4 w-4"}),"PDF Export"]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4","data-testid":"summary-section",children:[e.jsxs(Q,{children:[e.jsx(H,{className:"pb-2",children:e.jsx(X,{className:"text-sm font-medium text-muted-foreground",children:"Anlagen"})}),e.jsx(K,{children:e.jsxs("div",{className:"text-2xl font-bold",children:[m.count," Anlagen"]})})]}),e.jsxs(Q,{children:[e.jsx(H,{className:"pb-2",children:e.jsx(X,{className:"text-sm font-medium text-muted-foreground",children:"Anschaffungswert"})}),e.jsx(K,{children:e.jsx("div",{className:"text-2xl font-bold",children:ne(m.totalPurchaseValue)})})]}),e.jsxs(Q,{children:[e.jsx(H,{className:"pb-2",children:e.jsxs(X,{className:"text-sm font-medium text-muted-foreground",children:["AfA ",t]})}),e.jsx(K,{children:e.jsx("div",{className:"text-2xl font-bold",children:ne(m.totalAnnualAfa)})})]}),e.jsxs(Q,{children:[e.jsx(H,{className:"pb-2",children:e.jsxs(X,{className:"text-sm font-medium text-muted-foreground",children:["Buchwert ",t]})}),e.jsx(K,{children:e.jsx("div",{className:"text-2xl font-bold",children:ne(m.totalBookValue)})})]})]}),e.jsx(Q,{children:e.jsx(K,{className:"p-0 overflow-x-auto",children:e.jsxs(le,{className:"min-w-[900px]",children:[e.jsx(ce,{children:e.jsxs(I,{children:[e.jsx(R,{scope:"col",children:"Bezeichnung"}),e.jsx(R,{scope:"col",children:"Kategorie"}),e.jsx(R,{scope:"col",children:"Anschaffung"}),e.jsx(R,{scope:"col",className:"text-right",children:"Anschaffungswert"}),e.jsx(R,{scope:"col",className:"text-center",children:"AfA Jahre"}),e.jsx(R,{scope:"col",className:"text-right",children:"AfA/Jahr"}),e.jsxs(R,{scope:"col",className:"text-right",children:["Buchwert ",t]}),e.jsx(R,{scope:"col",children:"Status"})]})}),e.jsx(ie,{children:f.map(x=>{const p=Qe(x,t),l=x.status!=="active";return e.jsxs(I,{className:D(l&&"text-muted-foreground"),children:[e.jsxs(A,{className:"font-medium",children:[x.name,x.inventoryNumber&&e.jsxs("span",{className:"block text-xs text-muted-foreground",children:["Inv.-Nr.: ",x.inventoryNumber]})]}),e.jsx(A,{children:js(x.category)}),e.jsx(A,{children:Ge(new Date(x.purchaseDate))}),e.jsx(A,{className:"text-right",children:ne(x.purchasePrice)}),e.jsxs(A,{className:"text-center",children:[x.afaYears," Jahre"]}),e.jsx(A,{className:"text-right",children:ne(x.afaAnnualAmount)}),e.jsx(A,{className:"text-right",children:ne(p)}),e.jsxs(A,{children:[e.jsx("span",{className:D("inline-flex items-center rounded-full px-2 py-1 text-xs font-medium",x.status==="active"&&"bg-green-100 text-green-700",x.status==="disposed"&&"bg-gray-100 text-gray-700",x.status==="sold"&&"bg-blue-100 text-blue-700"),children:bs(x.status)}),l&&x.disposalDate&&e.jsx("span",{className:"block text-xs text-muted-foreground mt-1",children:Ge(new Date(x.disposalDate))})]})]},x.id)})})]})})}),e.jsxs("div",{className:"rounded-lg border bg-muted/30 p-4 text-sm text-muted-foreground",children:[e.jsx("p",{children:e.jsx("strong",{children:"Hinweise zum Anlageverzeichnis:"})}),e.jsxs("ul",{className:"list-disc list-inside mt-2 space-y-1",children:[e.jsx("li",{children:"Erforderlich für EÜR Anlage AVEÜR (Anlageverzeichnis)"}),e.jsx("li",{children:"Alle Beträge sind Netto-Werte (ohne USt)"}),e.jsx("li",{children:"Lineare AfA-Methode gemäß AfA-Tabelle"})]})]})]})}function ae(t){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(t)}function Ke(t){return new Intl.NumberFormat("de-DE",{style:"percent",minimumFractionDigits:0,maximumFractionDigits:1}).format(t)}function Ze(t){return{computer:"EDV/Computer",furniture:"Büromöbel",equipment:"Geräte",software:"Software",phone:"Telefon"}[t]||t}function vs(t,s){const c=new Date(t.afaStartDate).getFullYear()+t.afaYears-s-1;return Math.max(0,c)}function As(t,s){var n;const r=(n=t.depreciationSchedule)==null?void 0:n.find(c=>c.year===s);return(r==null?void 0:r.amount)??t.afaAnnualAmount}function ys({year:t,assets:s,isLoading:r=!1,error:n=null,showCategoryBreakdown:c=!1,showYearlyComparison:o=!1,onExportCSV:u,className:b}){const f=i.useMemo(()=>s.filter(h=>h.status==="active"||h.afaAnnualAmount>0),[s]),m=i.useMemo(()=>[...f].sort((h,a)=>a.afaAnnualAmount-h.afaAnnualAmount),[f]),x=i.useMemo(()=>{const h=m.reduce((N,j)=>N+j.afaAnnualAmount,0),a=m.length>0?h/m.length:0;return{count:m.length,totalAfa:h,averageAfa:a}},[m]),p=i.useMemo(()=>{const h={computer:{count:0,total:0},furniture:{count:0,total:0},equipment:{count:0,total:0},software:{count:0,total:0},phone:{count:0,total:0}};for(const a of m)h[a.category]&&(h[a.category].count++,h[a.category].total+=a.afaAnnualAmount);return Object.entries(h).filter(([a,N])=>N.count>0).map(([a,N])=>({category:a,...N})).sort((a,N)=>N.total-a.total)},[m]),l=i.useMemo(()=>{if(!o)return[];const h=new Set;for(const a of m)if(a.depreciationSchedule)for(const N of a.depreciationSchedule)h.add(N.year);return Array.from(h).sort()},[m,o]);return r?e.jsxs("div",{className:D("space-y-6",b),children:[e.jsxs("h2",{className:"text-xl font-semibold",children:["AfA-Übersicht ",t]}),e.jsx("div",{className:"rounded-lg border p-8 text-center text-muted-foreground",children:"Laden..."})]}):n?e.jsxs("div",{className:D("space-y-6",b),children:[e.jsxs("h2",{className:"text-xl font-semibold",children:["AfA-Übersicht ",t]}),e.jsx("div",{className:"rounded-lg border border-destructive p-8 text-center text-destructive",children:Z(n)})]}):m.length===0?e.jsxs("div",{className:D("space-y-6",b),children:[e.jsxs("h2",{className:"text-xl font-semibold",children:["AfA-Übersicht ",t]}),e.jsxs("div",{className:"rounded-lg border p-8 text-center text-muted-foreground",children:[e.jsx(Ye,{className:"mx-auto h-12 w-12 mb-4 opacity-50"}),e.jsx("p",{children:"Keine Abschreibungen vorhanden"}),e.jsx("p",{className:"text-sm mt-1",children:"No depreciation for this year"})]})]}):e.jsxs("div",{className:D("space-y-6",b),children:[e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("h2",{className:"text-xl font-semibold",children:["AfA-Übersicht ",t]}),e.jsxs(V,{variant:"outline",size:"sm",onClick:()=>u==null?void 0:u(m,t),className:"w-full sm:w-auto",children:[e.jsx(ut,{className:"mr-2 h-4 w-4"}),"CSV Export"]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4","data-testid":"afa-summary-totals",children:[e.jsxs(Q,{children:[e.jsx(H,{className:"pb-2",children:e.jsxs(X,{className:"text-sm font-medium text-muted-foreground flex items-center gap-2",children:[e.jsx(Ye,{className:"h-4 w-4"}),"Gesamt-AfA ",t]})}),e.jsx(K,{children:e.jsx("div",{className:"text-2xl font-bold",children:ae(x.totalAfa)})})]}),e.jsxs(Q,{children:[e.jsx(H,{className:"pb-2",children:e.jsx(X,{className:"text-sm font-medium text-muted-foreground",children:"Anlagen mit AfA"})}),e.jsx(K,{children:e.jsxs("div",{className:"text-2xl font-bold",children:[x.count," Anlagen"]})})]}),e.jsxs(Q,{children:[e.jsx(H,{className:"pb-2",children:e.jsxs(X,{className:"text-sm font-medium text-muted-foreground flex items-center gap-2",children:[e.jsx(Vt,{className:"h-4 w-4"}),"Durchschnitt/Anlage"]})}),e.jsx(K,{children:e.jsx("div",{className:"text-2xl font-bold",children:ae(x.averageAfa)})})]})]}),c&&p.length>0&&e.jsxs(Q,{children:[e.jsx(H,{children:e.jsx(X,{className:"text-sm font-medium",children:"AfA nach Kategorie"})}),e.jsx(K,{children:e.jsx("div",{className:"space-y-3",children:p.map(({category:h,count:a,total:N})=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:Ze(h)}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:["(",a," Anlagen)"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"font-medium",children:ae(N)}),e.jsx("span",{className:"text-sm text-muted-foreground ml-2",children:Ke(N/x.totalAfa)})]})]},h))})})]}),o&&l.length>0&&e.jsxs(Q,{children:[e.jsx(H,{children:e.jsx(X,{className:"text-sm font-medium",children:"Jahresvergleich"})}),e.jsx(K,{children:e.jsx("div",{className:"flex gap-4",children:l.map(h=>{const a=m.reduce((j,v)=>j+As(v,h),0),N=h===t;return e.jsxs("div",{className:D("flex-1 text-center p-3 rounded-lg border",N&&"bg-muted border-primary"),children:[e.jsx("div",{className:"text-sm font-medium",children:h}),e.jsx("div",{className:D("text-lg font-bold",N&&"text-primary"),children:ae(a)})]},h)})})})]}),e.jsxs(Q,{children:[e.jsx(H,{children:e.jsxs(X,{className:"text-sm font-medium",children:["AfA-Aufstellung ",t]})}),e.jsx(K,{className:"p-0 overflow-x-auto",children:e.jsxs(le,{className:"min-w-[600px]",children:[e.jsx(ce,{children:e.jsxs(I,{children:[e.jsx(R,{scope:"col",children:"Anlage"}),e.jsx(R,{scope:"col",children:"Kategorie"}),e.jsxs(R,{scope:"col",className:"text-right",children:["AfA ",t]}),e.jsx(R,{scope:"col",className:"text-right",children:"Anteil"}),e.jsx(R,{scope:"col",className:"text-center",children:"Restlaufzeit"})]})}),e.jsxs(ie,{children:[m.map(h=>{const a=x.totalAfa>0?h.afaAnnualAmount/x.totalAfa:0,N=vs(h,t);return e.jsxs(I,{children:[e.jsxs(A,{className:"font-medium",children:[h.name,h.inventoryNumber&&e.jsxs("span",{className:"block text-xs text-muted-foreground",children:["Inv.-Nr.: ",h.inventoryNumber]})]}),e.jsx(A,{children:Ze(h.category)}),e.jsx(A,{className:"text-right font-medium",children:ae(h.afaAnnualAmount)}),e.jsx(A,{className:"text-right",children:Ke(a)}),e.jsx(A,{className:"text-center",children:N>0?e.jsxs("span",{children:[N," Jahre"]}):e.jsx("span",{className:"text-muted-foreground",children:"Abgeschlossen"})})]},h.id)}),e.jsxs(I,{className:"bg-muted/50 font-bold",children:[e.jsx(A,{colSpan:2,children:"Gesamt"}),e.jsx(A,{className:"text-right",children:ae(x.totalAfa)}),e.jsx(A,{className:"text-right",children:"100%"}),e.jsx(A,{})]})]})]})})]}),e.jsxs("div",{className:"rounded-lg border bg-muted/30 p-4 text-sm text-muted-foreground",children:[e.jsx("p",{children:e.jsx("strong",{children:"Hinweise zur AfA-Berechnung:"})}),e.jsxs("ul",{className:"list-disc list-inside mt-2 space-y-1",children:[e.jsx("li",{children:"Lineare Abschreibung gemäß AfA-Tabelle"}),e.jsx("li",{children:"Pro-rata-temporis im Anschaffungs- und Abgangsjahr"}),e.jsx("li",{children:"Beträge netto (ohne Umsatzsteuer)"})]})]})]})}const He={ust_va:"USt-VA",zm:"ZM",euer:"EÜR"},Xe={draft:{label:"Entwurf",variant:"secondary"},validated:{label:"Validiert",variant:"outline"},submitted:{label:"Übermittelt",variant:"default"},accepted:{label:"Akzeptiert",variant:"default"},rejected:{label:"Abgelehnt",variant:"destructive"}};function ws(t){return new Intl.DateTimeFormat("de-DE",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}).format(new Date(t))}function Ds(){const t=new Date().getFullYear();return Array.from({length:6},(s,r)=>t-r)}function ks({className:t}){const[s,r]=i.useState([]),[n,c]=i.useState(!0),[o,u]=i.useState(null),[b,f]=i.useState("all"),[m,x]=i.useState("all"),p=Ds(),l=i.useCallback(async()=>{c(!0),u(null);try{const a={};b!=="all"&&(a.type=b),m!=="all"&&(a.year=parseInt(m));const N=await se.getElsterSubmissions(a);r(N)}catch(a){u(Z(a))}finally{c(!1)}},[b,m]);i.useEffect(()=>{l()},[l]);const h=a=>{if(!a.xml)return;const N=new Blob([a.xml],{type:"application/xml"}),j=URL.createObjectURL(N),v=document.createElement("a");v.href=j;const L=He[a.type]||a.type;v.download=`${L}-${a.period_key}.xml`,document.body.appendChild(v),v.click(),document.body.removeChild(v),URL.revokeObjectURL(j)};return e.jsxs("div",{className:D("space-y-6",t),children:[e.jsx("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"ELSTER-Verlauf"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Übersicht aller ELSTER-Übermittlungen"})]})}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Typ:"}),e.jsxs(q,{value:b,onValueChange:f,children:[e.jsx(W,{className:"w-[120px]",children:e.jsx(ee,{})}),e.jsxs(te,{children:[e.jsx(T,{value:"all",children:"Alle"}),e.jsx(T,{value:"ust_va",children:"USt-VA"}),e.jsx(T,{value:"zm",children:"ZM"}),e.jsx(T,{value:"euer",children:"EÜR"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Jahr:"}),e.jsxs(q,{value:m,onValueChange:x,children:[e.jsx(W,{className:"w-[100px]",children:e.jsx(ee,{})}),e.jsxs(te,{children:[e.jsx(T,{value:"all",children:"Alle"}),p.map(a=>e.jsx(T,{value:String(a),children:a},a))]})]})]})]}),n&&e.jsx("div",{className:"flex items-center justify-center p-8",children:e.jsx(J,{className:"h-8 w-8 animate-spin text-muted-foreground"})}),o&&e.jsx("div",{className:"rounded-lg border border-destructive p-4 text-sm text-destructive",children:o}),!n&&!o&&s.length===0&&e.jsx("div",{className:"rounded-lg border border-dashed p-8 text-center text-muted-foreground",children:"Keine ELSTER-Übermittlungen gefunden"}),!n&&s.length>0&&e.jsx("div",{className:"rounded-md border overflow-x-auto",children:e.jsxs(le,{children:[e.jsx(ce,{children:e.jsxs(I,{children:[e.jsx(R,{children:"Typ"}),e.jsx(R,{children:"Zeitraum"}),e.jsx(R,{children:"Status"}),e.jsx(R,{children:"Erstellt"}),e.jsx(R,{children:"Transferticket"}),e.jsx(R,{className:"w-[60px]"})]})}),e.jsx(ie,{children:s.map(a=>{const N=Xe[a.status]||Xe.draft;return e.jsxs(I,{children:[e.jsx(A,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Fe,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"font-medium",children:He[a.type]||a.type})]})}),e.jsx(A,{className:"font-mono text-sm",children:a.period_key}),e.jsxs(A,{children:[e.jsx(Y,{variant:N.variant,children:N.label}),a.test_mode&&e.jsx(Y,{variant:"outline",className:"ml-1 text-xs",children:"Test"})]}),e.jsx(A,{className:"text-sm text-muted-foreground",children:ws(a.created_at)}),e.jsx(A,{children:a.transfer_ticket?e.jsx("span",{className:"font-mono text-xs",children:a.transfer_ticket}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"—"})}),e.jsx(A,{children:a.xml&&e.jsx(V,{variant:"ghost",size:"icon",onClick:()=>h(a),"aria-label":"XML herunterladen",title:"XML herunterladen",children:e.jsx(fe,{className:"h-4 w-4 text-muted-foreground hover:text-primary"})})})]},a.id)})})]})})]})}function ve(t){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(t)}function Ss(){const t=new Date().getFullYear();return Array.from({length:6},(s,r)=>t-r)}function Es(){const t=new Date().getMonth();return Math.floor(t/3)+1}function Cs({className:t}){const s=new Date().getFullYear(),[r,n]=i.useState(s),[c,o]=i.useState(Es()),[u,b]=i.useState(!1),[f,m]=i.useState(!1),[x,p]=i.useState(null),[l,h]=i.useState(null),a=Ss(),N=i.useCallback(async()=>{b(!0),p(null);try{const v=await se.generateZmElster(r,c,!0);h(v)}catch(v){p(Z(v))}finally{b(!1)}},[r,c]),j=i.useCallback(()=>{if(!(l!=null&&l.xml))return;const v=new Blob([l.xml],{type:"application/xml"}),L=URL.createObjectURL(v),S=document.createElement("a");S.href=L,S.download=`ZM-${r}-Q${c}.xml`,document.body.appendChild(S),S.click(),document.body.removeChild(S),URL.revokeObjectURL(L)},[l,r,c]);return e.jsxs("div",{className:D("space-y-6",t),children:[e.jsx("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Zusammenfassende Meldung (ZM)"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"EU-Umsätze für das Bundeszentralamt für Steuern"})]})}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Jahr:"}),e.jsxs(q,{value:String(r),onValueChange:v=>n(Number(v)),children:[e.jsx(W,{className:"w-[100px]",children:e.jsx(ee,{})}),e.jsx(te,{children:a.map(v=>e.jsx(T,{value:String(v),children:v},v))})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Quartal:"}),e.jsxs(q,{value:String(c),onValueChange:v=>o(Number(v)),children:[e.jsx(W,{className:"w-[80px]",children:e.jsx(ee,{})}),e.jsxs(te,{children:[e.jsx(T,{value:"1",children:"Q1"}),e.jsx(T,{value:"2",children:"Q2"}),e.jsx(T,{value:"3",children:"Q3"}),e.jsx(T,{value:"4",children:"Q4"})]})]})]}),e.jsxs(V,{onClick:N,disabled:u,children:[u&&e.jsx(J,{className:"mr-2 h-4 w-4 animate-spin"}),e.jsx(Fe,{className:"mr-2 h-4 w-4"}),"ZM berechnen"]})]}),x&&e.jsx("div",{className:"rounded-lg border border-destructive bg-destructive/5 p-4 text-sm text-destructive",children:x}),l&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs(Y,{variant:"outline",className:"text-sm",children:[l.entryCount," EU-Kunden"]}),e.jsxs(Y,{variant:"outline",className:"text-sm",children:["Gesamtbetrag: ",ve(l.taxData.totalAmount)]}),e.jsxs(Y,{variant:"outline",className:"text-sm font-mono",children:["Submission: ",l.submission.id.slice(0,8),"..."]})]}),l.taxData.entries.length===0?e.jsx("div",{className:"rounded-lg border border-dashed p-8 text-center text-muted-foreground",children:e.jsxs("p",{children:["Keine EU-Umsätze im Zeitraum Q",c," ",r]})}):e.jsx("div",{className:"rounded-md border overflow-x-auto",children:e.jsxs(le,{children:[e.jsx(ce,{children:e.jsxs(I,{children:[e.jsx(R,{children:"USt-IdNr."}),e.jsx(R,{children:"Name"}),e.jsx(R,{className:"text-right",children:"Bemessungsgrundlage"})]})}),e.jsxs(ie,{children:[l.taxData.entries.map((v,L)=>e.jsxs(I,{children:[e.jsx(A,{className:"font-mono",children:v.vatId}),e.jsx(A,{children:v.name||"—"}),e.jsx(A,{className:"text-right font-medium",children:ve(v.amount)})]},L)),e.jsxs(I,{className:"border-t-2 bg-muted font-bold",children:[e.jsx(A,{colSpan:2,children:"Summe"}),e.jsx(A,{className:"text-right",children:ve(l.taxData.totalAmount)})]})]})]})}),e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsxs(V,{variant:"outline",onClick:j,children:[e.jsx(fe,{className:"mr-2 h-4 w-4"}),"ELSTER XML herunterladen"]})}),e.jsx("div",{className:"rounded-lg border bg-muted/30 p-4 text-sm text-muted-foreground",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(it,{className:"h-4 w-4 mt-0.5 flex-shrink-0 text-yellow-500"}),e.jsx("p",{children:"Die ZM muss quartalsweise an das Bundeszentralamt für Steuern (BZSt) über das ELSTER-Portal übermittelt werden. Laden Sie die XML-Datei herunter und importieren Sie diese in Ihre Steuersoftware oder das ELSTER-Online-Portal."})]})})]}),!l&&!x&&!u&&e.jsx("div",{className:"rounded-lg border border-dashed p-8 text-center text-muted-foreground",children:e.jsx("p",{children:'Wählen Sie Jahr und Quartal und klicken Sie "ZM berechnen", um die EU-Umsätze zu berechnen.'})})]})}const Rs=["Januar","Februar","März","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"],Je=["Jan","Feb","Mär","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];function Ls(){const t=new Date().getFullYear();return Array.from({length:6},(s,r)=>t-r)}function Ts(t){return new Intl.DateTimeFormat("de-DE",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}).format(new Date(t))}function qe(t){const s=new Date,r=s.getFullYear(),n=s.getMonth()+1;if(/^\d{4}-\d{2}$/.test(t)){const[c,o]=t.split("-").map(Number);return c>r||c===r&&o>n}if(/^\d{4}-Q[1-4]$/.test(t)){const c=parseInt(t.slice(0,4)),u=parseInt(t.slice(6))*3;return c>r||c===r&&u>n}return/^\d{4}$/.test(t)?parseInt(t)>r:!1}function Is({className:t}){var U;const{periods:s,isLoading:r,error:n,selectedYear:c,setSelectedYear:o,lockPeriod:u,unlockPeriod:b}=Yt(),[f,m]=i.useState(!1),[x,p]=i.useState(!1),[l,h]=i.useState(null),[a,N]=i.useState(""),[j,v]=i.useState(!1),[L,S]=i.useState(null),g=Ls(),d=s.filter(y=>y.type==="month"),k=s.filter(y=>y.type==="quarter"),E=s.find(y=>y.type==="year"),z=y=>{h(y),N(""),S(null),m(!0)},P=y=>{h(y),N(""),S(null),p(!0)},G=async()=>{if(l){v(!0),S(null);try{await u(l,a||void 0),m(!1)}catch(y){S(Z(y))}finally{v(!1)}}},w=async()=>{if(!(!l||!a.trim())){v(!0),S(null);try{await b(l,a),p(!1)}catch(y){S(Z(y))}finally{v(!1)}}},C=y=>{if(/^\d{4}-\d{2}$/.test(y)){const _=parseInt(y.split("-")[1]);return Rs[_-1]}return/^\d{4}-Q[1-4]$/.test(y)?`Quartal ${y.slice(6)}`:`Jahr ${y}`};return r?e.jsxs("div",{className:D("space-y-6",t),children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Zeiträume sperren"}),e.jsx("div",{className:"flex items-center justify-center p-8",children:e.jsx(J,{className:"h-8 w-8 animate-spin text-muted-foreground"})})]}):n?e.jsxs("div",{className:D("space-y-6",t),children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Zeiträume sperren"}),e.jsxs("div",{className:"rounded-lg border border-destructive p-8 text-center text-destructive",children:["Fehler: ",n]})]}):e.jsxs("div",{className:D("space-y-6",t),children:[e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Zeiträume sperren"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"GoBD-konforme Periodensperrung nach Meldung an das Finanzamt"})]}),e.jsxs(q,{value:String(c),onValueChange:y=>o(Number(y)),children:[e.jsx(W,{className:"w-[120px]",children:e.jsx(ee,{})}),e.jsx(te,{children:g.map(y=>e.jsx(T,{value:String(y),children:y},y))})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-muted-foreground uppercase tracking-wide mb-3",children:"Monate"}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2",children:d.map(y=>{const _=parseInt(y.key.split("-")[1])-1,$=qe(y.key);return e.jsxs("button",{onClick:()=>y.locked?P(y.key):z(y.key),disabled:$,className:D("flex flex-col items-center gap-1 rounded-lg border p-3 transition-colors text-sm",$&&"opacity-40 cursor-not-allowed bg-gray-50",!$&&y.locked&&"bg-red-50 border-red-200 hover:bg-red-100 cursor-pointer",!$&&!y.locked&&"bg-green-50 border-green-200 hover:bg-green-100 cursor-pointer"),"aria-label":`${Je[_]} ${c}: ${y.locked?"gesperrt":$?"zukünftig":"offen"}`,children:[e.jsx("span",{className:"font-medium",children:Je[_]}),$?e.jsx("span",{className:"text-xs text-gray-400",children:"—"}):y.locked?e.jsx(ue,{className:"h-4 w-4 text-red-500"}):e.jsx(be,{className:"h-4 w-4 text-green-500"})]},y.key)})})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-muted-foreground uppercase tracking-wide mb-3",children:"Quartale"}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-2",children:k.map(y=>{const _=y.key.slice(6),$=qe(y.key);return e.jsxs("button",{onClick:()=>y.locked?P(y.key):z(y.key),disabled:$,className:D("flex items-center justify-between rounded-lg border p-3 transition-colors",$&&"opacity-40 cursor-not-allowed bg-gray-50",!$&&y.locked&&"bg-red-50 border-red-200 hover:bg-red-100 cursor-pointer",!$&&!y.locked&&"bg-green-50 border-green-200 hover:bg-green-100 cursor-pointer"),"aria-label":`Quartal ${_} ${c}: ${y.locked?"gesperrt":$?"zukünftig":"offen"}`,children:[e.jsxs("span",{className:"font-medium",children:["Q",_]}),$?e.jsx("span",{className:"text-xs text-gray-400",children:"—"}):y.locked?e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Y,{variant:"destructive",className:"text-xs",children:"Gesperrt"}),e.jsx(ue,{className:"h-4 w-4 text-red-500"})]}):e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Y,{variant:"outline",className:"text-xs text-green-700 border-green-300",children:"Offen"}),e.jsx(be,{className:"h-4 w-4 text-green-500"})]})]},y.key)})})]}),E&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-muted-foreground uppercase tracking-wide mb-3",children:"Geschäftsjahr"}),e.jsxs("button",{onClick:()=>E.locked?P(E.key):z(E.key),className:D("flex items-center justify-between rounded-lg border p-4 w-full sm:w-auto sm:min-w-[300px] transition-colors",E.locked?"bg-red-50 border-red-200 hover:bg-red-100 cursor-pointer":"bg-green-50 border-green-200 hover:bg-green-100 cursor-pointer"),"aria-label":`Jahr ${c}: ${E.locked?"gesperrt":"offen"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[E.locked?e.jsx(Ft,{className:"h-5 w-5 text-red-500"}):e.jsx(Mt,{className:"h-5 w-5 text-green-500"}),e.jsx("span",{className:"font-semibold",children:c})]}),E.locked?e.jsx(Y,{variant:"destructive",children:"Gesperrt"}):e.jsx(Y,{variant:"outline",className:"text-green-700 border-green-300",children:"Offen"})]}),((U=E.lock)==null?void 0:U.reason)&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:["Grund: ",E.lock.reason," • Gesperrt am: ",Ts(E.lock.locked_at)]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-4 text-xs text-muted-foreground border-t pt-4",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"w-3 h-3 rounded bg-green-200 border border-green-300"}),e.jsx("span",{children:"Offen"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"w-3 h-3 rounded bg-red-200 border border-red-300"}),e.jsx("span",{children:"Gesperrt"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"w-3 h-3 rounded bg-gray-100 border border-gray-200"}),e.jsx("span",{children:"Zukünftig"})]})]}),e.jsx(Se,{open:f,onOpenChange:m,children:e.jsxs(Ee,{children:[e.jsxs(Ce,{children:[e.jsx(Re,{children:"Zeitraum sperren"}),e.jsxs(Le,{children:[l&&C(l)," ",c," wird gesperrt. Gesperrte Zeiträume können nicht mehr bearbeitet werden (GoBD)."]})]}),e.jsxs("div",{className:"space-y-3 py-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(re,{htmlFor:"lockReason",children:"Grund (optional)"}),e.jsx(me,{id:"lockReason",value:a,onChange:y=>N(y.target.value),placeholder:"z.B. USt-VA gemeldet"})]}),L&&e.jsx("p",{className:"text-sm text-destructive",children:L})]}),e.jsxs($e,{children:[e.jsx(V,{variant:"outline",onClick:()=>m(!1),disabled:j,children:"Abbrechen"}),e.jsxs(V,{variant:"destructive",onClick:G,disabled:j,children:[j&&e.jsx(J,{className:"mr-2 h-4 w-4 animate-spin"}),e.jsx(ue,{className:"mr-2 h-4 w-4"}),"Sperren"]})]})]})}),e.jsx(Se,{open:x,onOpenChange:p,children:e.jsxs(Ee,{children:[e.jsxs(Ce,{children:[e.jsx(Re,{children:"Zeitraum entsperren"}),e.jsxs(Le,{children:[l&&C(l)," ",c," wird entsperrt. Ein Grund ist für die GoBD-Dokumentation erforderlich."]})]}),e.jsxs("div",{className:"space-y-3 py-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(re,{htmlFor:"unlockReason",children:"Grund (erforderlich)"}),e.jsx(me,{id:"unlockReason",value:a,onChange:y=>N(y.target.value),placeholder:"z.B. Korrekturbuchung erforderlich"})]}),L&&e.jsx("p",{className:"text-sm text-destructive",children:L})]}),e.jsxs($e,{children:[e.jsx(V,{variant:"outline",onClick:()=>p(!1),disabled:j,children:"Abbrechen"}),e.jsxs(V,{onClick:w,disabled:j||!a.trim(),children:[j&&e.jsx(J,{className:"mr-2 h-4 w-4 animate-spin"}),e.jsx(be,{className:"mr-2 h-4 w-4"}),"Entsperren"]})]})]})})]})}function _s(t={}){const{entityType:s,entityId:r,autoFetch:n=!0}=t,[c,o]=i.useState([]),[u,b]=i.useState(0),[f,m]=i.useState(!1),[x,p]=i.useState(null),l=i.useCallback(async(N,j)=>{m(!0),p(null);try{const v=await se.getAuditLog(N,j);o(v),b(v.length)}catch(v){p(v instanceof Error?v.message:"Fehler beim Laden des Audit-Logs")}finally{m(!1)}},[]),h=i.useCallback(async N=>{m(!0),p(null);try{const j=await se.searchAudit(N);o(j.entries||[]),b(j.total||0)}catch(j){p(j instanceof Error?j.message:"Fehler bei der Audit-Suche")}finally{m(!1)}},[]),a=i.useCallback(async()=>{s&&r&&await l(s,r)},[s,r,l]);return i.useEffect(()=>{n&&s&&r&&l(s,r)},[n,s,r,l]),{entries:c,total:u,isLoading:f,error:x,fetchForEntity:l,search:h,refresh:a}}const We={create:{icon:$t,label:"Erstellt",color:"text-green-700",bgColor:"bg-green-100"},update:{icon:Ut,label:"Geändert",color:"text-yellow-700",bgColor:"bg-yellow-100"},delete:{icon:zt,label:"Gelöscht",color:"text-red-700",bgColor:"bg-red-100"},lock:{icon:ue,label:"Gesperrt",color:"text-blue-700",bgColor:"bg-blue-100"},unlock:{icon:ue,label:"Entsperrt",color:"text-purple-700",bgColor:"bg-purple-100"}},Vs={income:"Einnahme",expense:"Ausgabe",invoice:"Rechnung",asset:"Anlagegut",period_lock:"Periodensperre",attachment:"Anhang"};function Fs(t){return new Intl.DateTimeFormat("de-DE",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(new Date(t))}function Ms({entityType:t,entityId:s,embedded:r=!1,className:n}){const{entries:c,total:o,isLoading:u,error:b,search:f}=_s({entityType:t,entityId:s,autoFetch:!!t&&!!s}),[m,x]=i.useState(!t||!s),[p,l]=i.useState("all"),[h,a]=i.useState("all"),[N,j]=i.useState(""),[v,L]=i.useState(""),S=async()=>{await f({entity_type:p!=="all"?p:void 0,action:h!=="all"?h:void 0,start_date:N||void 0,end_date:v||void 0,limit:100})};return i.useEffect(()=>{m&&!t&&!s&&f({limit:50})},[m,t,s,f]),u&&c.length===0?e.jsxs("div",{className:D("flex items-center justify-center p-6",n),children:[e.jsx(J,{className:"h-6 w-6 animate-spin text-muted-foreground"}),e.jsx("span",{className:"ml-2 text-sm text-muted-foreground",children:"Audit-Log laden..."})]}):b?e.jsx("div",{className:D("rounded-lg border border-destructive p-4 text-sm text-destructive",n),children:b}):e.jsxs("div",{className:D("space-y-4",n),children:[!r&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Audit-Log"}),o>0&&e.jsxs(Y,{variant:"secondary",children:[o," Einträge"]})]}),m&&e.jsxs("div",{className:"rounded-lg border p-4 space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(re,{className:"text-xs",children:"Typ"}),e.jsxs(q,{value:p,onValueChange:l,children:[e.jsx(W,{className:"h-8",children:e.jsx(ee,{})}),e.jsxs(te,{children:[e.jsx(T,{value:"all",children:"Alle"}),e.jsx(T,{value:"income",children:"Einnahmen"}),e.jsx(T,{value:"expense",children:"Ausgaben"}),e.jsx(T,{value:"invoice",children:"Rechnungen"}),e.jsx(T,{value:"asset",children:"Anlagegüter"}),e.jsx(T,{value:"period_lock",children:"Periodensperren"})]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(re,{className:"text-xs",children:"Aktion"}),e.jsxs(q,{value:h,onValueChange:a,children:[e.jsx(W,{className:"h-8",children:e.jsx(ee,{})}),e.jsxs(te,{children:[e.jsx(T,{value:"all",children:"Alle"}),e.jsx(T,{value:"create",children:"Erstellt"}),e.jsx(T,{value:"update",children:"Geändert"}),e.jsx(T,{value:"delete",children:"Gelöscht"}),e.jsx(T,{value:"lock",children:"Gesperrt"})]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(re,{className:"text-xs",children:"Von"}),e.jsx(me,{type:"date",value:N,onChange:g=>j(g.target.value),className:"h-8"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(re,{className:"text-xs",children:"Bis"}),e.jsx(me,{type:"date",value:v,onChange:g=>L(g.target.value),className:"h-8"})]})]}),e.jsxs(V,{size:"sm",onClick:S,disabled:u,children:[u&&e.jsx(J,{className:"mr-2 h-3 w-3 animate-spin"}),e.jsx(Ot,{className:"mr-2 h-3 w-3"}),"Suchen"]})]})]}),c.length===0?e.jsx("div",{className:"text-center text-sm text-muted-foreground py-4",children:"Keine Audit-Einträge gefunden"}):e.jsx("div",{className:"space-y-1",children:c.map(g=>{const d=We[g.action]||We.update,k=d.icon,E=g.field_name&&(g.old_value!==void 0||g.new_value!==void 0);return e.jsxs(wt,{children:[e.jsxs(Dt,{className:"flex items-center gap-3 w-full rounded-lg px-3 py-2 text-left hover:bg-muted/50 transition-colors group",children:[e.jsx("div",{className:D("flex items-center justify-center w-7 h-7 rounded-full flex-shrink-0",d.bgColor),children:e.jsx(k,{className:D("h-3.5 w-3.5",d.color)})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Y,{variant:"outline",className:D("text-xs",d.color),children:d.label}),!r&&g.entity_type&&e.jsx("span",{className:"text-xs text-muted-foreground",children:Vs[g.entity_type]||g.entity_type}),g.field_name&&e.jsx("span",{className:"text-xs font-mono text-muted-foreground truncate",children:g.field_name})]}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-0.5",children:[Fs(g.timestamp),g.user_id&&` • ${g.user_id}`]})]}),E&&e.jsx(Bt,{className:"h-4 w-4 text-muted-foreground transition-transform group-data-[state=open]:rotate-180"})]}),E&&e.jsx(kt,{className:"pl-12 pr-3 pb-2",children:e.jsxs("div",{className:"flex items-center gap-2 text-xs bg-muted/30 rounded p-2",children:[g.old_value!==void 0&&g.old_value!==null&&e.jsx("span",{className:"text-red-600 line-through font-mono truncate max-w-[200px]",children:g.old_value}),g.old_value!==void 0&&g.new_value!==void 0&&e.jsx(Te,{className:"h-3 w-3 text-muted-foreground flex-shrink-0"}),g.new_value!==void 0&&g.new_value!==null&&e.jsx("span",{className:"text-green-600 font-mono truncate max-w-[200px]",children:g.new_value})]})})]},g.id)})})]})}const Os=[{euerCategory:"services",euerLine:14,skr03Account:8400,skr04Account:4400,defaultVatRate:19,isIncome:!0},{euerCategory:"services_7",euerLine:14,skr03Account:8300,skr04Account:4300,defaultVatRate:7,isIncome:!0},{euerCategory:"services_exempt",euerLine:14,skr03Account:8120,skr04Account:4120,defaultVatRate:0,isIncome:!0},{euerCategory:"asset_sale",euerLine:16,skr03Account:8600,skr04Account:4600,defaultVatRate:19,isIncome:!0},{euerCategory:"ust_refund",euerLine:18,skr03Account:8955,skr04Account:4955,defaultVatRate:0,isIncome:!0},{euerCategory:"subcontractor",euerLine:25,skr03Account:3100,skr04Account:5900,defaultVatRate:19,isIncome:!1},{euerCategory:"software",euerLine:34,skr03Account:4964,skr04Account:6815,defaultVatRate:19,isIncome:!1},{euerCategory:"telecom",euerLine:34,skr03Account:4920,skr04Account:6805,defaultVatRate:19,isIncome:!1},{euerCategory:"hosting",euerLine:34,skr03Account:4964,skr04Account:6815,defaultVatRate:19,isIncome:!1},{euerCategory:"travel",euerLine:34,skr03Account:4670,skr04Account:6650,defaultVatRate:19,isIncome:!1},{euerCategory:"insurance",euerLine:34,skr03Account:4360,skr04Account:6400,defaultVatRate:0,isIncome:!1},{euerCategory:"bank_fees",euerLine:34,skr03Account:4970,skr04Account:6855,defaultVatRate:0,isIncome:!1},{euerCategory:"training",euerLine:34,skr03Account:4945,skr04Account:6820,defaultVatRate:19,isIncome:!1},{euerCategory:"books",euerLine:34,skr03Account:4940,skr04Account:6821,defaultVatRate:7,isIncome:!1},{euerCategory:"office_supplies",euerLine:34,skr03Account:4930,skr04Account:6815,defaultVatRate:19,isIncome:!1},{euerCategory:"home_office",euerLine:33,skr03Account:4288,skr04Account:6310,defaultVatRate:0,isIncome:!1},{euerCategory:"depreciation",euerLine:30,skr03Account:4830,skr04Account:6220,defaultVatRate:0,isIncome:!1},{euerCategory:"afa",euerLine:30,skr03Account:4830,skr04Account:6220,defaultVatRate:0,isIncome:!1},{euerCategory:"other",euerLine:34,skr03Account:4980,skr04Account:6890,defaultVatRate:19,isIncome:!1}];function zs(t,s){if(t==="services")return s===7?8300:s===0?8120:8400;const r=Os.find(n=>n.euerCategory===t);return(r==null?void 0:r.skr03Account)??4980}const et={BANK:1200},Us=[{euerCategory:"services",euerLine:14,skr03Account:8400,skr04Account:4400,defaultVatRate:19,isIncome:!0},{euerCategory:"services_7",euerLine:14,skr03Account:8300,skr04Account:4300,defaultVatRate:7,isIncome:!0},{euerCategory:"services_exempt",euerLine:14,skr03Account:8120,skr04Account:4120,defaultVatRate:0,isIncome:!0},{euerCategory:"asset_sale",euerLine:16,skr03Account:8600,skr04Account:4600,defaultVatRate:19,isIncome:!0},{euerCategory:"ust_refund",euerLine:18,skr03Account:8955,skr04Account:4955,defaultVatRate:0,isIncome:!0},{euerCategory:"subcontractor",euerLine:25,skr03Account:3100,skr04Account:5900,defaultVatRate:19,isIncome:!1},{euerCategory:"software",euerLine:34,skr03Account:4964,skr04Account:6815,defaultVatRate:19,isIncome:!1},{euerCategory:"telecom",euerLine:34,skr03Account:4920,skr04Account:6805,defaultVatRate:19,isIncome:!1},{euerCategory:"hosting",euerLine:34,skr03Account:4964,skr04Account:6815,defaultVatRate:19,isIncome:!1},{euerCategory:"travel",euerLine:34,skr03Account:4670,skr04Account:6650,defaultVatRate:19,isIncome:!1},{euerCategory:"insurance",euerLine:34,skr03Account:4360,skr04Account:6400,defaultVatRate:0,isIncome:!1},{euerCategory:"bank_fees",euerLine:34,skr03Account:4970,skr04Account:6855,defaultVatRate:0,isIncome:!1},{euerCategory:"training",euerLine:34,skr03Account:4945,skr04Account:6820,defaultVatRate:19,isIncome:!1},{euerCategory:"books",euerLine:34,skr03Account:4940,skr04Account:6821,defaultVatRate:7,isIncome:!1},{euerCategory:"office_supplies",euerLine:34,skr03Account:4930,skr04Account:6815,defaultVatRate:19,isIncome:!1},{euerCategory:"home_office",euerLine:33,skr03Account:4288,skr04Account:6310,defaultVatRate:0,isIncome:!1},{euerCategory:"depreciation",euerLine:30,skr03Account:4830,skr04Account:6220,defaultVatRate:0,isIncome:!1},{euerCategory:"afa",euerLine:30,skr03Account:4830,skr04Account:6220,defaultVatRate:0,isIncome:!1},{euerCategory:"other",euerLine:34,skr03Account:4980,skr04Account:6890,defaultVatRate:19,isIncome:!1}];function $s(t,s){if(t==="services")return s===7?4300:s===0?4120:4400;const r=Us.find(n=>n.euerCategory===t);return(r==null?void 0:r.skr04Account)??6890}const tt={BANK:1800};function ht(t){switch(t){case 19:return 3;case 7:return 2;case 0:default:return 0}}function ft(t,s,r){return s==="SKR03"?zs(t,r):$s(t,r)}function gt(t,s){if(t==="SKR03")switch(s){case"cash":return 1e3;case"paypal":return 1360;case"credit_card":return 1361;case"bank_transfer":return et.BANK;default:return et.BANK}switch(s){case"cash":return 1600;case"paypal":return 1460;case"credit_card":return 1461;case"bank_transfer":return tt.BANK;default:return tt.BANK}}function pt(t){const s=String(t.getDate()).padStart(2,"0"),r=String(t.getMonth()+1).padStart(2,"0");return`${s}${r}`}function Ae(t){return t.toFixed(2).replace(".",",")}function jt(){return{amount:0,debitCredit:"S",currency:"EUR",exchangeRate:"",baseAmount:0,account:0,counterAccount:1200,vatCode:0,documentDate:"",documentRef1:"",documentRef2:"",discount:0,description:"",blocked:0,addressNumber:"",partnerBank:"",businessCase:"",interestBlocked:0,documentLink:"",documentInfoType:"",documentInfoContent:""}}function bt(t,s){const r=ft(t.euerCategory,s,t.vatRate),n=gt(s,t.paymentMethod);return{...jt(),amount:t.grossAmount,debitCredit:"H",baseAmount:t.grossAmount,account:r,counterAccount:n,vatCode:ht(t.vatRate),documentDate:pt(t.date),documentRef1:t.invoiceId??"",description:vt(t.description)}}function Nt(t,s){const r=ft(t.euerCategory,s,t.vatRate),n=gt(s,t.paymentMethod);return{...jt(),amount:t.grossAmount,debitCredit:"S",baseAmount:t.grossAmount,account:r,counterAccount:n,vatCode:ht(t.vatRate),documentDate:pt(t.date),documentRef1:t.receiptPath?Bs(t.receiptPath):"",description:vt(`${t.vendor}: ${t.description}`)}}function vt(t){return t.length<=60?t:t.slice(0,57)+"..."}function Bs(t){return(t.split("/").pop()??"").replace(/\.[^/.]+$/,"")}function At(t){const s=[];return t.amount<=0&&s.push("Amount must be greater than 0"),(!t.account||t.account===0)&&s.push("Account number is required"),(!t.counterAccount||t.counterAccount===0)&&s.push("Counter account is required"),(!t.documentDate||t.documentDate.length!==4)&&s.push("Document date must be in DDMM format"),["S","H"].includes(t.debitCredit)||s.push("Debit/Credit indicator must be S or H"),[0,2,3].includes(t.vatCode)||s.push("VAT code must be 0, 2, or 3"),s}const Ys=["Umsatz","Soll/Haben-Kennzeichen","WKZ Umsatz","Kurs","Basis-Umsatz","Konto","Gegenkonto","BU-Schlüssel","Belegdatum","Belegfeld 1","Belegfeld 2","Skonto","Buchungstext","Postensperre","Diverse Adressnummer","Geschäftspartnerbank","Sachverhalt","Zinssperre","Beleglink","Beleginfo - Art 1","Beleginfo - Inhalt 1"],Oe=";";function Ps(t){return[Ae(t.amount),t.debitCredit,t.currency,t.exchangeRate,Ae(t.baseAmount),String(t.account),String(t.counterAccount),String(t.vatCode),t.documentDate,ye(t.documentRef1),ye(t.documentRef2),Ae(t.discount),ye(t.description),String(t.blocked),t.addressNumber,t.partnerBank,t.businessCase,String(t.interestBlocked),t.documentLink,t.documentInfoType,t.documentInfoContent].join(Oe)}function ye(t){return t?t.includes(Oe)||t.includes('"')||t.includes(`
`)?`"${t.replace(/"/g,'""')}"`:t:""}function Gs(t){const s=Ys.join(Oe),r=t.map(Ps);return[s,...r].join(`
`)}function Qs(t,s){return t.map(r=>bt(r,s))}function Ks(t,s){return t.map(r=>Nt(r,s))}function st(t){const s=[];for(let r=0;r<t.length;r++){const n=t.charCodeAt(r);n<=255?s.push(n):s.push(63)}return new Uint8Array(s)}function Zs(t,s,r){const n=[],c=[],o=[],u=t.filter(f=>{const m=f.date;return m>=r.startDate&&m<=r.endDate}),b=s.filter(f=>{const m=f.date;return m>=r.startDate&&m<=r.endDate});if(r.includeIncome!==!1){const f=Qs(u,r.chartOfAccounts);o.push(...f)}if(r.includeExpenses!==!1){const f=Ks(b,r.chartOfAccounts);o.push(...f)}return o.forEach((f,m)=>{const x=At(f);x.length>0&&n.push(`Record ${m+1}: ${x.join(", ")}`)}),o.length===0&&c.push("No records found in the selected date range"),{records:o,recordCount:o.length,startDate:r.startDate,endDate:r.endDate,chartOfAccounts:r.chartOfAccounts,format:"csv",errors:n,warnings:c}}function Hs(t,s="csv"){const r=rt(t.startDate),n=rt(t.endDate);return`DATEV_${t.chartOfAccounts}_${r}_${n}.${s}`}function rt(t){const s=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0");return`${s}${r}${n}`}function we(t,s){switch(s){case"Q1":return{startDate:new Date(t,0,1),endDate:new Date(t,2,31)};case"Q2":return{startDate:new Date(t,3,1),endDate:new Date(t,5,30)};case"Q3":return{startDate:new Date(t,6,1),endDate:new Date(t,8,30)};case"Q4":return{startDate:new Date(t,9,1),endDate:new Date(t,11,31)};case"year":return{startDate:new Date(t,0,1),endDate:new Date(t,11,31)}}}function Xs(t,s){const r=new Date(t,s-1,1),n=new Date(t,s,0);return{startDate:r,endDate:n}}const Js=new Date().getFullYear(),nt=Math.ceil((new Date().getMonth()+1)/3),at={periodType:"quarter",year:Js,quarter:nt>1?nt-1:4,month:new Date().getMonth()||12,customStartDate:null,customEndDate:null,chartOfAccounts:"SKR03",format:"csv",consultantNumber:"",clientNumber:"",includeIncome:!0,includeExpenses:!0,includeDepreciation:!0};function qs(t={}){const[s,r]=i.useState({...at,...t}),n=i.useMemo(()=>{switch(s.periodType){case"month":return Xs(s.year,s.month);case"quarter":return we(s.year,`Q${s.quarter}`);case"year":return we(s.year,"year");case"custom":return{startDate:s.customStartDate||new Date(s.year,0,1),endDate:s.customEndDate||new Date(s.year,11,31)};default:return we(s.year,"year")}},[s.periodType,s.year,s.month,s.quarter,s.customStartDate,s.customEndDate]),c=i.useMemo(()=>({startDate:n.startDate,endDate:n.endDate,chartOfAccounts:s.chartOfAccounts,format:s.format,consultantNumber:s.consultantNumber||void 0,clientNumber:s.clientNumber||void 0,includeIncome:s.includeIncome,includeExpenses:s.includeExpenses,includeDepreciation:s.includeDepreciation}),[n,s]),o=i.useMemo(()=>{const g=[];return s.periodType==="custom"&&(s.customStartDate||g.push("Start date is required for custom period"),s.customEndDate||g.push("End date is required for custom period"),s.customStartDate&&s.customEndDate&&s.customStartDate>s.customEndDate&&g.push("Start date must be before end date")),!s.includeIncome&&!s.includeExpenses&&!s.includeDepreciation&&g.push("At least one transaction type must be selected"),g},[s]),u=o.length===0,b=i.useCallback(g=>{r(d=>({...d,periodType:g}))},[]),f=i.useCallback(g=>{r(d=>({...d,year:g}))},[]),m=i.useCallback(g=>{r(d=>({...d,quarter:g}))},[]),x=i.useCallback(g=>{r(d=>({...d,month:g}))},[]),p=i.useCallback((g,d)=>{r(k=>({...k,customStartDate:g,customEndDate:d}))},[]),l=i.useCallback(g=>{r(d=>({...d,chartOfAccounts:g}))},[]),h=i.useCallback(g=>{r(d=>({...d,format:g}))},[]),a=i.useCallback(g=>{r(d=>({...d,consultantNumber:g}))},[]),N=i.useCallback(g=>{r(d=>({...d,clientNumber:g}))},[]),j=i.useCallback(()=>{r(g=>({...g,includeIncome:!g.includeIncome}))},[]),v=i.useCallback(()=>{r(g=>({...g,includeExpenses:!g.includeExpenses}))},[]),L=i.useCallback(()=>{r(g=>({...g,includeDepreciation:!g.includeDepreciation}))},[]),S=i.useCallback(()=>{r(at)},[]);return{state:s,exportOptions:c,setPeriodType:b,setYear:f,setQuarter:m,setMonth:x,setCustomDateRange:p,setChartOfAccounts:l,setFormat:h,setConsultantNumber:a,setClientNumber:N,toggleIncludeIncome:j,toggleIncludeExpenses:v,toggleIncludeDepreciation:L,reset:S,validationErrors:o,isValid:u}}function Ws(){return i.useMemo(()=>{const t=[],s=new Date().getFullYear();for(let r=0;r<6;r++)t.push(s-r);return t},[])}function er(){return i.useMemo(()=>["Januar","Februar","März","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"].map((s,r)=>({value:r+1,label:s})),[])}function tr(){return i.useMemo(()=>[{value:1,label:"Q1 (Jan - Mär)"},{value:2,label:"Q2 (Apr - Jun)"},{value:3,label:"Q3 (Jul - Sep)"},{value:4,label:"Q4 (Okt - Dez)"}],[])}function sr(){return i.useMemo(()=>[{value:"month",label:"Monat"},{value:"quarter",label:"Quartal"},{value:"year",label:"Jahr"},{value:"custom",label:"Benutzerdefiniert"}],[])}const rr=({exportState:t,disabled:s=!1,className:r=""})=>{const{state:n,setPeriodType:c,setYear:o,setQuarter:u,setMonth:b,setCustomDateRange:f,setChartOfAccounts:m,setFormat:x,setConsultantNumber:p,setClientNumber:l,toggleIncludeIncome:h,toggleIncludeExpenses:a,toggleIncludeDepreciation:N,validationErrors:j}=t,v=Ws(),L=er(),S=tr(),g=sr();return e.jsxs("div",{className:`space-y-6 ${r}`,role:"form","aria-label":"DATEV Export Einstellungen",children:[e.jsxs("fieldset",{className:"space-y-4",disabled:s,children:[e.jsx("legend",{className:"text-sm font-medium text-gray-700",children:"Zeitraum"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"periodType",className:"block text-sm text-gray-600 mb-1",children:"Zeitraumtyp"}),e.jsx("select",{id:"periodType",value:n.periodType,onChange:d=>c(d.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500","aria-describedby":"periodType-description",children:g.map(d=>e.jsx("option",{value:d.value,children:d.label},d.value))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"year",className:"block text-sm text-gray-600 mb-1",children:"Jahr"}),e.jsx("select",{id:"year",value:n.year,onChange:d=>o(parseInt(d.target.value,10)),className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500",children:v.map(d=>e.jsx("option",{value:d,children:d},d))})]})]}),n.periodType==="quarter"&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"quarter",className:"block text-sm text-gray-600 mb-1",children:"Quartal"}),e.jsx("select",{id:"quarter",value:n.quarter,onChange:d=>u(parseInt(d.target.value,10)),className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500",children:S.map(d=>e.jsx("option",{value:d.value,children:d.label},d.value))})]}),n.periodType==="month"&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"month",className:"block text-sm text-gray-600 mb-1",children:"Monat"}),e.jsx("select",{id:"month",value:n.month,onChange:d=>b(parseInt(d.target.value,10)),className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500",children:L.map(d=>e.jsx("option",{value:d.value,children:d.label},d.value))})]}),n.periodType==="custom"&&e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"startDate",className:"block text-sm text-gray-600 mb-1",children:"Von"}),e.jsx("input",{type:"date",id:"startDate",value:n.customStartDate?n.customStartDate.toISOString().split("T")[0]:"",onChange:d=>f(d.target.value?new Date(d.target.value):null,n.customEndDate),className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"endDate",className:"block text-sm text-gray-600 mb-1",children:"Bis"}),e.jsx("input",{type:"date",id:"endDate",value:n.customEndDate?n.customEndDate.toISOString().split("T")[0]:"",onChange:d=>f(n.customStartDate,d.target.value?new Date(d.target.value):null),className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"})]})]})]}),e.jsxs("fieldset",{className:"space-y-4",disabled:s,children:[e.jsx("legend",{className:"text-sm font-medium text-gray-700",children:"Format"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"chartOfAccounts",className:"block text-sm text-gray-600 mb-1",children:"Kontenrahmen"}),e.jsxs("select",{id:"chartOfAccounts",value:n.chartOfAccounts,onChange:d=>m(d.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"SKR03",children:"SKR03 (Standard)"}),e.jsx("option",{value:"SKR04",children:"SKR04"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"format",className:"block text-sm text-gray-600 mb-1",children:"Exportformat"}),e.jsxs("select",{id:"format",value:n.format,onChange:d=>x(d.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"csv",children:"CSV (Buchungsstapel)"}),e.jsx("option",{value:"xml",children:"XML (LedgerImport)"})]})]})]})]}),e.jsxs("fieldset",{className:"space-y-4",disabled:s,children:[e.jsx("legend",{className:"text-sm font-medium text-gray-700",children:"DATEV Metadaten (optional)"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"consultantNumber",className:"block text-sm text-gray-600 mb-1",children:"Beraternummer"}),e.jsx("input",{type:"text",id:"consultantNumber",value:n.consultantNumber,onChange:d=>p(d.target.value),placeholder:"z.B. 12345",className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"clientNumber",className:"block text-sm text-gray-600 mb-1",children:"Mandantennummer"}),e.jsx("input",{type:"text",id:"clientNumber",value:n.clientNumber,onChange:d=>l(d.target.value),placeholder:"z.B. 99999",className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"})]})]})]}),e.jsxs("fieldset",{className:"space-y-3",disabled:s,children:[e.jsx("legend",{className:"text-sm font-medium text-gray-700",children:"Zu exportieren"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",checked:n.includeIncome,onChange:h,className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),e.jsx("span",{className:"ml-2 text-sm text-gray-700",children:"Einnahmen"})]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",checked:n.includeExpenses,onChange:a,className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),e.jsx("span",{className:"ml-2 text-sm text-gray-700",children:"Ausgaben"})]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",checked:n.includeDepreciation,onChange:N,className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),e.jsx("span",{className:"ml-2 text-sm text-gray-700",children:"Abschreibungen (AfA)"})]})]})]}),j.length>0&&e.jsxs("div",{className:"p-3 bg-red-50 border border-red-200 rounded-md",role:"alert","aria-live":"polite",children:[e.jsx("h4",{className:"text-sm font-medium text-red-800",children:"Bitte korrigieren Sie folgende Fehler:"}),e.jsx("ul",{className:"mt-1 text-sm text-red-600 list-disc list-inside",children:j.map((d,k)=>e.jsx("li",{children:d},k))})]})]})},nr="http://xml.datev.de/bedi/tps/ledger/v060",ar='<?xml version="1.0" encoding="UTF-8"?>';function lr(t){return t?t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;"):""}function O(t,s,r){if(s==null||s==="")return`<${t}/>`;const c=typeof s=="number"?s.toString():lr(s);return`<${t}>${c}</${t}>`}function ze(t,s){const r=s.filter(n=>n).join(`
`);return`<${t}>
${r}
</${t}>`}function Ie(t,s=2){const r=t.split(`
`),n=" ".repeat(s);return r.map(c=>n+c).join(`
`)}function lt(t){const s=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0");return`${s}-${r}-${n}`}function cr(t,s){const r=t.slice(0,2),n=t.slice(2,4);return`${s}-${n}-${r}`}function ir(t,s){const r=[],n=cr(t.documentDate,s);if(r.push(O("Date",n)),r.push(O("Amount",t.amount.toFixed(2))),t.debitCredit==="S"?(r.push(O("DebitAccount",t.account)),r.push(O("CreditAccount",t.counterAccount))):(r.push(O("DebitAccount",t.counterAccount)),r.push(O("CreditAccount",t.account))),t.description&&r.push(O("Description",t.description)),t.vatCode>0){const c=t.vatCode===3?19:t.vatCode===2?7:0;r.push(O("TaxCode",c))}return t.documentRef1&&r.push(O("DocumentNumber",t.documentRef1)),r.push(O("Currency",t.currency)),ze("Transaction",r)}function or(t,s){const r=t.map(n=>Ie(ir(n,s),4));return ze("Consolidate",r)}function dr(t){const s=[];return s.push(O("Version","6.0")),s.push(O("Generator","Personal Assistant")),s.push(O("GeneratedAt",new Date().toISOString())),t.consultantNumber&&s.push(O("ConsultantNumber",t.consultantNumber)),t.clientNumber&&s.push(O("ClientNumber",t.clientNumber)),s.push(O("ChartOfAccounts",t.chartOfAccounts)),s.push(O("PeriodStart",lt(t.startDate))),s.push(O("PeriodEnd",lt(t.endDate))),ze("Header",s)}function ur(t,s){const r=s.startDate.getFullYear(),n=Ie(dr(s),2),c=Ie(or(t,r),2),o=[n,c].join(`
`),u=`<LedgerImport xmlns="${nr}">
${o}
</LedgerImport>`;return`${ar}
${u}`}function mr(t,s){return t.map(r=>bt(r,s))}function xr(t,s){return t.map(r=>Nt(r,s))}function hr(t,s,r){const n=[],c=[],o=[],u=t.filter(f=>{const m=f.date;return m>=r.startDate&&m<=r.endDate}),b=s.filter(f=>{const m=f.date;return m>=r.startDate&&m<=r.endDate});if(r.includeIncome!==!1){const f=mr(u,r.chartOfAccounts);o.push(...f)}if(r.includeExpenses!==!1){const f=xr(b,r.chartOfAccounts);o.push(...f)}return o.forEach((f,m)=>{const x=At(f);x.length>0&&n.push(`Record ${m+1}: ${x.join(", ")}`)}),o.length===0&&c.push("No records found in the selected date range"),{records:o,recordCount:o.length,startDate:r.startDate,endDate:r.endDate,chartOfAccounts:r.chartOfAccounts,format:"xml",errors:n,warnings:c}}function fr(t,s){return ur(t.records,s)}let De=null,ke=null;async function gr(){if(!De||!ke){const[t,s]=await Promise.all([Ue(()=>import("./index-DV0Z4ueH.js"),__vite__mapDeps([0,1])),Ue(()=>import("./index-CDjnCujr.js"),__vite__mapDeps([2,3,1]))]);De=t,ke=s}return{save:De.save,writeFile:ke.writeFile}}function ct(t,s,r){const n=new Blob([t],{type:r}),c=URL.createObjectURL(n),o=document.createElement("a");o.href=c,o.download=s,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(c)}const pr=({open:t,onOpenChange:s,incomes:r,expenses:n,className:c=""})=>{const o=qs(),{exportOptions:u,isValid:b}=o,[f,m]=i.useState(!1),[x,p]=i.useState(null),[l,h]=i.useState(null),[a,N]=i.useState(null),[j,v]=i.useState(null);i.useEffect(()=>{if(!t)return;const d=r.filter(w=>{const C=w.date;return C>=u.startDate&&C<=u.endDate}),k=n.filter(w=>{const C=w.date;return C>=u.startDate&&C<=u.endDate}),E=u.includeIncome?d.length:0,z=u.includeExpenses?k.length:0,P=d.reduce((w,C)=>w+C.grossAmount,0),G=k.reduce((w,C)=>w+C.grossAmount,0);p({incomeCount:E,expenseCount:z,depreciationCount:0,totalCount:E+z,totalIncome:Math.round(P*100)/100,totalExpenses:Math.round(G*100)/100,startDate:u.startDate,endDate:u.endDate})},[t,r,n,u]);const L=i.useCallback(async()=>{if(b){m(!0),N(null),v(null);try{if(St()){const U=u.startDate.toISOString().split("T")[0],y=u.endDate.toISOString().split("T")[0],_=await se.generateDatevExport({start_date:U,end_date:y,chart_of_accounts:u.chartOfAccounts,consultant_number:u.consultantNumber||void 0,client_number:u.clientNumber||void 0,include_income:u.includeIncome,include_expenses:u.includeExpenses,include_depreciation:u.includeDepreciation});if(_.errors&&_.errors.length>0)throw v({errors:_.errors,warnings:_.warnings}),new Error(_.errors.join(`
`));if(_.warnings.length>0&&v({errors:[],warnings:_.warnings}),_.csv&&_.filename){const $=st(_.csv);ct($,_.filename,"text/csv")}h({records:[],recordCount:_.recordCount,startDate:u.startDate,endDate:u.endDate,chartOfAccounts:u.chartOfAccounts,format:"csv",errors:[],warnings:_.warnings});return}const d=r,k=n;let E,z,P,G;if(u.format==="csv"?(E=Zs(d,k,u),z=Gs(E.records),P="text/csv",G="iso-8859-1"):(E=hr(d,k,u),z=fr(E,u),P="application/xml",G="utf-8"),E.errors.length>0)throw new Error(E.errors.join(`
`));const w=Hs(u,u.format);let C;if(G==="iso-8859-1"?C=st(z):C=new TextEncoder().encode(z),xe()){const{save:U,writeFile:y}=await gr(),_=await U({defaultPath:w,filters:[{name:u.format==="csv"?"CSV Files":"XML Files",extensions:[u.format]}]});if(!_)return;await y(_,C)}else ct(C,w,P);h(E)}catch(d){N(d instanceof Error?d.message:"Export failed")}finally{m(!1)}}},[b,r,n,u]),S=d=>new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(d),g=d=>new Intl.DateTimeFormat("de-DE").format(d);return e.jsx(Pt,{open:t,onOpenChange:s,children:e.jsxs(Gt,{children:[e.jsx(Qt,{className:"fixed inset-0 bg-black/50 data-[state=open]:animate-fadeIn"}),e.jsxs(Kt,{className:`fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto focus:outline-none data-[state=open]:animate-contentShow ${c}`,"aria-describedby":"datev-export-description",children:[e.jsxs("div",{className:"sticky top-0 bg-white border-b px-6 py-4 z-10",children:[e.jsx(Zt,{className:"text-lg font-semibold text-gray-900",children:"DATEV Export"}),e.jsx(Ht,{id:"datev-export-description",className:"text-sm text-gray-500 mt-1",children:"Exportieren Sie Ihre Buchhaltungsdaten im DATEV-Format für Ihren Steuerberater."})]}),e.jsxs("div",{className:"px-6 py-4 space-y-6",children:[e.jsx(rr,{exportState:o,disabled:f}),x&&e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 space-y-3",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-700",children:"Vorschau"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Zeitraum:"}),e.jsxs("p",{className:"font-medium",children:[g(x.startDate)," -"," ",g(x.endDate)]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Datensätze:"}),e.jsx("p",{className:"font-medium",children:x.totalCount})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 text-sm pt-2 border-t",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Einnahmen"}),e.jsxs("p",{className:"font-medium text-green-600",children:[x.incomeCount," (",S(x.totalIncome),")"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Ausgaben"}),e.jsxs("p",{className:"font-medium text-red-600",children:[x.expenseCount," (",S(x.totalExpenses),")"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Ergebnis"}),e.jsx("p",{className:`font-medium ${x.totalIncome-x.totalExpenses>=0?"text-green-600":"text-red-600"}`,children:S(x.totalIncome-x.totalExpenses)})]})]})]}),l&&!a&&e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-md",role:"status","aria-live":"polite",children:[e.jsxs("p",{className:"text-sm text-green-800",children:["Export erfolgreich! ",l.recordCount," Datensätze wurden exportiert."]}),l.warnings.length>0&&e.jsx("ul",{className:"mt-2 text-sm text-yellow-700 list-disc list-inside",children:l.warnings.map((d,k)=>e.jsx("li",{children:d},k))})]}),j&&j.warnings.length>0&&!a&&e.jsxs("div",{className:"p-3 bg-yellow-50 border border-yellow-200 rounded-md",role:"status",children:[e.jsx("p",{className:"text-sm font-medium text-yellow-800 mb-1",children:"Server-Validierung:"}),e.jsx("ul",{className:"text-sm text-yellow-700 list-disc list-inside",children:j.warnings.map((d,k)=>e.jsx("li",{children:d},k))})]}),a&&e.jsxs("div",{className:"p-3 bg-red-50 border border-red-200 rounded-md",role:"alert","aria-live":"assertive",children:[e.jsx("p",{className:"text-sm text-red-800",children:a}),(j==null?void 0:j.errors)&&j.errors.length>0&&e.jsx("ul",{className:"mt-2 text-sm text-red-700 list-disc list-inside",children:j.errors.map((d,k)=>e.jsx("li",{children:d},k))})]})]}),e.jsxs("div",{className:"sticky bottom-0 bg-white border-t px-6 py-4 flex justify-end gap-3",children:[e.jsx(Pe,{asChild:!0,children:e.jsx("button",{type:"button",className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",disabled:f,children:"Abbrechen"})}),e.jsx("button",{type:"button",onClick:L,disabled:!b||f||(x==null?void 0:x.totalCount)===0,className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed","aria-busy":f,children:f?e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsxs("svg",{className:"animate-spin h-4 w-4",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Exportiere..."]}):"Exportieren"})]}),e.jsx(Pe,{asChild:!0,children:e.jsx("button",{type:"button",className:"absolute top-4 right-4 p-1 rounded-md text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500","aria-label":"Schließen",children:e.jsx("svg",{className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})})]})]})})};function zr(){const t=new Date().getFullYear(),[s,r]=i.useState(t),[n,c]=i.useState([]),[o,u]=i.useState([]),[b,f]=i.useState([]),[m,x]=i.useState([]),[p,l]=i.useState(!0),[h,a]=i.useState(!1);i.useEffect(()=>{async function j(){l(!0);try{const[v,L,S,g]=await Promise.all([Lt(),Jt(),qt(),Wt.getTransactions().catch(()=>[])]);c(v),u(L),f(S),x(g)}catch(v){console.error("Failed to load data:",v)}finally{l(!1)}}j()},[]);const N=Array.from({length:6},(j,v)=>t-v);return e.jsxs("div",{className:"space-y-6 animate-in fade-in",children:[e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:[e.jsx("div",{children:e.jsx("h1",{className:"text-2xl sm:text-3xl font-semibold tracking-tight",children:"Reports"})}),e.jsxs(q,{value:String(s),onValueChange:j=>r(Number(j)),children:[e.jsx(W,{className:"w-full sm:w-[120px]",children:e.jsx(ee,{placeholder:"Year"})}),e.jsx(te,{children:N.map(j=>e.jsx(T,{value:String(j),children:j},j))})]})]}),e.jsxs(_e,{defaultValue:"vat",className:"w-full",children:[e.jsxs(Ve,{className:"flex w-full overflow-x-auto gap-1",children:[e.jsx(F,{value:"vat",className:"flex-shrink-0",children:"VAT (USt)"}),e.jsx(F,{value:"euer",className:"flex-shrink-0",children:"Profit (EÜR)"}),e.jsx(F,{value:"assets",className:"flex-shrink-0 whitespace-nowrap",children:"Assets"}),e.jsx(F,{value:"afa",className:"flex-shrink-0",children:"AfA"}),e.jsx(F,{value:"zm",className:"flex-shrink-0",children:"ZM"}),e.jsx(F,{value:"banking",className:"flex-shrink-0",children:"Banking"}),e.jsx(F,{value:"datev",className:"flex-shrink-0",children:"DATEV"}),e.jsx(F,{value:"elster",className:"flex-shrink-0",children:"ELSTER"}),e.jsx(F,{value:"locks",className:"flex-shrink-0",children:"Sperren"}),e.jsx(F,{value:"audit",className:"flex-shrink-0",children:"Audit"})]}),e.jsx(B,{value:"vat",className:"mt-6",children:e.jsx(hs,{})}),e.jsx(B,{value:"euer",className:"mt-6",children:e.jsx(ps,{})}),e.jsx(B,{value:"assets",className:"mt-6",children:e.jsx(Ns,{year:s,assets:n,isLoading:p})}),e.jsx(B,{value:"afa",className:"mt-6",children:e.jsx(ys,{year:s,assets:n,isLoading:p})}),e.jsx(B,{value:"zm",className:"mt-6",children:e.jsx(Cs,{})}),e.jsx(B,{value:"banking",className:"mt-6",children:e.jsx(Xt,{transactions:m})}),e.jsx(B,{value:"datev",className:"mt-6",children:e.jsx("div",{className:"rounded-lg border bg-card p-6",children:e.jsxs("div",{className:"flex flex-col items-center justify-center space-y-4 py-8",children:[e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"DATEV Export"}),e.jsx("p",{className:"text-sm text-muted-foreground max-w-md",children:"Export your accounting data in DATEV format for your tax advisor. Supports CSV (Buchungsstapel) and XML (LedgerImport) formats."})]}),e.jsx(V,{onClick:()=>a(!0),size:"lg",children:"Open DATEV Export"})]})})}),e.jsx(B,{value:"elster",className:"mt-6",children:e.jsx(ks,{})}),e.jsx(B,{value:"locks",className:"mt-6",children:e.jsx(Is,{})}),e.jsx(B,{value:"audit",className:"mt-6",children:e.jsx(Ms,{})})]}),e.jsx(pr,{open:h,onOpenChange:a,incomes:o,expenses:b})]})}export{zr as ReportsPage};
