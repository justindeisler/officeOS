const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DV0Z4ueH.js","assets/core-BDPGcIsz.js","assets/index-CDjnCujr.js","assets/path-E9zjYLSN.js","assets/index-CLbthooq.js"])))=>i.map(i=>d[i]);
var J=Object.defineProperty;var j=(e,t,a)=>t in e?J(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a;var O=(e,t,a)=>j(e,typeof t!="symbol"?t+"":t,a);import{g}from"./db-DvpaIHPS.js";import{n as q,_ as F,ac as D,ad as z}from"./index-B9wpeZVf.js";import{A as X,G as k}from"./index-uXN-dP3D.js";const n=q("attachmentService");let I=null,S=null,N=null,x=null;async function A(){if(!I||!S||!N||!x){const[e,t,a,s]=await Promise.all([F(()=>import("./index-DV0Z4ueH.js"),__vite__mapDeps([0,1])),F(()=>import("./index-CDjnCujr.js"),__vite__mapDeps([2,3,1])),F(()=>import("./index-CLbthooq.js"),__vite__mapDeps([4,1])),F(()=>import("./path-E9zjYLSN.js"),__vite__mapDeps([3,1]))]);I=e,S=t,N=a,x=s}return{open:I.open,copyFile:S.copyFile,remove:S.remove,exists:S.exists,mkdir:S.mkdir,readFile:S.readFile,writeFile:S.writeFile,openPath:N.openPath,appDataDir:x.appDataDir,join:x.join}}const m=(e,t,a)=>{const s=new Promise((i,r)=>setTimeout(()=>r(new Error(`${a} timed out after ${t}ms`)),t));return Promise.race([e,s])};class K{constructor(){O(this,"ATTACHMENTS_DIR","attachments");O(this,"ASSETS_SUBDIR","assets")}async pickBillFile(){try{const{open:t}=await A(),a=await t({multiple:!1,filters:[{name:"PDF Documents",extensions:["pdf"]}],title:"Select Bill/Invoice PDF"});if(!a||Array.isArray(a))return null;const s=a.split(/[/\\]/),i=s[s.length-1];return{path:a,name:i}}catch(t){throw n.error({err:t},"Failed to pick file"),new Error("Failed to open file picker")}}async saveAttachment(t,a,s){try{const{appDataDir:i,join:r,copyFile:d,readFile:c,writeFile:l,exists:y}=await A();n.info(`[Attachment] Starting save for asset ${t}`),n.info(`[Attachment] Source path: ${a}`);const f=await m(i(),5e3,"Get app data dir");n.info(`[Attachment] App data dir: ${f}`);const v=await m(r(f,this.ATTACHMENTS_DIR),1e3,"Join path"),w=await m(r(v,this.ASSETS_SUBDIR),1e3,"Join path"),o=await m(r(w,t),1e3,"Join path");await m(this.ensureDirectory(v),5e3,"Create attachments dir"),await m(this.ensureDirectory(w),5e3,"Create assets dir"),await m(this.ensureDirectory(o),5e3,"Create asset dir"),n.info(`[Attachment] Directories created: ${o}`);const u=Date.now(),p=this.sanitizeFilename(s),h=`${u}_${p}`,E=await m(r(o,h),1e3,"Join target path");n.info(`[Attachment] Target path: ${E}`),n.info("Starting file copy..."),n.info(`[Attachment] From: ${a}`),n.info(`[Attachment] To: ${E}`);try{await m(d(a,E),3e4,"File copy"),n.info("File copy completed via copyFile")}catch(M){n.warn({data:M},"copyFile failed, trying readFile + writeFile");try{const b=await m(c(a),3e4,"Read source file");n.info(`[Attachment] Read ${b.byteLength} bytes from source`),await m(l(E,b),3e4,"Write destination file"),n.info("File written to destination")}catch(b){throw n.error({err:b},"Read/Write also failed"),new Error(`Failed to copy file: ${b instanceof Error?b.message:"Unknown error"}`)}}let P=!1;try{P=await m(y(E),5e3,"Verify copy"),n.info(`[Attachment] Post-copy exists() check: ${P}`)}catch(M){n.warn({data:M},"Post-copy exists() check failed, assuming success"),P=!0}return P||n.warn("exists() returned false for target, but copy may have succeeded"),n.info("File save completed (exists check may be unreliable)"),n.info(`[Attachment] Successfully saved: ${E}`),E}catch(i){n.error({err:i},"Failed to save attachment");const r=i instanceof Error?i.message:"Failed to save attachment";throw new Error(r)}}async deleteAttachment(t){try{const{exists:a,remove:s}=await A();return await a(t)?(await s(t),n.info(`Attachment deleted: ${t}`),!0):(n.warn(`Attachment not found: ${t}`),!1)}catch(a){throw n.error({err:a},"Failed to delete attachment"),new Error("Failed to delete attachment")}}async openAttachment(t){try{const{openPath:a}=await A();n.info(`[Attachment] Opening attachment: ${t}`),n.info("Calling openPath directly..."),await m(a(t),1e4,"Open file"),n.info("File opened successfully")}catch(a){n.error({err:a},"Failed to open attachment");const s=a instanceof Error?a.message:String(a);throw new Error(`Could not open file at ${t}: ${s}`)}}async getAttachmentInfo(t){try{const{exists:a}=await A();n.info(`[Attachment] Getting info for: ${t}`);let s=!0;try{s=await m(a(t),5e3,"Check exists for info"),n.info(`[Attachment] File exists check: ${s}`)}catch(l){n.warn({data:l},"exists() check failed, assuming file exists"),s=!0}const i=t.split(/[/\\]/),d=i[i.length-1].replace(/^\d+_/,""),c={path:t,name:d,exists:s};return n.info({data:c},"Info result"),c}catch(a){return n.error({err:a},"Failed to get attachment info"),null}}validateFile(t){var s;return((s=t.split(".").pop())==null?void 0:s.toLowerCase())!=="pdf"?{valid:!1,error:"Only PDF files are supported"}:{valid:!0}}async cleanupAssetAttachments(t){try{const{appDataDir:a,join:s,exists:i,remove:r}=await A(),d=await a(),c=await s(d,this.ATTACHMENTS_DIR,this.ASSETS_SUBDIR,t);await i(c)&&(await r(c,{recursive:!0}),n.info(`Cleaned up attachments for asset: ${t}`))}catch(a){n.error({err:a},"Failed to cleanup attachments")}}async ensureDirectory(t){const{exists:a,mkdir:s}=await A();let i=!1;try{i=await a(t)}catch{i=!1}if(!i)try{await s(t,{recursive:!0})}catch(r){n.warn({data:r},"mkdir warning (may be OK if dir exists)")}}sanitizeFilename(t){return t.replace(/[<>:"/\\|?*]/g,"_").replace(/\s+/g,"_").substring(0,100)}}const Q=new K,$=(e,t)=>z.request(e,t);function L(e,t){return Math.round(e*(t/100)*100)/100}function V(e,t,a,s){const i=[],r=t/s,c=12-a.getMonth(),l=r*c/12;let y=0,f=t;const v=a.getFullYear();y+=l,f-=l,i.push({id:crypto.randomUUID(),assetId:e,year:v,months:c,amount:Math.round(l*100)/100,cumulative:Math.round(y*100)/100,bookValue:Math.round(f*100)/100});const w=s-1;for(let o=1;o<=w;o++)y+=r,f-=r,f<0&&(f=0),i.push({id:crypto.randomUUID(),assetId:e,year:v+o,months:12,amount:Math.round(r*100)/100,cumulative:Math.round(y*100)/100,bookValue:Math.round(f*100)/100});if(c<12){const o=12-c,u=r*o/12;y+=u,f=0,i.push({id:crypto.randomUUID(),assetId:e,year:v+s,months:o,amount:Math.round(u*100)/100,cumulative:Math.round(t*100)/100,bookValue:0})}return i}function H(e,t,a){const s=a.getFullYear();return[{id:crypto.randomUUID(),assetId:e,year:s,months:12,amount:Math.round(t*100)/100,cumulative:Math.round(t*100)/100,bookValue:0}]}function Z(e){return{id:e.id,assetId:e.asset_id,year:e.year,months:e.months,amount:e.amount,cumulative:e.cumulative,bookValue:e.book_value}}function _(e,t=[]){return{id:e.id,name:e.name,description:e.description??void 0,purchaseDate:new Date(e.purchase_date),vendor:e.vendor??void 0,purchasePrice:e.purchase_price,vatPaid:e.vat_paid??0,grossPrice:e.gross_price??e.purchase_price,afaMethod:e.afa_method??e.depreciation_method??"linear",afaYears:e.afa_years??e.useful_life_years??3,afaStartDate:new Date(e.afa_start_date??e.purchase_date),afaAnnualAmount:e.afa_annual_amount??0,status:e.status??"active",disposalDate:e.disposal_date?new Date(e.disposal_date):void 0,disposalPrice:e.disposal_price??void 0,euerLine:e.euer_line??30,euerCategory:e.euer_category??"afa_beweglich",category:e.category,inventoryNumber:e.inventory_number??void 0,location:e.location??void 0,billPath:e.bill_path??void 0,depreciationSchedule:t,createdAt:new Date(e.created_at??Date.now())}}async function T(e){return(await(await g()).select("SELECT * FROM depreciation_schedule WHERE asset_id = $1 ORDER BY year ASC",[e])).map(Z)}async function U(e){const t=await g();for(const a of e)await t.execute(`INSERT INTO depreciation_schedule (
        id, asset_id, year, months, amount, cumulative, book_value
      ) VALUES ($1, $2, $3, $4, $5, $6, $7)`,[a.id,a.assetId,a.year,a.months,a.amount,a.cumulative,a.bookValue])}async function ee(){const t=await(await g()).select(`SELECT inventory_number as max_num FROM assets
     WHERE inventory_number IS NOT NULL
     ORDER BY inventory_number DESC LIMIT 1`);if(t.length===0||!t[0].max_num)return"INV-001";const a=t[0].max_num.match(/INV-(\d+)/);if(!a)return"INV-001";const s=parseInt(a[1],10)+1;return`INV-${String(s).padStart(3,"0")}`}async function oe(){if(!D())return(await $("/assets")).map(i=>_(i));const t=await(await g()).select("SELECT * FROM assets ORDER BY purchase_date DESC"),a=[];for(const s of t){const i=await T(s.id);a.push(_(s,i))}return a}async function R(e){if(!D())try{const i=await $(`/assets/${e}`);return _(i)}catch{return null}const a=await(await g()).select("SELECT * FROM assets WHERE id = $1",[e]);if(a.length===0)return null;const s=await T(e);return _(a[0],s)}async function ce(e){if(!D())return(await $(`/assets?category=${e}`)).map(r=>_(r));const a=await(await g()).select("SELECT * FROM assets WHERE category = $1 ORDER BY purchase_date DESC",[e]),s=[];for(const i of a){const r=await T(i.id);s.push(_(i,r))}return s}async function te(e){if(!D())return(await $(`/assets?status=${e}`)).map(r=>_(r));const a=await(await g()).select("SELECT * FROM assets WHERE status = $1 ORDER BY purchase_date DESC",[e]),s=[];for(const i of a){const r=await T(i.id);s.push(_(i,r))}return s}async function C(){return await te("active")}async function ae(){if(!D())return(await $("/assets?status=disposed,sold")).map(i=>_(i));const t=await(await g()).select("SELECT * FROM assets WHERE status IN ('disposed', 'sold') ORDER BY purchase_date DESC"),a=[];for(const s of t){const i=await T(s.id);a.push(_(s,i))}return a}async function ue(e,t){if(!D()){const w=await $("/assets",{method:"POST",body:JSON.stringify({id:t,name:e.name,description:e.description,purchase_date:e.purchaseDate.toISOString().split("T")[0],vendor:e.vendor,purchase_price:e.purchasePrice,vat_rate:e.vatRate,afa_method:e.afaMethod,afa_years:e.afaYears,category:e.category,inventory_number:e.inventoryNumber,location:e.location,bill_path:e.billPath})});return _(w)}const a=await g(),s=t??crypto.randomUUID(),i=new Date().toISOString(),r=L(e.purchasePrice,e.vatRate),d=e.purchasePrice+r;let c=e.afaMethod??"linear",l=e.afaYears??X[e.category];!e.afaMethod&&e.purchasePrice<=k.GWG_MAX&&(c="immediate",l=1);const y=c==="immediate"?H(s,e.purchasePrice,e.purchaseDate):V(s,e.purchasePrice,e.purchaseDate,l),f=c==="immediate"?e.purchasePrice:e.purchasePrice/l,v=e.inventoryNumber||await ee();return await a.execute(`INSERT INTO assets (
      id, name, description, purchase_date, vendor, purchase_price,
      vat_paid, gross_price, afa_method, afa_years, afa_start_date,
      afa_annual_amount, status, euer_line, euer_category, category,
      inventory_number, location, bill_path, created_at
    ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20)`,[s,e.name,e.description??null,e.purchaseDate.toISOString().split("T")[0],e.vendor??null,e.purchasePrice,r,d,c,l,e.purchaseDate.toISOString().split("T")[0],f,"active",30,"afa_beweglich",e.category,v,e.location??"Home Office",e.billPath??null,i]),await U(y),{id:s,name:e.name,description:e.description,purchaseDate:e.purchaseDate,vendor:e.vendor,purchasePrice:e.purchasePrice,vatPaid:r,grossPrice:d,afaMethod:c,afaYears:l,afaStartDate:e.purchaseDate,afaAnnualAmount:f,status:"active",euerLine:30,euerCategory:"afa_beweglich",category:e.category,inventoryNumber:v,location:e.location??"Home Office",billPath:e.billPath,depreciationSchedule:y,createdAt:new Date(i)}}async function le(e,t){if(!D())try{const h={};t.name!==void 0&&(h.name=t.name),t.description!==void 0&&(h.description=t.description),t.purchaseDate&&(h.purchase_date=t.purchaseDate.toISOString().split("T")[0]),t.vendor!==void 0&&(h.vendor=t.vendor),t.purchasePrice!==void 0&&(h.purchase_price=t.purchasePrice),t.vatRate!==void 0&&(h.vat_rate=t.vatRate),t.afaMethod!==void 0&&(h.afa_method=t.afaMethod),t.afaYears!==void 0&&(h.afa_years=t.afaYears),t.category!==void 0&&(h.category=t.category),t.inventoryNumber!==void 0&&(h.inventory_number=t.inventoryNumber),t.location!==void 0&&(h.location=t.location),t.billPath!==void 0&&(h.bill_path=t.billPath);const E=await $(`/assets/${e}`,{method:"PATCH",body:JSON.stringify(h)});return _(E)}catch{return null}const a=await R(e);if(!a)return null;const s=await g(),i=t.purchasePrice??a.purchasePrice,r=t.category??a.category,d=t.purchaseDate??a.purchaseDate;let c=t.afaYears??a.afaYears,l=t.afaMethod??a.afaMethod;t.afaMethod===void 0&&i<=k.GWG_MAX&&(l="immediate",c=1);let y=a.depreciationSchedule,f=a.afaAnnualAmount;(t.purchasePrice!==void 0||t.category!==void 0||t.purchaseDate!==void 0||t.afaYears!==void 0||t.afaMethod!==void 0)&&(await s.execute("DELETE FROM depreciation_schedule WHERE asset_id = $1",[e]),y=l==="immediate"?H(e,i,d):V(e,i,d,c),f=l==="immediate"?i:i/c,await U(y));let v=a.vatPaid,w=a.grossPrice;if(t.purchasePrice!==void 0||t.vatRate!==void 0){const h=t.vatRate??19;v=L(i,h),w=i+v}const o=[],u=[];let p=1;return t.name!==void 0&&(o.push(`name = $${p++}`),u.push(t.name)),t.description!==void 0&&(o.push(`description = $${p++}`),u.push(t.description??null)),t.purchaseDate!==void 0&&(o.push(`purchase_date = $${p++}`),u.push(d.toISOString().split("T")[0]),o.push(`afa_start_date = $${p++}`),u.push(d.toISOString().split("T")[0])),t.vendor!==void 0&&(o.push(`vendor = $${p++}`),u.push(t.vendor??null)),t.purchasePrice!==void 0&&(o.push(`purchase_price = $${p++}`),u.push(i)),(t.purchasePrice!==void 0||t.vatRate!==void 0)&&(o.push(`vat_paid = $${p++}`),u.push(v),o.push(`gross_price = $${p++}`),u.push(w)),(t.afaYears!==void 0||t.purchasePrice!==void 0||t.afaMethod!==void 0)&&(o.push(`afa_years = $${p++}`),u.push(c),o.push(`afa_method = $${p++}`),u.push(l),o.push(`afa_annual_amount = $${p++}`),u.push(f)),t.category!==void 0&&(o.push(`category = $${p++}`),u.push(r)),t.inventoryNumber!==void 0&&(o.push(`inventory_number = $${p++}`),u.push(t.inventoryNumber??null)),t.location!==void 0&&(o.push(`location = $${p++}`),u.push(t.location??null)),t.billPath!==void 0&&(o.push(`bill_path = $${p++}`),u.push(t.billPath??null)),o.length>0&&(u.push(e),await s.execute(`UPDATE assets SET ${o.join(", ")} WHERE id = $${p}`,u)),await R(e)}async function pe(e){if(!D())return await $(`/assets/${e}`,{method:"DELETE"}),!0;if(!await R(e))return!1;const a=await g();return await Q.cleanupAssetAttachments(e),await a.execute("DELETE FROM depreciation_schedule WHERE asset_id = $1",[e]),await a.execute("DELETE FROM assets WHERE id = $1",[e]),!0}async function he(e,t,a,s){if(!D()){const d=await $(`/assets/${e}/dispose`,{method:"POST",body:JSON.stringify({disposal_date:t.toISOString().split("T")[0],status:a,disposal_price:s})});return _(d)}return await R(e)?(await(await g()).execute("UPDATE assets SET status = $1, disposal_date = $2, disposal_price = $3 WHERE id = $4",[a,t.toISOString().split("T")[0],a==="sold"?s??null:null,e]),await R(e)):null}function B(e){const t=new Date().getFullYear(),a=e.depreciationSchedule.filter(s=>s.year<=t).sort((s,i)=>i.year-s.year)[0];return(a==null?void 0:a.bookValue)??e.purchasePrice}async function de(e){return(await C()).reduce((a,s)=>{const i=s.depreciationSchedule.find(r=>r.year===e);return a+((i==null?void 0:i.amount)??0)},0)}async function fe(e){const t=await C(),a={computer:0,phone:0,furniture:0,equipment:0,software:0};for(const s of t){const i=s.depreciationSchedule.find(r=>r.year===e);i&&(a[s.category]+=i.amount)}return a}async function me(){return(await C()).reduce((t,a)=>t+B(a),0)}async function W(e){return(await ae()).filter(a=>a.disposalDate?new Date(a.disposalDate).getFullYear()===e:!1)}function Y(e){if(!e.disposalDate)return B(e);const t=new Date(e.disposalDate).getFullYear(),a=e.depreciationSchedule.find(i=>i.year===t);if(a)return a.bookValue;const s=e.depreciationSchedule.filter(i=>i.year<t).sort((i,r)=>r.year-i.year)[0];return(s==null?void 0:s.bookValue)??e.purchasePrice}function G(e){if(e.status!=="sold"||!e.disposalPrice)return-Y(e);const t=Y(e);return e.disposalPrice-t}async function ye(e){return(await W(e)).reduce((a,s)=>{const i=G(s);return a+(i>0?i:0)},0)}async function ve(e){return(await W(e)).reduce((a,s)=>{const i=G(s);return a+(i<0?Math.abs(i):0)},0)}export{Q as a,ce as b,te as c,C as d,ae as e,ue as f,oe as g,pe as h,he as i,de as j,fe as k,me as l,ye as m,ve as n,le as u};
